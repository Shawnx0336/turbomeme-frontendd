<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DegenDice - Slotana Style</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext x='0' y='14'%3EðŸŽ²%3C/text%3E%3C/svg%3E" type="image/svg+xml">
    <style>
        :root {
            --bg-dark: #0A0A0A;
            --accent-pink: #FF3366;
            --accent-green: #00FF99;
            --text-light: #FFFFFF;
            --radius-md: 12px;
            --radius-sm: 6px;
            --shadow-glow: 0 0 10px;
            --header-height: 60px; /* Define header height */
            --leaderboard-width: 250px; /* Define leaderboard width */
            --chat-height: 300px; /* Define chat height */
            --chat-width: 300px; /* Define chat width */
            --chat-bubble-size: 60px; /* Size for the mobile chat bubble */
        }

        body {
            font-family: 'Inter', sans-serif;
            /* Animated background gradient */
            background: linear-gradient(180deg, #0A0A0A 0%, #1A1A2E 50%, #0A0A0A 100%);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
            color: var(--text-light);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative; /* Needed for fixed positioning */
            /* Safe Area Insets for mobile */
            padding-top: constant(safe-area-inset-top);
            padding-top: env(safe-area-inset-top);
            padding-bottom: constant(safe-area-inset-bottom);
            padding-bottom: env(safe-area-inset-bottom);
            overflow-x: hidden; /* Prevent horizontal scroll from fixed elements */
        }

        /* Add to CSS */
        body.high-intensity {
            animation: gradientAnimation 5s ease infinite;
            --shadow-glow: 0 0 15px;
        }
        body.low-intensity {
            animation: gradientAnimation 20s ease infinite;
            --shadow-glow: 0 0 5px;
        }


        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        header {
            background: linear-gradient(145deg, rgba(255, 51, 102, 0.2), rgba(0, 255, 153, 0.1));
            padding: 0.5rem 1rem; /* Adjusted padding */
            height: var(--header-height); /* Set header height */
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: fixed; /* Fixed header */
            top: 0;
            left: 0;
            width: 100%;
            z-index: 20; /* Ensure header is on top */
            box-sizing: border-box; /* Include padding in width */
        }

        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 1rem; /* Space between header elements */
        }

        .wallet-info {
            font-weight: 400;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .wallet-info i {
            color: var(--accent-green); /* Icon color */
        }

         .demo-mode-indicator {
             background-color: rgba(255, 255, 0, 0.2);
             color: yellow;
             padding: 0.2rem 0.5rem;
             border-radius: var(--radius-sm);
             font-size: 0.8rem;
             font-weight: 700;
             margin-left: 0.5rem;
         }


        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            padding-top: calc(var(--header-height) + 2rem); /* Add padding to account for fixed header */
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box; /* Include padding in width */
            position: relative; /* Needed for z-index */
            z-index: 1; /* Below fixed elements */
        }

        .dice-area {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .dice {
            width: 100px;
            height: 100px;
            background-color: white;
            border-radius: var(--radius-sm);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            color: var(--bg-dark);
            box-shadow: var(--shadow-glow) rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease; /* Added box-shadow transition */
        }

         /* Dice visual variety based on result */
         .dice.win {
             box-shadow: var(--shadow-glow) var(--accent-green);
             border: 2px solid var(--accent-green);
             animation: pulse 0.5s;
         }

         .dice.loss {
             box-shadow: var(--shadow-glow) var(--accent-pink);
             border: 2px solid var(--accent-pink);
             animation: shake 0.5s;
         }

         @keyframes pulse {
             0% { transform: scale(1); }
             50% { transform: scale(1.1); }
             100% { transform: scale(1); }
         }

         @keyframes shake {
             0%, 100% { transform: translateX(0); }
             20%, 60% { transform: translateX(-5px); }
             40%, 80% { transform: translateX(5px); }
         }


        .controls {
            background: rgba(20, 20, 20, 0.8);
            padding: 1.5rem;
            border-radius: var(--radius-md);
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: linear-gradient(to right, var(--accent-pink), var(--accent-green));
            border-radius: 4px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: var(--text-light);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow-glow) var(--accent-pink);
        }

        .multiplier-display {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            color: var(--accent-green);
            text-shadow: var(--shadow-glow) var(--accent-green);
        }

        .bet-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative; /* Needed for pseudo-elements/animations */
            overflow: hidden; /* Hide overflow for glowing effect */
        }

        /* FIX: Ensure consistent hover/active styles for all buttons */
        button:hover:not(:disabled) {
             transform: scale(1.05);
             box-shadow: var(--shadow-glow) rgba(255, 255, 255, 0.2); /* Default glow */
        }

        button:active:not(:disabled) {
            transform: scale(0.95); /* Press down effect */
        }

        button:disabled {
            opacity: 0.5 !important; /* Use !important to override potential conflicts */
            cursor: not-allowed !important;
        }

        .roll-btn {
            background-color: var(--accent-pink);
            color: white;
        }

        /* Glowing hover effect for roll button - Specific glow */
        .roll-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: var(--shadow-glow) var(--accent-pink); /* Pink glow */
            animation: glowing 1.5s infinite;
        }

        @keyframes glowing {
            0% { box-shadow: var(--shadow-glow) var(--accent-pink); }
            50% { box-shadow: 0 0 20px var(--accent-pink); }
            100% { box-shadow: var(--shadow-glow) var(--accent-pink); }
        }


        .chip-btn {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            flex: 1;
        }

        /* Chip button pulse animation */
        @keyframes chipPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
         .chip-btn.active {
            background-color: var(--accent-pink);
            box-shadow: var(--shadow-glow) var(--accent-pink);
            animation: chipPulse 0.5s; /* Apply pulse animation */
        }

        .result-display {
            font-size: 2rem;
            font-weight: 700;
            margin-top: 1rem;
            text-align: center;
            min-height: 3rem;
        }

        .win {
            color: var(--accent-green);
            animation: scale 0.5s;
        }

        .loss {
            color: var(--accent-pink);
            animation: shake 0.3s;
        }

        @keyframes scale {
            0% { transform: scale(0.8); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        .win-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 255, 153, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 72px;
            color: var(--accent-green);
            animation: flash 0.5s;
            pointer-events: none;
            z-index: 100;
        }

        @keyframes flash {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        .streak-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 1rem 2rem;
            border-radius: var(--radius-md);
            font-size: 48px;
            color: var(--accent-pink);
            animation: scale 0.5s;
            z-index: 101;
        }

        .recent-wins {
            position: fixed;
            bottom: 1rem;
            left: 0;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            background: rgba(0, 0, 0, 0.5);
            padding: 0.5rem 0;
            z-index: 10; /* Below game container, above background */
        }

        .recent-wins span {
            display: inline-block;
            padding-left: 100%;
            animation: slide-left 15s linear infinite;
        }

        @keyframes slide-left {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }

        .hot-streak {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-pink);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-weight: 700;
            /* Removed pulse animation */
            z-index: 10; /* Below header, above game */
        }


        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 99;
        }

        /* --- New Styles for Added Features --- */

        /* Modals */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000; /* High z-index for modals */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent black background */
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: var(--bg-dark);
            padding: 2rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-glow) rgba(255, 255, 255, 0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
            position: relative;
            animation: slideInFromTop 0.3s ease;
        }

        .modal-content h2 {
            margin-top: 0;
            color: var(--accent-green);
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--text-light);
            text-decoration: none;
        }

        /* Wallet Connect Modal Specifics */
        .wallet-options button {
            display: block;
            width: 100%;
            margin-bottom: 1rem;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            padding: 1rem;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 1rem;
             /* FIX: Add hover/active styles to wallet connect buttons */
             transition: all 0.2s ease;
        }

        .wallet-options button:hover {
             background-color: rgba(255, 255, 255, 0.2);
             box-shadow: var(--shadow-glow) rgba(255, 255, 255, 0.1);
        }

         .wallet-options button:active {
             transform: scale(0.98);
         }


        /* FIX: Add loading state style for wallet buttons */
        .wallet-options button.loading {
             opacity: 0.7;
             cursor: wait;
             position: relative;
             pointer-events: none; /* Prevent clicks while loading */
        }

        .wallet-options button.loading::after {
             content: '';
             position: absolute;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             width: 20px;
             height: 20px;
             border: 2px solid #fff;
             border-top-color: transparent;
             border-radius: 50%;
             animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }


        /* Leaderboard */
        .leaderboard-sidebar {
            position: fixed;
            top: var(--header-height); /* Position below header */
            right: 0;
            width: var(--leaderboard-width);
            height: calc(100% - var(--header-height)); /* Full height below header */
            background: rgba(20, 20, 20, 0.9);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem;
            box-sizing: border-box;
            z-index: 15; /* Above game container, below header */
            overflow-y: auto; /* Enable scrolling for long leaderboards */
            transform: translateX(0); /* Default position */
            transition: transform 0.3s ease-in-out;
        }

        .leaderboard-sidebar h3 {
            margin-top: 0;
            color: var(--accent-green);
            text-align: center;
            margin-bottom: 1rem;
        }

        .leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            opacity: 1; /* Default opacity for animation */
            transition: opacity 0.5s ease-in-out;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-item .player-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .leaderboard-item .player-info .avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1); /* Placeholder background */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem;
        }

        .leaderboard-item .wins {
            font-weight: 700;
            color: var(--accent-green);
        }

        /* Leaderboard update animation */
        .leaderboard-item.fade-in {
            animation: fadeIn 0.5s ease;
        }

        .leaderboard-item.pulse {
            animation: pulse 1s infinite;
        }


        /* Chat System */
        /* PRIORITY FIX: Chat Bubble Fix CSS */
        .chat-container {
            position: fixed;
            bottom: calc(4.5rem + env(safe-area-inset-bottom)); /* Adjusted position based on user request */
            right: 1rem;
            width: var(--chat-width); /* Default desktop width */
            height: var(--chat-height); /* Default desktop height */
            background: rgba(20, 20, 20, 0.9); /* Default desktop background */
            border-radius: var(--radius-md); /* Default desktop radius */
            box-shadow: var(--shadow-glow) rgba(255, 255, 255, 0.1); /* Default desktop shadow */
            z-index: 100; /* Above most elements */
            display: flex; /* Default desktop display */
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease-in-out; /* Added transition for smooth opening/closing */
            /* Mobile specific styles - these will be overridden by media query on desktop */
            transform: translateY(100%); /* Start off-screen for mobile */
            width: 100%; /* Full width on mobile */
            height: 50vh; /* Half height on mobile */
            bottom: 0; /* Position at the bottom on mobile */
            left: 0; /* Position at the left on mobile */
            border-radius: 0; /* No radius on mobile */
            background: rgba(26, 26, 26, 0.95); /* Specified mobile background */
            backdrop-filter: blur(10px); /* Specified mobile backdrop */
            -webkit-backdrop-filter: blur(10px); /* Specified mobile backdrop */
            box-shadow: none; /* No shadow on mobile */
        }

        /* PRIORITY FIX: Chat Bubble Fix CSS - Active state for mobile */
        .chat-container.active {
            transform: translateY(0); /* Slide up into view */
        }

        .chat-header {
            background: rgba(255, 255, 255, 0.05);
            padding: 0.75rem;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* Removed cursor: pointer here, toggle logic is now on the container/close button */
        }

        .chat-header i {
             transition: transform 0.3s ease;
        }

        .chat-header i.rotated {
            transform: rotate(180deg);
        }

        /* Added close button style for chat header on mobile */
         .chat-header .close-chat-btn {
             color: #aaa;
             font-size: 20px;
             cursor: pointer;
             transition: color 0.2s ease;
         }

         .chat-header .close-chat-btn:hover {
             color: var(--text-light);
         }


        .chat-body {
            flex: 1;
            padding: 1rem;
            overflow-y: auto; /* Scrollable chat messages */
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-pink) transparent;
        }

        .chat-body::-webkit-scrollbar {
            width: 6px;
        }

        .chat-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-body::-webkit-scrollbar-thumb {
            background-color: var(--accent-pink);
            border-radius: 3px;
        }


        .chat-message {
            background: rgba(255, 255, 255, 0.05);
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            word-break: break-word; /* Break long words */
        }

        .chat-message .username {
            font-weight: 700;
            color: var(--accent-green);
            margin-right: 0.5rem;
        }

        .chat-input-area {
            display: flex;
            padding: 0.75rem;
            gap: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-input-area input[type="text"] {
            flex: 1;
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            border: none;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            outline: none;
        }

        .chat-input-area input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .chat-input-area button {
            padding: 0.5rem 1rem;
            background-color: var(--accent-pink);
            color: white;
            border-radius: var(--radius-sm);
            font-weight: 700;
             /* FIX: Add hover/active styles to chat send button */
             transition: all 0.2s ease;
        }

        .chat-input-area button:hover {
            background-color: #ff6699;
             box-shadow: var(--shadow-glow) var(--accent-pink);
        }

         .chat-input-area button:active {
             transform: scale(0.95);
         }


        /* PRIORITY FIX: Chat Bubble Fix CSS - Toggle Button (Bubble) */
        #toggle-chat {
            display: block; /* Show on mobile */
            position: fixed;
            bottom: calc(4.5rem + env(safe-area-inset-bottom)); /* Position above safe area */
            right: 1rem;
            background-color: var(--accent-pink);
            color: white;
            width: var(--chat-bubble-size);
            height: var(--chat-bubble-size);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-glow) var(--accent-pink);
            z-index: 110; /* Above chat container */
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            border: none; /* Ensure it's a clean button */
             /* FIX: Add hover/active styles to chat toggle button */
             transition: all 0.3s ease-in-out, box-shadow 0.2s ease;
        }

        #toggle-chat:hover {
             box-shadow: 0 0 15px var(--accent-pink);
        }

         #toggle-chat:active {
             transform: scale(0.9);
         }


        /* Full-screen chat for mobile when open */
        /* This section is modified to work with the new toggle logic */
        .chat-container:not(.active) .chat-header,
        .chat-container:not(.active) .chat-body,
        .chat-container:not(.active) .chat-input-area {
             display: none; /* Hide chat content when not active (mobile bubble state) */
        }

        .chat-container.active .chat-header,
        .chat-container.active .chat-body,
        .chat-container.active .chat-input-area {
             display: flex; /* Show chat content when active (mobile full screen) */
        }

         /* Ensure the chat bubble icon is visible in the bubble state */
        #chat-bubble-icon {
             display: flex; /* Always display the icon */
             color: white; /* Icon color */
        }

        /* Hide the chat bubble icon when chat is full screen (active) */
        .chat-container.active #chat-bubble-icon {
             display: none;
        }

        /* Adjust padding for safe areas when chat is active (full screen) */
        .chat-container.active .chat-header {
            padding-top: constant(safe-area-inset-top);
            padding-top: env(safe-area-inset-top);
        }

        .chat-container.active .chat-input-area {
             padding-bottom: constant(safe-area-inset-bottom);
            padding-bottom: env(safe-area-inset-bottom);
        }


        /* Profile Modal Specifics */
        .profile-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .profile-options label {
            text-align: left;
            font-weight: 700;
        }

        .profile-options input[type="text"] {
             padding: 0.75rem;
             border-radius: var(--radius-sm);
             border: 1px solid rgba(255, 255, 255, 0.1);
             background-color: rgba(255, 255, 255, 0.05);
             color: var(--text-light);
             outline: none;
        }

        .profile-options button {
            background-color: var(--accent-green);
            color: var(--bg-dark);
            font-weight: 700;
             /* FIX: Add hover/active styles to profile buttons */
             transition: all 0.2s ease;
        }

        .profile-options button:hover {
            background-color: #33ffb3;
             box-shadow: var(--shadow-glow) var(--accent-green);
        }

         .profile-options button:active {
             transform: scale(0.95);
         }


        /* Deposit/Withdraw Modals */
        .transaction-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .transaction-options input[type="number"] {
            padding: 0.75rem;
            border-radius: var(--radius-sm);
            border: 1px solid rgba(255, 255, 255, 0.1);
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-light);
            outline: none;
        }

        .transaction-options button {
            background-color: var(--accent-green);
            color: var(--bg-dark);
            font-weight: 700;
             /* FIX: Add hover/active styles to transaction buttons */
             transition: all 0.2s ease;
        }

        .transaction-options button:hover {
             background-color: #33ffb3;
             box-shadow: var(--shadow-glow) var(--accent-green);
        }

         .transaction-options button:active {
             transform: scale(0.95);
         }


        /* Daily Challenge */
        .daily-challenge-panel {
            background: rgba(20, 20, 20, 0.9);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-top: 2rem;
            text-align: center;
            border: 1px solid var(--accent-green);
            animation: pulseBorder 2s infinite;
        }

        @keyframes pulseBorder {
            0%, 100% { border-color: var(--accent-green); }
            50% { border-color: rgba(0, 255, 153, 0.5); }
        }

        .daily-challenge-panel h4 {
            margin-top: 0;
            color: var(--accent-green);
        }

        .daily-challenge-panel .progress {
            margin: 0.5rem 0;
        }

        .daily-challenge-panel button {
            background-color: var(--accent-pink);
            color: white;
            margin-top: 1rem;
             /* FIX: Add hover/active styles to daily challenge button */
             transition: all 0.2s ease;
        }

        .daily-challenge-panel button:hover {
             background-color: #ff6699;
             box-shadow: var(--shadow-glow) var(--accent-pink);
        }

         .daily-challenge-panel button:active {
             transform: scale(0.95);
         }


        /* Referral Feature */
        .referral-feature {
            background: rgba(20, 20, 20, 0.9);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-top: 2rem;
            text-align: center;
            border: 1px solid var(--accent-pink);
        }

        .referral-feature h4 {
            margin-top: 0;
            color: var(--accent-pink);
        }

        .referral-code {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0.5rem 0;
            color: var(--accent-green);
        }

        .referral-feature button {
            background-color: var(--accent-green);
            color: var(--bg-dark);
            margin-top: 1rem;
             /* FIX: Add hover/active styles to referral button */
             transition: all 0.2s ease;
        }

        .referral-feature button:hover {
             background-color: #33ffb3;
             box-shadow: var(--shadow-glow) var(--accent-green);
        }

         .referral-feature button:active {
             transform: scale(0.95);
         }


        /* Coin Shower Animation (using existing confetti) */
        /* Confetti styles are already present */

        /* Big Win Fireworks Animation (Mock) */
        .big-win-fireworks {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.5) 0%, rgba(255, 215, 0, 0) 70%); /* Golden glow effect */
            animation: fireworks 1s ease-out forwards;
        }

        @keyframes fireworks {
             0% { opacity: 0; transform: scale(0.5); }
             50% { opacity: 1; transform: scale(1.2); }
             100% { opacity: 0; transform: scale(1.5); }
        }

        /* Big Win Text Animation */
        .big-win-text {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 96px;
            font-weight: 900;
            color: gold;
            text-shadow: 0 0 20px gold, 0 0 40px orange, 0 0 60px yellow;
            animation: bigWinText 2s ease-out forwards;
            z-index: 101;
            pointer-events: none;
        }

        @keyframes bigWinText {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }


        /* Micro-interactions (added to existing buttons) */
        /* button:active:not(:disabled) {
            transform: scale(0.95); /* Press down effect */
        /* } */ /* Moved to generic button style */


        /* Flash on Wins/Milestones (using existing .win-overlay) */
        /* The .win-overlay already provides a flash effect */

        /* Multiplier Flash Animation */
        @keyframes multiplierFlash {
            0% { text-shadow: var(--shadow-glow) var(--accent-green); }
            50% { text-shadow: 0 0 20px var(--accent-green); }
            100% { text-shadow: var(--shadow-glow) var(--accent-green); }
        }
         .multiplier-display.flashing {
             animation: multiplierFlash 0.3s ease;
         }


        /* Limited-Time Event Timer */
        .event-timer {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            margin-left: 1rem; /* Space from other header elements */
        }

        /* Live Win Notifications (Enhanced Recent Wins) */
        .recent-wins span {
            display: inline-block;
            padding-left: 100%;
            animation: slide-left 15s linear infinite;
        }

         .recent-wins .win-notification {
             margin-right: 2rem; /* Space between notifications */
             font-weight: 700;
         }

         .recent-wins .win-notification .avatar {
             margin-right: 0.5rem;
         }

         .recent-wins .win-notification .join-button {
             background-color: var(--accent-green);
             color: var(--bg-dark);
             padding: 0.2rem 0.5rem;
             border-radius: var(--radius-sm);
             font-size: 0.8rem;
             cursor: pointer;
             margin-left: 0.5rem;
              /* FIX: Add hover/active styles to join button */
             transition: all 0.2s ease;
         }

         .recent-wins .win-notification .join-button:hover {
             background-color: #33ffb3;
             box-shadow: var(--shadow-glow) var(--accent-green);
         }

          .recent-wins .win-notification .join-button:active {
             transform: scale(0.95);
         }


        /* Winner of the Day Banner */
        .winner-banner {
            background: linear-gradient(90deg, var(--accent-green), rgba(0, 255, 153, 0.5));
            color: var(--bg-dark);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            font-weight: 700;
            text-align: center;
            margin-bottom: 2rem; /* Space below banner */
            display: none; /* Hidden by default */
        }

        .winner-banner .avatar {
             margin-right: 0.5rem;
        }


        /* Chat Enhancements */
        .chat-message .chat-badge {
             background-color: var(--accent-pink);
             color: white;
             padding: 0.1rem 0.4rem;
             border-radius: var(--radius-sm);
             font-size: 0.7rem;
             margin-left: 0.5rem;
             font-weight: 400;
        }

         .chat-message .cheer-button {
             background-color: rgba(255, 255, 255, 0.1);
             color: white;
             padding: 0.1rem 0.4rem;
             border-radius: var(--radius-sm);
             font-size: 0.7rem;
             margin-left: 0.5rem;
             cursor: pointer;
              /* FIX: Add hover/active styles to cheer button */
             transition: all 0.2s ease;
         }

         .chat-message .cheer-button:hover {
             background-color: rgba(255, 255, 255, 0.2);
             box-shadow: var(--shadow-glow) rgba(255, 255, 255, 0.1);
         }

         .chat-message .cheer-button:active {
             transform: scale(0.95);
         }


        /* Profile Flair */
        .user-profile .vip-badge {
             background-color: gold;
             color: var(--bg-dark);
             padding: 0.1rem 0.4rem;
             border-radius: var(--radius-sm);
             font-size: 0.7rem;
             margin-left: 0.5rem;
             font-weight: 700;
        }


        /* Streak Tracker */
        .streak-tracker {
            background: rgba(20, 20, 20, 0.9);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-top: 2rem;
            text-align: center;
            border: 1px solid var(--accent-pink);
            display: none; /* Hidden by default */
        }

        /* High Score/Biggest Wins Modal Specifics */
        #high-scores-modal .modal-content {
             text-align: left;
        }
         #high-scores-modal ul {
             list-style: none;
             padding: 0;
             margin: 1rem 0;
         }
         #high-scores-modal li {
             background: rgba(255, 255, 255, 0.05);
             padding: 0.75rem;
             border-radius: var(--radius-sm);
             margin-bottom: 0.5rem;
             display: flex;
             justify-content: space-between;
             align-items: center;
         }
         #high-scores-modal li span {
             font-weight: 700;
             color: var(--accent-green);
             word-break: break-all; /* Break long hashes */
         }


        /* Spin Wheel Modal */
        #spin-wheel-modal .modal-content {
             display: flex;
             flex-direction: column;
             align-items: center;
        }
         #spin-wheel {
             width: 250px;
             height: 250px;
             border: 5px solid var(--accent-pink);
             border-radius: 50%;
             margin-bottom: 1rem;
         }
         #spin-wheel-modal button {
             background-color: var(--accent-green);
             color: var(--bg-dark);
              /* FIX: Add hover/active styles to spin button */
             transition: all 0.2s ease;
         }

         #spin-wheel-modal button:hover {
             background-color: #33ffb3;
             box-shadow: var(--shadow-glow) var(--accent-green);
         }

         #spin-wheel-modal button:active {
             transform: scale(0.95);
         }


        /* Deposit Bonus Modal */
        #deposit-bonus-modal .modal-content {
             background: linear-gradient(145deg, var(--accent-green), rgba(0, 255, 153, 0.5));
             color: var(--bg-dark);
             font-weight: 700;
        }

        #deposit-bonus-modal button {
             /* FIX: Add hover/active styles to deposit bonus button */
             transition: all 0.2s ease;
        }

         #deposit-bonus-modal button:hover {
             background-color: #33ffb3;
             box-shadow: var(--shadow-glow) var(--accent-green);
         }

         #deposit-bonus-modal button:active {
             transform: scale(0.95);
         }


        /* Toast Notification (Generic Style) */
        .toast-notification {
            bottom: calc(1rem + var(--chat-bubble-size) + 1rem + constant(safe-area-inset-bottom)); /* Position above chat bubble */
            bottom: calc(1rem + var(--chat-bubble-size) + 1rem + env(safe-area-inset-bottom));
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-md);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none; /* Don't block clicks */
            max-width: 90%;
            text-align: center;
        }

         .toast-notification.show {
             opacity: 1;
         }

         .toast-notification button {
             background-color: var(--accent-pink);
             color: white;
             padding: 0.3rem 0.6rem;
             border-radius: var(--radius-sm);
             font-size: 0.8rem;
             margin-left: 1rem;
             cursor: pointer;
              /* FIX: Add hover/active styles to toast button */
             transition: all 0.2s ease;
         }

         .toast-notification button:hover {
             background-color: #ff6699;
             box-shadow: var(--shadow-glow) var(--accent-pink);
         }

         .toast-notification button:active {
             transform: scale(0.95);
         }


        /* Progressive Jackpot */
        .jackpot-counter {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            margin-right: 1rem; /* Space from other header elements */
            color: var(--accent-green);
            font-weight: 700;
        }


        /* Provably Fair Modal */
        #provably-fair-modal .modal-content {
             text-align: left;
        }
         #provably-fair-modal h3 {
             text-align: center;
             margin-bottom: 1rem;
         }
         #provably-fair-modal p {
             margin-bottom: 0.5rem;
             font-size: 0.9rem;
         }
         #provably-fair-modal span {
             font-weight: 700;
             color: var(--accent-green);
             word-break: break-all; /* Break long hashes */
         }

        #provably-fair-modal button {
             /* FIX: Add hover/active styles to provably fair button */
             transition: all 0.2s ease;
        }

         #provably-fair-modal button:hover {
             background-color: rgba(255, 255, 255, 0.2);
             box-shadow: var(--shadow-glow) rgba(255, 255, 255, 0.1);
         }

         #provably-fair-modal button:active {
             transform: scale(0.95);
         }


        /* Dynamic Background Video */
        /* Removed background video styles */


        /* Engagement Hooks */
        .engagement-hooks {
            margin-top: 2rem;
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .live-bets-ticker {
            background: rgba(20, 20, 20, 0.9);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            overflow: hidden;
            white-space: nowrap;
        }

         .live-bets-ticker span {
             display: inline-block;
             padding-left: 100%;
             animation: slide-left 10s linear infinite; /* Faster scroll */
         }

        .streak-booster {
            background: rgba(20, 20, 20, 0.9);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

         .streak-booster .booster-meter {
             flex-grow: 1;
             height: 8px;
             background: linear-gradient(to right, var(--accent-pink), var(--accent-green));
             border-radius: 4px;
             width: 0%; /* Filled by JS */
             transition: width 0.3s ease-in-out;
         }


        /* Fairness Verification */
        .fairness-verification {
            margin-top: 2rem;
            text-align: center;
        }
         .fairness-verification button {
             background-color: rgba(255, 255, 255, 0.1);
             color: white;
             margin-bottom: 1rem;
              /* FIX: Add hover/active styles to fairness verification button */
             transition: all 0.2s ease;
         }

         .fairness-verification button:hover {
             background-color: rgba(255, 255, 255, 0.2);
             box-shadow: var(--shadow-glow) rgba(255, 255, 255, 0.1);
         }

         .fairness-verification button:active {
             transform: scale(0.95);
         }


         #verification-result {
             background: rgba(20, 20, 20, 0.9);
             padding: 1rem;
             border-radius: var(--radius-md);
             text-align: left;
             font-size: 0.9rem;
             display: none; /* Hidden by default */
         }


        /* Monetization Tactics */
        .monetization-tactics {
            margin-top: 2rem;
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .time-limited-offer {
            background: linear-gradient(90deg, var(--accent-pink), rgba(255, 51, 102, 0.5));
            color: white;
            padding: 0.75rem;
            border-radius: var(--radius-md);
            font-weight: 700;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: pulse 1s infinite; /* Keep pulse for urgency */
            display: none; /* Hidden by default */
        }
         .time-limited-offer button {
             background-color: white;
             color: var(--accent-pink);
             padding: 0.3rem 0.6rem;
             border-radius: var(--radius-sm);
             font-size: 0.8rem;
             font-weight: 700;
              /* FIX: Add hover/active styles to time limited offer button */
             transition: all 0.2s ease;
         }

         .time-limited-offer button:hover {
             background-color: #eee;
             box-shadow: var(--shadow-glow) rgba(255, 255, 255, 0.2);
         }

         .time-limited-offer button:active {
             transform: scale(0.95);
         }


        .sunk-cost-tracker {
            background: rgba(20, 20, 20, 0.9);
            padding: 0.75rem;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

         .sunk-cost-tracker .progress-bar {
             height: 8px;
             background: linear-gradient(to right, var(--accent-green), rgba(0, 255, 153, 0.5));
             border-radius: 4px;
             width: 0%; /* Filled by JS */
             transition: width 0.3s ease-in-out;
         }


        /* Neuro Feedback */
        .neuro-feedback {
             /* Placeholder for visual effects */
        }

        /* Coercive Retention */
        .retention-popup {
             position: fixed;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             background: rgba(0, 0, 0, 0.9);
             padding: 1.5rem;
             border-radius: var(--radius-md);
             box-shadow: var(--shadow-glow) rgba(255, 255, 255, 0.2);
             z-index: 1000;
             text-align: center;
             display: none; /* Hidden by default */
        }
         .retention-popup p {
             margin-bottom: 1rem;
             font-size: 1.1rem;
             font-weight: 700;
         }
         .retention-popup button {
             background-color: var(--accent-green);
             color: var(--bg-dark);
             font-weight: 700;
              /* FIX: Add hover/active styles to retention popup button */
             transition: all 0.2s ease;
         }

         .retention-popup button:hover {
             background-color: #33ffb3;
             box-shadow: var(--shadow-glow) var(--accent-green);
         }

         .retention-popup button:active {
             transform: scale(0.95);
         }


         .retention-popup #countdown {
             color: var(--accent-pink);
         }


        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .header-left, .header-right {
                /* Adjusted gap and button width for better spacing */
                gap: 0.3rem; /* Reduced gap slightly */
                flex-shrink: 0; /* Prevent shrinking */
            }

            .header-left {
                 flex-grow: 1; /* Allow left side to grow */
                 justify-content: flex-start;
                 overflow-x: auto; /* Add horizontal scroll if needed */
                 padding-right: 0.5rem;
                 -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            }

             .header-right {
                 flex-grow: 1; /* Allow right side to grow */
                 justify-content: flex-end;
                  overflow-x: auto; /* Add horizontal scroll if needed */
                  padding-left: 0.5rem;
                  -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
             }


            .wallet-info {
                font-size: 12px;
                flex-shrink: 0; /* Prevent shrinking */
            }

            /* Header Buttons Mobile Size - Further refined based on Slotana */
            header button {
                padding: 0.3rem 0.5rem; /* Reduced padding more */
                font-size: 0.7rem; /* Reduced font size */
                 flex-shrink: 0; /* Prevent buttons from shrinking too much */
                 min-width: 50px; /* Ensure minimum width */
                 text-align: center;
                 display: flex;
                 align-items: center;
                 justify-content: center;
                 gap: 0.2rem; /* Small gap for icon and text */
            }

             header button i {
                 font-size: 0.8em; /* Adjust icon size relative to text */
             }


            .dice {
                width: 80px;
                height: 80px;
                font-size: 2.5rem;
            }

            .dice-area {
                gap: 1rem;
            }

            .controls {
                padding: 1rem;
            }

            .multiplier-display {
                font-size: 1.2rem;
            }

            .bet-controls {
                gap: 0.5rem;
            }

            button {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }

            .result-display {
                font-size: 1.5rem;
                min-height: 2.5rem;
            }

            .leaderboard-sidebar {
                width: 100%; /* Full width on mobile */
                right: -100%; /* Hide off-screen initially */
                transition: transform 0.3s ease-in-out;
            }

            body.leaderboard-open .leaderboard-sidebar {
                transform: translateX(-100%); /* Slide in from right */
            }

            /* PRIORITY FIX: Chat Bubble Fix CSS - Mobile Styles */
            /* These styles are now applied directly to .chat-container and .chat-container.active */
            /* The separate .chat-toggle-btn is used for the clickable bubble */
            .chat-container {
                /* Mobile styles defined above in the main .chat-container block */
            }

            .chat-container.active {
                /* Active mobile styles defined above */
            }

            /* Hide desktop chat content when not active on mobile */
             .chat-container:not(.active) .chat-header,
             .chat-container:not(.active) .chat-body,
             .chat-container:not(.active) .chat-input-area {
                  display: none;
             }

             /* Show mobile chat bubble toggle */
            #toggle-chat {
                 display: flex; /* Ensure it's visible on mobile */
            }


            .modal-content {
                padding: 1.5rem;
            }

            .streak-popup {
                font-size: 36px;
                padding: 0.75rem 1.5rem;
            }

            .hot-streak {
                font-size: 0.9rem;
                padding: 0.4rem 0.8rem;
            }

            .recent-wins {
                font-size: 0.9rem;
            }
        }

        /* PRIORITY FIX: Additional Mobile Optimizations CSS */
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        button,
        input[type="button"],
        .clickable {
            cursor: pointer;
            min-height: 44px; /* iOS minimum touch target size */
            min-width: 44px;
        }

        /* Prevent text selection on interactive elements */
        .no-select {
            -webkit-user-select: none;
            user-select: none;
        }

        /* PRIORITY FIX: iOS specific fixes CSS */
        /* Fix for iOS height issues */
        .full-height {
            height: -webkit-fill-available;
            height: 100vh;
        }

        /* Fix for iOS momentum scrolling */
        .scroll-container {
            -webkit-overflow-scrolling: touch;
        }

        /* Styles for the new consolidated user modal */
        .user-modal-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1rem;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-light);
            font-weight: 700;
            cursor: pointer;
            position: relative;
             /* FIX: Add hover/active styles to tab buttons */
             transition: all 0.2s ease;
        }

        .tab-btn:hover {
             color: rgba(255, 255, 255, 0.8);
        }

         .tab-btn:active {
             transform: scale(0.98);
         }


        .tab-btn.active {
            color: var(--accent-green);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--accent-green);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .wallet-actions {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .wallet-balance-display {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
        }

        .wallet-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .wallet-action-btn {
            flex: 1;
            padding: 1rem;
            border-radius: var(--radius-md);
            border: none;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
             /* FIX: Add hover/active styles to wallet action buttons */
             transition: all 0.2s ease;
        }

        .wallet-action-btn.deposit {
            background: var(--accent-green);
            color: var(--bg-dark);
        }

        .wallet-action-btn.deposit:hover {
             background-color: #33ffb3;
             box-shadow: var(--shadow-glow) var(--accent-green);
        }

         .wallet-action-btn:active {
             transform: scale(0.95);
         }


        .wallet-action-btn.withdraw {
            background: var(--accent-pink);
            color: white;
        }

        .wallet-action-btn.withdraw:hover {
             background-color: #ff6699;
             box-shadow: var(--shadow-glow) var(--accent-pink);
        }


        #user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
        }

        #user-menu .wallet-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
        }

        #user-menu .profile-avatar {
            font-size: 24px;
            color: var(--accent-green);
        }


    </style>
</head>
<body>
    <header>
        <div class="header-left">
            <button id="connect-wallet-btn" class="chip-btn"><i class="fas fa-wallet"></i> Connect Wallet</button>

            <div id="user-menu" style="display: none;">
                <div class="wallet-info" id="wallet-info">
                    <i class="fas fa-wallet"></i>
                    <span id="wallet-balance">0.00 SOL</span>
                </div>
                <div class="profile-avatar" id="profile-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
            </div>

            </div>

        <div class="header-right">
            <div class="jackpot-counter" id="jackpot-counter">Jackpot: 50.00 SOL!</div>
            <button id="provably-fair-btn" class="chip-btn"><i class="fas fa-balance-scale"></i> Fair</button>
            <button id="high-scores-btn" class="chip-btn"><i class="fas fa-trophy"></i> Scores</button>
        </div>

        <div class="hot-streak" id="hot-streak">
            ðŸ”¥ Hot Streak! 5 Wins
        </div>
    </header>

    <div class="game-container">
        <div class="dice-area">
            <div class="dice" id="die1">1</div>
            <div class="dice" id="die2">1</div>
        </div>

        <div class="result-display" id="result"></div>

        <div class="controls">
            <div class="slider-container">
                <div class="slider-labels">
                    <span>Roll Under:</span>
                    <span id="roll-under-value">7</span>
                </div>
                <input type="range" id="roll-under-slider" min="3" max="11" value="7" step="1">
            </div>

            <div class="multiplier-display" id="multiplier">
                Payout: 6x
            </div>

            <div class="bet-controls">
                <button class="chip-btn" data-value="0.01">0.01</button>
                <button class="chip-btn" data-value="0.1">0.1</button>
                <button class="chip-btn active" data-value="1">1</button>
                <button class="chip-btn" data-value="5">5</button>
                <button class="chip-btn" data-value="MAX">MAX</button>
            </div>

            <button class="roll-btn" id="roll-button">ROLL</button>
        </div>

        <div class="engagement-hooks">
            <div class="live-bets-ticker" id="live-bets-ticker">
                <span>ðŸ”¥ LIVE BETS: User123 bet 5 SOL â€¢ User456 bet 2.5 SOL</span>
            </div>
            <div class="streak-booster" id="streak-booster">
                <div class="booster-meter"></div>
                <span>NEXT BONUS AT 3 WINS!</span>
            </div>
        </div>

         <div class="monetization-tactics">
            <div class="time-limited-offer" id="flash-offer">
                <span>â³ 2X BONUS NEXT 5 MINUTES!</span>
                <button class="fomo-buy">ACTIVATE 2X</button>
            </div>
            <div class="sunk-cost-tracker" id="sunk-cost-tracker">
                </div>
         </div>

        <div class="daily-challenge-panel" id="daily-challenge-panel">
            <h4>Daily Challenge</h4>
            <p id="challenge-text">Roll under 5 three times</p>
            <div class="progress" id="challenge-progress">Progress: 0/3</div>
            <button id="claim-reward-btn" style="display: none;">Claim Reward (Mock)</button>
        </div>

         <div class="referral-feature" id="referral-feature" style="display: none;">
             <h4>Invite Friends</h4>
             <p>Earn 0.05 SOL for each friend who joins!</p>
             <div class="referral-code" id="referral-code">YOURCODE123</div>
             <button id="copy-referral-btn">Copy Code</button>
         </div>

         <div class="fairness-verification">
             <button id="verify-roll">Verify Fairness</button>
             <div id="verification-result"></div>
         </div>


    </div>

    <div class="recent-wins">
        <span>Player1 won 2.5 SOL! â€¢ Player2 won 1.8 SOL! â€¢ Player3 won 5.2 SOL!</span>
    </div>

    <canvas id="confetti-canvas"></canvas>

     <div id="wallet-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Connect Wallet</h2>
            <div class="wallet-options">
                <button id="connect-phantom" class="wallet-connect-button" data-wallet="phantom"><img src="https://phantom.app/img/phantom-icon-purple.png" alt="Phantom Icon"> Phantom</button>
                <button id="connect-solflare" class="wallet-connect-button" data-wallet="solflare"><img src="https://solflare.com/favicon.ico" alt="Solflare Icon"> Solflare</button>
                <button id="disconnect-wallet" style="display: none;">Disconnect</button>
            </div>
        </div>
    </div>

    <div id="user-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>My Account</h2>

            <div class="user-modal-tabs">
                <button class="tab-btn active" data-tab="profile">Profile</button>
                <button class="tab-btn" data-tab="wallet">Wallet</button>
            </div>

            <div class="tab-content active" id="profile-tab">
                <div class="profile-options">
                    <label for="username-input">Username:</label>
                    <input type="text" id="username-input" placeholder="Enter your username">

                    <label for="avatar-select">Choose Avatar:</label>
                    <select id="avatar-select">
                        <option value="ðŸ˜Ž">ðŸ˜Ž</option>
                        <option value="ðŸ¥³">ðŸ¥³</option>
                        <option value="ðŸ¤©">ðŸ¤©</option>
                        <option value="ðŸš€">ðŸš€</option>
                        <option value="ðŸ’Ž">ðŸ’Ž</option>
                    </select>

                    <button id="save-profile-btn">Save Profile</button>
                    <button id="reset-demo-balance-btn" class="chip-btn">Reset Demo Balance</button>
                </div>
            </div>

            <div class="tab-content" id="wallet-tab">
                <div class="wallet-actions">
                    <div class="wallet-balance-display">
                        <h3>Your Balance: <span id="modal-balance">0.00</span> SOL</h3>
                    </div>

                    <div class="wallet-buttons">
                        <button id="modal-deposit-btn" class="wallet-action-btn deposit">
                            <i class="fas fa-plus-circle"></i> Deposit
                        </button>
                        <button id="modal-withdraw-btn" class="wallet-action-btn withdraw">
                            <i class="fas fa-minus-circle"></i> Withdraw
                        </button>
                    </div>
                     <div class="transaction-input-group">
                        <label for="modal-deposit-amount" style="display: none;">Deposit Amount (SOL):</label>
                        <input type="number" id="modal-deposit-amount" value="1" min="0.01" step="0.01" placeholder="Deposit Amount (SOL)" style="margin-bottom: 0.5rem;">
                        <label for="modal-withdraw-amount" style="display: none;">Withdraw Amount (SOL):</label>
                        <input type="number" id="modal-withdraw-amount" value="0.1" min="0.01" step="0.01" placeholder="Withdraw Amount (SOL)">
                     </div>
                </div>
            </div>
        </div>
    </div>


    <div class="leaderboard-sidebar" id="leaderboard-sidebar">
        <h3>Leaderboard ðŸ”¥</h3>
        <ul class="leaderboard-list" id="leaderboard-list">
            <div class="winner-banner" id="winner-banner">
                 ðŸ† Winner of the Day: <span id="daily-winner"></span>
            </div>
            </ul>
    </div>

    <button id="toggle-chat">
        <i class="fas fa-comment-dots" id="chat-bubble-icon"></i>
    </button>

    <div class="chat-container" id="chat-container">
         <div class="chat-header" id="chat-header">
            Chat
            <span class="close-chat-btn">&times;</span>
        </div>
        <div class="chat-body" id="chat-body">
            </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Type a message...">
            <button id="send-chat-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <div id="achievements-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>Achievements</h3>
            <ul id="achievement-list">
                </ul>
        </div>
    </div>

    <div id="high-scores-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>Biggest Wins (Demo)</h3>
            <ul id="high-scores-list">
                </ul>
        </div>
    </div>


    <div id="spin-wheel-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>Daily Spin</h3>
            <canvas id="spin-wheel"></canvas>
            <button id="spin-button">Spin!</button>
        </div>
    </div>

    <div id="deposit-bonus-modal" class="modal">
         <div class="modal-content">
             <span class="close-button">&times;</span>
             <h3>First Deposit Bonus!</h3>
             <p>Deposit now and get 10% bonus SOL!</p>
             <button id="activate-deposit-bonus">Deposit Now</button>
         </div>
    </div>

     <div id="notification-prompt" class="modal">
         <div class="modal-content">
             <span class="close-button">&times;</span>
             <h3>Enable Notifications</h3>
             <p>Get daily rewards and updates!</p>
             <button id="enable-notifications-btn">Enable</button>
         </div>
     </div>

    <div id="provably-fair-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>Provably Fair (Mock)</h3>
            <p>Server Seed: <span id="server-seed"></span></p>
            <p>Client Seed: <span id="client-seed"></span></p>
            <p>Combined Hash: <span id="combined-hash"></span></p>
            <p>Next Server Seed Hash: <span id="next-server-seed-hash"></span></p>
             <button id="reveal-seed-btn">Reveal Previous Seed</button>
             <div id="previous-seed-info" style="display: none; margin-top: 1rem; text-align: left;">
                 <p>Previous Server Seed: <span id="previous-server-seed"></span></p>
                 <p>Previous Client Seed: <span id="previous-client-seed"></span></p>
             </div>
        </div>
    </div>

     <div class="retention-popup" id="retention-popup">
         <p id="retention-message"></p>
         <button id="retention-action-btn"></button>
     </div>

    <script>
        // --- Variable Declarations (Moved to Top) ---
        let dailyPayouts = 0;
        let currentServerSeed = "initialServerSeed" + Date.now();
        let currentClientSeed = Math.random().toString(36).substr(2, 9);
        let previousServerSeed = '';
        let previousClientSeed = '';

        // DOM elements (Declared after variables)
        const die1 = document.getElementById('die1');
        const die2 = document.getElementById('die2');
        const resultDisplay = document.getElementById('result');
        const rollUnderSlider = document.getElementById('roll-under-slider');
        const rollUnderValue = document.getElementById('roll-under-value');
        const multiplierDisplay = document.getElementById('multiplier');
        const rollButton = document.getElementById('roll-button');
        const chipButtons = document.querySelectorAll('.bet-controls .chip-btn'); // Select only chip buttons in bet controls
        const hotStreakDisplay = document.getElementById('hot-streak'); // Get hot streak element
        const sunkCostTracker = document.getElementById('sunk-cost-tracker'); // Get sunk cost tracker element
        const demoModeIndicator = document.querySelector('.demo-mode-indicator'); // Get demo mode indicator
        const leaderboardSidebar = document.getElementById('leaderboard-sidebar'); // Declared here

        // Game state
        const state = {
            rollUnder: 7,
            chipValue: 1,
            diceValues: [1, 1],
            rollResult: null,
            streak: 0, // Initialize streak to 0
            payouts: {
                3: 35,
                4: 17,
                5: 11,
                6: 8,
                7: 6,
                8: 5,
                9: 4,
                10: 3,
                11: 2.5
            },
            lossStreak: 0 // Track loss streak for recovery mechanics
        };

        // Sound Effects - Moved declarations to the top of the script block
        const rollSound = new Audio('data:audio/wav;base64,UklGRl9v...');
        const winSound = new Audio('data:audio/wav;base64,UklGRl9v...');
        const lossSound = new Audio('data:audio/wav;base64,UklGRl9v...');
        const jackpotSound = new Audio('data:audio/wav;base64,UklGRl9v...');
        const tickSound = new Audio('data:audio/wav;base64,UklGRl9v...');


        // Initialize
        updateMultiplier();
        updateHotStreakDisplay(); // Initialize hot streak display
        updateSunkCostTracker(); // Initial update of sunk cost tracker
        updateBackgroundIntensity(); // Initial background intensity based on default chip value
        // Initial seed generation on load (Moved here)
        generateNextSeeds();


        // Event listeners
        rollUnderSlider.addEventListener('input', function() {
            state.rollUnder = parseInt(this.value);
            rollUnderValue.textContent = state.rollUnder;
            updateMultiplier();
             // Trigger multiplier flash animation
             multiplierDisplay.classList.add('flashing');
             setTimeout(() => {
                 multiplierDisplay.classList.remove('flashing');
             }, 300);
        });

        // FIX: Add event listeners to specific buttons
        document.getElementById('save-profile-btn').addEventListener('click', saveProfile);
        // Deposit and Withdraw button listeners are now on the modal buttons
        // document.getElementById('confirm-deposit-btn').addEventListener('click', processDeposit);
        // document.getElementById('confirm-withdraw-btn').addEventListener('click', processWithdraw);
        document.getElementById('reset-demo-balance-btn').addEventListener('click', resetDemoBalance); // Add event listener for reset button


        // FIX: Refine chip button event listeners
        chipButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                chipButtons.forEach(chipBtn => chipBtn.classList.remove('active'));
                this.classList.add('active');

                if (this.dataset.value === 'MAX') {
                    state.chipValue = mockWallet.balance > 0 ? mockWallet.balance : 1; // Use mock balance for MAX
                } else {
                    state.chipValue = parseFloat(this.dataset.value);
                }
                 updateBackgroundIntensity(); // Update background intensity when chip value changes
            });
        });

        rollButton.addEventListener('click', rollDice);

        // Game functions
        function rollDice() {
             // Check for low balance before rolling
             if (mockWallet.balance < state.chipValue) {
                 showToast("Low balance! Deposit more to keep rolling! ðŸ’°", true, () => {
                     // Open the user modal to the wallet tab
                     userModal.style.display = 'flex';
                     document.querySelectorAll('.user-modal-tabs .tab-btn').forEach(btn => {
                         btn.classList.remove('active');
                         if (btn.dataset.tab === 'wallet') btn.classList.add('active');
                     });
                      document.querySelectorAll('.modal .tab-content').forEach(c => {
                          c.classList.remove('active');
                          if (c.id === 'wallet-tab') c.classList.add('active');
                      });
                     document.getElementById('modal-balance').textContent = mockWallet.balance.toFixed(2); // Update balance in modal

                 }, "Deposit Now");
                 return; // Stop the roll if balance is too low
             }

            // Deduct bet from mock balance
            mockWallet.balance -= state.chipValue;
            updateWalletUI(); // Update wallet display

            // Play tick sound during roll animation (simplified mock)
            let tickCount = 0;
            const tickInterval = setInterval(() => {
                playTickSound();
                tickCount++;
                if (tickCount >= 10) clearInterval(tickInterval); // Stop after a few ticks
            }, 50);


            // Disable button during roll
            rollButton.disabled = true;

            // Animate dice
            animateDice();

            // Play roll sound
            playRollSound(); // Added sound effect

            // After animation, show result
            setTimeout(() => {
                let sum;
                let outcome;
                try { // Wrap core roll logic in try...catch
                    // --- Rigged Outcome Calculation ---
                    outcome = advancedRigAlgorithm(); // Use the advanced rigging logic

                    // --- Start: User provided WIN case logic ---
                    if (outcome === 'WIN') {
                        // Force a win with valid dice values
                        sum = Math.floor(Math.random() * (state.rollUnder - 2)) + 2;

                        // Ensure sum is within valid dice range (2-12)
                        sum = Math.max(2, Math.min(12, sum));

                        // Generate valid die1 and die2 that sum to 'sum'
                        let die1Value = Math.floor(Math.random() * (Math.min(6, sum - 1))) + 1;
                        let die2Value = sum - die1Value;

                        // Ensure die2 is within 1-6, adjust die1 if needed
                        if (die2Value < 1) {
                            die2Value = 1;
                            die1Value = sum - die2Value;
                        } else if (die2Value > 6) {
                            die2Value = 6;
                            die1Value = sum - die2Value;
                        }

                        // Final clamp to ensure valid values
                        die1Value = Math.max(1, Math.min(6, die1Value));
                        die2Value = Math.max(1, Math.min(6, die2Value));

                        // Update sum in case adjustments were made
                        sum = die1Value + die2Value;
                        state.diceValues = [die1Value, die2Value];
                    }
                    // --- End: User provided WIN case logic ---
                    else {
                         // Force a loss
                         sum = Math.floor(Math.random() * (12 - state.rollUnder + 1)) + state.rollUnder; // Ensure sum is >= rollUnder

                         // Ensure sum is within valid dice range (2-12)
                         sum = Math.max(2, Math.min(12, sum));

                          // Ensure dice values are between 1 and 6 and sum correctly
                         let die1Value = Math.max(1, Math.min(6, Math.floor(sum / 2)));
                         let die2Value = Math.max(1, Math.min(6, sum - die1Value));
                          // Adjust if sum is too low or too high to be represented by two dice
                          if (die1Value + die2Value !== sum) {
                              if (sum < 2) { die1Value = 1; die2Value = 1; sum = 2; }
                              else if (sum > 12) { die1Value = 6; die2Value = 6; sum = 12; }
                              else { // Try to adjust one die
                                  if (die1Value + die2Value < sum) die1Value += (sum - (die1Value + die2Value));
                                  else if (die1Value + die2Value > sum) die1Value -= ((die1Value + die2Value) - sum);
                                  // Ensure values are still within 1-6
                                  die1Value = Math.max(1, Math.min(6, die1Value));
                                  die2Value = sum - die1Value;
                                  die2Value = Math.max(1, Math.min(6, die2Value)); // Ensure die2 is also valid
                              }
                          }
                         state.diceValues = [die1Value, die2Value];
                    }
                     state.rollResult = outcome; // Use the rigged outcome


                    // Update UI with roll outcome
                    die1.textContent = state.diceValues[0];
                    die2.textContent = state.diceValues[1];
                     // Apply visual variety to dice
                     die1.classList.remove('win', 'loss');
                     die2.classList.remove('win', 'loss');
                     die1.classList.add(state.rollResult === 'WIN' ? 'win' : 'loss');
                     die2.classList.add(state.rollResult === 'WIN' ? 'win' : 'loss');

                    // FIX: Ensure UI result matches console logs and fallback gracefully
                    // resultDisplay.textContent = `Roll: ${state.diceValues[0]} + ${state.diceValues[1]} = ${sum} - ${state.rollResult}`; // Original problematic line
                    // Restored winning logic as requested by the user, adapted to use 'sum' and 'state.rollResult'
                    resultDisplay.textContent = `ðŸŽ² Roll: ${sum} â€” ${state.rollResult}`;
                    resultDisplay.className = 'result-display ' + (state.rollResult === 'WIN' ? 'win' : 'loss');

                    // Add analytics log (mock)
                    logUserAction('roll', { rollUnder: state.rollUnder, bet: state.chipValue, result: state.rollResult, dice: state.diceValues, sum: sum });


                    // Show effects
                    if (state.rollResult === 'WIN') {
                        const payout = state.chipValue * state.payouts[state.rollUnder];
                        mockWallet.balance += payout; // Add winnings to mock balance
                        updateWalletUI(); // Update wallet display
                        dailyPayouts += payout; // Update mock budget

                        showWinEffect();
                        updateStreak(true);
                        playWinSound(); // Play win sound

                         // Check for Big Win
                         if (state.payouts[state.rollUnder] > 5) { // Big Win threshold
                             triggerCoinShower(); // Use confetti for coin shower
                             playJackpotSound(); // Play jackpot sound
                             showBigWinFireworks(); // Show fireworks animation
                             showBigWinText(payout); // Show big win text animation
                             saveBiggestWin(payout); // Save the big win
                         } else {
                             triggerConfetti(); // Regular confetti for smaller wins
                         }

                        updateLeaderboardWins(); // Update leaderboard wins (mock)
                        checkDailyChallenge(); // Check daily challenge progress
                         addChatWinNotification(); // Add chat notification for win (mock)
                         updateSunkCostTracker(); // Update sunk cost tracker
                         checkLuckyRoll(); // Check for lucky roll bonus
                         checkStreakReward(); // Check for streak reward after win
                         rewardSchedule.check(); // Check variable reward schedule

                    } else {
                        updateStreak(false);
                        playLossSound(); // Play loss sound
                         updateSunkCostTracker(); // Update sunk cost tracker
                         checkLuckyRoll(); // Check for lucky roll bonus
                         // checkLossAversionNudge(); // Check for loss aversion nudge (after any roll) - Moved to after win/loss update
                    }

                    // Check personalized nudges after every roll
                     personalizedNudges();
                     checkLossAversionNudge(); // Check for loss aversion nudge after win/loss update


                     // Update provably fair display (mock)
                     updateProvablyFairDisplay();
                     generateNextSeeds(); // Generate seeds for the *next* roll

                } catch (error) {
                    // Log more detailed error information
                    console.error("Error during rollDice execution:", error.message, error.stack, error);
                    // FIX: Ensure UI displays error gracefully
                    resultDisplay.textContent = "Error during roll.";
                    resultDisplay.className = 'result-display loss';
                    showToast("An error occurred during the roll.", false);
                } finally {
                    // Re-enable button regardless of success or failure
                    rollButton.disabled = false;
                }

            }, 1000); // Reduced timeout for faster feedback
        }

        function animateDice() {
            die1.style.animation = 'none';
            die2.style.animation = 'none';

            // Trigger reflow
            void die1.offsetWidth;
            void die2.offsetWidth;

            die1.style.animation = 'shake 0.5s infinite';
            die2.style.animation = 'shake 0.5s infinite';
        }

        function showWinEffect() {
            // Create win overlay
            const overlay = document.createElement('div');
            overlay.className = 'win-overlay';
            overlay.textContent = `+${(state.chipValue * state.payouts[state.rollUnder]).toFixed(2)} SOL!`;
            document.body.appendChild(overlay);

            // Remove overlay after animation
            setTimeout(() => {
                overlay.remove();
            }, 1000);
        }

        function showBigWinText(amount) {
             const bigWinTextElement = document.createElement('div');
             bigWinTextElement.className = 'big-win-text';
             bigWinTextElement.textContent = `BIG WIN! +${amount.toFixed(2)} SOL!`;
             document.body.appendChild(bigWinTextElement);
             setTimeout(() => {
                 bigWinTextElement.remove();
             }, 2000); // Match animation duration
         }


        function updateStreak(isWin) {
            if (isWin) {
                state.streak++;
                state.lossStreak = 0; // Reset loss streak on win

                // Show streak popup every 3 wins
                if (state.streak >= 3 && state.streak % 3 === 0) {
                    showStreakPopup();
                }
            } else {
                state.streak = 0; // Reset win streak on loss
                state.lossStreak++; // Increment loss streak
            }
            updateHotStreakDisplay();
            updateStreakBooster();
        }

        function showStreakPopup() {
            const popup = document.createElement('div');
            popup.className = 'streak-popup';
            popup.textContent = `ðŸ”¥ Streak x${state.streak}!`;
            document.body.appendChild(popup);

            setTimeout(() => {
                popup.remove();
            }, 1500);
        }

        function updateMultiplier() {
            const multiplier = state.payouts[state.rollUnder];
            multiplierDisplay.textContent = `Payout: ${multiplier}x`;
        }

        // Confetti function (existing)
        function triggerConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const particles = [];
            const colors = ['#FF3366', '#00FF99', '#FFFFFF', '#FFD700'];

            // Create particles
            for (let i = 0; i < 100; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - canvas.height,
                    size: Math.random() * 10 + 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    speedY: Math.random() * 3 + 2,
                    speedX: Math.random() * 4 - 2,
                    rotation: Math.random() * 360,
                    rotationSpeed: Math.random() * 10 - 5
                });
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                let stillAlive = false;

                particles.forEach(p => {
                    p.x += p.speedX;
                    p.y += p.speedY;
                    p.rotation += p.rotationSpeed;

                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rotation * Math.PI / 180);
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
                    ctx.restore();

                    if (p.y < canvas.height) {
                        stillAlive = true;
                    }
                });

                if (stillAlive) {
                    requestAnimationFrame(animate);
                }
            }

            animate();
        }

        // Update hot streak display
        function updateHotStreakDisplay() {
             if (state.streak > 0) {
                hotStreakDisplay.style.display = 'block';
                hotStreakDisplay.textContent = `ðŸ”¥ Hot Streak! ${state.streak} Wins`;
             } else {
                hotStreakDisplay.style.display = 'none';
             }
        }


        // --- New Script for Added Features ---

        // --- Modals ---
        const walletModal = document.getElementById('wallet-modal');
        // const profileModal = document.getElementById('profile-modal'); // Removed, consolidated
        // const depositModal = document.getElementById('deposit-modal'); // Removed, consolidated
        // const withdrawModal = document.getElementById('withdraw-modal'); // Removed, consolidated
        const userModal = document.getElementById('user-modal'); // New consolidated modal
        const achievementsModal = document.getElementById('achievements-modal');
        const highScoresModal = document.getElementById('high-scores-modal'); // Get high scores modal
        const spinWheelModal = document.getElementById('spin-wheel-modal');
        const depositBonusModal = document.getElementById('deposit-bonus-modal');
        const notificationPromptModal = document.getElementById('notification-prompt');
        const provablyFairModal = document.getElementById('provably-fair-modal');


        const connectWalletBtn = document.getElementById('connect-wallet-btn');
        const profileAvatar = document.getElementById('profile-avatar');
        // Deposit and Withdraw buttons in header removed - now accessed via user menu/modal
        // const depositBtn = document.getElementById('deposit-btn');
        // const withdrawBtn = document.getElementById('withdraw-btn');
        const referralBtn = document.getElementById('referral-btn'); // Get referral button - Removed from header, keep for now if needed elsewhere
        const provablyFairBtn = document.getElementById('provably-fair-btn'); // Get provably fair button
        const highScoresBtn = document.getElementById('high-scores-btn'); // Get high scores button

        // Get the new modal buttons
        const modalDepositBtn = document.getElementById('modal-deposit-btn');
        const modalWithdrawBtn = document.getElementById('modal-withdraw-btn');


        const closeButtons = document.querySelectorAll('.modal .close-button');

        // Open Modals
        connectWalletBtn.addEventListener('click', () => { walletModal.style.display = 'flex'; });
        // Profile avatar click handler updated to open the new user modal
        profileAvatar.addEventListener('click', () => {
            // Update balance display in modal regardless of connection status
            document.getElementById('modal-balance').textContent = mockWallet.balance.toFixed(2);
            userModal.style.display = 'flex';
        });
        // Deposit and Withdraw buttons now open the user modal to the correct tab
        modalDepositBtn.addEventListener('click', processDeposit);
        modalWithdrawBtn.addEventListener('click', processWithdraw);

        // Referral button is now gone from header, keep listener if needed elsewhere
        // referralBtn.addEventListener('click', () => {
        //      // Toggle referral panel visibility instead of a modal for simplicity
        //      const referralPanel = document.getElementById('referral-feature');
        //      referralPanel.style.display = referralPanel.style.display === 'none' ? 'block' : 'none';
        // });
         provablyFairBtn.addEventListener('click', () => {
             provablyFairModal.style.display = 'flex';
             updateProvablyFairDisplay(); // Update display when modal opens
         });
         highScoresBtn.addEventListener('click', () => { // Add event listener for high scores button
             renderHighScores(); // Render high scores before opening
             highScoresModal.style.display = 'flex';
         });


        // Close Modals
        closeButtons.forEach(button => {
            button.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });

        window.addEventListener('click', (event) => {
            if (event.target === walletModal) { walletModal.style.display = 'none'; }
            // if (event.target === profileModal) { profileModal.style.display = 'none'; } // Removed
            // if (event.target === depositModal) { depositModal.style.display = 'none'; } // Removed
            // if (event.target === withdrawModal) { withdrawModal.style.display = 'none'; } // Removed
            if (event.target === userModal) { userModal.style.display = 'none'; } // Close new user modal
            if (event.target === achievementsModal) { achievementsModal.style.display = 'none'; }
            if (event.target === highScoresModal) { highScoresModal.style.display = 'none'; } // Add close for high scores modal
            if (event.target === spinWheelModal) { spinWheelModal.style.display = 'none'; }
            if (event.target === depositBonusModal) { depositBonusModal.style.display = 'none'; }
            if (event.target === notificationPromptModal) { notificationPromptModal.style.display = 'none'; }
            if (event.target === provablyFairModal) { provablyFairModal.style.display = 'none'; }
        });


        // --- Wallet Connection (Mock) ---
        // walletInfo element is now inside the user-menu div
        const walletInfoSpan = document.getElementById('wallet-balance'); // Get the span for balance
        const connectPhantomBtn = document.getElementById('connect-phantom');
        const connectSolflareBtn = document.getElementById('connect-solflare');
        const disconnectWalletBtn = document.getElementById('disconnect-wallet'); // Still exists in wallet modal
         const activateDepositBonusBtn = document.getElementById('activate-deposit-bonus'); // Get deposit bonus button

        const mockWallet = {
            isConnected: false,
            address: null,
            balance: parseFloat(localStorage.getItem('demoBalance') || '10.00') // Load demo balance from localStorage
        };

        function updateWalletUI() {
            if (mockWallet.isConnected) {
                // Update balance in the header user menu
                walletInfoSpan.textContent = `${mockWallet.balance.toFixed(2)} SOL`;
                // Update wallet address display (if needed, currently not shown in new header)
                // walletInfo.innerHTML = `<i class="fas fa-wallet"></i> Wallet: ${mockWallet.address.substring(0, 6)}...${mockWallet.address.slice(-4)} (${mockWallet.balance.toFixed(2)} SOL)`;

                // Show user menu and hide connect button
                document.getElementById('user-menu').style.display = 'flex';
                connectWalletBtn.style.display = 'none';

                disconnectWalletBtn.style.display = 'block'; // Disconnect button is in the wallet modal
                 profileAvatar.style.display = 'flex'; // Show profile avatar when connected
                 // Show deposit bonus on first connection (mock)
                 if (!localStorage.getItem('firstDepositBonusShown')) {
                     depositBonusModal.style.display = 'flex';
                     localStorage.setItem('firstDepositBonusShown', 'true');
                 }
            } else {
                // Display demo mode balance when not connected
                 // walletInfo.innerHTML = `<i class="fas fa-wallet"></i> Balance: ${mockWallet.balance.toFixed(2)} SOL <span class="demo-mode-indicator">(Demo Mode)</span>`; // Removed, now handled by user-menu/wallet-info
                 walletInfoSpan.textContent = `${mockWallet.balance.toFixed(2)} SOL`; // Update balance in the user menu (even if not connected)
                 document.getElementById('user-menu').style.display = 'flex'; // Always show user menu in demo mode
                 connectWalletBtn.style.display = 'none'; // Hide connect button in demo mode

                disconnectWalletBtn.style.display = 'none';
                 profileAvatar.style.display = 'flex'; // Show profile avatar even in demo mode
            }
             // Save demo balance to localStorage
             localStorage.setItem('demoBalance', mockWallet.balance.toFixed(2));
        }

        // FIX: Wallet Connection Modal Fix - Deep Linking and Loading State
        function handleWalletConnection() {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

            // Deep linking base URLs
            const phantomDeepLink = 'https://phantom.app/ul/browse/';
            const solflareDeepLink = 'https://solflare.com/ul/v1/browse/';

            const openWalletModal = async (walletType) => {
                 const button = document.getElementById(`connect-${walletType}`);
                 if (!button) return;

                 // Add loading state
                 button.classList.add('loading');
                 button.disabled = true; // Disable button while loading

                 try {
                     if (isMobile) {
                         const deepLink = walletType === 'phantom' ? phantomDeepLink : solflareDeepLink;
                         // Encode the current page URL to return after connection
                         const currentURL = encodeURIComponent(window.location.href);
                         // In a real app, you would construct the deep link with connection parameters
                         // For this mock, we'll just redirect to the wallet's browser with the current URL
                         window.location.href = `${deepLink}${currentURL}`;

                         // Note: Actual session persistence in the in-app browser depends on the wallet app.
                         // The code here ensures the user is directed back to the app.
                         // The app would then need to detect the wallet connection upon returning.
                         // For this mock, we simulate connection after a short delay.
                         await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate connection delay
                         simulateWalletConnection(walletType); // Simulate successful connection
                         walletModal.style.display = 'none'; // Close modal on successful mock connection

                     } else {
                         // Simulate wallet connection on desktop
                         await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate connection delay
                         simulateWalletConnection(walletType); // Simulate successful connection
                         walletModal.style.display = 'none'; // Close modal on successful mock connection
                     }
                 } catch (error) {
                     console.error(`Error connecting to ${walletType}:`, error);
                     showToast(`Failed to connect to ${walletType}. Please try again.`, false);
                 } finally {
                     // Remove loading state
                     button.classList.remove('loading');
                     button.disabled = false;
                 }
            };

            // Simulate a successful wallet connection (for mock purposes)
            function simulateWalletConnection(walletType) {
                mockWallet.isConnected = true;
                mockWallet.address = walletType === 'phantom' ? 'G4t1mE5b8...' : 'S0lF1aR3...'; // Mock address
                updateWalletUI();
                document.getElementById('user-menu').style.display = 'flex';
                connectWalletBtn.style.display = 'none';
                // Show deposit bonus on first connection (mock)
                if (!localStorage.getItem('firstDepositBonusShown')) {
                    depositBonusModal.style.display = 'flex';
                    localStorage.setItem('firstDepositBonusShown', 'true');
                }
                 showToast(`Connected to ${walletType} (Mock)!`, false);
            }


            // Add click handlers to wallet buttons with the 'wallet-connect-button' class
            document.querySelectorAll('.wallet-connect-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const walletType = e.currentTarget.dataset.wallet; // Use currentTarget to get the button itself
                    openWalletModal(walletType);
                });
            });
        }

        // Initialize wallet connection handlers on page load
        document.addEventListener('DOMContentLoaded', handleWalletConnection);


        // connectPhantomBtn.addEventListener('click', async () => { /* ... existing logic ... */ }); // This is now handled by handleWalletConnection
        // connectSolflareBtn.addEventListener('click', async () => { /* ... existing logic ... */ }); // This is now handled by handleWalletConnection


        disconnectWalletBtn.addEventListener('click', () => {
            // Simulate disconnecting
            mockWallet.isConnected = false;
            mockWallet.address = null;
            updateWalletUI();
            walletModal.style.display = 'none';
             // Show connect button and hide user menu after disconnecting
             connectWalletBtn.style.display = 'block';
             document.getElementById('user-menu').style.display = 'none';
             showToast("Wallet disconnected (Mock).", false);
        });

         activateDepositBonusBtn.addEventListener('click', () => {
             depositBonusModal.style.display = 'none';
             // Open user modal to wallet tab
             userModal.style.display = 'flex';
             document.querySelectorAll('.user-modal-tabs .tab-btn').forEach(btn => {
                 btn.classList.remove('active');
                 if (btn.dataset.tab === 'wallet') btn.classList.add('active');
             });
              document.querySelectorAll('.modal .tab-content').forEach(c => {
                  c.classList.remove('active');
                  if (c.id === 'wallet-tab') c.classList.add('active');
              });
             document.getElementById('modal-balance').textContent = mockWallet.balance.toFixed(2); // Update balance in modal
         });

        // Reset Demo Balance Function
        function resetDemoBalance() {
             mockWallet.balance = 10.00; // Reset to initial demo balance
             localStorage.setItem('demoBalance', mockWallet.balance.toFixed(2)); // Save reset balance
             updateWalletUI(); // Update display
             userModal.style.display = 'none'; // Close modal
             showToast("Demo balance reset to 10.00 SOL!", false);
        }


        // Initial wallet UI update
        updateWalletUI();


        // --- Leaderboard (Mock) ---
        const leaderboardList = document.getElementById('leaderboard-list');
         const winnerBanner = document.getElementById('winner-banner'); // Get winner banner element
         const dailyWinnerSpan = document.getElementById('daily-winner'); // Get daily winner span

        let mockLeaderboardData = [
            { id: 1, username: 'CryptoKing', avatar: 'ðŸ˜Ž', wins: 150 },
            { id: 2, username: 'SOL_Roller', avatar: 'ðŸ¥³', wins: 120 },
            { id: 3, username: 'DegenMaster', avatar: 'ðŸ¤©', wins: 95 },
            { id: 4, username: 'LuckyCharm', avatar: 'ðŸ€', wins: 88 },
            { id: 5, username: 'BlockchainPro', avatar: 'ðŸ’Ž', wins: 76 },
            { id: 6, username: 'NFT_Gamer', avatar: 'ðŸŽ®', wins: 65 },
            { id: 7, username: 'YieldFarmer', avatar: 'ðŸ§‘â€ðŸŒ¾', wins: 50 },
            { id: 8, username: 'TokenTrader', avatar: 'ðŸ“ˆ', wins: 45 },
            { id: 9, username: 'Web3_Novice', avatar: 'ðŸ£', wins: 30 },
            { id: 10, username: 'HODLer', avatar: 'ðŸ§˜', wins: 25 },
        ];

        function renderLeaderboard() {
            leaderboardList.innerHTML = ''; // Clear current list
            mockLeaderboardData.sort((a, b) => b.wins - a.wins); // Sort by wins

             // Update Winner of the Day banner (mock)
             if (mockLeaderboardData.length > 0) {
                 const topPlayer = mockLeaderboardData[0];
                 dailyWinnerSpan.innerHTML = `<span class="avatar">${topPlayer.avatar}</span> ${topPlayer.username} (${topPlayer.wins} Wins)`;
                 winnerBanner.style.display = 'block';
             } else {
                 winnerBanner.style.display = 'none';
             }


            mockLeaderboardData.slice(0, 10).forEach(player => {
                const listItem = document.createElement('li');
                listItem.className = 'leaderboard-item fade-in'; // Add fade-in class
                 let playerName = player.username;
                 // Add Top Chatter badge (mock)
                 if (player.id === 'top_chatter') { // Mock top chatter
                     playerName += ' <span class="chat-badge">ðŸ’¬ Top Chatter</span>';
                 }
                 // Add VIP badge (mock)
                 if (player.id === 'vip_user') { // Mock VIP user
                      playerName += ' <span class="vip-badge">ðŸ‘‘ VIP</span>';
                 }


                listItem.innerHTML = `
                    <div class="player-info">
                        <span class="avatar">${player.avatar}</span>
                        <span class="username">${playerName}</span>
                    </div>
                    <span class="wins">${player.wins} Wins</span>
                `;
                leaderboardList.appendChild(listItem);
            });
        }

        // Mock function to update wins for the connected user (if connected)
        function updateLeaderboardWins() {
            // Update wins for the current user in demo mode
             let currentUser = mockLeaderboardData.find(player => player.id === 'current_user');
             if (!currentUser) {
                 const username = localStorage.getItem('username') || 'You';
                 const avatar = localStorage.getItem('avatar') || 'ðŸ‘¤';
                 currentUser = { id: 'current_user', username: username, avatar: avatar, wins: 0 }; // Use current username/avatar
                 mockLeaderboardData.push(currentUser);
             } else {
                  // Update existing user data
                  currentUser.username = localStorage.getItem('username') || 'You'; // Update with current profile username
                  currentUser.avatar = localStorage.getItem('avatar') || 'ðŸ‘¤'; // Update with current profile avatar
             }
             currentUser.wins++;
             renderLeaderboard(); // Re-render leaderboard
        }

        // Initial render of the leaderboard
        renderLeaderboard();

        // VISUAL ENHANCEMENT: Live Leaderboard Animations
        function animateLeaderboard() {
            setInterval(() => {
                // Randomly change positions to simulate active play
                mockLeaderboardData = mockLeaderboardData.map(player => {
                    // Only update wins for existing players, don't add random wins to 'current_user' mock
                    if (player.id !== 'current_user' && player.id !== 'vip_user' && player.id !== 'top_chatter') {
                         return {
                             ...player,
                             wins: player.wins + Math.floor(Math.random() * 3) // Simulate random wins
                         };
                    }
                    return player; // Return current user or special mock users unchanged
                }).sort((a,b) => b.wins - a.wins);

                renderLeaderboard();
            }, 30000); // Update every 30 seconds
        }
        animateLeaderboard(); // Start leaderboard animation


        // --- Chat System (Mock) ---
        const chatContainer = document.getElementById('chat-container');
        const chatHeader = document.getElementById('chat-header');
        const chatBody = document.getElementById('chat-body');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const chatBubbleIcon = document.getElementById('chat-bubble-icon'); // Get the bubble icon
        const closeChatBtn = document.querySelector('.chat-header .close-chat-btn'); // Get the new close button
        const toggleChatBtn = document.getElementById('toggle-chat'); // Get the new toggle button

        let mockChatMessages = [
            { username: 'System', text: 'Welcome to DegenDice Chat!', type: 'system' },
            { username: 'CryptoKing', text: 'Just hit a x35!', type: 'user' },
            { username: 'LuckyCharm', text: 'Nice one!', type: 'user' },
        ];

        // Simulate new messages arriving - Moved definition before setInterval
        function simulateNewChatMessage() {
             const simulatedMessages = [
                 { username: 'SOL_Roller', text: 'Anyone on a hot streak?', type: 'user' },
                 { username: 'DegenMaster', text: 'Just started, feeling lucky!', type: 'user' },
                 { username: 'System', text: 'A new player joined!', type: 'system' },
                  { username: 'Bot', text: 'Wow, CryptoKing just won 10 SOL! ðŸ”¥', type: 'system' } // Mock win notification
             ];
             const randomMsg = simulatedMessages[Math.floor(Math.random() * simulatedMessages.length)];
             mockChatMessages.push(randomMsg);
             renderChatMessages();
        }


        function renderChatMessages() {
            chatBody.innerHTML = ''; // Clear current messages
            mockChatMessages.forEach(msg => {
                const msgElement = document.createElement('div');
                msgElement.className = 'chat-message';
                if (msg.type === 'system') {
                    msgElement.style.fontStyle = 'italic';
                    msgElement.style.opacity = 0.7;
                    msgElement.textContent = msg.text;
                } else {
                     let messageContent = `<span class="username">${msg.username}:</span> ${msg.text}`;
                     // Add Cheer button to user messages (mock)
                     if (msg.type === 'user') {
                         messageContent += ` <span class="cheer-button">ðŸŽ‰ Cheer</span>`;
                     }
                     msgElement.innerHTML = messageContent;
                }
                chatBody.appendChild(msgElement);
            });
            // Auto-scroll to bottom
            chatBody.scrollTop = chatBody.scrollHeight;

             // Add event listeners to Cheer buttons (mock)
             chatBody.querySelectorAll('.cheer-button').forEach(button => {
                 button.addEventListener('click', () => {
                     alert('You cheered!'); // Mock cheer action
                 });
             });
        }

        function sendChatMessage() {
            // Check if wallet is connected before sending message
            if (!mockWallet.isConnected) {
                showToast("Connect wallet to chat!", true, () => walletModal.style.display = 'flex', "Connect Wallet");
                return;
            }

            const text = chatInput.value.trim();
            if (text) {
                 const username = localStorage.getItem('username') || 'Anonymous';
                mockChatMessages.push({ username: username, text: text, type: 'user' });
                chatInput.value = ''; // Clear input
                renderChatMessages();
                 // Simulate receiving a response or another message
                 setTimeout(simulateNewChatMessage, 1000);
                 logUserAction('chat_message', { message: text, username: username }); // Log chat message
            }
        }

        sendChatBtn.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        });

        // Simulate new messages every few seconds
        setInterval(simulateNewChatMessage, 5000); // Simulate a new message every 5 seconds

         // Simulate random chat events
         setInterval(simulateRandomChatEvent, 900000); // Every 15 minutes

         function simulateRandomChatEvent() {
             const events = [
                 { text: 'Bot: Flash Giveaway! First to roll wins 0.1 SOL!', type: 'system' },
                 { text: 'Bot: Double XP for the next 10 minutes!', type: 'system' }
             ];
             const randomEvent = events[Math.floor(Math.random() * events.length)];
             mockChatMessages.push(randomEvent);
             renderChatMessages();
         }

        // Add chat notification for win (mock)
        function addChatWinNotification() {
            const username = localStorage.getItem('username') || 'Anonymous';
            const winAmount = (state.chipValue * state.payouts[state.rollUnder]).toFixed(2);
            mockChatMessages.push({ username: 'System', text: `${username} just won ${winAmount} SOL! ðŸŽ‰`, type: 'system' });
            renderChatMessages();
        }


        // Initial render of chat messages
        renderChatMessages();

        // PRIORITY FIX: Chat Bubble Fix JavaScript
        // Add event listener to the new toggle button
        document.getElementById('toggle-chat').addEventListener('click', function() {
            const chatContainer = document.querySelector('.chat-container');
            // Toggle the 'active' class
            chatContainer.classList.toggle('active');

            // Add slide-up animation based on the 'active' class
            if(chatContainer.classList.contains('active')) {
                chatContainer.style.transform = 'translateY(0)';
            } else {
                chatContainer.style.transform = 'translateY(100%)';
            }
        });

        // Add event listener to the close button inside the chat header
        document.querySelector('.chat-header .close-chat-btn').addEventListener('click', function() {
             const chatContainer = document.querySelector('.chat-container');
             // Remove the 'active' class to close the chat
             chatContainer.classList.remove('active');
             // Trigger the slide-down animation
             chatContainer.style.transform = 'translateY(100%)';
        });


        // --- Profile System ---
        const usernameInput = document.getElementById('username-input');
        const avatarSelect = document.getElementById('avatar-select');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const profileAvatarIcon = document.querySelector('#profile-avatar i'); // Get the icon element

        function loadProfile() {
            const savedUsername = localStorage.getItem('username');
            const savedAvatar = localStorage.getItem('avatar');

            if (savedUsername) {
                usernameInput.value = savedUsername;
            }
            if (savedAvatar) {
                avatarSelect.value = savedAvatar;
                profileAvatarIcon.textContent = savedAvatar; // Update header icon
            } else {
                 profileAvatarIcon.className = ''; // Remove font awesome class
                 profileAvatarIcon.textContent = 'ðŸ‘¤'; // Default emoji
            }
             // Update leaderboard with current profile info on load
             updateLeaderboardWins(); // This function also updates user info in mock data
        }

        // FIX: Implement saveProfile function
        function saveProfile() {
            const username = usernameInput.value.trim();
            const avatar = avatarSelect.value;

            if (username) {
                localStorage.setItem('username', username);
            } else {
                 localStorage.removeItem('username');
            }
            localStorage.setItem('avatar', avatar);

            loadProfile(); // Update UI after saving
            userModal.style.display = 'none'; // Close the new user modal
             // Update leaderboard with new username/avatar if connected
             // This logic is now handled within updateLeaderboardWins which is called by loadProfile
        }


        // Load profile on page load
        loadProfile();


        // --- Deposit & Withdraw (Mock) ---
        // Inputs are now in the user modal
        // Need to get the inputs from the new user modal structure
        const modalDepositAmountInput = document.getElementById('modal-deposit-amount'); // Corrected ID
        const modalWithdrawAmountInput = document.getElementById('modal-withdraw-amount'); // Corrected ID


        // FIX: Implement processDeposit function
        function processDeposit() {
            const amount = parseFloat(modalDepositAmountInput.value); // Use the input from the new modal
            if (amount > 0) {
                // Simulate MoonPay flow (replace with actual integration)
                alert(`Simulating deposit of ${amount.toFixed(2)} SOL via MoonPay... (This is a mock)`);
                 mockWallet.balance += amount; // Update mock balance
                 updateWalletUI(); // Update wallet display
                 userModal.style.display = 'none'; // Close the new user modal
                 logUserAction('deposit', { amount: amount }); // Log deposit
                 checkVIPStatus(); // Check for VIP status after deposit
                 // PSYCHOLOGICAL HOOK: Increase win probability temporarily after deposit (Mock)
                 localStorage.setItem('recentDeposit', 'true');
                 setTimeout(() => {
                     localStorage.removeItem('recentDeposit'); // Reset after a duration (e.g., 1 hour in real app)
                 }, 60000); // Mock duration: 1 minute
            } else {
                alert('Please enter a valid deposit amount.');
            }
        }

        // FIX: Implement processWithdraw function
        function processWithdraw() {
            const amount = parseFloat(modalWithdrawAmountInput.value); // Use the input from the new modal
            if (amount > 0 && amount <= mockWallet.balance) {
                // Simulate withdrawal transaction
                alert(`Simulating withdrawal of ${amount.toFixed(2)} SOL... (This is a mock)`);
                 mockWallet.balance -= amount; // Update mock balance
                 updateWalletUI(); // Update wallet display
                 userModal.style.display = 'none'; // Close the new user modal
                 logUserAction('withdraw', { amount: amount }); // Log withdrawal
            } else if (amount > mockWallet.balance) {
                alert('Insufficient balance for withdrawal.');
            } else {
                 alert('Please enter a valid withdrawal amount.');
            }
        }

        // Add event listeners for the new modal buttons
        document.getElementById('modal-deposit-btn').addEventListener('click', processDeposit);
        document.getElementById('modal-withdraw-btn').addEventListener('click', processWithdraw);


        // --- Engagement Boosters ---

        // Sound Effects
        // Using Base64 encoded dummy sounds as placeholders
        // Declarations moved to the top of the script block


        function playRollSound() {
             if (rollSound.readyState >= 2) { // Check if sound is loaded
                rollSound.currentTime = 0; // Rewind to start
                rollSound.play().catch(e => console.error("Error playing roll sound:", e)); // Added catch
             } else {
                 console.warn("Roll sound not ready to play.");
             }
        }

        function playWinSound() {
             if (winSound.readyState >= 2) {
                winSound.currentTime = 0;
                winSound.play().catch(e => console.error("Error playing win sound:", e)); // Added catch
             } else {
                 console.warn("Win sound not ready to play.");
             }
        }

        function playLossSound() {
             if (lossSound.readyState >= 2) {
                lossSound.currentTime = 0;
                lossSound.play().catch(e => console.error("Error playing loss sound:", e)); // Added catch
             } else {
                 console.warn("Loss sound not ready to play.");
             }
        }

         function playJackpotSound() {
             if (jackpotSound.readyState >= 2) {
                jackpotSound.currentTime = 0;
                jackpotSound.play().catch(e => console.error("Error playing jackpot sound:", e)); // Added catch
             } else {
                 console.warn("Jackpot sound not ready to play.");
             }
         }

         function playTickSound() {
             if (tickSound.readyState >= 2) {
                tickSound.currentTime = 0;
                tickSound.play().catch(e => console.error("Error playing tick sound:", e)); // Added catch
             } else {
                 console.warn("Tick sound not ready to play.");
             }
        }


        // Coin Shower Animation (using existing triggerConfetti function)
        function triggerCoinShower() {
            // The existing triggerConfetti function serves as a coin shower effect
            triggerConfetti();
        }

         // Big Win Fireworks Animation (Mock)
         function showBigWinFireworks() {
             const fireworks = document.createElement('div');
             fireworks.className = 'big-win-fireworks';
             document.body.appendChild(fireworks);
             setTimeout(() => {
                 fireworks.remove();
             }, 1000); // Match animation duration
         }


        // Glowing Hover Effect on Roll Button (Implemented in CSS)

        // Daily Challenge
        const dailyChallengePanel = document.getElementById('daily-challenge-panel');
        const challengeText = document.getElementById('challenge-text');
        const challengeProgress = document.getElementById('challenge-progress');
        const claimRewardBtn = document.getElementById('claim-reward-btn');

        const dailyChallenge = {
            description: "Roll under 5 three times",
            targetValue: 5,
            targetCount: 3,
            currentProgress: 0,
            rewardAmount: 0.1, // Mock reward
            isCompleted: false
        };

        function loadDailyChallengeProgress() {
            const savedProgress = localStorage.getItem('dailyChallengeProgress');
            if (savedProgress !== null) {
                dailyChallenge.currentProgress = parseInt(savedProgress);
            }
            const savedCompletion = localStorage.getItem('dailyChallengeCompleted');
            if (savedCompletion === 'true') {
                dailyChallenge.isCompleted = true;
            }
             updateDailyChallengeUI();
             // PSYCHOLOGICAL HOOK: Endowed Progress Effect
             fakeProgress(); // Give initial progress on load
        }

        function updateDailyChallengeUI() {
            challengeText.textContent = dailyChallenge.description;
            challengeProgress.textContent = `Progress: ${dailyChallenge.currentProgress}/${dailyChallenge.targetCount}`;

            if (dailyChallenge.isCompleted) {
                challengeProgress.textContent = "Completed!";
                claimRewardBtn.style.display = 'none'; // Hide claim button after claiming
            } else if (dailyChallenge.currentProgress >= dailyChallenge.targetCount) {
                 claimRewardBtn.style.display = 'block';
            } else {
                 claimRewardBtn.style.display = 'none';
            }
        }

        function checkDailyChallenge() {
            if (!dailyChallenge.isCompleted && state.rollResult === 'WIN' && (state.diceValues[0] + state.diceValues[1]) < dailyChallenge.targetValue) {
                dailyChallenge.currentProgress++;
                localStorage.setItem('dailyChallengeProgress', dailyChallenge.currentProgress);
                updateDailyChallengeUI();
                if (dailyChallenge.currentProgress >= dailyChallenge.targetCount) {
                     // Challenge completed!
                     dailyChallenge.isCompleted = true;
                     localStorage.setItem('dailyChallengeCompleted', 'true');
                     updateDailyChallengeUI();
                     alert('Daily Challenge Completed! Claim your reward.'); // Notify user
                }
            }
        }

        claimRewardBtn.addEventListener('click', () => {
            if (dailyChallenge.isCompleted && !localStorage.getItem('dailyChallengeClaimed')) {
                // Simulate claiming reward
                 alert(`Claiming mock reward of ${dailyChallenge.rewardAmount} SOL!`);
                 mockWallet.balance += dailyChallenge.rewardAmount; // Add mock bonus
                 updateWalletUI();
                 localStorage.setItem('dailyChallengeClaimed', 'true'); // Mark as claimed
                 claimRewardBtn.style.display = 'none'; // Hide button
            } else {
                 alert('Reward already claimed or challenge not completed.');
            }
        });

        // PSYCHOLOGICAL HOOK: Endowed Progress Effect
        function fakeProgress() {
          if (dailyChallenge.currentProgress === 0 && !localStorage.getItem('fakeProgressApplied')) {
            dailyChallenge.currentProgress = 1;
            localStorage.setItem('dailyChallengeProgress', dailyChallenge.currentProgress);
            localStorage.setItem('fakeProgressApplied', 'true'); // Add this line
            showToast("We started your Daily Challenge for you! Just 2 more!", false);
            updateDailyChallengeUI();
          }
        }


        // Load daily challenge progress on page load
        loadDailyChallengeProgress();


        // Referral Feature
        const referralCodeElement = document.getElementById('referral-code');
        const copyReferralBtn = document.getElementById('copy-referral-btn');

        function generateReferralCode() {
             // Simple mock code generation
             const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
             let code = '';
             for (let i = 0; i < 7; i++) {
                 code += characters.charAt(Math.floor(Math.random() * characters.length));
             }
             return code;
        }

        // Generate and display a mock referral code
        referralCodeElement.textContent = generateReferralCode();

        copyReferralBtn.addEventListener('click', () => {
             const code = referralCodeElement.textContent;
             navigator.clipboard.writeText(code).then(() => {
                 alert('Referral code copied to clipboard!');
             }).catch(err => {
                 console.error('Failed to copy referral code: ', err);
                 alert('Could not copy referral code.');
             });
        });


        // --- UI/UX Enhancements ---

        /*
        // Dynamic Backgrounds (Mock) - Removed video, using CSS gradient animation
        const backgroundVideo = document.getElementById('background-video');
        const videoSources = [
             'https://www.w3schools.com/tags/mov_bbb.mp4', // Example video 1
             'https://file-examples-com.github.io/uploads/2017/04/file_example_MP4_480_1_5MG.mp4' // Example video 2
        ];
        let currentVideoIndex = 0;

        function changeBackgroundVideo() {
             currentVideoIndex = (currentVideoIndex + 1) % videoSources.length;
             backgroundVideo.src = videoSources[currentVideoIndex];
             backgroundVideo.load(); // Load the new video
             backgroundVideo.play().catch(e => console.error("Error playing background video:", e));
        }

        // Change video every 5 minutes (Mock)
        setInterval(changeBackgroundVideo, 300000);
        */


        // Micro-interactions (Button hover/active effects implemented in CSS)

        // Safe Area Insets (Implemented in CSS padding)

        // Mobile Chat Toggle (Implemented in CSS and JS event listeners)

        // Adjust leaderboard and chat visibility on window resize
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                // Ensure leaderboard and chat are visible on desktop if window is resized
                document.body.classList.remove('leaderboard-open'); // Assume leaderboard is always visible on desktop
                // document.body.classList.remove('chat-open'); // Removed - chat state is now managed by .active class on container
                leaderboardSidebar.style.transform = 'translateX(0)';

                // Reset chat to desktop state
                chatContainer.classList.remove('active'); // Ensure chat is not in active state on desktop
                chatContainer.style.transform = 'translateY(0)'; // Reset transform for desktop positioning

                chatContainer.style.position = 'fixed';
                chatContainer.style.width = 'var(--chat-width)';
                chatContainer.style.height = 'var(--chat-height)';
                chatContainer.style.bottom = 'calc(1rem + constant(safe-area-inset-bottom))';
                chatContainer.style.bottom = 'calc(1rem + env(safe-area-inset-bottom))';
                chatContainer.style.right = '1rem';
                chatContainer.style.top = 'auto';
                chatContainer.style.left = 'auto';
                chatContainer.style.borderRadius = 'var(--radius-md)';
                chatContainer.style.background = 'rgba(20, 20, 20, 0.9)';
                 chatContainer.style.boxShadow = 'var(--shadow-glow) rgba(255, 255, 255, 0.1)';
                 chatContainer.style.cursor = 'default';

                 // Show desktop chat elements
                 chatBubbleIcon.style.display = 'none'; // Hide bubble icon on desktop
                 chatHeader.style.display = 'flex'; // Show chat header on desktop
                 chatBody.style.display = 'flex'; // Show chat body on desktop
                 chatInput.parentElement.style.display = 'flex'; // Show chat input area on desktop
                 toggleChatBtn.style.display = 'none'; // Hide the dedicated toggle button on desktop
             } else {
                // On mobile, ensure leaderboard is hidden and chat is positioned correctly as a bubble
                 leaderboardSidebar.style.transform = 'translateX(100%)'; // Hide leaderboard
                 // Set chat to mobile bubble state if not active
                 if (!chatContainer.classList.contains('active')) {
                     chatContainer.style.position = 'fixed';
                     // Width, height, bottom, left, border-radius, background, box-shadow are handled by CSS media query
                     chatContainer.style.right = '1rem'; // Keep right position for the bubble
                     chatContainer.style.top = 'auto';
                     chatContainer.style.cursor = 'pointer'; // Make it clickable

                     // Hide desktop chat elements in bubble state
                     chatBubbleIcon.style.display = 'flex'; // Show bubble icon on mobile
                     chatHeader.style.display = 'none'; // Hide chat header in bubble state
                     chatBody.style.display = 'none'; // Hide chat body in bubble state
                     chatInput.parentElement.style.display = 'none'; // Hide chat input area in bubble state
                     toggleChatBtn.style.display = 'flex'; // Show the dedicated toggle button on mobile
                 } else {
                     // If chat is active (full screen) on mobile, ensure correct styles
                     chatContainer.style.position = 'fixed';
                     chatContainer.style.top = '0';
                     chatContainer.style.left = '0';
                     chatContainer.style.width = '100%';
                     chatContainer.style.height = '100%';
                     chatContainer.style.bottom = '0';
                     chatContainer.style.right = '0';
                     chatContainer.style.borderRadius = '0';
                     chatContainer.style.background = 'var(--bg-dark)'; // Solid background for full screen
                     chatContainer.style.boxShadow = 'none'; // Remove bubble shadow
                     chatContainer.style.cursor = 'default';

                     // Show chat content in active state
                     chatBubbleIcon.style.display = 'none'; // Hide bubble icon when active
                     chatHeader.style.display = 'flex';
                     chatBody.style.display = 'flex';
                     chatInput.parentElement.style.display = 'flex';
                     toggleChatBtn.style.display = 'none'; // Hide the dedicated toggle button when chat is open
                 }
            }
        });

        // Initial check for mobile layout on load
        if (window.innerWidth <= 768) {
            leaderboardSidebar.style.transform = 'translateX(100%)'; // Hide leaderboard on mobile

            // Set chat to mobile bubble state on load
            chatContainer.classList.remove('active'); // Start in bubble state
            chatContainer.style.transform = 'translateY(100%)'; // Start off-screen

            chatContainer.style.position = 'fixed';
            // Width, height, bottom, left, border-radius, background, box-shadow are handled by CSS media query
            chatContainer.style.right = '1rem'; // Keep right position for the bubble
            chatContainer.style.top = 'auto';
            chatContainer.style.cursor = 'pointer'; // Make it clickable

            // Hide desktop chat elements in bubble state
            chatBubbleIcon.style.display = 'flex'; // Show bubble icon on mobile
            chatHeader.style.display = 'none'; // Hide chat header in bubble state
            chatBody.style.display = 'none'; // Hide chat body in bubble state
            chatInput.parentElement.style.display = 'none'; // Hide chat input area in bubble state
            toggleChatBtn.style.display = 'flex'; // Show the dedicated toggle button on mobile
        } else {
             leaderboardSidebar.style.transform = 'translateX(0)'; // Ensure leaderboard is visible on desktop

             // Set chat to desktop state on load
            chatContainer.classList.remove('active'); // Ensure chat is not in active state on desktop
            chatContainer.style.transform = 'translateY(0)'; // Reset transform for desktop positioning

            chatContainer.style.position = 'fixed';
            chatContainer.style.width = 'var(--chat-width)';
            chatContainer.style.height = 'var(--chat-height)';
            chatContainer.style.bottom = 'calc(1rem + constant(safe-area-inset-bottom))';
            chatContainer.style.bottom = 'calc(1rem + env(safe-area-inset-bottom))';
            chatContainer.style.right = '1rem';
            chatContainer.style.top = 'auto';
            chatContainer.style.left = 'auto';
            chatContainer.style.borderRadius = 'var(--radius-md)';
            chatContainer.style.background = 'rgba(20, 20, 20, 0.9)';
            chatContainer.style.boxShadow = 'var(--shadow-glow) rgba(255, 255, 255, 0.1)';
            chatContainer.style.cursor = 'default';

            // Show desktop chat elements
            chatBubbleIcon.style.display = 'none'; // Hide bubble icon on desktop
            chatHeader.style.display = 'flex'; // Show chat header on desktop
            chatBody.style.display = 'flex'; // Show chat body on desktop
            chatInput.parentElement.style.display = 'flex'; // Show chat input area on desktop
            toggleChatBtn.style.display = 'none'; // Hide the dedicated toggle button on desktop
        }


        // VISUAL ENHANCEMENT: Dynamic Background Intensity
        // Tie to bet amount
        function updateBackgroundIntensity() {
            if (state.chipValue > 5) {
                document.body.classList.add('high-intensity');
                document.body.classList.remove('low-intensity');
            } else {
                document.body.classList.add('low-intensity');
                document.body.classList.remove('high-intensity');
            }
        }
        // updateBackgroundIntensity() is called initially and when chip value changes


        // --- Psychological Principles & Engagement Hooks Script ---

        // Mock Budget and Rigging
        const DAILY_BUDGET = 1800 * 1.1; // 10% daily growth target (Mock)

        // ENHANCED RIGGING ALGORITHM
        function advancedRigAlgorithm() {
            const userValue = mockWallet.balance; // Using balance as a proxy for user value
            const houseEdge = 0.05; // 5% house edge

            // Dynamic adjustment based on:
            // - Time of day (more wins during peak hours)
            // - User deposit history (recentDeposit flag)
            // - Current losing/winning streak (lossStreak)
            // - Dynamic Difficulty Adjustment (based on balance)

            let rigFactor = 0;
            const currentHour = new Date().getHours();

            // Time of day adjustment (More wins during peak hours 7 PM - 2 AM)
            if (currentHour >= 19 || currentHour <= 2) {
                rigFactor += 0.1; // Increase win probability
            }

            // User deposit history adjustment (Better odds after recent deposit)
            if (localStorage.getItem('recentDeposit') === 'true') {
                rigFactor += 0.15; // Increase win probability
            }

            // PSYCHOLOGICAL HOOK: Loss Recovery Mechanics (Force win after loss streak)
            if (state.lossStreak >= 3) {
                console.log("Mock: Forcing win after loss streak based on Loss Recovery.");
                state.lossStreak = 0; // Reset loss streak after forcing a win
                return 'WIN';
            }

            // PSYCHOLOGICAL HOOK: Dynamic Difficulty Adjustment
            let dynamicWinRate = 0.48; // Base win rate for dynamic adjustment
            // Make easier when balance is low to encourage continued play
            if (mockWallet.balance < 1) {
                dynamicWinRate = 0.52;
                console.log("Mock: Increasing win rate due to low balance (Dynamic Difficulty).");
            }
            // Make harder after big wins to recoup losses (Mock: assuming a "big win" is a payout > 5x bet)
            // This would require tracking previous roll outcomes and payouts
            // For simplicity in this mock, we'll just use the current win rate logic.
            // A more complex implementation would track 'bigWinFlag' based on the previous roll.
            // if (bigWinFlag) { dynamicWinRate = 0.45; console.log("Mock: Decreasing win rate after big win (Dynamic Difficulty)."); }


            const effectiveWinRate = (dynamicWinRate + rigFactor - houseEdge);
            console.log(`Mock: Calculated effective win rate: ${effectiveWinRate.toFixed(2)}`);

            // Simulate rigging the random outcome
            if (Math.random() < effectiveWinRate) {
                 console.log(`Mock: Resulting in a WIN.`);
                 return 'WIN'; // Allow a win based on adjusted rate
            } else {
                console.log(`Mock: Resulting in a LOSE.`);
                 return 'LOSE'; // Force a loss
            }
        }


        // Provably Fair (Mock)
        const serverSeedSpan = document.getElementById('server-seed');
        const clientSeedSpan = document.getElementById('client-seed');
        const combinedHashSpan = document.getElementById('combined-hash');
        const nextServerSeedHashSpan = document.getElementById('next-server-seed-hash');
        const revealSeedBtn = document.getElementById('reveal-seed-btn');
        const previousSeedInfoDiv = document.getElementById('previous-seed-info');
        const previousServerSeedSpan = document.getElementById('previous-server-seed');
        const previousClientSeedSpan = document.getElementById('previous-client-seed');


        function updateProvablyFairDisplay() {
             // Mock hash generation
             const combinedString = currentServerSeed + currentClientSeed;
             const combinedHash = btoa(combinedString); // Simple base64 encoding as mock hash
             const nextServerSeedHash = btoa("next" + currentServerSeed); // Mock hash of next server seed

             serverSeedSpan.textContent = currentServerSeed;
             clientSeedSpan.textContent = currentClientSeed;
             combinedHashSpan.textContent = combinedHash;
             nextServerSeedHashSpan.textContent = nextServerSeedHash;

             previousServerSeedSpan.textContent = previousServerSeed;
             previousClientSeedSpan.textContent = previousClientSeed;
        }

        revealSeedBtn.addEventListener('click', () => {
             previousSeedInfoDiv.style.display = 'block';
        });

        // Update seeds for the next roll (mock)
        function generateNextSeeds() {
             previousServerSeed = currentServerSeed;
             previousClientSeed = currentClientSeed;
             currentServerSeed = "serverSeed" + Date.now() + Math.random().toString(36).substr(2, 5);
             currentClientSeed = Math.random().toString(36).substr(2, 9);
        }
         // Initial seed generation on load
         // generateNextSeeds(); // Called in initialization block


        // Engagement Hooks
        const liveBetsTicker = document.getElementById('live-bets-ticker');
        const streakBoosterMeter = document.querySelector('#streak-booster .booster-meter');

        // PSYCHOLOGICAL HOOK: Social Proof & Urgency (Enhanced live bets ticker)
        function superchargedLiveTicker() {
            const fakeBets = [
                {user: `User${Math.floor(1000+Math.random()*9000)}`, amount: (5+Math.random()*20).toFixed(2), won: (10+Math.random()*50).toFixed(2)},
                {user: `VIP_${Math.floor(100+Math.random()*900)}`, amount: "MAX", won: "JACKPOT"}
            ];

            setInterval(() => {
                const bet = fakeBets[Math.floor(Math.random()*fakeBets.length)];
                // Use innerHTML to render the ðŸ”¥ emoji correctly
                const msg = `<span>ðŸ”¥ ${bet.user} just won ${bet.won} SOL from a ${bet.amount} bet!</span>`;
                liveBetsTicker.innerHTML = msg;
            }, 3000); // Update every 3 seconds
        }
        superchargedLiveTicker(); // Start the enhanced ticker


        // Streak Booster (Mock)
        function updateStreakBooster() {
             const progress = (state.streak % 3) / 3; // Progress towards next 3-win bonus
             streakBoosterMeter.style.width = `${progress * 100}%`;
        }


        // Monetization Tactics
        const flashOffer = document.getElementById('flash-offer');
        // const potentialWinsSpan = document.getElementById('potential-wins'); // Removed
        const sunkCostProgressBar = document.querySelector('.sunk-cost-tracker .progress-bar');
        const fomoBuyButton = document.querySelector('.time-limited-offer .fomo-buy');


        // Flash Sales (Mock)
        function flashSales() {
            setInterval(() => {
              if(Math.random() < 0.2) { // 20% chance every 30 minutes
                flashOffer.style.display = 'flex'; // Use flex for centering content
                // Mock countdown (simple)
                let timeLeft = 300; // 5 minutes in seconds
                const countdownInterval = setInterval(() => {
                     timeLeft--;
                     // Update display if needed (e.g., add a span for countdown)
                     // Example: flashOffer.querySelector('#countdown-span').textContent = formatTime(timeLeft);
                     if (timeLeft <= 0) {
                         clearInterval(countdownInterval);
                         flashOffer.style.display = 'none';
                     }
                }, 1000);

                setTimeout(() => {
                  flashOffer.style.display = 'none';
                }, 300000); // 5 minute urgency
              }
            }, 1800000); // Every 30 minutes
        }
        flashSales(); // Start flash sales simulation

        fomoBuyButton.addEventListener('click', () => {
             alert("Mock: Activating 2X Bonus!"); // Simulate activation
             flashOffer.style.display = 'none'; // Hide offer after activation
        });


        // PSYCHOLOGICAL HOOK: Sunk Cost Visualizations
        function emotionalSunkCost() {
            const totalSpent = parseFloat(localStorage.getItem('totalBetAmount') || '0'); // Use total bet amount as total spent
            // Mock potential wins based on total bet - keeping original logic for now
            const potentialWins = parseFloat(localStorage.getItem('potentialWins') || '0'); // This value isn't currently updated elsewhere, might need adjustment

            sunkCostTracker.innerHTML = `
                <div class="emotional-message">
                    You've invested ${totalSpent.toFixed(2)} SOL - don't stop now!
                </div>
                <div class="progress-container">
                    <div class="progress-bar" style="width: ${(totalSpent/20)*100}%"></div> </div>
                <div class="reward-preview">
                    Next milestone at ${(Math.floor(totalSpent/5)+1)*5} SOL: Exclusive VIP Badge! </div>
            `;
             // Update progress bar width based on total spent
             const progressBar = sunkCostTracker.querySelector('.progress-bar');
             const progress = Math.min(totalSpent / 20, 1) * 100; // Mock progress: 100% at 20 SOL spent
             progressBar.style.width = `${progress}%`;

        }

        // Artificial Scarcity / Sunk Cost (Existing logic, updated to use emotionalSunkCost)
        function updateSunkCostTracker() {
             const totalRolls = parseInt(localStorage.getItem('rollCount') || '0');
             const totalBetAmount = parseFloat(localStorage.getItem('totalBetAmount') || '0');

             // Mock potential wins based on total bet
             // potentialWinsSpan.textContent = `${(totalBetAmount * 0.8).toFixed(2)} SOL`; // Mock 80% return potential - Removed, now in emotionalSunkCost
             // Update progress bar (mock based on rolls) - Removed, now in emotionalSunkCost
             // const maxRollsForProgress = 50; // Mock target rolls
             // const progress = Math.min(totalRolls / maxRollsForProgress, 1);
             // sunkCostProgressBar.style.width = `${progress * 100}%`;

             // Call the emotionalSunkCost function to update the tracker's content and progress bar
             emotionalSunkCost();


             // Sunk Cost Fallacy Nudge
             if (totalRolls > 0 && totalRolls % 10 === 0 && !localStorage.getItem(`sunkCostNudgeShown${totalRolls}`)) {
                  showToast(`You've made ${totalRolls} rollsâ€”don't quit before the win!`, false); // Updated message
                  localStorage.setItem(`sunkCostNudgeShown${totalRolls}`, 'true'); // Show only once per 10 rolls
             }

             // Limited Rolls Scarcity (Mock for free users)
             const isFreeUser = true; // Mock free user status
             const freeRollLimit = 20; // Mock limit
             if (isFreeUser && totalRolls >= freeRollLimit && !localStorage.getItem('scarcityNudgeShown')) {
                  showToast(`Only ${freeRollLimit - totalRolls} rolls left today! Deposit to unlock unlimited rolls!`, true, () => {
                      // Open user modal to wallet tab
                      userModal.style.display = 'flex';
                      document.querySelectorAll('.user-modal-tabs .tab-btn').forEach(btn => {
                         btn.classList.remove('active');
                         if (btn.dataset.tab === 'wallet') btn.classList.add('active');
                     });
                       document.querySelectorAll('.modal .tab-content').forEach(c => {
                           c.classList.remove('active');
                           if (c.id === 'wallet-tab') c.classList.add('active');
                       });
                      document.getElementById('modal-balance').textContent = mockWallet.balance.toFixed(2); // Update balance in modal

                  }, "Deposit");
                 localStorage.setItem('scarcityNudgeShown', 'true');
             }
        }
         // Initial update of sunk cost tracker on load
         // updateSunkCostTracker(); // Called in initialization block


        // Neuro Feedback (Mock visual/audio effects)
        function visualRewards(betSize) {
            // Implement spark/particle effects here if desired
            console.log(`Mock: Triggering visual rewards for bet size ${betSize}`);
        }

        // Audio Conditioning (Implemented in rollDice function)
        // rollSound, winSound, lossSound, jackpotSound, tickSound are defined and used in rollDice


        // Coercive Retention
        const retentionPopup = document.getElementById('retention-popup');
        const retentionMessage = document.getElementById('retention-message');
        const retentionActionButton = document.getElementById('retention-action-btn');
        // const retentionCountdownSpan = document.querySelector('#retention-popup #countdown'); // Countdown span is not in the HTML for retention popup

        function showRetentionPopup(message, buttonText, action, countdownMinutes = 2) {
             retentionMessage.textContent = message;
             retentionActionButton.textContent = buttonText;
             retentionActionButton.onclick = action; // Assign the action function

             retentionPopup.style.display = 'flex'; // Show the popup

             // Mock countdown (Removed countdown display from HTML, just use a timer)
             let timeLeft = countdownMinutes * 60;
             const countdownInterval = setInterval(() => {
                 timeLeft--;
                 // Update display if needed (e.g., add a countdown span in the HTML)
                 // Example: retentionPopup.querySelector('#countdown-span').textContent = formatTime(timeLeft);
                 if (timeLeft <= 0) {
                     clearInterval(countdownInterval);
                     retentionPopup.style.display = 'none'; // Hide popup when countdown ends
                 }
             }, 1000);
        }

        // Session Recovery (Mock)
        // This would typically involve tracking user activity pauses.
        // For this mock, we'll tie it to a loss streak.
        // let lossStreakForRecovery = 0; // Moved lossStreak to state object
        // Event listener for 'loss' is added in the rollDice function after determining result
        // Check for Loss Aversion Nudge (Moved to rollDice function)
        function checkLossAversionNudge() {
             // This is checked after every roll in rollDice
             // Trigger nudge if it was a loss AND loss streak is 1 (first loss)
             if (state.rollResult === 'LOSE' && state.lossStreak === 1 && !localStorage.getItem('lossAversionNudgeShown')) {
                 showToast("Don't stop now! Double your next bet to win it back! ðŸ’ª", true, () => {
                     // Simulate doubling the bet (capped by balance)
                     state.chipValue = Math.min(state.chipValue * 2, mockWallet.balance > 0 ? mockWallet.balance : state.chipValue);
                     // Update active chip button visually (find the closest value)
                     let closestButton = chipButtons[0];
                     let minDiff = Math.abs(state.chipValue - parseFloat(closestButton.dataset.value));

                     chipButtons.forEach(button => {
                          const value = parseFloat(button.dataset.value);
                          const diff = Math.abs(state.chipValue - value);
                          if (diff < minDiff) {
                              minDiff = diff;
                              closestButton = button;
                          }
                     });
                      chipButtons.forEach(btn => btn.classList.remove('active'));
                      if (closestButton) closestButton.classList.add('active');

                     // The toast/popup will hide automatically if it has a button
                     // retentionPopup.style.display = 'none'; // This was for the retention popup, not toast
                 }, "Double Bet");
                 localStorage.setItem('lossAversionNudgeShown', 'true'); // Mark as shown once per session/condition
                 // Reset this flag based on session or time if needed
             }
        }
        // checkLossAversionNudge is called in rollDice after every roll


        // Fake Balance Protection (Mock)
        function checkLowBalanceNudge() {
            if (mockWallet.balance < 0.5 && !localStorage.getItem('lowBalanceNudgeShown')) {
                 showToast("Low balance! Deposit more to keep rolling! ðŸ’°", true, () => {
                     // Open user modal to wallet tab
                     userModal.style.display = 'flex';
                     document.querySelectorAll('.user-modal-tabs .tab-btn').forEach(btn => {
                         btn.classList.remove('active');
                         if (btn.dataset.tab === 'wallet') btn.classList.add('active');
                     });
                       document.querySelectorAll('.modal .tab-content').forEach(c => {
                           c.classList.remove('active');
                           if (c.id === 'wallet-tab') c.classList.add('active');
                       });
                      document.getElementById('modal-balance').textContent = mockWallet.balance.toFixed(2); // Update balance in modal

                 }, "Deposit Now");
                 localStorage.setItem('lowBalanceNudgeShown', 'true');
            }
        }
        // checkLowBalanceNudge is called in rollDice after every roll

        // FIX: Handle SecurityError on cssRules access
        function checkCSSRulesAccess() {
            try {
                // Accessing cssRules can throw a SecurityError if the stylesheet is from a different origin
                // This loop is just to trigger the potential error, the actual fix is the try/catch
                for (let i = 0; i < document.styleSheets.length; i++) {
                    const sheet = document.styleSheets[i];
                    try {
                        // Attempt to access cssRules - this is where the error can occur
                        const rules = sheet.cssRules;
                        // If successful, you might do something with the rules, e.g., logging
                        // console.log(`Successfully accessed cssRules for stylesheet ${sheet.href || i}`);
                    } catch (e) {
                        // Catch the SecurityError or any other error for this specific stylesheet
                        if (e.name === 'SecurityError') {
                            console.warn(`SecurityError accessing cssRules for stylesheet ${sheet.href || i}. This is expected for cross-origin stylesheets and does not affect functionality.`); // Added more informative message
                        } else {
                            console.error(`Error accessing cssRules for stylesheet ${sheet.href || i}:`, e);
                        }
                    }
                }
            } catch (e) {
                // Catch any errors that occur before iterating through stylesheets, if necessary
                console.error("Error iterating through stylesheets:", e);
            }
        }
        // Call this function on load to check for the error
        window.addEventListener('load', checkCSSRulesAccess);


        // Time Gated Bonuses (Mock Daily Login)
        function checkDailyLoginBonus() {
            const lastLoginDate = localStorage.getItem('lastLoginDate');
            const today = new Date().toDateString();

            if (lastLoginDate !== today) {
                 showRetentionPopup("Daily login bonus: 0.1 SOL!", "Claim Bonus", () => {
                     alert("Mock: Daily login bonus claimed!");
                     mockWallet.balance += 0.1; // Add mock bonus
                     updateWalletUI();
                     retentionPopup.style.display = 'none';
                 });
                 localStorage.setItem('lastLoginDate', today);
            }
        }
        checkDailyLoginBonus(); // Check on page load


        // --- Gamification ---
        const streakTracker = document.getElementById('streak-tracker');
        // const streakDaysSpan = document.getElementById('streak-days'); // streakDaysSpan is not in the HTML
        const achievementsList = document.getElementById('achievement-list');
        const highScoresList = document.getElementById('high-scores-list'); // Get high scores list element
        const spinButton = document.getElementById('spin-button');
        const spinWheelCanvas = document.getElementById('spin-wheel');
        // Check if canvas and context exist before getting context
        const spinWheelCtx = spinWheelCanvas ? spinWheelCanvas.getContext('2d') : null;


        // PSYCHOLOGICAL HOOK: Variable Reward Schedules (Mock)
        const rewardSchedule = {
            nextRewardAt: 3, // Initial wins required for first reward
            increment: function() {
                // Variable interval - sometimes 3 wins, sometimes 5, etc.
                this.nextRewardAt = [3,3,3,5,7][Math.floor(Math.random()*5)];
                console.log(`Mock: Next streak reward at ${this.nextRewardAt} wins.`);
            },
            check: function() {
                if (state.streak >= this.nextRewardAt) {
                    this.reward();
                    this.increment(); // Set the next reward target
                }
            },
            reward: function() {
                const rewards = [
                    {type: "SOL", amount: 0.05},
                    {type: "Free Roll", amount: 1},
                    {type: "2X Multiplier", amount: "next"} // Mock 2X multiplier for next roll
                ];
                const reward = rewards[Math.floor(Math.random()*rewards.length)];
                showToast(`ðŸŽ Streak Reward: ${reward.type} ${reward.amount}!`, false);

                // Implement mock reward logic
                if (reward.type === "SOL") {
                    mockWallet.balance += reward.amount;
                    updateWalletUI();
                } else if (reward.type === "Free Roll") {
                    // Mock free roll logic
                    alert("You got a free roll! (Mock)");
                } else if (reward.type === "2X Multiplier") {
                    // Mock 2X multiplier logic for next roll
                    alert("Mock: Your next win will be 2X!");
                    // You would need to add state to track this and apply it in rollDice
                }
            }
        };
        // rewardSchedule.check() is called in rollDice win block


        // Achievement System (Mock)
        const mockAchievements = [
             { id: 'roll_master', name: 'Roll Master', target: 50, progress: 0, completed: false },
             { id: 'win_streak', name: 'Win Streak Pro', target: 10, progress: 0, completed: false },
             { id: 'big_spender', name: 'Big Spender', target: 100, progress: 0, completed: false }, // Mock total bet target
        ];

        function loadAchievements() {
             const savedAchievements = localStorage.getItem('achievements');
             if (savedAchievements) {
                 try { // Add try...catch for JSON parsing
                    const parsedAchievements = JSON.parse(savedAchievements);
                    // Merge saved progress with current achievements to handle new achievements
                    mockAchievements.forEach(achievement => {
                        const saved = parsedAchievements.find(sa => sa.id === achievement.id);
                        if (saved) {
                            achievement.progress = saved.progress;
                            achievement.completed = saved.completed;
                        }
                    });
                 } catch (e) {
                     console.error("Error parsing achievements from localStorage:", e);
                     // Optionally reset achievements or handle the error differently
                 }
             }
             renderAchievements();
        }

        function renderAchievements() {
             achievementsList.innerHTML = '';
             mockAchievements.forEach(achievement => {
                 const listItem = document.createElement('li');
                 listItem.innerHTML = `
                     ${achievement.name}: <span>${achievement.completed ? 'Completed!' : `${achievement.progress}/${achievement.target}`}</span>
                 `;
                 if (achievement.completed) {
                      listItem.style.color = 'var(--accent-green)'; // Use CSS variable
                 }
                 achievementsList.appendChild(listItem);
             });
        }

        function updateAchievementProgress(id, amount) {
             const achievement = mockAchievements.find(a => a.id === id);
             if (achievement && !achievement.completed) {
                 achievement.progress += amount;
                 if (achievement.progress >= achievement.target) {
                     achievement.progress = achievement.target;
                     achievement.completed = true;
                     showToast(`Achievement Unlocked: ${achievement.name}!`, false); // Notify user
                 }
                 saveAchievements();
                 renderAchievements(); // Update display
             }
        }

        function saveAchievements() {
             localStorage.setItem('achievements', JSON.stringify(mockAchievements));
        }

        // Hook into relevant events to update achievements
        // Custom event listener for 'roll'
        document.addEventListener('roll', (event) => {
             updateAchievementProgress('roll_master', 1);
             // You could also update win streak achievement here based on event.detail.result
             if (event.detail.result === 'WIN') {
                 // Need to track win streak for achievement separately if needed,
                 // as state.streak resets on loss.
                 // For simplicity, let's just track wins for a 'Total Wins' achievement if added.
             }
        });
        // Win streak update is handled in updateStreak function
        document.addEventListener('deposit', (event) => { // Assuming deposit event is fired with amount
             updateAchievementProgress('big_spender', event.detail.amount);
        });

        // Fire custom events from relevant functions
        function logUserAction(action, data = {}) {
             const logs = JSON.parse(localStorage.getItem('userLogs') || '[]');
             logs.push({ timestamp: new Date().toISOString(), action: action, data: data });
             localStorage.setItem('userLogs', JSON.stringify(logs));

             // Update total roll count and bet amount for sunk cost
             if (action === 'roll') {
                 const rollCount = parseInt(localStorage.getItem('rollCount') || '0') + 1;
                 localStorage.setItem('rollCount', rollCount);
                 const totalBetAmount = parseFloat(localStorage.getItem('totalBetAmount') || '0') + state.chipValue;
                 localStorage.setItem('totalBetAmount', totalBetAmount);
                 // Dispatch custom 'roll' event
                 document.dispatchEvent(new CustomEvent('roll', { detail: { result: data.result, bet: state.chipValue } }));
             } else if (action === 'deposit') {
                  const totalDepositAmount = parseFloat(localStorage.getItem('totalDepositAmount') || '0') + data.amount;
                  localStorage.setItem('totalDepositAmount', totalDepositAmount);
                  // Dispatch custom 'deposit' event
                  document.dispatchEvent(new CustomEvent('deposit', { detail: { amount: data.amount } }));
             }
        }

        // A/B Testing Placeholder (Mock)
        function applyABTestVariants() {
             const testVariant = localStorage.getItem('abTestVariant');
             if (!testVariant) {
                 // Assign a variant on first visit
                 const variant = Math.random() < 0.5 ? 'A' : 'B';
                 localStorage.setItem('abTestVariant', variant);
             }

             const currentVariant = localStorage.getItem('abTestVariant');
             if (currentVariant === 'B') {
                 // Apply variant B styles/logic (e.e.g., change roll button color)
                 // Create a new style element for the A/B test rule
                 const styleElement = document.createElement('style');
                 styleElement.type = 'text/css';
                 styleElement.innerHTML = `
                     .roll-btn.variant-green {
                         background-color: var(--accent-green);
                     }
                 `;
                 document.head.appendChild(styleElement);
             }
        }
        applyABTestVariants(); // Apply A/B test variant on load


        // Generic Toast Notification Function
        function showToast(message, includeButton = false, buttonAction = null, buttonText = "") {
             let toast = document.querySelector('.toast-notification');
             // Remove existing toast with a button if a new one with a button is shown
             if (includeButton) {
                 const existingButtonToast = document.querySelector('.toast-notification button');
                 if (existingButtonToast && existingButtonToast.parentElement) {
                     existingButtonToast.parentElement.classList.remove('show');
                     // Small delay before removing to allow fade out
                     setTimeout(() => existingButtonToast.parentElement.remove(), 300);
                 }
             }

             if (!toast || !toast.classList.contains('show') || includeButton) { // Create new if none, or not showing, or needs a button
                 if (toast && toast.classList.contains('show') && includeButton) {
                     // If a non-button toast is showing and we need a button toast, remove the old one
                     toast.classList.remove('show');
                      setTimeout(() => toast.remove(), 300);
                      toast = null; // Ensure a new one is created
                 }
                 if (!toast) {
                     toast = document.createElement('div');
                     toast.className = 'toast-notification';
                     document.body.appendChild(toast);
                 }
             } else {
                 // If a non-button toast is already showing, just update its content
                 toast.innerHTML = ''; // Clear existing content
             }


             const messageSpan = document.createElement('span');
             messageSpan.textContent = message;
             toast.appendChild(messageSpan);


             if (includeButton && buttonAction) {
                 const button = document.createElement('button');
                 button.textContent = buttonText;
                 // Remove previous event listener if updating an existing toast
                 const oldButton = toast.querySelector('button');
                 if (oldButton) {
                     const newButton = button.cloneNode(true); // Clone to remove old listeners
                     oldButton.replaceWith(newButton);
                     newButton.addEventListener('click', buttonAction);
                 } else {
                     toast.appendChild(button);
                     button.addEventListener('click', buttonAction);
                 }
             } else {
                 // If no button is needed, remove any existing button
                 const existingButton = toast.querySelector('button');
                 if (existingButton) {
                     existingButton.remove();
                 }
             }

             toast.classList.add('show');

             // Hide after a few seconds unless it has a button
             if (!includeButton) {
                 setTimeout(() => {
                     toast.classList.remove('show');
                 }, 4000); // Hide after 4 seconds
             }
        }

        // Check for VIP status (Mock)
        function checkVIPStatus() {
            const totalDepositAmount = parseFloat(localStorage.getItem('totalDepositAmount') || '0');
            if (totalDepositAmount >= 10 && !localStorage.getItem('vipStatusGranted')) { // Mock threshold
                 // Find the current user in mock leaderboard data and add VIP badge
                 const currentUser = mockLeaderboardData.find(player => player.id === 'current_user');
                 if (currentUser) {
                     currentUser.id = 'vip_user'; // Change ID to trigger VIP badge in render
                     renderLeaderboard();
                     showToast("Congratulations! You are now a VIP! ðŸ‘‘", false);
                     localStorage.setItem('vipStatusGranted', 'true');
                 }
            }
        }
        checkVIPStatus(); // Check VIP status on load

        // Tab switching in the user modal
        document.querySelectorAll('.user-modal-tabs .tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active class from all tabs and buttons
                document.querySelectorAll('.user-modal-tabs .tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.modal .tab-content').forEach(c => c.classList.remove('active'));

                // Add active class to clicked tab
                btn.classList.add('active');
                const tabId = btn.dataset.tab + '-tab';
                document.getElementById(tabId).classList.add('active');

                // Update balance in wallet tab when switching to it
                if (btn.dataset.tab === 'wallet') {
                    document.getElementById('modal-balance').textContent = mockWallet.balance.toFixed(2);
                }
            });
        });


        // Initial calls for features that need to run on load
        loadAchievements();
        // fakeProgress(); // Called within loadDailyChallengeProgress

        // --- High Scores / Biggest Wins (Mock) ---
        function saveBiggestWin(winAmount) {
            const biggestWins = JSON.parse(localStorage.getItem('biggestWins') || '[]');
            const username = localStorage.getItem('username') || 'Anonymous';
            const newWin = { username: username, amount: winAmount, timestamp: new Date().toISOString() };

            biggestWins.push(newWin);
            // Sort by amount descending and keep top 5
            biggestWins.sort((a, b) => b.amount - a.amount);
            const topWins = biggestWins.slice(0, 5);

            localStorage.setItem('biggestWins', JSON.stringify(topWins));
            renderHighScores(); // Update the display immediately
        }

        function renderHighScores() {
            const highScoresList = document.getElementById('high-scores-list');
            if (!highScoresList) return; // Ensure the element exists

            highScoresList.innerHTML = ''; // Clear current list
            const biggestWins = JSON.parse(localStorage.getItem('biggestWins') || '[]');

            if (biggestWins.length === 0) {
                const listItem = document.createElement('li');
                listItem.textContent = "No big wins yet!";
                highScoresList.appendChild(listItem);
            } else {
                biggestWins.forEach(win => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        ${win.username}: <span>${win.amount.toFixed(2)} SOL</span>
                    `;
                    highScoresList.appendChild(listItem);
                });
            }
        }

        // Call renderHighScores on page load to display existing scores
        renderHighScores();


        // --- Lucky Roll Bonus (Mock) ---
        function checkLuckyRoll() {
            // Mock logic: 5% chance of a lucky roll bonus after any roll
            if (Math.random() < 0.05) {
                const bonusAmount = (Math.random() * 0.1 + 0.01).toFixed(2); // Bonus between 0.01 and 0.11 SOL
                showToast(`ðŸ€ Lucky Roll Bonus! +${bonusAmount} SOL!`, false);
                mockWallet.balance += parseFloat(bonusAmount);
                updateWalletUI();
            }
        }

        // --- Personalized Nudges (Mock) ---
        function personalizedNudges() {
            // Placeholder for personalized nudge logic
            console.log("Mock: Checking for personalized nudges...");
            // Example: Nudge based on recent losses
            if (state.lossStreak > 0 && state.lossStreak % 2 === 0 && !localStorage.getItem(`lossNudge${state.lossStreak}Shown`)) {
                 showToast("Keep going! A win might be just around the corner! âœ¨", false);
                 localStorage.setItem(`lossNudge${state.lossStreak}Shown`, 'true');
            }
            // Example: Nudge based on high balance (encourage higher bets)
            if (mockWallet.balance > 20 && state.chipValue < 5 && !localStorage.getItem('highBalanceNudgeShown')) {
                 showToast("Feeling lucky? Try a higher bet for bigger payouts! ðŸš€", true, () => {
                     state.chipValue = Math.min(5, mockWallet.balance > 0 ? mockWallet.balance : state.chipValue);
                     // Update active chip button visually
                     let closestButton = chipButtons[0];
                     let minDiff = Math.abs(state.chipValue - parseFloat(closestButton.dataset.value));

                     chipButtons.forEach(button => {
                          const value = parseFloat(button.dataset.value);
                          const diff = Math.abs(state.chipValue - value);
                          if (diff < minDiff) {
                              minDiff = diff;
                              closestButton = button;
                          }
                     });
                      chipButtons.forEach(btn => btn.classList.remove('active'));
                      if (closestButton) closestButton.classList.add('active');

                 }, "Increase Bet");
                 localStorage.setItem('highBalanceNudgeShown', 'true');
            }
        }

        // --- Streak Reward (Mock) ---
        function checkStreakReward() {
            // Mock function for checking and applying streak rewards
            console.log("Mock: Checking for streak rewards...");
            // Actual streak reward logic is handled by the rewardSchedule object's check() method
            // This function is just a placeholder to resolve the ReferenceError
        }


    </script>
</body>
</html>
