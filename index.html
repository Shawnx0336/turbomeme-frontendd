<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SolRoulette LIVE - Spin to Win</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* Reset and Base Styles */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(180deg, #0A0A0A, #1A1A1A);
            color: #FFFFFF;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            position: relative; /* Needed for absolute positioning of overlays */
        }
        :root {
            --primary: #9945FF; /* Purple branding */
            --danger: #FF375F; /* Red for losses */
            --success: #14F195; /* Green for wins */
            --accent: #FFD700; /* Gold for highlights */
            --secondary: #1A1A1A; /* Dark panels */
            --text: #FFFFFF;
            --background-gradient: linear-gradient(180deg, #0A0A0A, #1A1A1A);
            --panel-background: rgba(26, 26, 26, 0.8); /* Semi-transparent dark */
            --panel-border-radius: 12px;
            --button-border-radius: 8px;
            --input-border-radius: 8px;
        }
        .container {
            max-width: 100%;
            height: 100%;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1; /* Ensure content is above background effects */
        }

        /* Background Effects */
        .background-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(153, 69, 255, 0.1) 0%, rgba(10, 10, 10, 0) 50%);
            pointer-events: none;
            z-index: 0;
            overflow: hidden; /* Hide particles outside */
        }

        /* Particle FX */
        .particle {
            position: absolute;
            width: 5px;
            height: 5px;
            background-color: var(--accent);
            border-radius: 50%;
            pointer-events: none;
            animation: particle-float 5s infinite ease-out;
            opacity: 0;
        }

        @keyframes particle-float {
            0% { transform: translateY(0) translateX(0) scale(1); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateY(-200px) translateX(50px) scale(0.5); opacity: 0; }
        }

         .background-overlay.intensify-particles .particle {
             animation-duration: 3s; /* Faster float */
             animation-timing-function: cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Different easing */
             opacity: 1; /* Always visible during intensification */
         }


        /* Money Rain Effect */
        .money-rain {
            position: absolute;
            width: 15px;
            height: 15px;
            background-color: var(--success);
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%); /* Simple triangle coin */
            pointer-events: none;
            animation: money-fall 2s ease-in forwards;
            opacity: 0;
        }

        @keyframes money-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* Strobe Effect during spin */
        .strobe-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1); /* Subtle white overlay */
            pointer-events: none;
            z-index: 0;
            opacity: 0;
        }

        .strobe-overlay.active {
            animation: strobe 0.2s infinite alternate;
        }

        @keyframes strobe {
            0% { opacity: 0; }
            100% { opacity: 0.1; }
        }


        /* Animations */
        @keyframes pulse-glow {
            0% { filter: drop-shadow(0 0 4px var(--primary)); }
            100% { filter: drop-shadow(0 0 16px var(--primary)); }
        }
         @keyframes pulse-glow-red {
            0% { filter: drop-shadow(0 0 4px var(--danger)); }
            100% { filter: drop-shadow(0 0 16px var(--danger)); }
        }
        @keyframes enter {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-60px); opacity: 0; }
        }
        /* Spin animation will be controlled by JS for precise landing */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        @keyframes vibrate {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
         @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
         @keyframes timer-pulse-fast {
             0% { transform: translateX(-50%) scale(1); }
             50% { transform: translateX(-50%) scale(1.1); }
             100% { transform: translateX(-50%) scale(1); }
         }
         @keyframes pointer-pulse {
             0% { filter: drop-shadow(0 0 4px var(--accent)); }
             50% { filter: drop-shadow(0 0 20px var(--accent)); }
             100% { filter: drop-shadow(0 0 4px var(--accent)); }
         }
         @keyframes subtle-vibrate {
             0%, 100% { transform: translateX(0); }
             25% { transform: translateX(-1px); }
             75% { transform: translateX(1px); }
         }
         /* Glow effect for onboarding tooltip target */
         @keyframes onboarding-glow {
             0% { box-shadow: 0 0 5px var(--accent); }
             50% { box-shadow: 0 0 20px var(--accent), 0 0 30px var(--accent); }
             100% { box-shadow: 0 0 5px var(--accent); }
         }


        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: var(--panel-background);
            border-radius: var(--panel-border-radius);
            margin: 10px;
            width: calc(100% - 20px); /* Adjust for margin */
            max-width: 800px; /* Limit header width on larger screens */
            backdrop-filter: blur(6px);
            z-index: 10;
        }
         .site-title {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary);
            text-shadow: 0 0 8px rgba(153, 69, 255, 0.5);
        }
        .players-online, .user-profile {
            background: rgba(26, 26, 26, 0.5); /* More transparent */
            padding: 8px 12px;
            border-radius: var(--button-border-radius);
            font-size: 0.9em;
        }
        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer; /* Indicate clickable */
             transition: transform 0.2s;
        }
        .user-profile:hover {
             transform: translateY(-2px);
        }
        .avatar {
            width: 28px; /* Slightly larger */
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            display: grid;
            place-items: center;
            font-size: 0.9em;
            border: 2px solid var(--text);
        }
        .xp-bar {
            width: 70px; /* Slightly wider */
            height: 8px; /* Taller */
            background: #333;
            border-radius: 4px; /* More rounded */
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }
        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #7A37CC); /* Gradient fill */
            transition: width 0.3s ease-in-out;
        }

        /* Global Timer */
        .global-timer {
            position: absolute;
            top: 80px; /* Adjusted position */
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, var(--danger), var(--primary));
            padding: 10px 20px;
            border-radius: var(--button-border-radius);
            font-weight: bold;
            animation: pulse-glow 1.5s ease-in-out infinite alternate;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
         .global-timer.urgent {
             background: linear-gradient(45deg, var(--danger), #FF6B8A); /* Red gradient */
             animation: timer-pulse-fast 0.5s ease-in-out infinite alternate; /* Faster pulse */
         }

         /* Pre-Spin CTA */
         .pre-spin-cta {
             position: absolute;
             top: 120px; /* Position below timer */
             left: 50%;
             transform: translateX(-50%);
             background: var(--panel-background);
             padding: 8px 15px;
             border-radius: var(--button-border-radius);
             font-weight: bold;
             font-size: 1em;
             z-index: 10;
             box-shadow: 0 2px 10px rgba(0,0,0,0.3);
             color: var(--accent);
         }


        /* Roulette Wheel */
        .wheel-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 40px auto 20px auto; /* More space */
            perspective: 1000px;
            animation: enter 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 5; /* Below timer, above background */
        }
         #rouletteCanvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 12px solid #222; /* Thicker border */
            box-shadow: 0 0 64px rgba(153, 69, 255, 0.3), 0 0 32px rgba(255, 215, 0, 0.3); /* Multiple shadows */
            /* No conic gradient here, drawn on canvas */
            /* Metallic texture overlay handled by canvas drawing or filter */
         }

        .pointer {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 40px;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            background: var(--accent);
            filter: drop-shadow(0 0 12px var(--accent));
            z-index: 2;
        }
        .pointer.vibrate {
            animation: vibrate 0.2s infinite;
        }
        .wheel-container.bounce {
            animation: bounce 0.3s;
        }
         .pointer.pulse {
             animation: pointer-pulse 1s infinite alternate;
         }

         /* Recent Spins Display */
         .recent-spins {
             position: absolute;
             bottom: 10px;
             left: 50%;
             transform: translateX(-50%);
             background: var(--panel-background);
             padding: 8px 12px;
             border-radius: var(--button-border-radius);
             font-size: 0.8em;
             z-index: 10;
             box-shadow: 0 2px 10px rgba(0,0,0,0.3);
             display: flex;
             gap: 5px;
             align-items: center;
         }
         .recent-spins .label {
             font-weight: bold;
             color: var(--accent);
         }
         .recent-spins .outcome {
             padding: 3px 6px;
             border-radius: 4px;
             font-weight: bold;
         }
         .recent-spins .outcome.win { background: var(--success); color: #000;}
         .recent-spins .outcome.lose { background: var(--danger); color: #000;}
         .recent-spins .outcome.neutral { background: #555; color: #fff;}


        /* Bet Controls */
        .bet-controls {
            background: var(--panel-background);
            padding: 15px;
            border-radius: var(--panel-border-radius);
            margin: 10px;
            display: flex;
            flex-direction: column;
            gap: 15px; /* Increased gap */
            width: calc(100% - 20px);
            max-width: 600px;
            backdrop-filter: blur(6px);
            z-index: 10;
             position: relative; /* Needed for onboarding tooltip */
        }
         .bet-label {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--accent);
         }
        .multiplier-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); /* Responsive grid */
            gap: 8px;
             /* Onboarding glow */
             transition: box-shadow 0.3s ease-in-out;
        }
         .multiplier-options.onboarding-glow {
             animation: onboarding-glow 1.5s infinite alternate;
         }

        .multiplier-btn {
            background: #333;
            color: var(--text);
            padding: 10px;
            border: none;
            border-radius: var(--button-border-radius);
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
             display: flex; /* Enable flex for label alignment */
             flex-direction: column;
             align-items: center;
             justify-content: center;
             gap: 4px;
        }
        .multiplier-btn:hover:not(:disabled) {
            background: var(--primary);
            transform: scale(1.05);
             box-shadow: 0 4px 10px rgba(153, 69, 255, 0.5);
             animation: subtle-vibrate 0.3s infinite alternate; /* Subtle vibrate on hover */
        }
        .multiplier-btn.active:not(:disabled) {
            background: var(--success);
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(20, 241, 149, 0.5);
        }
        .multiplier-btn:disabled {
            background: #555;
            cursor: not-allowed;
             transform: scale(1);
             box-shadow: none;
             opacity: 0.6; /* Indicate disabled state */
             animation: none; /* No vibrate when disabled */
        }
         .multiplier-btn:disabled[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            white-space: nowrap;
            font-size: 0.8em;
            margin-bottom: 5px;
            z-index: 11; /* Above controls */
         }
         .multiplier-btn small {
             font-size: 0.6em;
             font-weight: normal;
             color: #aaa; /* Subtle gray */
         }


        .bet-amount {
            display: flex;
            flex-direction: column; /* Stack label and input/value */
            gap: 5px;
        }
         .bet-amount-top {
             display: flex;
             align-items: center;
             gap: 10px;
         }
         .bet-amount-label {
            font-weight: bold;
         }
        .bet-slider {
            flex: 1;
            -webkit-appearance: none; /* Override default appearance */
            appearance: none;
            height: 10px; /* Thicker slider */
            background: #333;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
            cursor: pointer;
        }
        .bet-slider:hover:not(:disabled) {
            opacity: 1;
        }
        .bet-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px; /* Thumb size */
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
         .bet-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
             box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
         .bet-slider:disabled {
             opacity: 0.6;
             cursor: not-allowed;
         }
         .bet-slider:disabled[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            white-space: nowrap;
            font-size: 0.8em;
            margin-bottom: 5px;
            z-index: 11; /* Above controls */
         }

        .bet-value {
            font-size: 1.2em; /* Larger value */
            font-weight: bold;
            color: var(--accent);
             min-width: 80px; /* Prevent jumping */
             text-align: right;
        }
         .max-win-text {
             font-size: 0.8em;
             color: #aaa;
             text-align: right;
             margin-top: -10px; /* Pull it closer to the slider */
         }
         .bet-summary {
             font-size: 0.9em;
             color: #ccc;
             margin-top: 10px;
             text-align: center;
         }


        .place-bet, .connect-wallet-btn {
            background: var(--primary);
            color: var(--text);
            padding: 12px;
            border: none;
            border-radius: var(--button-border-radius);
            font-size: 1.1em; /* Larger font */
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s, box-shadow 0.2s;
            width: 100%;
             box-shadow: 0 4px 10px rgba(153, 69, 255, 0.5);
        }
        .place-bet:hover:not(:disabled), .connect-wallet-btn:hover:not(:disabled) {
            background: #7A37CC;
            transform: scale(1.02);
             box-shadow: 0 6px 12px rgba(153, 69, 255, 0.7);
        }
        .place-bet:disabled, .connect-wallet-btn:disabled {
            background: #555;
            cursor: not-allowed;
             transform: scale(1);
             box-shadow: none;
             opacity: 0.6; /* Indicate disabled state */
        }
         .place-bet:disabled[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            white-space: nowrap;
            font-size: 0.8em;
            margin-bottom: 5px;
            z-index: 11; /* Above controls */
         }

         /* Onboarding Tooltip */
         .onboarding-tooltip {
             position: absolute;
             bottom: 100%; /* Position above the target */
             left: 50%;
             transform: translateX(-50%);
             background: var(--accent);
             color: #000;
             padding: 8px 12px;
             border-radius: var(--button-border-radius);
             font-size: 0.9em;
             font-weight: bold;
             white-space: nowrap;
             pointer-events: none; /* Don't block clicks */
             opacity: 0;
             transition: opacity 0.3s ease-in-out;
             margin-bottom: 10px; /* Space between tooltip and target */
             z-index: 11; /* Above controls */
         }
         .onboarding-tooltip.visible {
             opacity: 1;
         }
         .onboarding-tooltip::after {
             content: '';
             position: absolute;
             top: 100%;
             left: 50%;
             transform: translateX(-50%);
             width: 0;
             height: 0;
             border-left: 8px solid transparent;
             border-right: 8px solid transparent;
             border-top: 8px solid var(--accent);
         }


        /* Live Bet Feed */
        .bet-feed {
            position: absolute;
            top: 120px;
            left: 10px;
            background: var(--panel-background);
            padding: 12px;
            border-radius: var(--panel-border-radius);
            max-height: 250px; /* Increased height */
            overflow-y: auto;
            backdrop-filter: blur(6px);
            width: 250px; /* Increased width */
            font-size: 0.85em;
            z-index: 10;
             box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
         .bet-feed-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--accent);
         }
        .bet-entry {
            padding: 8px 0;
            border-bottom: 1px solid #333;
            display: flex;
            gap: 6px;
            animation: enter 0.3s ease-out;
        }
         .bet-entry:last-child {
            border-bottom: none;
         }
         .bet-entry i {
            color: var(--success); /* Coin icon color */
         }
         .bet-entry .user {
            font-weight: bold;
            color: var(--primary);
         }
         .bet-entry .amount {
            color: var(--accent);
         }
         .bet-entry .multiplier {
            font-weight: bold;
         }

        /* Chat Box */
        .chat-box {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: var(--panel-background);
            padding: 12px;
            border-radius: var(--panel-border-radius);
            max-height: 250px; /* Increased height */
            overflow-y: auto;
            backdrop-filter: blur(6px);
            width: 250px; /* Increased width */
            font-size: 0.85em;
            z-index: 10;
             box-shadow: 0 4px 15px rgba(0,0,0,0.5);
             display: flex;
             flex-direction: column;
        }
         .chat-feed {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
         }
         .chat-feed::-webkit-scrollbar {
            width: 6px;
         }
         .chat-feed::-webkit-scrollbar-track {
            background: #333;
            border-radius: 3px;
         }
         .chat-feed::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
         }
        .chat-message {
            padding: 8px 0;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 6px;
            animation: enter 0.3s ease-out;
        }
         .chat-message:last-child {
            border-bottom: none;
         }
         .chat-message .user {
            font-weight: bold;
            color: var(--success); /* User name color */
         }
         .chat-message .system {
            font-style: italic;
            color: #aaa;
         }
        .chat-input {
            display: flex;
            gap: 6px;
            margin-top: auto; /* Push to bottom */
        }
        .chat-input input {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: var(--input-border-radius);
            background: #333;
            color: var(--text);
            font-size: 0.85em;
             outline: none;
        }
        .chat-input button {
            background: var(--primary);
            color: var(--text);
            padding: 8px 12px;
            border: none;
            border-radius: var(--button-border-radius);
            cursor: pointer;
            font-size: 0.85em;
             transition: background 0.2s;
        }
         .chat-input button:hover {
            background: #7A37CC;
         }
        .reaction {
            font-size: 0.8em;
            margin-left: 4px;
            cursor: pointer;
             opacity: 0.8;
             transition: opacity 0.2s;
        }
         .reaction:hover {
            opacity: 1;
         }

        /* Token Rewards */
        .token-notification {
            position: absolute;
            bottom: 270px; /* Adjusted position above chat */
            right: 10px;
            background: var(--panel-background);
            padding: 12px 20px;
            border-radius: var(--panel-border-radius);
            border-left: 6px solid var(--success);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: enter 0.3s ease-out;
            z-index: 10;
             box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
         .token-notification button {
            background: var(--success);
            color: #000;
            padding: 4px 8px;
            border: none;
            border-radius: var(--button-border-radius);
            font-size: 0.8em;
            cursor: pointer;
             transition: background 0.2s;
         }
         .token-notification button:hover {
            background: #10C07D;
         }
        .token-float {
            position: absolute;
            color: var(--success);
            font-weight: bold;
            animation: floatUp 1.5s ease-out forwards;
             pointer-events: none; /* Don't block clicks */
        }

        /* Achievements */
        .achievement-popup {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: var(--panel-background);
            padding: 12px;
            border-radius: var(--panel-border-radius);
            border-left: 6px solid var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: enter 0.3s ease-out;
            z-index: 10;
             box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .badge-icon {
            width: 36px;
            height: 36px;
            background: var(--accent);
            border-radius: 8px;
            display: grid;
            place-items: center;
            font-size: 1.2em;
             box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* Share Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9); /* Darker overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
             opacity: 0;
             pointer-events: none;
             transition: opacity 0.3s ease-in-out;
        }
         .modal-overlay.visible {
             opacity: 1;
             pointer-events: auto;
         }
        .modal-content {
            background: var(--secondary);
            padding: 20px;
            border-radius: var(--panel-border-radius);
            text-align: center;
            max-width: 90%;
             width: 400px; /* Fixed width on larger screens */
             box-shadow: 0 8px 20px rgba(0,0,0,0.6);
             transform: translateY(-20px);
             opacity: 0;
             animation: enter 0.3s ease-out forwards;
             position: relative; /* For close button positioning */
        }
         .modal-content h2 {
            color: var(--success);
            margin-bottom: 10px;
         }
         .modal-content p {
            margin-bottom: 15px;
            color: #ccc;
         }
        .modal-content input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: none;
            border-radius: var(--input-border-radius);
            background: #333;
            color: var(--text);
             font-size: 0.9em;
             cursor: text;
        }
        .modal-content button {
            background: var(--primary);
            color: var(--text);
            padding: 10px 20px;
            border: none;
            border-radius: var(--button-border-radius);
            cursor: pointer;
            margin: 5px;
             transition: background 0.2s;
        }
         .modal-content button:hover {
            background: #7A37CC;
         }
         .modal-content .close-btn {
             position: absolute;
             top: 10px;
             right: 10px;
             background: none;
             border: none;
             font-size: 1.5em;
             color: #aaa;
             cursor: pointer;
         }

        /* Flash Screen */
        .flash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 15;
            opacity: 0;
            transition: opacity 0.1s ease-out; /* Faster flash */
        }
        .flash-screen.win {
            background: var(--success);
            opacity: 0.4; /* More intense flash */
        }
         .flash-screen.win-10x {
            background: var(--accent); /* Yellow flash for 10x */
            opacity: 0.6; /* Very intense flash */
         }
        .flash-screen.lose {
            background: var(--danger);
            opacity: 0.4; /* More intense flash */
        }

         /* Confetti Effect (for wins) */
         .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--accent); /* Default color */
            animation: confetti-fall 2s ease-out forwards;
            pointer-events: none;
            z-index: 16; /* Above flash screen */
         }

        /* Leaderboard */
        .leaderboard-panel {
            position: absolute;
            top: 120px;
            right: 10px;
            background: var(--panel-background);
            padding: 12px;
            border-radius: var(--panel-border-radius);
            max-height: 250px;
            overflow-y: auto;
            backdrop-filter: blur(6px);
            width: 250px;
            font-size: 0.85em;
            z-index: 10;
             box-shadow: 0 4px 15px rgba(0,0,0,0.5);
             display: flex; /* Use flexbox for tabs */
             flex-direction: column;
        }
         .leaderboard-tabs {
             display: flex;
             margin-bottom: 10px;
             border-bottom: 1px solid #555;
         }
         .leaderboard-tab {
             flex-grow: 1;
             text-align: center;
             padding: 5px 0;
             cursor: pointer;
             font-weight: bold;
             color: #aaa;
             border-bottom: 2px solid transparent;
             transition: color 0.2s, border-bottom-color 0.2s;
         }
         .leaderboard-tab.active {
             color: var(--accent);
             border-bottom-color: var(--accent);
         }
         .leaderboard-content-tab {
             display: none; /* Hide content tabs by default */
         }
         .leaderboard-content-tab.active {
             display: block; /* Show active content tab */
         }


         .leaderboard-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--accent);
         }
         .leaderboard-entry {
             padding: 6px 0;
             border-bottom: 1px solid #333;
             display: flex;
             justify-content: space-between;
             align-items: center; /* Align items vertically */
         }
         .leaderboard-entry:last-child {
             border-bottom: none;
         }
         .leaderboard-entry .user {
             font-weight: bold;
             color: var(--primary);
             display: flex; /* Enable flex for user + emoji */
             align-items: center;
             gap: 5px;
         }
         .leaderboard-entry .value {
             color: var(--text);
         }

        /* Limited Time Bonus Banner */
        .bonus-banner {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(90deg, var(--accent), #FF8C00); /* Orange-gold gradient */
            color: #000;
            padding: 8px 15px;
            border-radius: var(--button-border-radius);
            font-weight: bold;
            font-size: 0.9em;
            z-index: 12; /* Above header */
            box-shadow: 0 4px 10px rgba(255, 215, 0, 0.5);
            animation: bounce 0.5s infinite alternate; /* Bouncing animation */
            display: none; /* Hidden by default */
        }

        /* Low Balance Alert */
        .low-balance-alert {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--danger);
            color: var(--text);
            padding: 15px 20px;
            border-radius: var(--panel-border-radius);
            font-weight: bold;
            z-index: 15;
            box-shadow: 0 4px 15px rgba(255, 55, 95, 0.5);
            display: none; /* Hidden by default */
            animation: enter 0.3s ease-out;
            text-align: center;
        }
        .low-balance-alert button {
            background: var(--text);
            color: var(--danger);
            padding: 8px 15px;
            border: none;
            border-radius: var(--button-border-radius);
            font-weight: bold;
            margin-top: 10px;
            cursor: pointer;
        }

         /* Refill Fake SOL Modal */
         #refillFakeSolModal .modal-content h2 {
             color: var(--primary);
         }
         #refillFakeSolModal .modal-content button {
             background: var(--success);
             color: #000;
         }


        /* Double or Nothing Modal */
        #doubleOrNothingModal .modal-content h2 {
            color: var(--danger); /* Red title for loss prompt */
        }
         #doubleOrNothingModal .modal-content button {
             margin-top: 15px;
         }
         #doubleOrNothingModal .modal-content button:first-of-type {
             background: var(--success); /* Green for Try Again */
             color: #000;
         }
         #doubleOrNothingModal .modal-content button:first-of-type:hover {
             background: #10C07D;
         }
         #doubleOrNothingModal .modal-content button:last-of-type {
             background: #555; /* Darker for Cancel */
         }
         #doubleOrNothingModal .modal-content button:last-of-type:hover {
             background: #777;
         }

         /* Result Modal */
         #resultModal .modal-content h2.win {
             color: var(--success);
         }
          #resultModal .modal-content h2.lose {
             color: var(--danger);
         }
          #resultModal .modal-content button {
             background: var(--primary);
             color: var(--text);
             margin-top: 20px;
             font-size: 1.2em;
             padding: 12px 25px;
             /* Disable style for Spin Again button */
             transition: opacity 0.2s, background 0.2s;
          }
          #resultModal .modal-content button:disabled {
              opacity: 0.6;
              cursor: not-allowed;
              background: #555;
          }

          /* Idle Modal */
          #idleModal .modal-content h2 {
              color: var(--accent);
          }
           #idleModal .modal-content button {
               background: var(--success);
               color: #000;
           }

           /* Auto Demo Banner */
           .auto-demo-banner {
               position: absolute;
               top: 10px;
               left: 50%;
               transform: translateX(-50%);
               background: rgba(0,0,0,0.7);
               color: var(--accent);
               padding: 8px 15px;
               border-radius: var(--button-border-radius);
               font-weight: bold;
               font-size: 0.9em;
               z-index: 12;
               box-shadow: 0 2px 10px rgba(0,0,0,0.3);
               display: none; /* Hidden by default */
           }


        /* Responsive Design */
        @media (max-width: 767px) {
             /* Mobile-only styles */
             .bet-controls {
                 position: fixed;
                 bottom: 0;
                 left: 0;
                 width: 100%;
                 border-radius: 0;
                 margin: 0;
                 padding-bottom: calc(15px + env(safe-area-inset-bottom)); /* Add safe area inset */
                 box-shadow: 0 -4px 15px rgba(0,0,0,0.5);
             }
             .bet-slider::-webkit-slider-thumb {
                 width: 25px; /* Larger thumb */
                 height: 25px;
             }
             .bet-slider::-moz-range-thumb {
                 width: 25px; /* Larger thumb */
                 height: 25px;
             }
             .container {
                 padding-bottom: 150px; /* Add padding to avoid content being hidden by sticky controls */
             }
             /* Adjust chat and bet feed position for smaller screens */
             .bet-feed {
                 top: 80px; /* Move below header */
                 left: 5px;
                 width: calc(50% - 10px); /* Take up half the screen width */
                 max-height: 150px; /* Reduce max height */
                 padding: 8px;
             }
             .chat-box {
                 bottom: 80px; /* Move above bet controls */
                 right: 5px;
                 width: calc(50% - 10px); /* Take up half the screen width */
                 max-height: 150px; /* Reduce max height */
                 padding: 8px;
             }
             .leaderboard-panel {
                 display: none; /* Hide leaderboard on small screens */
             }
             .token-notification {
                 bottom: auto; /* Remove fixed bottom position */
                 top: 80px; /* Position near bet feed */
                 right: 5px;
                 padding: 8px 12px;
             }
             .achievement-popup {
                 bottom: auto; /* Remove fixed bottom position */
                 top: 80px; /* Position near bet feed */
                 left: 5px;
                 padding: 8px 12px;
             }
             .low-balance-alert {
                 bottom: calc(150px + 20px); /* Position above bet controls */
             }
             .recent-spins {
                 bottom: 160px; /* Position above bet controls */
             }
             .bonus-banner {
                 top: 60px; /* Adjust position */
             }
             .fake-activity-banner {
                 top: 10px; /* Adjust position */
             }
             .ten-x-hit-banner {
                 top: 120px; /* Adjust position */
             }
              /* Guest Mode Banner */
             .guest-banner {
                 position: fixed;
                 top: 10px;
                 left: 10px;
                 background: var(--primary);
                 color: var(--text);
                 padding: 5px 10px;
                 border-radius: var(--button-border-radius);
                 font-size: 0.7em;
                 font-weight: bold;
                 z-index: 15; /* Above most elements */
                 box-shadow: 0 2px 5px rgba(0,0,0,0.3);
             }
             .auto-demo-banner {
                  top: 60px; /* Position below guest banner */
                  font-size: 0.7em;
                  padding: 5px 10px;
             }
        }

        @media (min-width: 768px) {
             .container {
                 flex-direction: row; /* Layout side-by-side */
                 justify-content: center;
                 align-items: center;
                 gap: 40px;
                 padding: 20px;
             }
             .header {
                 position: absolute;
                 top: 20px;
                 left: 50%;
                 transform: translateX(-50%);
                 width: auto; /* Auto width */
                 max-width: 960px;
             }
             .global-timer {
                 top: 100px; /* Adjusted position */
             }
            .wheel-container {
                 width: 400px;
                 height: 400px;
                 margin: 0; /* Remove auto margin */
                 margin-top: 120px; /* Space for header/timer */
             }
             #rouletteCanvas {
                 /* Adjust canvas size if needed, but CSS width/height should handle scaling */
             }
             .bet-feed {
                 position: static; /* Remove absolute positioning */
                 max-height: none; /* Allow full height */
                 overflow-y: visible;
                 width: 300px;
                 margin: 0;
                 align-self: stretch; /* Stretch to fill height */
                 margin-top: 120px; /* Space for header/timer */
             }
             .chat-box {
                 position: static; /* Remove absolute positioning */
                 max-height: none; /* Allow full height */
                 overflow-y: visible;
                 width: 300px;
                 margin: 0;
                 align-self: stretch; /* Stretch to fill height */
                 margin-top: 120px; /* Space for header/timer */
             }
             .bet-controls {
                 position: static; /* Remove absolute positioning */
                 width: 400px; /* Match wheel width */
                 margin: 20px 0 0 0; /* Space below wheel */
             }
             .token-notification {
                 bottom: auto;
                 top: 180px; /* Position below timer */
                 right: 10px;
             }
             .achievement-popup {
                 bottom: auto;
                 top: 180px; /* Position below timer */
                 left: 10px;
             }
             .leaderboard-panel {
                 position: static; /* Remove absolute positioning */
                 max-height: none;
                 overflow-y: visible;
                 width: 300px;
                 margin: 0;
                 align-self: stretch;
                 margin-top: 120px;
             }
             .low-balance-alert {
                 bottom: 20px;
                 left: auto;
                 right: 20px; /* Position on the right */
                 transform: none;
             }
              .bonus-banner {
                 top: 10px;
                 left: 50%;
                 transform: translateX(-50%);
             }
             /* Guest Mode Banner */
             .guest-banner {
                 position: fixed;
                 top: 10px;
                 left: 10px;
                 background: var(--primary);
                 color: var(--text);
                 padding: 5px 10px;
                 border-radius: var(--button-border-radius);
                 font-size: 0.8em;
                 font-weight: bold;
                 z-index: 15; /* Above most elements */
                 box-shadow: 0 2px 5px rgba(0,0,0,0.3);
             }
             .auto-demo-banner {
                 top: 10px; /* Position next to guest banner */
             }
        }
    </style>
</head>
<body>
    <div class="background-overlay" id="backgroundOverlay"></div>
    <div class="strobe-overlay" id="strobeOverlay"></div>
    <div class="container">
        <div class="flash-screen" id="flashScreen"></div>

        <div id="guestModeBanner" class="guest-banner" style="display: none;" title="You're playing with Fake SOL. Connect wallet to win real rewards.">
             ‚ö†Ô∏è Guest Mode ‚Äì Fake SOL Only
        </div>
         <div id="autoDemoBanner" class="auto-demo-banner" style="display: none;">
             Auto demo in progress ‚Äì Tap anything to join
         </div>


        <div class="header">
            <div class="site-title">SolRoulette LIVE</div>
            <div class="players-online"><i class="fas fa-users"></i> <span id="playersOnline">1,247</span> Online</div>
            <div class="user-profile" id="userProfile">
                <div class="avatar" id="userAvatar">üòé</div>
                <div>
                    <div id="userName">Guest</div>
                    <div class="xp-bar"><div class="xp-fill" id="xpFill" style="width: 0%"></div></div>
                </div>
                <div><i class="fas fa-wallet"></i> <span id="solBalance">0.00</span> SOL</div>
                 <div id="fakeWinningsDisplay" style="display: none; margin-left: 10px;" title="Your total fake winnings so far.">
                     ‚óé<span id="fakeWinningsTotalDisplay">0.00</span> (Fake)
                 </div>
            </div>
        </div>

        <div class="global-timer" id="globalTimer">‚è≥ Next Spin: 25s</div>
         <div class="pre-spin-cta" id="preSpinCta">Place your bets...</div>


        <div class="bonus-banner" id="bonusBanner">Double $SPIN next 10 spins! üî•</div>

        <div class="bet-feed" id="betFeed">
            <div class="bet-feed-title">Live Bets</div>
            <div class="bet-entry"><i class="fas fa-dice"></i> <span class="system">System:</span> Welcome to SolRoulette LIVE!</div>
        </div>

        <div class="leaderboard-panel" id="leaderboardPanel">
             <div class="leaderboard-tabs">
                 <div class="leaderboard-tab active" data-tab="wager">Top Wager</div>
                 <div class="leaderboard-tab" data-tab="streak">Streak</div>
                 <div class="leaderboard-tab" data-tab="10x">10x Wins</div>
             </div>
            <div id="leaderboardContent">
                 <div class="leaderboard-content-tab active" data-tab="wager">
                     </div>
                 <div class="leaderboard-content-tab" data-tab="streak">
                      </div>
                 <div class="leaderboard-content-tab" data-tab="10x">
                      </div>
            </div>
        </div>


        <div class="wheel-container" id="wheelContainer">
            <div class="pointer" id="pointer"></div>
            <canvas id="rouletteCanvas"></canvas>
             <div class="recent-spins" id="recentSpins">
                 <span class="label">Recent:</span>
                 </div>
        </div>

        <div class="bet-controls">
            <div class="onboarding-tooltip" id="onboardingTooltip">Start here ‚Äì Pick your multiplier.</div>
            <div class="bet-label">Select Multiplier</div>
            <div class="multiplier-options" id="multiplierOptions">
                <button class="multiplier-btn" data-multiplier="1.5x" data-probability="30" title="">1.5x<small>Chance: 30%</small></button>
                <button class="multiplier-btn" data-multiplier="2x" data-probability="20" title="">2x<small>Chance: 20%</small></button>
                <button class="multiplier-btn" data-multiplier="3x" data-probability="20" title="">3x<small>Chance: 20%</small></button>
                <button class="multiplier-btn" data-multiplier="5x" data-probability="15" title="">5x<small>Chance: 15%</small></button>
                <button class="multiplier-btn" data-multiplier="10x" data-probability="15" title="">10x<small>Chance: 15%</small></button>
            </div>
            <div class="bet-amount">
                 <div class="bet-amount-top">
                    <span class="bet-amount-label">Bet Amount:</span>
                    <input type="range" class="bet-slider" id="betSlider" min="0.01" max="10" step="0.01" value="0.5" title="">
                    <span class="bet-value" id="betValue">‚óé0.50 SOL</span>
                 </div>
                 <div class="max-win-text">Max Win Per Round: ‚óé50</div>
            </div>
             <div class="bet-summary" id="betSummary" style="display: none;">
                 </div>
             <button class="connect-wallet-btn" id="connectWalletBtn" >Connect Wallet</button>
            <button class="place-bet" id="placeBetBtn" style="display: none;" title="Connect your wallet to place real bets">üîí Place Bet</button>
        </div>

        <div class="chat-box" id="chatBox">
             <div class="chat-feed" id="chatFeed">
                <div class="chat-message"><i class="fas fa-robot"></i> <span class="system">System:</span> Spin to win big! <span class="reaction">üî•</span></div>
             </div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="Say something..." aria-label="Chat input">
                <button id="sendChatBtn" aria-label="Send chat message">Send</button>
            </div>
        </div>

        <div class="token-notification" id="tokenNotification" style="display: none;">
            <i class="fas fa-coins"></i> Earned: <span id="tokenCount">0.000</span> $SPIN
            <button id="claimModalBtn" aria-label="Claim SPIN tokens">Claim</button>
        </div>

        <div id="achievementContainer"></div>

        <div class="modal-overlay" id="walletModal">
            <div class="modal-content">
                <button class="close-btn" id="closeWalletModalBtn" aria-label="Close wallet modal">&times;</button>
                <h2>Connect Your Wallet</h2>
                <p>Choose a wallet to connect and start betting.</p>
                <button id="connectPhantomBtn">Connect Phantom (Mock)</button>
                 <button class="secondary-btn" id="justWatchingBtn">Just Watching? Close</button>
            </div>
        </div>

        <div class="modal-overlay" id="profileModal">
            <div class="modal-content">
                 <button class="close-btn" id="closeProfileModalBtn" aria-label="Close profile modal">&times;</button>
                 <h2>Your Profile</h2>
                 <div id="profileContent">
                     <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                         <div class="avatar large" id="profileAvatar">üòé</div>
                         <div>
                             <div style="font-size: 1.2em; font-weight: bold;" id="profileName">Guest</div>
                             <div style="color: #aaa;">Level <span id="profileLevel">1</span></div>
                             <div class="xp-bar large" style="width: 150px;"><div class="xp-fill" id="profileXpFill" style="width: 0%;"></div></div>
                         </div>
                     </div>
                     <p>Wallet: <span id="profileWallet">Not Connected</span></p>
                     <p>Balance: <span id="profileBalance">0.00 SOL</span></p>
                     <p>Total Wagered: <span id="profileTotalWagered">0.00 SOL</span></p>
                     <p>Win Streak: <span id="profileWinStreak">0</span></p>
                     <p>10x Wins: <span id="profileTenXWins">0</span></p>
                     <p id="profileFakeWinnings" style="display: none;">Fake Winnings: <span id="fakeWinningsTotal">0.00</span> SOL</p>


                     <h3>Achievements</h3>
                     <div id="profileAchievementsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); gap: 10px; margin-top: 10px;">
                         </div>

                     <h3>Referral Code</h3>
                     <input type="text" id="referralLinkInput" readonly>
                     <button id="copyReferralLinkBtn">Copy Referral Link</button>

                     <button id="resetGuestProgressBtn" style="display: none; background: var(--danger); color: var(--text); margin-top: 20px;">Reset Guest Progress</button>

                 </div>
            </div>
        </div>

        <div class="modal-overlay" id="shopModal">
            <div class="modal-content">
                 <button class="close-btn" id="closeShopModalBtn" aria-label="Close shop modal">&times;</button>
                 <h2>$SPIN Shop</h2>
                 <p>Your $SPIN Balance: <span id="shopSpinBalance">0.000</span></p>
                 <div id="shopItems" style="margin-top: 20px;">
                     <div style="border: 1px solid #333; padding: 10px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                         <span>üöÄ Rocket Avatar</span>
                         <span>10 $SPIN <button class="buy-item-btn" data-item-id="rocket_avatar" data-cost="10">Buy</button></span>
                     </div>
                      <div style="border: 1px solid #333; padding: 10px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                         <span>üî• Fire Chat Emote</span>
                         <span>5 $SPIN <button class="buy-item-btn" data-item-id="fire_emote" data-cost="5">Buy</button></span>
                     </div>
                 </div>
            </div>
        </div>

        <div class="modal-overlay" id="dailyBonusModal">
            <div class="modal-content">
                 <button class="close-btn" id="closeDailyBonusModalBtn" aria-label="Close daily bonus modal">&times;</button>
                 <h2>Daily Login Bonus!</h2>
                 <p>Claim your bonus for Day <span id="dailyBonusDay">1</span>!</p>
                 <p id="dailyBonusAmount">Reward: 0.01 $SPIN</p>
                 <button id="claimDailyBonusBtn">Claim Bonus</button>
            </div>
        </div>

        <div class="modal-overlay" id="doubleOrNothingModal">
             <div class="modal-content">
                 <h2>Want to win back your loss?</h2>
                 <p>Bet the same amount again on the same multiplier.</p>
                 <button id="tryAgainBetBtn">Try Again</button>
                 <button id="cancelDoubleOrNothingBtn">Cancel</button>
             </div>
        </div>

        <div class="modal-overlay" id="resultModal">
             <div class="modal-content">
                 <h2 id="resultModalTitle"></h2>
                 <p id="resultModalMessage"></p>
                 <button id="resultModalSpinAgainBtn">Spin Again</button>
             </div>
        </div>

         <div class="modal-overlay" id="onboardingModal">
             <div class="modal-content">
                 <h2>üéâ Welcome to SolRoulette LIVE!</h2>
                 <p>Here‚Äôs ‚óé500 in Fake SOL to try your luck. Connect your wallet any time to win real rewards.</p>
                 <button id="onboardingStartBtn">Start Playing</button>
                 <button id="onboardingConnectBtn">Connect Wallet</button>
             </div>
         </div>

         <div class="modal-overlay" id="refillFakeSolModal">
             <div class="modal-content">
                 <h2>Out of SOL?</h2>
                 <p>Looks like your fake SOL balance is low.</p>
                 <button id="refillFakeSolBtn">Refill ‚óé500 fake SOL!</button>
             </div>
         </div>

         <div class="modal-overlay" id="idleModal">
             <div class="modal-content">
                 <h2>Still here?</h2>
                 <p>Try a spin and feel the rush üî•</p>
                 <button id="closeIdleModalBtn">OK</button>
             </div>
         </div>


        <div class="modal-overlay" id="shareModal">
            <div class="modal-content">
                <button class="close-btn" id="closeShareModalBtn" aria-label="Close share modal">&times;</button>
                <h2 id="shareTitle">Big Win!</h2>
                <p id="shareMessage">Share your victory on X!</p>
                <input type="text" id="shareText" readonly aria-label="Share link">
                <button id="copyShareTextBtn"><i class="fas fa-copy"></i> Copy Link</button>
                 <button id="tweetWinBtn"><i class="fab fa-twitter"></i> Tweet Now</button>
            </div>
        </div>

         <div class="modal-overlay" id="messageBox">
             <div class="modal-content">
                 <h2 id="messageBoxTitle"></h2>
                 <p id="messageBoxContent"></p>
                 <button id="closeMessageBoxBtn">OK</button>
             </div>
         </div>

         <div class="low-balance-alert" id="lowBalanceAlert">
             Low Balance! Your SOL is running low.
             <button id="topUpWalletBtn">Top Up Now (Mock)</button>
         </div>

          <div class="low-balance-alert" id="guestModeToast" style="background: rgba(153, 69, 255, 0.9); display: none;">
             Guest Mode ‚Äì Playing with Fake SOL. Connect wallet to win real rewards.
         </div>

         <div class="bonus-banner" id="fakeActivityBanner" style="background: rgba(0,0,0,0.6); color: #fff; animation: none; top: 50px; font-size: 0.8em; padding: 5px 10px;">
             <span id="activityWatchers">üéØ 32 watching</span> | <span id="activityBetting">7 betting 10x</span> | <span id="activityWins">3 wins just hit!</span>
         </div>

         <div class="bonus-banner" id="tenXHitBanner" style="background: linear-gradient(90deg, var(--danger), var(--accent)); color: #fff; animation: bounce 0.5s infinite alternate; top: 150px; font-size: 1em; padding: 8px 15px; display: none;">
             üî• 3 others just hit 10x! üî•
         </div>


    </div>

    <script src="https://unpkg.com/@solana/web3.js@1.66.0/lib/index.iife.js"></script>
    <script src="https://unpkg.com/@solana/wallet-adapter-base@0.9.19/dist/index.js"></script>
    <script src="https://unpkg.com/@solana/wallet-adapter-wallets@0.19.9/dist/index.js"></script>
    <script src="https://unpkg.com/@solana/wallet-adapter-react-ui@0.9.19/dist/index.js"></script>
    <script>
        // State Management
        let spinTimer = 25;
        let isSpinning = false;
        let walletBalance = parseFloat(localStorage.getItem('solroulette_wallet_balance') || '0'); // Load balance from localStorage
        let tokensEarned = parseFloat(localStorage.getItem('solroulette_spin_tokens') || '0'); // Load tokens from localStorage
        let xp = parseInt(localStorage.getItem('solroulette_xp') || '0'); // Load XP from localStorage
        let level = parseInt(localStorage.getItem('solroulette_level') || '1'); // Load level from localStorage
        let totalWagered = parseFloat(localStorage.getItem('solroulette_total_wagered') || '0'); // Load total wagered
        let winStreak = parseInt(localStorage.getItem('solroulette_win_streak') || '0'); // Load win streak
        let tenXWins = parseInt(localStorage.getItem('solroulette_ten_x_wins') || '0'); // Load 10x wins
        let currentBet = { multiplier: null, amount: 0 };
        let achievementsUnlocked = new Set(JSON.parse(localStorage.getItem('solroulette_achievements') || '[]')); // Load achievements
        let playersOnline = 1247;
        let playerBets = []; // Array to store bets for the current round
        let lastLossBet = null; // Store details of the last losing bet for "Double or Nothing"
        let isGuestMode = localStorage.getItem('solroulette_is_guest') === 'true'; // Track guest mode
        let guestSpinCount = parseInt(localStorage.getItem('solroulette_guest_spin_count') || '0'); // Track guest spins for modal
        let recentSpins = JSON.parse(localStorage.getItem('solroulette_recent_spins') || '[]'); // Load recent spins
        let fakeWinningsTotal = parseFloat(localStorage.getItem('solroulette_fake_winnings_total') || '0'); // Track fake winnings
        let onboardingShown = localStorage.getItem('solroulette_onboarding_shown') === 'true'; // Track if onboarding tooltip has been shown

        // User Profile
        let user = {
            wallet: localStorage.getItem('solroulette_wallet') || null, // Load wallet from localStorage
            name: localStorage.getItem('solroulette_user_name') || 'Guest', // Load name
            avatar: localStorage.getItem('solroulette_user_avatar') || 'üòé', // Load avatar
            referral: localStorage.getItem('solroulette_referral_code') || generateReferralCode(), // Load or generate referral code
        };

        // Daily Bonus State
        let lastLoginDate = localStorage.getItem('solroulette_last_login') || null;
        let dailyBonusDay = parseInt(localStorage.getItem('solroulette_daily_bonus_day') || '0');

        // Idle Timer State
        let idleTimer = null;
        const IDLE_TIMEOUT = 120000; // 2 minutes in milliseconds

        // Auto Demo State
        let isAutoDemo = false;
        let autoDemoTimer = null;
        const AUTO_DEMO_INTERVAL = 25000; // Spin every 25 seconds in auto demo


        // Dev Flags
        window.autoRefill = false; // Set to true in browser console for auto-refill testing


        // Audio Effects (Lazy Loading)
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const sounds = {};

        async function loadSound(name, url) {
            try {
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                sounds[name] = audioBuffer;
            } catch (e) {
                console.error(`Error loading sound ${name}:`, e);
            }
        }

        function playSound(name, volume = 1.0, loop = false) {
            // Ensure audio context is resumed after user interaction
            if (audioContext.state === 'suspended') {
                audioContext.resume().catch(e => console.error("AudioContext resume failed:", e));
            }

            const audioBuffer = sounds[name];
            if (!audioBuffer || !audioContext) return;

            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;

            const gainNode = audioContext.createGain();
            gainNode.gain.value = volume;

            source.connect(gainNode).connect(audioContext.destination);
            source.loop = loop;
            source.start(0);
            return source; // Return source to stop looping sounds later
        }

        // Preload sounds
        loadSound('click', 'https://www.soundjay.com/buttons/button-1.wav'); // Example click sound
        loadSound('tick', 'https://www.soundjay.com/mechanical/tick-tock-2.wav'); // Example tick sound
        loadSound('whoosh', 'https://www.soundjay.com/transport/train-whoosh-2.wav'); // Example whoosh sound
        loadSound('clank', 'https://www.soundjay.com/mechanical/clank-gong-1.wav'); // Example clank sound
        loadSound('fanfare', 'https://www.soundjay.com/human/fanfare-1.wav'); // Example fanfare sound
        loadSound('sad_trombone', 'https://www.soundjay.com/human/sad-trombone-1.wav'); // Example sad trombone sound
        loadSound('win', 'https://www.soundjay.com/human/applause-2.wav'); // Example general win sound
        loadSound('win_10x', 'https://www.soundjay.com/misc/magic-chime-1.wav'); // Example 10x win sound

        let currentTickSound = null; // To control the looping tick sound

        // Debounce function
        function debounce(func, delay) {
            let inDebounce;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(inDebounce);
                inDebounce = setTimeout(() => func.apply(context, args), delay);
            }
        }

        const updateUIDebounced = debounce(updateUI, 50); // Debounce updateUI calls

        // Canvas Wheel Drawing
        const canvas = document.getElementById('rouletteCanvas');
        const ctx = canvas.getContext('2d');
        const segments = [
            { multiplier: '1.5x', color: '--success', probability: 0.3 },
            { multiplier: '2x', color: '--primary', probability: 0.2 },
            { multiplier: '3x', color: '--accent', probability: 0.2 },
            { multiplier: '5x', color: '--success', probability: 0.15 }, // Keeping same as success for visual variety
            { multiplier: '10x', color: '--danger', probability: 0.15 } // Lower chance for 10x
        ];
        const totalProbability = segments.reduce((sum, seg) => sum + seg.probability, 0);
        // Calculate angles based on probability
        let startAngle = 0;
        segments.forEach(segment => {
            segment.startAngle = startAngle;
            segment.endAngle = startAngle + (segment.probability / totalProbability) * 2 * Math.PI;
            segment.middleAngle = segment.startAngle + (segment.endAngle - segment.startAngle) / 2;
            startAngle = segment.endAngle;
        });

        let currentWheelRotation = 0;
        let spinAnimationId = null;
        let spinStartTime = null;
        let spinDuration = 5000; // 5 seconds
        let targetRotation = 0;
        let isNearMiss = false;

        function drawWheel() {
            const size = Math.min(canvas.width, canvas.height);
            const centerX = size / 2;
            const centerY = size / 2;
            const radius = size / 2 - 12; // Account for border

            ctx.clearRect(0, 0, size, size);

            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(currentWheelRotation);

            segments.forEach(segment => {
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, radius, segment.startAngle, segment.endAngle);
                ctx.closePath();
                // Correctly get CSS variable value
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue(segment.color).trim();
                ctx.fill();

                // Draw text
                ctx.save();
                // Rotate to the middle of the segment
                ctx.rotate(segment.middleAngle);
                ctx.fillStyle = '#FFF';
                ctx.font = 'bold 24px "Inter", sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                // Position text away from the center
                const textRadius = radius * 0.7;
                ctx.fillText(segment.multiplier, textRadius, 0);
                ctx.restore();
            });

            ctx.restore();

            // Draw metallic texture effect (simple overlay)
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.beginPath();
            ctx.arc(0, 0, radius, 0, 2 * Math.PI);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)'; // Subtle white overlay
            ctx.globalCompositeOperation = 'overlay'; // Blend mode
            ctx.fill();
            ctx.restore();

            // Draw center circle
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius * 0.3, 0, 2 * Math.PI);
            ctx.fillStyle = '#222';
            ctx.fill();
            ctx.lineWidth = 5;
            ctx.strokeStyle = '#444';
            ctx.stroke();

            // Draw center text
             // Correctly get CSS variable value
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
            ctx.font = 'bold 20px "Press Start 2P", cursive'; // Arcade font for center
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('SPIN', centerX, centerY);
        }

        function animateWheel(timestamp) {
            if (!spinStartTime) spinStartTime = timestamp;
            const elapsed = timestamp - spinStartTime;
            const progress = Math.min(elapsed / spinDuration, 1);

            // Easing function (cubic-bezier for spin)
            // This needs to match the CSS transition for the visual pointer effect
            // A simple cubic-bezier(0.25, 0.1, 0.25, 1) can be approximated
            const easedProgress = 1 - Math.pow(1 - progress, 3); // Simple ease-out

            // Calculate rotation based on progress
            // Start fast, slow down towards the end
            // We need to rotate from current position to targetRotation
            // For near-miss, the targetRotation will be adjusted during the spin

            let currentTargetRotation = targetRotation;
             // Apply near-miss fakeout during the last part of the spin
            if (isNearMiss && progress > 0.7 && progress < 0.95) {
                 const nearMissTarget = calculateCanvasTargetRotation('10x') + (Math.random() * 20 - 10); // Aim slightly past 10x
                 const nearMissProgress = (progress - 0.7) / (0.95 - 0.7); // Progress within the fakeout phase
                 currentTargetRotation = targetRotation + (nearMissTarget - targetRotation) * Math.sin(nearMissProgress * Math.PI / 2); // Ease into near miss
            }


            currentWheelRotation = currentTargetRotation * easedProgress;


            drawWheel();

            if (progress < 1) {
                spinAnimationId = requestAnimationFrame(animateWheel);
            } else {
                // Animation finished
                isSpinning = false;
                spinStartTime = null;
                // Snap to the final target position to avoid floating point issues
                currentWheelRotation = targetRotation;
                drawWheel();
                handleSpinResult(); // Process results after animation
            }
        }

         // Function to calculate target rotation for canvas
         function calculateCanvasTargetRotation(winningMultiplier) {
             const segment = segments.find(seg => seg.multiplier === winningMultiplier);
             if (!segment) return 0;

             // We want the pointer to land on the middle of the segment
             // The canvas is rotated, so we need to find the rotation value
             // that brings the segment's middle angle to the pointer position (which is at the top, 0 degrees relative to the container)

             // The pointer is at the top (0 degrees relative to the container).
             // The canvas is rotated. We want the segment's middleAngle to align with the top.
             // If the segment's middle angle is M, we need to rotate the canvas by -M
             // However, the canvas drawing starts at 0 degrees to the right (standard canvas arc).
             // Our segments are defined starting from 0 degrees to the right.
             // The pointer is at the top, which is -PI/2 radians or -90 degrees.

             // So, we need to rotate the wheel such that the middle of the winning segment
             // aligns with the pointer's position (-90 degrees).

             const pointerAngle = -Math.PI / 2; // Pointer is at the top (in radians)
             const segmentMiddleAngle = segment.middleAngle; // Middle of the winning segment (in radians)

             // The rotation needed is the difference between the pointer angle and the segment's middle angle.
             // We need to add full rotations to make it spin multiple times.
             const fullRotations = 5; // Spin at least 5 full times
             const rotationInRadians = (pointerAngle - segmentMiddleAngle) + (fullRotations * 2 * Math.PI);

             return rotationInRadians;
         }


        // Wallet Connection
        async function connectWallet() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);

            try {
                // Attempt to connect using a common adapter like Phantom
                const { PhantomWalletAdapter } = window.SolanaWalletAdapters;
                const adapter = new PhantomWalletAdapter();

                // Check if the adapter is available and connectable
                if (!adapter) {
                    showMessageBox('Wallet Not Found', 'Phantom wallet not found. Please install it.');
                    return;
                }

                await adapter.connect();
                user.wallet = adapter.publicKey.toString();
                user.name = user.wallet.slice(0, 4) + '...' + user.wallet.slice(-4);

                 // If coming from guest mode, save guest stats before switching
                 if (isGuestMode) {
                     localStorage.setItem('solroulette_guest_balance', walletBalance);
                     localStorage.setItem('solroulette_guest_xp', xp);
                     localStorage.setItem('solroulette_guest_tokens', tokensEarned);
                     localStorage.setItem('solroulette_guest_total_wagered', totalWagered);
                     localStorage.setItem('solroulette_guest_win_streak', winStreak);
                     localStorage.setItem('solroulette_guest_ten_x_wins', tenXWins);
                      localStorage.setItem('solroulette_guest_achievements', JSON.stringify([...achievementsUnlocked]));
                      localStorage.setItem('solroulette_guest_spin_count', guestSpinCount); // Save guest spin count
                      localStorage.setItem('solroulette_fake_winnings_total', fakeWinningsTotal); // Save fake winnings
                 }

                isGuestMode = false; // Exit guest mode on real wallet connection

                // Mock balance - in a real app, fetch from the blockchain
                walletBalance = parseFloat(localStorage.getItem('solroulette_wallet_balance') || (Math.random() * 10).toFixed(2)); // Load real balance or generate mock if first time


                // Load real user data or initialize if first time connecting
                xp = parseInt(localStorage.getItem('solroulette_xp') || '0');
                level = parseInt(localStorage.getItem('solroulette_level') || '1');
                tokensEarned = parseFloat(localStorage.getItem('solroulette_spin_tokens') || '0');
                totalWagered = parseFloat(localStorage.getItem('solroulette_total_wagered') || '0');
                winStreak = parseInt(localStorage.getItem('solroulette_win_streak') || '0');
                tenXWins = parseInt(localStorage.getItem('solroulette_ten_x_wins') || '0');
                achievementsUnlocked = new Set(JSON.parse(localStorage.getItem('solroulette_achievements') || '[]'));


                // Save state to localStorage (real wallet keys)
                localStorage.setItem('solroulette_wallet', user.wallet);
                localStorage.setItem('solroulette_user_name', user.name);
                localStorage.setItem('solroulette_wallet_balance', walletBalance); // Save balance
                localStorage.setItem('solroulette_spin_tokens', tokensEarned);
                localStorage.setItem('solroulette_xp', xp);
                localStorage.setItem('solroulette_level', level);
                localStorage.setItem('solroulette_total_wagered', totalWagered);
                localStorage.setItem('solroulette_win_streak', winStreak);
                localStorage.setItem('solroulette_ten_x_wins', tenXWins);
                localStorage.setItem('solroulette_achievements', JSON.stringify([...achievementsUnlocked]));
                 localStorage.setItem('solroulette_is_guest', 'false'); // Update guest mode status


                updateUIDebounced();
                addChatMessage('System', `${user.name} joined the game!`, 'ü§ù', 'system');

                // Hide connect button, show place bet button
                document.getElementById('connectWalletBtn').style.display = 'none';
                document.getElementById('placeBetBtn').style.display = 'block';

                 closeWalletModal(); // Close the wallet modal on successful connection

                 checkDailyBonus(); // Check for daily bonus after connecting wallet

                 // Show welcome back modal
                 showMessageBox('Welcome Back!', 'Your real wallet is now live.');

                 // Stop auto demo if it was running
                 stopAutoDemo();


            } catch (err) {
                console.error('Wallet connection failed:', err);
                showMessageBox('Connection Failed', 'Failed to connect wallet. Please try again.');
                if (navigator.vibrate) navigator.vibrate(200); // Vibrate on error
            }
        }

         function openWalletModal() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             document.getElementById('walletModal').classList.add('visible');
             resetIdleTimer(); // Reset idle timer on modal open
         }

         function closeWalletModal() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             document.getElementById('walletModal').classList.remove('visible');
             resetIdleTimer(); // Reset idle timer on modal close
         }

        // Update Timer
        function updateTimer() {
            const timerElement = document.getElementById('globalTimer');
            const pointerElement = document.getElementById('pointer');
            const preSpinCtaElement = document.getElementById('preSpinCta');


            if (isSpinning) {
                 timerElement.textContent = `‚ú® Spinning...`;
                 timerElement.style.background = 'linear-gradient(45deg, var(--accent), var(--primary))';
                 timerElement.classList.remove('urgent');
                 pointerElement.classList.remove('pulse'); // Stop pointer pulse
                 document.getElementById('backgroundOverlay').classList.add('intensify-particles'); // Intensify particles
                 if (currentTickSound) {
                     currentTickSound.stop(); // Stop tick sound when spinning starts
                     currentTickSound = null;
                 }
                 document.getElementById('strobeOverlay').classList.add('active'); // Activate strobe
                 preSpinCtaElement.textContent = 'Bets closed. Spinning now...'; // Update CTA

                 // Disable Spin Again button during spin
                 document.getElementById('resultModalSpinAgainBtn').disabled = true;

                 return;
            }

            document.getElementById('strobeOverlay').classList.remove('active'); // Deactivate strobe
            document.getElementById('backgroundOverlay').classList.remove('intensify-particles'); // De-intensify particles

            // Enable Spin Again button if betting is allowed
            if (!isSpinning && spinTimer > 3) {
                 document.getElementById('resultModalSpinAgainBtn').disabled = false;
            }


            timerElement.textContent = `‚è≥ Next Spin: ${spinTimer}s`;
            timerElement.style.background = 'linear-gradient(45deg, var(--danger), var(--primary))';
             timerElement.classList.remove('urgent'); // Remove urgent class initially
             pointerElement.classList.remove('pulse'); // Stop pointer pulse

            if (spinTimer <= 10 && spinTimer > 0) {
                 timerElement.classList.add('urgent'); // Add urgent class for faster pulse and red gradient
                 // Play tick sound only if not already playing
                 if (!currentTickSound) {
                    currentTickSound = playSound('tick', 0.5, true); // Play tick sound on loop
                 }
                 // Increase pitch as timer nears 0 (mock pitch increase)
                 if (currentTickSound && audioContext) {
                     const pitch = 1 + (10 - spinTimer) * 0.05; // Increase pitch by 0.05 for each second closer to 0
                     currentTickSound.playbackRate.setValueAtTime(pitch, audioContext.currentTime);
                 }
                if (spinTimer <= 5) {
                    preSpinCtaElement.textContent = `${spinTimer}s left...`; // Update CTA
                } else {
                     preSpinCtaElement.textContent = 'Place your bets...'; // Default CTA
                }


            } else {
                 if (currentTickSound) {
                     currentTickSound.stop(); // Stop tick sound when timer is above 10 or is 0
                     currentTickSound = null;
                 }
                 preSpinCtaElement.textContent = 'Place your bets...'; // Default CTA
            }

             // Pulse pointer when timer is <= 3s
             if (spinTimer <= 3 && spinTimer > 0) {
                 pointerElement.classList.add('pulse');
             } else {
                 pointerElement.classList.remove('pulse');
             }


            if (spinTimer <= 0) {
                // Betting closes 3 seconds before spin
                if (!isSpinning) { // Only spin if not already spinning
                     spinWheel();
                }
                spinTimer = 25; // Reset timer
                playerBets = []; // Clear bets for the new round
                document.getElementById('betFeed').innerHTML = '<div class="bet-feed-title">Live Bets</div>'; // Clear bet feed UI
                // simulateMultiplayer(); // Simulate new bets for the next round - now handled by interval
            } else {
                spinTimer--;
            }
            updateUIDebounced(); // Update UI elements that depend on the timer state
        }

        // Simulate Multiplayer (placing bets for the next round)
        function simulateMultiplayer() {
            // Only simulate if not spinning
            if (isSpinning || spinTimer <= 3) return;

            playersOnline += Math.floor(Math.random() * 10 - 5);
            document.getElementById('playersOnline').textContent = playersOnline;

            const fakeUsers = ['SolDegen', 'CryptoChad', 'MoonApe', 'WheelMaster', 'LuckyLuke', 'GambaGuy', 'AnonBets', 'SolSpinner', 'DeFiKing', 'NFTCollector'];
            const multipliers = ['1.5x', '2x', '3x', '5x', '10x'];

            // Simulate fake bets
            if (Math.random() < 0.7) { // 70% chance to add a fake bet
                 const newBet = {
                    user: fakeUsers[Math.floor(Math.random() * fakeUsers.length)],
                    amount: parseFloat((Math.random() * 5).toFixed(2)),
                    multiplier: multipliers[Math.floor(Math.random() * multipliers.length)]
                 };
                 // Add to the UI feed immediately to show active bets
                 addBetEntry(`@${newBet.user}`, newBet.amount, newBet.multiplier); // Pass amount as number
            }

            // Simulate fake chat messages
            if (Math.random() < 0.5) { // 50% chance to add a fake message
                const fakeMessages = ['Gonna hit 10x this round! üöÄ', 'Feeling lucky today!', 'Any big bettors out there?', 'Let\'s gooo!', 'Hope I don\'t bust üò≠', 'What multiplier are you guys on?', 'Spin it!', 'To the moon! üåï', 'Wen 10x?', 'This wheel is rigged! üòâ'];
                addChatMessage(fakeUsers[Math.floor(Math.random() * fakeUsers.length)], fakeMessages[Math.floor(Math.random() * fakeMessages.length)], 'üí¨', 'user');
            }

            // Simulate leaderboard updates periodically
            // updateLeaderboard(); // Now called by its own interval

            // Update fake activity banner
            updateFakeActivityBanner();
        }

         // Update Fake Activity Banner
         function updateFakeActivityBanner() {
             const watchers = Math.floor(Math.random() * 50) + 20; // 20-70 watchers
             const betting10x = Math.floor(Math.random() * 10); // 0-10 betting 10x
             const winsHit = Math.floor(Math.random() * 5); // 0-5 wins

             document.getElementById('activityWatchers').textContent = `üéØ ${watchers} watching`;
             document.getElementById('activityBetting').textContent = `${betting10x} betting 10x`;
             document.getElementById('activityWins').textContent = `${winsHit} wins just hit!`;
         }

         // Show 10x Hit Banner (Fake)
         function showTenXHitBanner() {
             const banner = document.getElementById('tenXHitBanner');
             banner.style.display = 'block';
             playSound('win_10x'); // Play a sound effect
             setTimeout(() => {
                 banner.style.display = 'none';
             }, 3000); // Hide after 3 seconds
         }


        // Add Bet Entry to Feed
        function addBetEntry(user, amount, multiplier) {
            const feed = document.getElementById('betFeed');
            const entry = document.createElement('div');
            entry.className = 'bet-entry';
            entry.innerHTML = `<i class="fas fa-dice"></i> <span class="user">${user}</span> bet <span class="amount">‚óé${amount.toFixed(2)}</span> on <span class="multiplier">${multiplier}</span>`;
            feed.appendChild(entry);
            feed.scrollTop = feed.scrollHeight; // Auto-scroll to bottom
        }

        // Add Chat Message to Feed
        function addChatMessage(user, text, reaction, type) { // Added type parameter
            const chatFeed = document.getElementById('chatFeed'); // Use chatFeed div
            const msg = document.createElement('div');
            msg.className = 'chat-message';
            const userClass = type === 'system' ? 'system' : 'user';
            msg.innerHTML = `<i class="fas ${type === 'system' ? 'fa-robot' : 'fa-user'}"></i> <span class="${userClass}">${user}:</span> ${text} <span class="reaction">${reaction}</span>`;
            chatFeed.appendChild(msg); // Append to chatFeed
            chatFeed.scrollTop = chatFeed.scrollHeight; // Auto-scroll to bottom
        }

        // Send Chat
        function sendChat() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;

            // Handle /tip command (mock)
            if (text.startsWith('/tip ')) {
                 const parts = text.split(' ');
                 if (parts.length === 3) {
                     const targetUser = parts[1];
                     const tipAmount = parseFloat(parts[2]);
                     if (!isNaN(tipAmount) && tipAmount > 0 && tokensEarned >= tipAmount && !isGuestMode) { // Cannot tip in guest mode
                         tokensEarned -= tipAmount;
                         localStorage.setItem('solroulette_spin_tokens', tokensEarned);
                         addChatMessage('System', `${user.name} tipped ${targetUser} ${tipAmount.toFixed(3)} $SPIN!`, 'üí∏', 'system');
                         updateUIDebounced();
                     } else if (isGuestMode) {
                         showMessageBox('Guest Mode Limitation', 'Connect your wallet to tip $SPIN.');
                     }
                     else {
                         showMessageBox('Tip Failed', 'Invalid tip amount or insufficient $SPIN.');
                     }
                 } else {
                     showMessageBox('Invalid Command', 'Usage: /tip [username] [amount]');
                 }
            } else {
                addChatMessage(user.name, text, 'üöÄ', 'user'); // Use 'user' type
                xp += 5; // Earn XP for chatting
                checkAchievements();
                updateUIDebounced();
            }

            input.value = '';
            resetIdleTimer(); // Reset idle timer on chat
            stopAutoDemo(); // Stop auto demo on chat interaction
        }

        // Place Bet
        function placeBet() {
            playSound('click');
            if (navigator.vibrate) navigator.vibrate(50);

            if (!currentBet.multiplier) {
                showMessageBox('No Multiplier Selected', 'Select a multiplier!');
                 if (navigator.vibrate) navigator.vibrate(200);
                return;
            }
            const amount = parseFloat(document.getElementById('betSlider').value);

            // Auto Refill Fake SOL if balance is too low in guest mode
            if (isGuestMode && walletBalance < 0.01 && window.autoRefill) { // Check autoRefill flag
                 refillFakeSol(); // Auto refill
                 // Now check if the bet is possible after refill
                 if (walletBalance < amount) {
                     showMessageBox('Insufficient Balance', 'Insufficient SOL balance even after refill!');
                     if (navigator.vibrate) navigator.vibrate(200);
                     return;
                 }
            } else if (isGuestMode && walletBalance < 0.01) { // Manual refill needed
                 openRefillFakeSolModal();
                 return; // Prevent placing bet if balance is too low
            }


            if (walletBalance < amount) {
                // Show refill modal if in guest mode and balance is low
                if (isGuestMode) {
                    openRefillFakeSolModal();
                } else {
                     showMessageBox('Insufficient Balance', 'Insufficient SOL balance!');
                }
                 if (navigator.vibrate) navigator.vibrate(200);
                return;
            }
            if (isSpinning || spinTimer <= 3) {
                showMessageBox('Betting Closed', 'Betting is closed for this round!');
                 if (navigator.vibrate) navigator.vibrate(200);
                return;
            }

            // Deduct bet amount immediately
            walletBalance -= amount;
            totalWagered += amount;
            currentBet.amount = amount; // Store the actual bet amount

            // Add user's bet to the list of bets for the current round
            playerBets.push({ user: user.name, amount, multiplier: currentBet.multiplier, isUser: true }); // Mark user's bet

            // Add user's bet to the live feed
            addBetEntry('You', amount, currentBet.multiplier); // Pass amount as number for formatting in addBetEntry


            xp += 10; // Earn XP for placing a bet
            checkAchievements();
            updateUIDebounced();

            // Disable bet controls until next round starts
            document.getElementById('placeBetBtn').disabled = true;
            document.getElementById('placeBetBtn').textContent = 'Bet Placed!';
            document.querySelectorAll('.multiplier-btn').forEach(btn => {
                 btn.disabled = true;
                 btn.title = 'Betting is closed'; // Update tooltip
            });
            document.getElementById('betSlider').disabled = true;
             document.getElementById('betSlider').title = 'Betting is closed'; // Update tooltip

             // Dismiss onboarding tooltip/glow if active
             dismissOnboarding();


            // Show mock transaction feedback (only for real wallet, or maybe simulate for guest?)
            if (!isGuestMode) {
                 addChatMessage('System', `Transaction sent: ‚óé${amount.toFixed(2)} on ${currentBet.multiplier}`, '‚úÖ', 'system');
             } else {
                 addChatMessage('System', `Fake transaction sent: ‚óé${amount.toFixed(2)} on ${currentBet.multiplier}`, '‚úÖ', 'system');
             }


            // Save state to localStorage based on mode
            if (isGuestMode) {
                 localStorage.setItem('solroulette_guest_balance', walletBalance);
                 localStorage.setItem('solroulette_guest_xp', xp);
                 localStorage.setItem('solroulette_guest_tokens', tokensEarned);
                 localStorage.setItem('solroulette_guest_total_wagered', totalWagered);
                 localStorage.setItem('solroulette_guest_win_streak', winStreak);
                 localStorage.setItem('solroulette_guest_ten_x_wins', tenXWins);
                 localStorage.setItem('solroulette_guest_achievements', JSON.stringify([...achievementsUnlocked]));
                 guestSpinCount++; // Increment guest spin count
                 localStorage.setItem('solroulette_guest_spin_count', guestSpinCount);
                 localStorage.setItem('solroulette_fake_winnings_total', fakeWinningsTotal); // Save fake winnings

             } else {
                 localStorage.setItem('solroulette_wallet_balance', walletBalance); // Save balance
                 localStorage.setItem('solroulette_total_wagered', totalWagered);
                 localStorage.setItem('solroulette_xp', xp);
                 localStorage.setItem('solroulette_level', level);
                 localStorage.setItem('solroulette_spin_tokens', tokensEarned);
                 localStorage.setItem('solroulette_win_streak', winStreak);
                 localStorage.setItem('solroulette_ten_x_wins', tenXWins);
                 localStorage.setItem('solroulette_achievements', JSON.stringify([...achievementsUnlocked]));
                 localStorage.setItem('solroulette_wallet', user.wallet);
                 localStorage.setItem('solroulette_user_name', user.name);
                 localStorage.setItem('solroulette_user_avatar', user.avatar);
             }
             localStorage.setItem('solroulette_is_guest', isGuestMode); // Save guest mode status


            // Start the spin animation immediately after placing the bet
            spinWheel();
            resetIdleTimer(); // Reset idle timer on spin
            stopAutoDemo(); // Stop auto demo on manual spin
        }

         // Function to handle the result of the spin
         function handleSpinResult() {
             let userWinAmount = 0;
             let userLostAmount = 0; // Track lost amount for result modal
             let userWon = false;
             let winningMultiplier = null; // Determine the actual winning multiplier
             let userPickedMultiplier = currentBet.multiplier; // Store what the user picked

             // Find the segment the wheel landed on based on final rotation
             const finalRotationNormalized = (currentWheelRotation % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI); // Normalize to 0-2PI

              // Find the segment that corresponds to the final rotation angle
             const landedSegment = segments.find(segment => {
                 const effectiveAngle = (finalRotationNormalized + Math.PI / 2) % (2 * Math.PI);
                 let start = segment.startAngle;
                 let end = segment.endAngle;

                 if (start > end) { // Handles segments that cross the 0/2PI boundary
                     return effectiveAngle >= start || effectiveAngle < end;
                 } else {
                     return effectiveAngle >= start && effectiveAngle < end;
                 }
             });

             if (landedSegment) {
                 winningMultiplier = landedSegment.multiplier;
             } else {
                 console.error("Could not determine winning segment!");
                 winningMultiplier = '1.5x'; // Default to lowest multiplier
             }

             // Add outcome to recent spins
             recentSpins.unshift({ multiplier: winningMultiplier, won: userPickedMultiplier === winningMultiplier }); // Add to the beginning
             if (recentSpins.length > 10) {
                 recentSpins.pop(); // Keep only the last 10
             }
             localStorage.setItem('solroulette_recent_spins', JSON.stringify(recentSpins)); // Save recent spins
             updateRecentSpinsDisplay();


             playerBets.forEach(bet => {
                 const multiplierValue = parseFloat(bet.multiplier);
                 if (bet.multiplier === winningMultiplier) {
                     const winnings = bet.amount * multiplierValue;
                     // If the bet was by the current user
                     if (bet.isUser) {
                         walletBalance += winnings;
                         userWinAmount = winnings;
                         userWon = true;
                         addChatMessage('System', `${user.name} won ‚óé${winnings.toFixed(2)} on ${winningMultiplier}! üéâ`, 'üéâ', 'system'); // Win notification in chat
                         if (isGuestMode) {
                             fakeWinningsTotal += winnings - bet.amount; // Track net fake winnings
                             localStorage.setItem('solroulette_fake_winnings_total', fakeWinningsTotal);
                         }
                     } else {
                         addChatMessage('System', `@${bet.user} won on ${winningMultiplier}! üéâ`, 'üéâ', 'system');
                     }
                 } else {
                     if (bet.isUser) {
                         addChatMessage('System', `${user.name} busted on ${bet.multiplier}! üíÄ`, 'üíÄ', 'system'); // Loss notification in chat
                         lastLossBet = { amount: bet.amount, multiplier: bet.multiplier }; // Store loss details
                         userLostAmount = bet.amount; // Track lost amount
                         if (isGuestMode) {
                             fakeWinningsTotal -= bet.amount; // Deduct lost amount from fake winnings
                             localStorage.setItem('solroulette_fake_winnings_total', fakeWinningsTotal);
                         }
                     } else {
                         addChatMessage('System', `@${bet.user} busted! üò≠`, 'üò≠', 'system'); // Rage emoji for others' losses
                     }
                 }
             });

             // Handle user's win/loss feedback
             if (userWon) {
                 playSound('win');
                 triggerMoneyRain(); // Trigger money rain on win
                 if (parseFloat(winningMultiplier) >= 5) {
                     playSound('win_10x'); // Play special sound for 5x+ wins
                     showFlash('win-10x'); // Yellow flash for 10x+
                     tenXWins++; // Increment 10x wins count
                 } else {
                      showFlash('win'); // Green flash for other wins
                 }
                 if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]); // Win vibration pattern
                 showConfetti(); // Show confetti on win
                 winStreak++;
                 lastLossBet = null; // Clear loss bet on win
                 if (parseFloat(winningMultiplier) >= 5) showShareModal(userWinAmount, winningMultiplier);

                 // Auto-populate chat input on win
                 document.getElementById('chatInput').value = `üî• Just hit ${winningMultiplier} on SolRoulette! üëë`;

             } else {
                 playSound('sad_trombone'); // Sad trombone for losses
                 showFlash('lose'); // Red flash for losses
                 if (navigator.vibrate) navigator.vibrate(300); // Loss vibration pattern
                 winStreak = 0;
                 // Show "Double or Nothing" prompt after a loss (only in real wallet mode)
                 if (!isGuestMode && user.wallet && lastLossBet) {
                     openDoubleOrNothingModal();
                 }
             }

             // Update tokens based on participation or win (only in real wallet mode)
             if (!isGuestMode) {
                 updateTokens(userWon ? 0.05 : 0.01);
             } else {
                 // Show guest mode toast after each spin in guest mode
                 showGuestModeToast();
                 // Check if fake balance is low after the spin result
                 if (walletBalance < 0.01 && !document.getElementById('refillFakeSolModal').classList.contains('visible')) {
                     openRefillFakeSolModal();
                 }
             }


             // Reset user's current bet state and enable controls
             currentBet = { multiplier: null, amount: 0 };
             document.getElementById('placeBetBtn').disabled = false;
             document.getElementById('placeBetBtn').textContent = 'Place Bet'; // Reset button text
             document.querySelectorAll('.multiplier-btn').forEach(btn => {
                 btn.classList.remove('active'); // Deselect multiplier button
                 // Re-enable multiplier buttons for both guest and real users
                 btn.disabled = false;
                 // Update tooltip based on mode
                 btn.title = isGuestMode ? 'Using Fake SOL ‚Äì Real rewards require a wallet' : (user.wallet ? '' : 'Connect Wallet to Bet');
             });
             document.getElementById('betSlider').disabled = false; // Re-enable slider for both
             // Update tooltip based on mode
             document.getElementById('betSlider').title = isGuestMode ? 'Using Fake SOL ‚Äì Real rewards require a wallet' : (user.wallet ? '' : 'Connect Wallet to Bet');


             xp += 10; // Earn XP for completing a round
             checkAchievements();
             updateUIDebounced();

             // Save state to localStorage based on mode
             if (isGuestMode) {
                 localStorage.setItem('solroulette_guest_balance', walletBalance);
                 localStorage.setItem('solroulette_guest_xp', xp);
                 localStorage.setItem('solroulette_guest_tokens', tokensEarned);
                 localStorage.setItem('solroulette_guest_total_wagered', totalWagered);
                 localStorage.setItem('solroulette_guest_win_streak', winStreak);
                 localStorage.setItem('solroulette_guest_ten_x_wins', tenXWins);
                 localStorage.setItem('solroulette_guest_achievements', JSON.stringify([...achievementsUnlocked]));
                 localStorage.setItem('solroulette_guest_spin_count', guestSpinCount); // Save guest spin count
                 localStorage.setItem('solroulette_fake_winnings_total', fakeWinningsTotal); // Save fake winnings
             } else {
                 localStorage.setItem('solroulette_wallet_balance', walletBalance); // Save balance
                 localStorage.setItem('solroulette_total_wagered', totalWagered);
                 localStorage.setItem('solroulette_xp', xp);
                 localStorage.setItem('solroulette_level', level);
                 localStorage.setItem('solroulette_spin_tokens', tokensEarned);
                 localStorage.setItem('solroulette_win_streak', winStreak);
                 localStorage.setItem('solroulette_ten_x_wins', tenXWins);
                 localStorage.setItem('solroulette_achievements', JSON.stringify([...achievementsUnlocked]));
                 localStorage.setItem('solroulette_wallet', user.wallet);
                 localStorage.setItem('solroulette_user_name', user.name);
                 localStorage.setItem('solroulette_user_avatar', user.avatar);
             }
             localStorage.setItem('solroulette_is_guest', isGuestMode); // Save guest mode status


             // Check low balance after result (only in real wallet mode)
             if (!isGuestMode) {
                 checkLowBalance();
             } else {
                 document.getElementById('lowBalanceAlert').style.display = 'none'; // Hide alert in guest mode
             }

             // Show result modal
             showResultModal(userPickedMultiplier, winningMultiplier, userWon, userWinAmount, userLostAmount); // Pass lost amount

             // Show "Enjoying the game?" modal after 3 guest spins
             if (isGuestMode && guestSpinCount >= 3 && localStorage.getItem('solroulette_guest_modal_shown') === null) {
                 showMessageBox('Enjoying the game?', 'Connect your wallet to win real rewards!');
                 localStorage.setItem('solroulette_guest_modal_shown', 'true'); // Set flag so it only shows once
             }

             // Restart auto demo after a short delay if it was active
             if (isAutoDemo) {
                 setTimeout(startAutoDemo, 3000); // Wait 3 seconds before next auto spin
             }
         }

         // Show Result Modal
         function showResultModal(picked, landed, won, winAmount, lostAmount) { // Added lostAmount parameter
             const modal = document.getElementById('resultModal');
             const title = document.getElementById('resultModalTitle');
             const message = document.getElementById('resultModalMessage');
             const spinAgainBtn = document.getElementById('resultModalSpinAgainBtn');

             title.classList.remove('win', 'lose'); // Reset classes

             if (won) {
                 title.textContent = 'You Won!';
                 title.classList.add('win');
                 message.textContent = `You picked ${picked}. Landed on ${landed}. You won ‚óé${winAmount.toFixed(2)}.`;
             } else {
                 title.textContent = 'You Lost!';
                 title.classList.add('lose');
                 message.textContent = `You picked ${picked}. Landed on ${landed}. You lost ‚óé${lostAmount.toFixed(2)}.`; // Use lostAmount
             }

             // Event listener for "Spin Again" button (already attached)
             // spinAgainBtn.onclick = () => { closeResultModal(); };

             modal.classList.add('visible');
         }

         function closeResultModal() {
              playSound('click');
              if (navigator.vibrate) navigator.vibrate(50);
              document.getElementById('resultModal').classList.remove('visible');
         }

         // Refill Fake SOL Modal
         function openRefillFakeSolModal() {
             document.getElementById('refillFakeSolModal').classList.add('visible');
             resetIdleTimer(); // Reset idle timer on modal open
         }

         function closeRefillFakeSolModal() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             document.getElementById('refillFakeSolModal').classList.remove('visible');
             resetIdleTimer(); // Reset idle timer on modal close
         }

         function refillFakeSol() {
             playSound('win'); // Use win sound for positive reinforcement
             if (navigator.vibrate) navigator.vibrate([50, 50]);
             walletBalance = 500; // Reset fake balance
             localStorage.setItem('solroulette_guest_balance', walletBalance);
             // Optionally reset other guest stats here if desired
             // localStorage.setItem('solroulette_guest_xp', '0');
             // ... etc.
             showMessageBox('Refilled!', 'Your fake SOL balance has been refilled.');
             updateUIDebounced();
             closeRefillFakeSolModal();
         }


        // Wheel Spin (Initiation)
        function spinWheel() {
            isSpinning = true;
            playSound('whoosh', 0.7); // Play whoosh sound

            const wheel = document.getElementById('rouletteCanvas');
            const pointer = document.getElementById('pointer');
            const container = document.getElementById('wheelContainer');

            // Determine the actual winning multiplier (mock logic with psychological bait)
            let actualWinningMultiplier;
            const lastSpinMultiplier = recentSpins.length > 0 ? recentSpins[0].multiplier : null;

            // Implement psychological bait logic
            if (lastSpinMultiplier === '1.5x' && Math.random() < 0.6) { // 60% chance 3x follows 1.5x
                actualWinningMultiplier = '3x';
            } else if (lastSpinMultiplier === '10x') { // 10x never lands twice in a row
                 // Choose randomly from other multipliers
                 const otherMultipliers = segments.filter(seg => seg.multiplier !== '10x').map(seg => seg.multiplier);
                 actualWinningMultiplier = otherMultipliers[Math.floor(Math.random() * otherMultipliers.length)];
            }
             else {
                // Default random logic
                const result = Math.random();
                actualWinningMultiplier = result < 0.3 ? '1.5x' :
                                          result < 0.5 ? '2x' :
                                          result < 0.7 ? '3x' :
                                          result < 0.85 ? '5x' : '10x';
            }


            // Determine if it's a near-miss fakeout (20% chance)
            isNearMiss = Math.random() < 0.2 && actualWinningMultiplier !== '10x'; // Don't fakeout on actual 10x win

            // Calculate the target rotation based on the actual winning multiplier
            targetRotation = calculateCanvasTargetRotation(actualWinningMultiplier);

            spinStartTime = null; // Reset start time for requestAnimationFrame
            spinAnimationId = requestAnimationFrame(animateWheel); // Start the animation loop

            container.classList.add('bounce');
            pointer.classList.add('vibrate');

            // Remove bounce/vibrate after the animation duration
            setTimeout(() => {
                 container.classList.remove('bounce');
                 pointer.classList.remove('vibrate');
                 playSound('clank'); // Play clank sound on landing
            }, spinDuration);
        }


        // Update Tokens
        function updateTokens(amount) {
            tokensEarned += amount;
            localStorage.setItem('solroulette_spin_tokens', tokensEarned);
            document.getElementById('tokenCount').textContent = tokensEarned.toFixed(3);
            document.getElementById('shopSpinBalance').textContent = tokensEarned.toFixed(3); // Update shop balance
            document.getElementById('tokenNotification').style.display = 'flex';

            const float = document.createElement('div');
            float.className = 'token-float';
            float.textContent = `+${amount.toFixed(3)} $SPIN`;
            // Position the float near the notification
            const notificationRect = document.getElementById('tokenNotification').getBoundingClientRect();
            float.style.left = `${notificationRect.left + notificationRect.width / 2}px`;
            float.style.top = `${notificationRect.top - 10}px`; // Start above notification
            document.body.appendChild(float); // Append to body to float freely
            setTimeout(() => float.remove(), 1500);
        }

        // Claim Tokens
        function openClaimModal() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);

            if (isGuestMode) {
                 showMessageBox('Guest Mode Limitation', 'Connect your wallet to claim $SPIN tokens.');
                 return;
            }
            if (tokensEarned <= 0) {
                 showMessageBox('No Tokens', 'No $SPIN tokens to claim.');
                 return;
            }
            // In a real app, this would interact with a smart contract
            showMessageBox('Tokens Claimed', `Claimed ${tokensEarned.toFixed(3)} $SPIN! (Mock Claim)`);
            tokensEarned = 0;
            localStorage.setItem('solroulette_spin_tokens', tokensEarned);
            document.getElementById('tokenCount').textContent = tokensEarned.toFixed(3);
            document.getElementById('shopSpinBalance').textContent = tokensEarned.toFixed(3);
            document.getElementById('tokenNotification').style.display = 'none';
            updateUIDebounced();
        }

        // Achievements
        function checkAchievements() {
            const achievements = [
                { name: 'First Bust', condition: winStreak === 0 && totalWagered > 0, icon: 'üíÄ' },
                { name: 'Hit 10x', condition: tenXWins >= 1, icon: 'üåü' },
                { name: '10 Spins', condition: guestSpinCount >= 10, icon: 'üé°' }, // Use guestSpinCount for this
                { name: 'High Roller', condition: totalWagered >= 50, icon: 'üí∞' },
                 { name: 'Lucky Streak x3', condition: winStreak >= 3, icon: 'üî•' },
                 { name: 'Chatty', condition: xp >= 50, icon: 'üí¨' }, // XP from chatting
                 { name: 'Daily Grinder', condition: dailyBonusDay >= 5, icon: 'üóìÔ∏è' } // Based on daily logins
            ];

            achievements.forEach(ach => {
                // Check if condition is met AND achievement is not already unlocked
                if (ach.condition && !achievementsUnlocked.has(ach.name)) {
                    unlockAchievement(ach.name, ach.icon);
                }
            });
             localStorage.setItem('solroulette_achievements', JSON.stringify([...achievementsUnlocked]));
        }

        function unlockAchievement(name, icon) {
            achievementsUnlocked.add(name);
            const container = document.getElementById('achievementContainer');
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `
                <div class="badge-icon">${icon}</div>
                <div>
                    <div style="font-weight: bold;">Achievement Unlocked!</div>
                    <div>${name}</div>
                </div>
            `;
            container.appendChild(popup);
            setTimeout(() => popup.remove(), 4000); // Popup disappears after 4 seconds
             localStorage.setItem('solroulette_achievements', JSON.stringify([...achievementsUnlocked])); // Save updated achievements
        }

        // Flash Screen
        function showFlash(type) {
            const flash = document.getElementById('flashScreen');
            flash.className = `flash-screen ${type}`;
            setTimeout(() => flash.className = 'flash-screen', 100); // Flash duration
        }

         // Confetti Effect
         function showConfetti() {
            const confettiColors = ['var(--primary)', 'var(--accent)', 'var(--success)', 'var(--danger)'];
            const confettiCount = 100; // More confetti
            const confettiShapes = ['square', 'circle', 'triangle', 'star']; // Variable shapes

            for (let i = 0; i < confettiCount; i++) {
                 const confetti = document.createElement('div');
                 const shape = confettiShapes[Math.floor(Math.random() * confettiShapes.length)];
                 confetti.className = `confetti ${shape}`; // Add shape class for styling
                 confetti.style.left = `${Math.random() * 100}vw`; // Random horizontal position
                 confetti.style.top = `${Math.random() * -20}vh`; // Start above viewport
                 confetti.style.width = `${Math.random() * 10 + 5}px`; // Variable size
                 confetti.style.height = confetti.style.width; // Keep it square/circle initially
                 confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                 confetti.style.animationDelay = `${Math.random() * 1}s`; // Random delay
                 confetti.style.animationDuration = `${Math.random() * 2 + 1.5}s`; // Variable duration
                 document.body.appendChild(confetti);
                 // Remove confetti after animation
                 confetti.addEventListener('animationend', () => confetti.remove());
            }
         }

        // Share Modal
        function showShareModal(winnings, multiplier) {
             playSound('win_10x'); // Play a sound when share modal appears (celebration)
             if (navigator.vibrate) navigator.vibrate([50, 50]);

            document.getElementById('shareTitle').textContent = 'Big Win!';
            document.getElementById('shareMessage').textContent = `Just won ‚óé${winnings.toFixed(2)} on the ${multiplier} multiplier! Share your victory!`;
            const shareText = `Just won ‚óé${winnings.toFixed(2)} on ${multiplier} at SolRoulette LIVE! Spin now: ${user.referral} #SolRoulette #Solana #Crypto`;
            document.getElementById('shareText').value = shareText;
            document.getElementById('shareModal').classList.add('visible');
        }

        function copyShareText() {
            playSound('click');
            if (navigator.vibrate) navigator.vibrate(50);
            const shareText = document.getElementById('shareText');
            shareText.select();
            shareText.setSelectionRange(0, 99999); // For mobile devices
            try {
                document.execCommand('copy');
                showMessageBox('Copied!', 'Share link copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showMessageBox('Copy Failed', 'Failed to copy link. Please copy manually.');
            }
        }

         function tweetWin() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             const shareText = document.getElementById('shareText').value;
             const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`;
             window.open(twitterUrl, '_blank');
             closeShareModal();
         }

        function closeShareModal() {
            playSound('click');
            if (navigator.vibrate) navigator.vibrate(50);
            document.getElementById('shareModal').classList.remove('visible');
        }

         // Message Box (Custom Alert)
         function showMessageBox(title, message) {
             document.getElementById('messageBoxTitle').textContent = title;
             document.getElementById('messageBoxContent').textContent = message;
             document.getElementById('messageBox').classList.add('visible');
             resetIdleTimer(); // Reset idle timer on modal open
         }

         function closeMessageBox() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             document.getElementById('messageBox').classList.remove('visible');
             resetIdleTimer(); // Reset idle timer on modal close
         }

         // Profile Modal
         function openProfileModal() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             updateProfileModal(); // Update content before showing
             document.getElementById('profileModal').classList.add('visible');
             resetIdleTimer(); // Reset idle timer on modal open
             stopAutoDemo(); // Stop auto demo on modal open
         }

         function closeProfileModal() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             document.getElementById('profileModal').classList.remove('visible');
             resetIdleTimer(); // Reset idle timer on modal close
             // Restart auto demo if it was active before opening the modal (optional, depends on desired flow)
             // if (wasAutoDemoActive) startAutoDemo();
         }

         function updateProfileModal() {
             document.getElementById('profileAvatar').textContent = user.avatar;
             document.getElementById('profileName').textContent = user.name + (isGuestMode ? ' (Guest)' : ''); // Label guest mode
             document.getElementById('profileLevel').textContent = level;
             document.getElementById('profileXpFill').style.width = `${(xp % 100)}%`;
             document.getElementById('profileWallet').textContent = user.wallet ? user.wallet.slice(0, 6) + '...' + user.wallet.slice(-6) : 'Not Connected';
             document.getElementById('profileBalance').textContent = walletBalance.toFixed(2) + ' SOL' + (isGuestMode ? ' (Fake)' : ''); // Label fake balance
             document.getElementById('profileTotalWagered').textContent = totalWagered.toFixed(2) + ' SOL' + (isGuestMode ? ' (Fake)' : ''); // Label fake stats
             document.getElementById('profileWinStreak').textContent = winStreak + (isGuestMode ? ' (Fake)' : '');
             document.getElementById('profileTenXWins').textContent = tenXWins + (isGuestMode ? ' (Fake)' : '');

             // Show fake winnings only in guest mode
             const fakeWinningsElement = document.getElementById('profileFakeWinnings');
             const fakeWinningsTotalElement = document.getElementById('fakeWinningsTotal');
             if (isGuestMode) {
                 fakeWinningsElement.style.display = 'block';
                 fakeWinningsTotalElement.textContent = fakeWinningsTotal.toFixed(2);
             } else {
                 fakeWinningsElement.style.display = 'none';
             }

             // Show/Hide Guest Reset Button
             const resetGuestBtn = document.getElementById('resetGuestProgressBtn');
             if (isGuestMode) {
                 resetGuestBtn.style.display = 'block';
             } else {
                 resetGuestBtn.style.display = 'none';
             }


             // Update achievements grid
             const achievementsGrid = document.getElementById('profileAchievementsGrid');
             achievementsGrid.innerHTML = ''; // Clear existing
             const allAchievements = [
                 { name: 'First Bust', icon: 'üíÄ' },
                 { name: 'Hit 10x', condition: tenXWins >= 1, icon: 'üåü' },
                 { name: '10 Spins', condition: guestSpinCount >= 10, icon: 'üé°' }, // Use guestSpinCount for this
                 { name: 'High Roller', condition: totalWagered >= 50, icon: 'üí∞' },
                 { name: 'Lucky Streak x3', condition: winStreak >= 3, icon: 'üî•' },
                 { name: 'Chatty', condition: xp >= 50, icon: 'üí¨' }, // XP from chatting
                 { name: 'Daily Grinder', condition: dailyBonusDay >= 5, icon: 'üóìÔ∏è' } // Based on daily logins
             ];

             allAchievements.forEach(ach => {
                 const badge = document.createElement('div');
                 badge.className = 'badge-icon'; // Reuse badge-icon style
                 if (achievementsUnlocked.has(ach.name)) {
                     badge.textContent = ach.icon;
                     badge.title = ach.name; // Tooltip for unlocked achievements
                 } else {
                     badge.textContent = '?'; // Placeholder for locked achievements
                     badge.style.opacity = 0.5;
                     badge.title = 'Locked';
                 }
                 achievementsGrid.appendChild(badge);
             });
         }

         function copyReferralLink() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             const referralInput = document.getElementById('referralLinkInput');
             referralInput.select();
             referralInput.setSelectionRange(0, 99999); // For mobile devices
             try {
                 document.execCommand('copy');
                 showMessageBox('Copied!', 'Referral link copied to clipboard!');
             } catch (err) {
                 console.error('Failed to copy referral link: ', err);
                 showMessageBox('Copy Failed', 'Failed to copy referral link. Please copy manually.');
             }
         }

         function generateReferralCode() {
             const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
             let code = '';
             for (let i = 0; i < 8; i++) {
                 code += chars.charAt(Math.floor(Math.random() * chars.length));
             }
             const referralLink = `https://solroulette.live?ref=${code}`;
             localStorage.setItem('solroulette_referral_code', referralLink);
             return referralLink;
         }

         // Check for referral code in URL on load
         function checkReferralCode() {
             const urlParams = new URLSearchParams(window.location.search);
             const ref = urlParams.get('ref');
             if (ref) {
                 localStorage.setItem('solroulette_referred_by', ref);
                 console.log(`Referred by: ${ref}`); // Log for tracking
                 // You might want to award the referrer here in a real app
             }
         }

         // Reset Guest Progress
         function resetGuestProgress() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             if (confirm('Are you sure you want to reset your guest progress? This cannot be undone.')) {
                 // Clear only guest-specific localStorage items
                 localStorage.removeItem('solroulette_is_guest');
                 localStorage.removeItem('solroulette_guest_balance');
                 localStorage.removeItem('solroulette_guest_xp');
                 localStorage.removeItem('solroulette_guest_tokens');
                 localStorage.removeItem('solroulette_guest_total_wagered');
                 localStorage.removeItem('solroulette_guest_win_streak');
                 localStorage.removeItem('solroulette_guest_ten_x_wins');
                 localStorage.removeItem('solroulette_guest_achievements');
                 localStorage.removeItem('solroulette_guest_spin_count');
                 localStorage.removeItem('solroulette_guest_last_login');
                 localStorage.removeItem('solroulette_guest_daily_bonus_day');
                 localStorage.removeItem('solroulette_fake_winnings_total');
                 localStorage.removeItem('solroulette_fake_intro_shown'); // Reset onboarding flag too
                 localStorage.removeItem('solroulette_guest_modal_shown'); // Reset enjoyment modal flag
                 localStorage.removeItem('solroulette_onboarding_shown'); // Reset onboarding tooltip flag

                 location.reload(); // Reload the page to restart in fresh guest mode
             }
         }


         // Shop Modal
         function openShopModal() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             document.getElementById('shopSpinBalance').textContent = tokensEarned.toFixed(3);
             document.getElementById('shopModal').classList.add('visible');
             resetIdleTimer(); // Reset idle timer on modal open
             stopAutoDemo(); // Stop auto demo on modal open
         }

         function closeShopModal() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             document.getElementById('shopModal').classList.remove('visible');
             resetIdleTimer(); // Reset idle timer on modal close
             // Restart auto demo if it was active before opening the modal (optional)
         }

         function buyShopItem(itemId, cost) {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             if (isGuestMode) {
                 showMessageBox('Guest Mode Limitation', 'Connect your wallet to buy shop items.');
                 return;
             }
             if (tokensEarned >= cost) {
                 tokensEarned -= cost;
                 localStorage.setItem('solroulette_spin_tokens', tokensEarned);
                 document.getElementById('shopSpinBalance').textContent = tokensEarned.toFixed(3);
                 showMessageBox('Purchase Successful', `You bought ${itemId}! (Mock Purchase)`);
                 updateUIDebounced(); // Update UI including token balance

                 // Apply item effect (mock)
                 if (itemId === 'rocket_avatar') {
                     user.avatar = 'üöÄ';
                     localStorage.setItem('solroulette_user_avatar', user.avatar);
                     updateUIDebounced(); // Update avatar in header
                 } else if (itemId === 'fire_emote') {
                     // Unlock fire emote in chat (mock - would need chat input enhancement)
                     addChatMessage('System', `${user.name} unlocked the üî• emote!`, 'üéâ', 'system');
                 }

             } else {
                 showMessageBox('Purchase Failed', 'Not enough $SPIN tokens.');
             }
         }

         // Daily Login Bonus
         function checkDailyBonus() {
             const today = new Date().toDateString();
             const lastBonusDate = localStorage.getItem(isGuestMode ? 'solroulette_guest_last_login' : 'solroulette_last_login');

             if (lastBonusDate !== today) {
                 dailyBonusDay++;
                 localStorage.setItem(isGuestMode ? 'solroulette_guest_last_login' : 'solroulette_last_login', today);
                 localStorage.setItem(isGuestMode ? 'solroulette_guest_daily_bonus_day' : 'solroulette_daily_bonus_day', dailyBonusDay);

                 const bonusAmount = isGuestMode ? 25 : (dailyBonusDay === 7 ? 0.1 : 0.01); // 25 fake SOL for guests
                 const bonusCurrency = isGuestMode ? 'SOL' : (dailyBonusDay === 7 ? 'SOL' : '$SPIN');

                 document.getElementById('dailyBonusDay').textContent = dailyBonusDay;
                 document.getElementById('dailyBonusAmount').textContent = `Reward: ‚óé${bonusAmount.toFixed(bonusCurrency === 'SOL' ? 2 : 3)} ${bonusCurrency}`;

                 openDailyBonusModal();
             }
         }

         function openDailyBonusModal() {
             document.getElementById('dailyBonusModal').classList.add('visible');
             resetIdleTimer(); // Reset idle timer on modal open
             stopAutoDemo(); // Stop auto demo on modal open
         }

         function closeDailyBonusModal() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             document.getElementById('dailyBonusModal').classList.remove('visible');
             resetIdleTimer(); // Reset idle timer on modal close
             // Restart auto demo if it was active before opening the modal (optional)
         }

         function claimDailyBonus() {
             playSound('win');
             if (navigator.vibrate) navigator.vibrate([50, 50]);
             const bonusAmount = isGuestMode ? 25 : (dailyBonusDay === 7 ? 0.1 : 0.01); // 25 fake SOL for guests
             const bonusCurrency = isGuestMode ? 'SOL' : (dailyBonusDay === 7 ? 'SOL' : '$SPIN');

             if (isGuestMode) {
                 walletBalance += bonusAmount; // Add to fake balance
                 localStorage.setItem('solroulette_guest_balance', walletBalance);
                 showMessageBox('Bonus Claimed!', `Claimed ‚óé${bonusAmount.toFixed(2)} Fake SOL!`);
             } else if (bonusCurrency === 'SOL') {
                 walletBalance += bonusAmount;
                 localStorage.setItem('solroulette_wallet_balance', walletBalance); // Save real balance
                 showMessageBox('Bonus Claimed!', `Claimed ${bonusAmount} SOL!`);
             } else {
                 tokensEarned += bonusAmount;
                 localStorage.setItem('solroulette_spin_tokens', tokensEarned); // Save real tokens
                 showMessageBox('Bonus Claimed!', `Claimed ${bonusAmount} $SPIN!`);
             }

             // Reset daily bonus day after claiming day 7
             if (dailyBonusDay === 7) {
                 dailyBonusDay = 0;
                 localStorage.setItem(isGuestMode ? 'solroulette_guest_daily_bonus_day' : 'solroulette_daily_bonus_day', dailyBonusDay);
             }

             checkAchievements(); // Check if daily grinder achievement is unlocked
             updateUIDebounced();
             closeDailyBonusModal();
         }

         // Leaderboard (Mock Data with Tabs)
         function updateLeaderboard() {
             const leaderboardContent = document.getElementById('leaderboardContent');

             // Mock Leaderboard Data (can be made more dynamic)
             const mockLeaderboard = {
                 wager: [
                     { name: user.name, value: (isGuestMode ? totalWagered : totalWagered).toFixed(2) + ' SOL', avatar: user.avatar }, // Show fake wager in guest mode
                     { name: 'WhaleShark', value: '5000 SOL', avatar: 'üêã' },
                     { name: 'GambaKing', value: '3000 SOL', avatar: 'üëë' },
                      { name: 'SolDegen', value: '1500 SOL', avatar: 'üòé' },
                      { name: 'CryptoChad', value: '1000 SOL', avatar: 'üìà' },
                      { name: 'DiamondHands', value: '800 SOL', avatar: 'üíé' },
                      { name: 'PaperHands', value: '500 SOL', avatar: 'üìâ' }
                 ],
                 streak: [
                     { name: user.name, value: winStreak, avatar: user.avatar },
                     { name: 'LuckyLuke', value: 15, avatar: 'üçÄ' },
                     { name: 'StreakMaster', value: 10, avatar: 'üî•' },
                      { name: 'WinGod', value: 8, avatar: '‚ú®' },
                      { name: 'HotHand', value: 6, avatar: 'üå∂Ô∏è' },
                      { name: 'Consistent', value: 5, avatar: '‚úÖ' },
                      { name: 'NeverLose', value: 4, avatar: 'üõ°Ô∏è' }
                 ],
                 '10x': [
                     { name: user.name, value: tenXWins, avatar: user.avatar },
                     { name: 'TenXHunter', value: 25, avatar: 'üéØ' },
                     { name: 'JackpotJoe', value: 18, avatar: 'üí∞' },
                      { name: 'BigWinner', value: 12, avatar: 'üèÜ' },
                      { name: 'MoonApe', value: 9, avatar: 'üåï' },
                      { name: 'StarChaser', value: 7, avatar: 'üåü' },
                      { name: 'Legend', value: 5, avatar: 'üëë' }
                 ]
             };

             // Update content for each tab
             Object.keys(mockLeaderboard).forEach(tabId => {
                 const tabContentDiv = leaderboardContent.querySelector(`.leaderboard-content-tab[data-tab="${tabId}"]`);
                 if (tabContentDiv) {
                     tabContentDiv.innerHTML = ''; // Clear existing content
                     mockLeaderboard[tabId].forEach(entry => {
                         const entryDiv = document.createElement('div');
                         entryDiv.className = 'leaderboard-entry';
                         entryDiv.innerHTML = `
                             <span class="user">
                                 ${entry.avatar} ${entry.name}:
                             </span>
                             <span class="value">${entry.value}</span>
                         `;
                         tabContentDiv.appendChild(entryDiv);
                     });
                 }
             });
         }

         // Leaderboard Tab Switching
         document.querySelectorAll('.leaderboard-tab').forEach(tab => {
             tab.addEventListener('click', () => {
                 document.querySelectorAll('.leaderboard-tab').forEach(t => t.classList.remove('active'));
                 tab.classList.add('active');
                 const targetTab = tab.dataset.tab;
                 document.querySelectorAll('.leaderboard-content-tab').forEach(content => {
                     content.classList.remove('active');
                     if (content.dataset.tab === targetTab) {
                         content.classList.add('active');
                     }
                 });
             });
         });


         // Low Balance Alert
         function checkLowBalance() {
             if (!isGuestMode && user.wallet && walletBalance < 0.5) { // Only show in real wallet mode
                 document.getElementById('lowBalanceAlert').style.display = 'block';
             } else {
                 document.getElementById('lowBalanceAlert').style.display = 'none';
             }
         }

         function topUpWallet() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             // Mock Top Up
             walletBalance += 5; // Add 5 SOL mock
             localStorage.setItem('solroulette_wallet_balance', walletBalance);
             showMessageBox('Mock Top Up', '5 SOL added to your balance!');
             updateUIDebounced();
             checkLowBalance(); // Re-check balance after top up
         }

         // Double or Nothing
         function openDoubleOrNothingModal() {
             document.getElementById('doubleOrNothingModal').classList.add('visible');
             resetIdleTimer(); // Reset idle timer on modal open
             stopAutoDemo(); // Stop auto demo on modal open
         }

         function closeDoubleOrNothingModal() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             document.getElementById('doubleOrNothingModal').classList.remove('visible');
             resetIdleTimer(); // Reset idle timer on modal close
             // Restart auto demo if it was active before opening the modal (optional)
         }

         function tryAgainBet() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             if (lastLossBet) {
                 // Attempt to place the same bet again
                 // Need to ensure betting is open and user has enough balance
                 if (!isSpinning && spinTimer > 3 && walletBalance >= lastLossBet.amount) {
                     // Set current bet to the last loss bet details
                     currentBet.multiplier = lastLossBet.multiplier;
                     document.getElementById('betSlider').value = lastLossBet.amount; // Set slider value
                     // Find and activate the corresponding multiplier button (UI only)
                     document.querySelectorAll('.multiplier-btn').forEach(btn => {
                         btn.classList.remove('active');
                         if (btn.dataset.multiplier === currentBet.multiplier) {
                             btn.classList.add('active');
                         }
                     });
                     updateUIDebounced(); // Update bet value display

                     // Place the bet
                     placeBet();

                     lastLossBet = null; // Clear last loss bet after attempting "Try Again"
                     closeDoubleOrNothingModal(); // Close the modal
                 } else if (isSpinning || spinTimer <= 3) {
                     showMessageBox('Betting Closed', 'Betting is closed for this round!');
                 } else if (walletBalance < lastLossBet.amount) {
                     showMessageBox('Insufficient Balance', 'Not enough SOL to try again.');
                 } else {
                     // Should not happen with the above checks, but as a fallback
                     showMessageBox('Try Again Failed', 'Could not place the bet. Please try manually.');
                 }
             } else {
                 // Should not happen if modal is shown only after loss
                 closeDoubleOrNothingModal();
             }
         }

         // Show Guest Mode Toast
         function showGuestModeToast() {
             const toast = document.getElementById('guestModeToast');
             toast.style.display = 'block';
             setTimeout(() => {
                 toast.style.display = 'none';
             }, 5000); // Hide after 5 seconds
         }

         // Onboarding Modal for Guest Mode
         function showOnboardingModal() {
             const modal = document.getElementById('onboardingModal');
             modal.classList.add('visible');
             stopAutoDemo(); // Stop auto demo during onboarding


             document.getElementById('onboardingStartBtn').onclick = () => {
                 localStorage.setItem('solroulette_fake_intro_shown', 'true');
                 isGuestMode = true; // Explicitly set guest mode
                 localStorage.setItem('solroulette_is_guest', 'true');
                 walletBalance = 500; // Set initial fake balance
                 localStorage.setItem('solroulette_guest_balance', walletBalance);

                 // Initialize other guest stats if they don't exist
                 if (localStorage.getItem('solroulette_guest_xp') === null) localStorage.setItem('solroulette_guest_xp', '0');
                 if (localStorage.getItem('solroulette_guest_tokens') === null) localStorage.setItem('solroulette_guest_tokens', '0');
                 if (localStorage.getItem('solroulette_guest_total_wagered') === null) localStorage.setItem('solroulette_guest_total_wagered', '0');
                 if (localStorage.getItem('solroulette_guest_win_streak') === null) localStorage.setItem('solroulette_guest_win_streak', '0');
                 if (localStorage.getItem('solroulette_guest_ten_x_wins') === null) localStorage.setItem('solroulette_guest_ten_x_wins', '0');
                 if (localStorage.getItem('solroulette_guest_achievements') === null) localStorage.setItem('solroulette_guest_achievements', '[]');
                 if (localStorage.getItem('solroulette_guest_spin_count') === null) localStorage.setItem('solroulette_guest_spin_count', '0');
                 if (localStorage.getItem('solroulette_guest_last_login') === null) localStorage.setItem('solroulette_guest_last_login', new Date().toDateString()); // Initialize guest login date
                 if (localStorage.getItem('solroulette_guest_daily_bonus_day') === null) localStorage.setItem('solroulette_guest_daily_bonus_day', '0');
                 if (localStorage.getItem('solroulette_fake_winnings_total') === null) localStorage.setItem('solroulette_fake_winnings_total', '0');

                 // Reload guest stats after setting them
                 xp = parseInt(localStorage.getItem('solroulette_guest_xp'));
                 tokensEarned = parseFloat(localStorage.getItem('solroulette_guest_tokens'));
                 totalWagered = parseFloat(localStorage.getItem('solroulette_guest_total_wagered'));
                 winStreak = parseInt(localStorage.getItem('solroulette_guest_win_streak'));
                 tenXWins = parseInt(localStorage.getItem('solroulette_ten_x_wins'));
                 achievementsUnlocked = new Set(JSON.parse(localStorage.getItem('solroulette_guest_achievements')));
                 guestSpinCount = parseInt(localStorage.getItem('solroulette_guest_spin_count'));
                 dailyBonusDay = parseInt(localStorage.getItem('solroulette_guest_daily_bonus_day'));
                 fakeWinningsTotal = parseFloat(localStorage.getItem('solroulette_fake_winnings_total'));


                 user.name = 'Guest'; // Ensure name is Guest
                 user.avatar = 'üëã'; // Ensure avatar is Guest avatar
                 localStorage.setItem('solroulette_user_name', user.name);
                 localStorage.setItem('solroulette_user_avatar', user.avatar);


                 closeOnboardingModal();
                 updateUIDebounced(); // Update UI to show the new balance and guest state
                 showMessageBox('Fake SOL Added', '‚óé500 Fake SOL added. Start spinning!'); // Show toast
                 showOnboardingTooltip(); // Show the onboarding tooltip after modal
                 resetIdleTimer(); // Start idle timer after onboarding
             };

             document.getElementById('onboardingConnectBtn').onclick = () => {
                 localStorage.setItem('solroulette_fake_intro_shown', 'true');
                 isGuestMode = false; // Explicitly set guest mode to false
                 localStorage.setItem('solroulette_is_guest', 'false');
                 closeOnboardingModal();
                 openWalletModal(); // Open the real wallet connection modal
                 dismissOnboarding(); // Dismiss the onboarding tooltip/glow
                 resetIdleTimer(); // Start idle timer after onboarding
             };
         }

         function closeOnboardingModal() {
             document.getElementById('onboardingModal').classList.remove('visible');
         }

         // Onboarding Tooltip
         function showOnboardingTooltip() {
             if (!onboardingShown && isGuestMode) {
                 const tooltip = document.getElementById('onboardingTooltip');
                 const multiplierOptions = document.getElementById('multiplierOptions');

                 // Add glow to multiplier options
                 multiplierOptions.classList.add('onboarding-glow');

                 // Show tooltip
                 tooltip.classList.add('visible');

                 // Auto-dismiss after 10 seconds
                 setTimeout(() => {
                     dismissOnboarding();
                 }, 10000);
             }
         }

         function dismissOnboarding() {
             const tooltip = document.getElementById('onboardingTooltip');
             const multiplierOptions = document.getElementById('multiplierOptions');

             // Remove glow and hide tooltip
             multiplierOptions.classList.remove('onboarding-glow');
             tooltip.classList.remove('visible');

             // Mark onboarding as shown
             onboardingShown = true;
             localStorage.setItem('solroulette_onboarding_shown', 'true');
         }


         // Update Recent Spins Display
         function updateRecentSpinsDisplay() {
             const recentSpinsDiv = document.getElementById('recentSpins');
             recentSpinsDiv.innerHTML = '<span class="label">Recent:</span>'; // Reset content

             recentSpins.forEach(spin => {
                 const outcomeSpan = document.createElement('span');
                 outcomeSpan.className = `outcome ${spin.won ? 'win' : 'lose'}`; // Add class based on win/loss
                 outcomeSpan.textContent = spin.multiplier;
                 recentSpinsDiv.appendChild(outcomeSpan);
             });
         }

         // Update Bet Summary Display
         function updateBetSummary() {
             const betSummaryDiv = document.getElementById('betSummary');
             if (currentBet.multiplier && currentBet.amount > 0) {
                 const potentialWin = currentBet.amount * parseFloat(currentBet.multiplier);
                 betSummaryDiv.innerHTML = `
                     üßæ You bet ‚óé${currentBet.amount.toFixed(2)} on ${currentBet.multiplier}
                     <br>
                     üéØ Potential Win: ‚óé${potentialWin.toFixed(2)}
                 `;
                 betSummaryDiv.style.display = 'block';
             } else {
                 betSummaryDiv.style.display = 'none';
             }
         }

         // Auto Demo Mode Functions
         function startAutoDemo() {
             if (!isGuestMode || isSpinning || document.querySelector('.modal-overlay.visible')) {
                 isAutoDemo = false; // Cannot start auto demo if not guest, spinning, or modal is open
                 document.getElementById('autoDemoBanner').style.display = 'none';
                 return;
             }

             isAutoDemo = true;
             document.getElementById('autoDemoBanner').style.display = 'block';

             // Select a random multiplier (or a "baiting" one)
             const multipliers = ['1.5x', '2x', '3x', '5x', '10x'];
             const randomMultiplier = multipliers[Math.floor(Math.random() * multipliers.length)];

             // Select the multiplier button in the UI (visual only)
             document.querySelectorAll('.multiplier-btn').forEach(btn => {
                 btn.classList.remove('active');
                 if (btn.dataset.multiplier === randomMultiplier) {
                     btn.classList.add('active');
                 }
             });
             currentBet.multiplier = randomMultiplier; // Set the state

             // Set a random bet amount (e.g., between 0.1 and 2 SOL)
             const randomAmount = parseFloat((Math.random() * 1.9 + 0.1).toFixed(2));
             document.getElementById('betSlider').value = randomAmount; // Update slider
             currentBet.amount = randomAmount; // Set the state

             updateUIDebounced(); // Update UI to show selected bet

             // Place the bet after a short delay
             setTimeout(() => {
                 if (isAutoDemo && !isSpinning && spinTimer > 3) { // Double check state before placing bet
                     placeBet();
                 } else {
                     // If conditions aren't met, try starting demo again later
                     autoDemoTimer = setTimeout(startAutoDemo, AUTO_DEMO_INTERVAL);
                 }
             }, 1000); // Wait 1 second before placing the bet in auto demo
         }

         function stopAutoDemo() {
             clearTimeout(autoDemoTimer);
             isAutoDemo = false;
             document.getElementById('autoDemoBanner').style.display = 'none';
             // Reset selected multiplier and amount in UI if needed, but keep state for manual play
             document.querySelectorAll('.multiplier-btn').forEach(btn => btn.classList.remove('active'));
             currentBet = { multiplier: null, amount: 0 };
             document.getElementById('betSlider').value = 0.5; // Reset slider visually
             updateUIDebounced(); // Update UI
         }


        // Update UI elements
        function updateUI() {
            document.getElementById('solBalance').textContent = walletBalance.toFixed(2);
            //document.getElementById('userName').textContent = user.name; // Removed this line
            //document.getElementById('userAvatar').textContent = user.avatar; // Removed this line
            document.getElementById('betValue').textContent = `‚óé${parseFloat(document.getElementById('betSlider').value).toFixed(2)} SOL`; // Ensure 2 decimal places

            // Update XP bar and level
            const xpPercentage = (xp % 100);
            //document.getElementById('xpFill').style.width = `${xpPercentage}%`; // Removed this line
            // Check for level up
            if (xp >= 100) {
                level++;
                xp -= 100; // Reset XP for the new level
                addChatMessage('System', `${user.name} leveled up to ${level}!`, 'üéâ', 'system');
                localStorage.setItem('solroulette_level', level); // Save new level
                localStorage.setItem('solroulette_xp', xp); // Save remaining XP
                // Recursively check if multiple levels were gained
                if (xp >= 100) updateUIDebounced(); // Re-run updateUI if still enough XP for next level
            }
             localStorage.setItem('solroulette_xp', xp); // Save current XP

            // Update the entire user profile block in the header
            document.getElementById('userProfile').innerHTML = `
                <div class="avatar" id="userAvatar">${user.avatar}</div>
                <div>
                    <div id="userName">${user.name} ${isGuestMode ? '(Guest)' : ''} (Lv. ${level})</div>
                    <div class="xp-bar"><div class="xp-fill" id="xpFill" style="width: ${(xp % 100)}%"></div></div>
                </div>
                <div><i class="fas fa-wallet"></i> <span id="solBalance">${walletBalance.toFixed(2)}</span> SOL ${isGuestMode ? '(Fake)' : ''}</div>
                 <div id="fakeWinningsDisplay" style="${isGuestMode ? 'display: block;' : 'display: none;'} margin-left: 10px;" title="Your total fake winnings so far.">
                     ‚óé<span id="fakeWinningsTotalDisplay">${fakeWinningsTotal.toFixed(2)}</span> (Fake)
                 </div>
            `;
             // Re-attach event listener to the new user profile element
             document.getElementById('userProfile').addEventListener('click', openProfileModal);


            // Update button states based on timer and wallet connection/guest mode
            const placeBetBtn = document.getElementById('placeBetBtn');
            const connectWalletBtn = document.getElementById('connectWalletBtn');
            const multiplierBtns = document.querySelectorAll('.multiplier-btn');
            const betSlider = document.getElementById('betSlider');
            const spinAgainBtn = document.getElementById('resultModalSpinAgainBtn');
            const guestModeBanner = document.getElementById('guestModeBanner');


            const bettingAllowedByTimer = !isSpinning && spinTimer > 3;

            if (user.wallet && !isGuestMode) { // Connected with real wallet
                 connectWalletBtn.style.display = 'none';
                 placeBetBtn.style.display = 'block';
                 guestModeBanner.style.display = 'none'; // Hide guest banner for real users

                 placeBetBtn.disabled = !bettingAllowedByTimer || currentBet.multiplier === null || parseFloat(betSlider.value) <= 0;
                 placeBetBtn.title = bettingAllowedByTimer ? '' : 'Betting is closed';

                 multiplierBtns.forEach(btn => {
                     btn.disabled = !bettingAllowedByTimer;
                     btn.title = bettingAllowedByTimer ? '' : 'Betting is closed';
                 });
                 betSlider.disabled = !bettingAllowedByTimer;
                 betSlider.title = bettingAllowedByTimer ? '' : 'Betting is closed';

            } else { // Guest Mode or not connected
                 connectWalletBtn.style.display = 'block';
                 placeBetBtn.style.display = 'none';
                 guestModeBanner.style.display = 'block'; // Show guest banner for guest users

                 // In guest mode, placeBetBtn is ENABLED if bettingAllowedByTimer is true and a multiplier is selected and amount > 0
                 placeBetBtn.disabled = !bettingAllowedByTimer || currentBet.multiplier === null || parseFloat(betSlider.value) <= 0;
                 placeBetBtn.title = 'Fake SOL bets. Connect wallet to win real rewards.'; // Tooltip for guest mode Place Bet


                 // Multiplier buttons and slider are ENABLED in guest mode for fake bets, but disabled by timer
                 multiplierBtns.forEach(btn => {
                     btn.disabled = !bettingAllowedByTimer; // Disable based on timer
                     btn.title = bettingAllowedByTimer ? 'Using Fake SOL ‚Äì Real rewards require a wallet' : 'Betting is closed';
                 });
                 betSlider.disabled = !bettingAllowedByTimer; // Disable based on timer
                 betSlider.title = bettingAllowedByTimer ? 'Using Fake SOL ‚Äì Real rewards require a wallet' : 'Betting is closed';
            }

             // Disable Spin Again button if betting is not allowed by timer
             spinAgainBtn.disabled = !bettingAllowedByTimer;


             // Update token notification visibility (only in real wallet mode)
             if (tokensEarned > 0 && !isGuestMode) {
                 document.getElementById('tokenNotification').style.display = 'flex';
             } else {
                  document.getElementById('tokenNotification').style.display = 'none';
             }

             // Check and show low balance alert (only in real wallet mode)
             if (!isGuestMode) {
                 checkLowBalance();
             } else {
                 document.getElementById('lowBalanceAlert').style.display = 'none'; // Hide alert in guest mode
             }


             // Update shop balance
             document.getElementById('shopSpinBalance').textContent = tokensEarned.toFixed(3);

             // Update bet summary
             updateBetSummary();

             // Update fake winnings display in header
             document.getElementById('fakeWinningsTotalDisplay').textContent = fakeWinningsTotal.toFixed(2);

        }

        // Initial Canvas Setup
        function setupCanvas() {
            const container = document.getElementById('wheelContainer');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            drawWheel(); // Initial draw
        }

        // Idle Timer Functions
        function resetIdleTimer() {
            clearTimeout(idleTimer);
            idleTimer = setTimeout(showIdleModal, IDLE_TIMEOUT);
             // Stop auto demo if it's running when user interacts
             if (isAutoDemo) {
                 stopAutoDemo();
             }
        }

        function showIdleModal() {
            const idleModal = document.getElementById('idleModal');
            // Only show if no other modal is visible and not in auto demo
            const anyModalVisible = document.querySelector('.modal-overlay.visible');
            if (!anyModalVisible && !isAutoDemo) {
                idleModal.classList.add('visible');
            }
             // Reset timer even if modal wasn't shown, to prevent immediate re-trigger
            resetIdleTimer();
        }

        function closeIdleModal() {
            document.getElementById('idleModal').classList.remove('visible');
            resetIdleTimer(); // Reset timer after closing modal
        }


        // Event Listeners
        document.getElementById('betSlider').addEventListener('input', updateUIDebounced); // Update bet value display on slider change

        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChat();
                e.preventDefault(); // Prevent default form submission if input is inside a form
            }
        });

        document.querySelectorAll('.multiplier-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                 // Multiplier buttons are enabled even in guest mode, but placeBetBtn handles real betting
                 if (isSpinning || spinTimer <= 3) return; // Cannot select during spin or countdown

                playSound('click');
                if (navigator.vibrate) navigator.vibrate(50);

                // Remove active class from all buttons
                document.querySelectorAll('.multiplier-btn').forEach(b => b.classList.remove('active'));
                // Add active class to the clicked button
                btn.classList.add('active');
                // Set the current bet multiplier
                currentBet.multiplier = btn.dataset.multiplier;
                 // Enable place bet button if amount > 0 and wallet is connected and betting is allowed
                 // This logic is now handled in updateUI based on user.wallet and isSpinning/spinTimer
                 updateUIDebounced(); // Update UI to reflect button state and potentially enable Place Bet

                 // Dismiss onboarding tooltip/glow if active
                 dismissOnboarding();
                 resetIdleTimer(); // Reset idle timer on multiplier selection
                 stopAutoDemo(); // Stop auto demo on manual selection
            });
        });

        // Event listener for the user profile div to open profile modal
        // This is handled within the updateUI function now.

        // Update bet amount when slider changes
        document.getElementById('betSlider').addEventListener('input', (e) => {
             currentBet.amount = parseFloat(e.target.value);
             updateUIDebounced(); // Update the displayed bet value and button state
             // Dismiss onboarding tooltip/glow if active and user interacts with slider
             dismissOnboarding();
             resetIdleTimer(); // Reset idle timer on slider change
             stopAutoDemo(); // Stop auto demo on manual selection
        });

         // Event listeners for new modals
         document.getElementById('walletModal').addEventListener('click', (e) => {
             // Close modal if clicking outside the content
             if (e.target === document.getElementById('walletModal')) {
                 // closeWalletModal(); // Keep wallet modal open until user chooses or clicks close button
             }
         });
          document.getElementById('profileModal').addEventListener('click', (e) => {
             if (e.target === document.getElementById('profileModal')) {
                 closeProfileModal();
             }
         });
          document.getElementById('shopModal').addEventListener('click', (e) => {
             if (e.target === document.getElementById('shopModal')) {
                 closeShopModal();
             }
         });
          document.getElementById('dailyBonusModal').addEventListener('click', (e) => {
             if (e.target === document.getElementById('dailyBonusModal')) {
                 closeDailyBonusModal();
             }
         });
          document.getElementById('doubleOrNothingModal').addEventListener('click', (e) => {
             if (e.target === document.getElementById('doubleOrNothingModal')) {
                 // closeDoubleOrNothingModal(); // Keep double or nothing modal open until user chooses
             }
         });
         document.getElementById('resultModal').addEventListener('click', (e) => {
             if (e.target === document.getElementById('resultModal')) {
                 // closeResultModal(); // Keep result modal open until user clicks button
             }
         });
         document.getElementById('messageBox').addEventListener('click', (e) => {
             if (e.target === document.getElementById('messageBox')) {
                 closeMessageBox();
             }
         });
          document.getElementById('shareModal').addEventListener('click', (e) => {
             if (e.target === document.getElementById('shareModal')) {
                 closeShareModal();
             }
         });
         document.getElementById('onboardingModal').addEventListener('click', (e) => {
             if (e.target === document.getElementById('onboardingModal')) {
                 // Do not close onboarding modal by clicking outside, force button click
             }
         });
          document.getElementById('refillFakeSolModal').addEventListener('click', (e) => {
             if (e.target === document.getElementById('refillFakeSolModal')) {
                 // Do not close refill modal by clicking outside
             }
         });
         document.getElementById('idleModal').addEventListener('click', (e) => {
             if (e.target === document.getElementById('idleModal')) {
                 // closeIdleModal(); // Keep idle modal open until user clicks button
             }
         });


        // Add event listeners for buttons that had inline onclick
        document.getElementById('connectWalletBtn').addEventListener('click', openWalletModal); // Open wallet modal first
        document.getElementById('placeBetBtn').addEventListener('click', placeBet);
        document.getElementById('sendChatBtn').addEventListener('click', sendChat);
        document.getElementById('claimModalBtn').addEventListener('click', openClaimModal);
        document.getElementById('closeWalletModalBtn').addEventListener('click', closeWalletModal);
        document.getElementById('justWatchingBtn').addEventListener('click', closeWalletModal); // "Just Watching" button
        document.getElementById('connectPhantomBtn').addEventListener('click', connectWallet); // Actual connect button inside modal
        document.getElementById('closeProfileModalBtn').addEventListener('click', closeProfileModal);
        document.getElementById('copyReferralLinkBtn').addEventListener('click', copyReferralLink);
        document.getElementById('resetGuestProgressBtn').addEventListener('click', resetGuestProgress); // Guest Reset Button
        document.getElementById('closeShopModalBtn').addEventListener('click', closeShopModal);
        document.querySelectorAll('.buy-item-btn').forEach(btn => { // Event listeners for buy buttons
            btn.addEventListener('click', () => {
                buyShopItem(btn.dataset.itemId, parseFloat(btn.dataset.cost));
            });
        });
        document.getElementById('closeDailyBonusModalBtn').addEventListener('click', closeDailyBonusModal);
        document.getElementById('claimDailyBonusBtn').addEventListener('click', claimDailyBonus);
        document.getElementById('tryAgainBetBtn').addEventListener('click', tryAgainBet);
        document.getElementById('cancelDoubleOrNothingBtn').addEventListener('click', closeDoubleOrNothingModal);
        document.getElementById('closeShareModalBtn').addEventListener('click', closeShareModal);
        document.getElementById('copyShareTextBtn').addEventListener('click', copyShareText);
        document.getElementById('tweetWinBtn').addEventListener('click', tweetWin);
        document.getElementById('closeMessageBoxBtn').addEventListener('click', closeMessageBox);
        document.getElementById('topUpWalletBtn').addEventListener('click', topUpWallet);
         document.getElementById('resultModalSpinAgainBtn').addEventListener('click', closeResultModal); // Spin Again button in result modal
         document.getElementById('refillFakeSolBtn').addEventListener('click', refillFakeSol); // Refill fake SOL button
         document.getElementById('closeIdleModalBtn').addEventListener('click', closeIdleModal); // Close Idle Modal button


        // Add event listener for the Shop button (assuming you add one in the header or elsewhere)
        // For now, let's add a mock button in the header for testing
        // (You might want to integrate this into the profile modal later)
        const shopButton = document.createElement('div');
        shopButton.className = 'players-online'; // Reuse styling
        shopButton.innerHTML = '<i class="fas fa-store"></i> Shop';
        shopButton.style.cursor = 'pointer';
        shopButton.style.marginLeft = '10px';
        shopButton.addEventListener('click', openShopModal);
        document.querySelector('.header').appendChild(shopButton);


        // Add particle effects to the background overlay
        function createParticle() {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = `${Math.random() * 100}vw`;
            particle.style.top = `${Math.random() * 100}vh`;
            particle.style.animationDelay = `${Math.random() * 5}s`; // Random delay
            document.getElementById('backgroundOverlay').appendChild(particle);
            // Remove particle after animation
            particle.addEventListener('animationend', () => particle.remove());
        }

        function spawnParticles(count) {
            for (let i = 0; i < count; i++) {
                createParticle();
            }
        }

        // Add money rain effect on win
        function triggerMoneyRain() {
             const moneyCount = 50;
             for (let i = 0; i < moneyCount; i++) {
                 const money = document.createElement('div');
                 money.className = 'money-rain';
                 money.style.left = `${Math.random() * 100}vw`;
                 money.style.animationDelay = `${Math.random() * 0.5}s`;
                 document.body.appendChild(money);
                 money.addEventListener('animationend', () => money.remove());
             }
        }


        // Start Simulation
        setInterval(updateTimer, 1000); // Update timer every second
        // Simulate multiplayer activity periodically (bets for the next round)
        setInterval(simulateMultiplayer, 5000); // Simulate fake bets and chat every 5 seconds
         setInterval(updateLeaderboard, 15000); // Update leaderboard every 15 seconds
         setInterval(checkLowBalance, 30000); // Check low balance every 30 seconds
         setInterval(updateFakeActivityBanner, 7000); // Update fake activity banner periodically
         setInterval(() => { // Randomly show 10x hit banner
             if (Math.random() < 0.3) { // 30% chance every 30-60 seconds
                 showTenXHitBanner();
             }
         }, Math.random() * 30000 + 30000); // Between 30 and 60 seconds


        // Initial setup on page load
        window.onload = function() {
            setupCanvas(); // Setup canvas size and initial draw

             // --- Guest Mode Initialization and Onboarding ---
             const fakeIntroShown = localStorage.getItem('solroulette_fake_intro_shown');

             if (!user.wallet && !fakeIntroShown) {
                 // First time guest user: Immediately set guest mode and balance, then show onboarding
                 isGuestMode = true;
                 localStorage.setItem('solroulette_is_guest', 'true');
                 walletBalance = 500; // Set initial fake balance immediately
                 localStorage.setItem('solroulette_guest_balance', walletBalance);

                 // Initialize other guest stats if they don't exist
                 if (localStorage.getItem('solroulette_guest_xp') === null) localStorage.setItem('solroulette_guest_xp', '0');
                 if (localStorage.getItem('solroulette_guest_tokens') === null) localStorage.setItem('solroulette_guest_tokens', '0');
                 if (localStorage.getItem('solroulette_guest_total_wagered') === null) localStorage.setItem('solroulette_guest_total_wagered', '0');
                 if (localStorage.getItem('solroulette_guest_win_streak') === null) localStorage.setItem('solroulette_guest_win_streak', '0');
                 if (localStorage.getItem('solroulette_guest_ten_x_wins') === null) localStorage.setItem('solroulette_guest_ten_x_wins', '0');
                 if (localStorage.getItem('solroulette_guest_achievements') === null) localStorage.setItem('solroulette_guest_achievements', '[]');
                 if (localStorage.getItem('solroulette_guest_spin_count') === null) localStorage.setItem('solroulette_guest_spin_count', '0');
                 if (localStorage.getItem('solroulette_guest_last_login') === null) localStorage.setItem('solroulette_guest_last_login', new Date().toDateString()); // Initialize guest login date
                 if (localStorage.getItem('solroulette_guest_daily_bonus_day') === null) localStorage.setItem('solroulette_guest_daily_bonus_day', '0');
                 if (localStorage.getItem('solroulette_fake_winnings_total') === null) localStorage.setItem('solroulette_fake_winnings_total', '0');

                 // Load guest stats after setting them
                 xp = parseInt(localStorage.getItem('solroulette_guest_xp'));
                 tokensEarned = parseFloat(localStorage.getItem('solroulette_guest_tokens'));
                 totalWagered = parseFloat(localStorage.getItem('solroulette_guest_total_wagered'));
                 winStreak = parseInt(localStorage.getItem('solroulette_guest_win_streak'));
                 tenXWins = parseInt(localStorage.getItem('solroulette_ten_x_wins'));
                 achievementsUnlocked = new Set(JSON.parse(localStorage.getItem('solroulette_guest_achievements')));
                 guestSpinCount = parseInt(localStorage.getItem('solroulette_guest_spin_count'));
                 dailyBonusDay = parseInt(localStorage.getItem('solroulette_guest_daily_bonus_day'));
                 fakeWinningsTotal = parseFloat(localStorage.getItem('solroulette_fake_winnings_total'));


                 user.name = 'Guest'; // Ensure name is Guest
                 user.avatar = 'üëã'; // Ensure avatar is Guest avatar
                 localStorage.setItem('solroulette_user_name', user.name);
                 localStorage.setItem('solroulette_user_avatar', user.avatar);


                 updateUIDebounced(); // Update UI to show the initial balance and guest state
                 showOnboardingModal(); // Show onboarding modal

             } else if (!user.wallet && fakeIntroShown) {
                 // Returning guest user
                 isGuestMode = true;
                 localStorage.setItem('solroulette_is_guest', 'true');
                 // Load guest stats (defaulting balance to 500 if it's 0 or null)
                 walletBalance = parseFloat(localStorage.getItem('solroulette_guest_balance') || '500');
                 if (walletBalance <= 0) { // Ensure balance is at least 500 for returning guests if they zeroed out
                    walletBalance = 500;
                    localStorage.setItem('solroulette_guest_balance', walletBalance);
                 }

                 xp = parseInt(localStorage.getItem('solroulette_guest_xp') || '0');
                 tokensEarned = parseFloat(localStorage.getItem('solroulette_guest_tokens') || '0');
                 totalWagered = parseFloat(localStorage.getItem('solroulette_guest_total_wagered') || '0');
                 winStreak = parseInt(localStorage.getItem('solroulette_guest_win_streak') || '0');
                 tenXWins = parseInt(localStorage.getItem('solroulette_ten_x_wins') || '0');
                 achievementsUnlocked = new Set(JSON.parse(localStorage.getItem('solroulette_guest_achievements') || '[]'));
                 guestSpinCount = parseInt(localStorage.getItem('solroulette_guest_spin_count') || '0');
                 dailyBonusDay = parseInt(localStorage.getItem('solroulette_guest_daily_bonus_day') || '0');
                 fakeWinningsTotal = parseFloat(localStorage.getItem('solroulette_fake_winnings_total') || '0');


                 user.name = 'Guest';
                 user.avatar = 'üëã';
                 localStorage.setItem('solroulette_user_name', user.name);
                 localStorage.setItem('solroulette_user_avatar', user.avatar);

                 updateUIDebounced(); // Initial UI update
                 showGuestModeToast(); // Show guest mode toast on returning guest visit
                 // Show onboarding tooltip if it hasn't been dismissed
                 showOnboardingTooltip();
                 resetIdleTimer(); // Start idle timer for returning guests


             } else {
                 // Connected user
                 isGuestMode = false;
                 localStorage.setItem('solroulette_is_guest', 'false');
                 // Load real user stats (already handled at top, but ensure consistency)
                 walletBalance = parseFloat(localStorage.getItem('solroulette_wallet_balance') || '0');
                 xp = parseInt(localStorage.getItem('solroulette_xp') || '0');
                 tokensEarned = parseFloat(localStorage.getItem('solroulette_spin_tokens') || '0');
                 totalWagered = parseFloat(localStorage.getItem('solroulette_total_wagered') || '0');
                 winStreak = parseInt(localStorage.getItem('solroulette_win_streak') || '0');
                 tenXWins = parseInt(localStorage.getItem('solroulette_ten_x_wins') || '0');
                 achievementsUnlocked = new Set(JSON.parse(localStorage.getItem('solroulette_achievements') || '[]'));
                 dailyBonusDay = parseInt(localStorage.getItem('solroulette_daily_bonus_day') || '0');

                 // user.name and user.wallet are already loaded at the top
                 updateUIDebounced(); // Initial UI update
                 resetIdleTimer(); // Start idle timer for connected users
             }

             // Default multiplier selection for new guests or returning guests who haven't selected one
             if (isGuestMode && currentBet.multiplier === null) {
                 currentBet.multiplier = '2x'; // Default to 2x
                 // Find the 2x button and add the active class
                 const defaultMultiplierBtn = document.querySelector('.multiplier-btn[data-multiplier="2x"]');
                 if (defaultMultiplierBtn) {
                     defaultMultiplierBtn.classList.add('active');
                 }
                 updateUIDebounced(); // Update UI to show selected multiplier
             }


            // simulateMultiplayer(); // Initial fake bets and chat messages - now handled by interval
            spawnParticles(50); // Start background particles
            checkReferralCode(); // Check for referral code in URL
            updateRecentSpinsDisplay(); // Display recent spins on load
            updateFakeActivityBanner(); // Initial fake activity banner update
            updateLeaderboard(); // Initial leaderboard population


             // Check daily bonus on load
             checkDailyBonus();

             // Start auto demo after a delay if in guest mode and idle timer is running (user hasn't interacted yet)
             // This is handled by the idle timer now. When the idle timer triggers, it checks if a modal is open.
             // If no modal is open, it shows the idle modal. If the user closes the idle modal without interacting,
             // the idle timer will reset and eventually trigger again.
             // To start auto demo after initial load inactivity, we can add a check here:
             if (isGuestMode && onboardingShown && !isAutoDemo) { // Only start auto demo for returning guests who have seen onboarding
                 // Start auto demo after a delay if no interaction occurs
                 autoDemoTimer = setTimeout(startAutoDemo, IDLE_TIMEOUT); // Use the same timeout as idle modal
             }
        };

        // Ensure canvas resizes with window
        window.addEventListener('resize', setupCanvas);

        // Reset idle timer on user activity
        document.addEventListener('mousemove', resetIdleTimer);
        document.addEventListener('keypress', resetIdleTimer);
        document.addEventListener('touchstart', resetIdleTimer);
        document.addEventListener('click', resetIdleTimer); // Also reset on click anywhere
        document.addEventListener('scroll', resetIdleTimer); // Also reset on scroll

    </script>
</body>
</html>
