<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#111111">
  <meta name="description" content="DegenJack: Web3 Blackjack with Solana. Join, bet, win big!">
  <title>DegenJack | Web3 Blackjack</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background: #111111;
      color: #ffffff;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    #app {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    #top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: #1a1a1a;
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }
    #wallet-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #wallet-info button {
      background: #7b61ff;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: transform 0.2s;
    }
    #wallet-info button:hover {
      transform: scale(1.05);
    }
    #xp-progress {
      flex: 1;
      text-align: center;
    }
    #xp-bar {
      width: 200px;
      height: 10px;
      background: #333;
      border-radius: 5px;
      overflow: hidden;
      display: inline-block;
      margin: 0 10px;
    }
    #xp-fill {
      height: 100%;
      background: linear-gradient(to right, #00ff00, #ff00ff);
      transition: width 0.5s ease;
    }
    #ticker {
      flex: 1;
      text-align: right;
      font-size: 14px;
      overflow: hidden;
      white-space: nowrap;
    }
    #ticker span {
      display: inline-block;
      animation: tickerSlide 10s linear infinite;
    }
    @keyframes tickerSlide {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
    #settings-menu {
      position: absolute;
      right: 20px;
      top: 60px;
      background: #1a1a1a;
      border-radius: 8px;
      padding: 10px;
      display: none;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
    }
    #settings-menu.active {
      display: block;
    }
    #game-table {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px 100px;
      position: relative;
    }
    #dealer-hand {
      position: absolute;
      top: 80px;
      display: flex;
      gap: 10px;
    }
    #player-seats {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 100px;
    }
    .player-seat {
      background: #222;
      border-radius: 8px;
      padding: 10px;
      width: 200px;
      text-align: center;
      position: relative;
      transition: box-shadow 0.3s;
    }
    .player-seat.active {
      box-shadow: 0 0 15px #ff00ff;
    }
    .player-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin: 0 auto 5px;
    }
    .player-cards {
      display: flex;
      gap: 5px;
      justify-content: center;
      margin: 10px 0;
    }
    .card {
      width: 60px;
      height: 90px;
      background: #fff;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #000;
      font-size: 14px;
      transform-style: preserve-3d;
      transition: transform 0.6s;
    }
    .card.flipped {
      transform: rotateY(180deg);
    }
    #action-buttons {
      display: none;
      gap: 10px;
      justify-content: center;
    }
    .player-seat.active #action-buttons {
      display: flex;
    }
    #action-buttons button {
      background: #00ff00;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: transform 0.2s;
    }
    #action-buttons button.stand {
      background: #ff00ff;
    }
    #action-buttons button:hover {
      transform: scale(1.05);
    }
    #turn-timer {
      width: 100%;
      height: 5px;
      background: #333;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 5px;
      display: none;
    }
    .player-seat.active #turn-timer {
      display: block;
    }
    #timer-fill {
      height: 100%;
      background: #ff00ff;
      transition: width 0.1s linear;
    }
    #bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 100px;
      background: #1a1a1a;
      display: flex;
      padding: 10px;
      box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.5);
    }
    #bet-controls {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #bet-slider {
      width: 100%;
    }
    #quick-bets {
      display: flex;
      gap: 5px;
    }
    #quick-bets button {
      background: #7b61ff;
      border: none;
      padding: 8px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: transform 0.2s;
    }
    #quick-bets button:hover {
      transform: scale(1.05);
    }
    #join-leave {
      background: #00ff00;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: transform 0.2s;
    }
    #join-leave.leave {
      background: #ff00ff;
    }
    #join-leave:hover {
      transform: scale(1.05);
    }
    #chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    #chat-feed {
      height: 60px;
      overflow-y: auto;
      background: #222;
      border-radius: 8px;
      padding: 5px;
      font-size: 12px;
    }
    #chat-feed div {
      margin-bottom: 5px;
    }
    #chat-input {
      display: flex;
      gap: 5px;
    }
    #chat-input input {
      flex: 1;
      background: #333;
      border: none;
      padding: 8px;
      border-radius: 8px;
      color: white;
      font-size: 14px;
    }
    #chat-input button {
      background: #7b61ff;
      border: none;
      padding: 8px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-size: 14px;
      transition: transform 0.2s;
    }
    #chat-input button:hover {
      transform: scale(1.05);
    }
    #crate-animation {
      position: absolute;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      width: 100px;
      height: 100px;
      background: url('/assets/crates/crate_level1.png');
      background-size: cover;
      cursor: pointer;
      display: none;
    }
    #crate-animation.active {
      display: block;
      animation: crateDrop 1s ease-out;
    }
    @keyframes crateDrop {
      0% { transform: translateX(-50%) translateY(-100px); opacity: 0; }
      100% { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    @media (max-width: 1366px) {
      .player-seat { width: 180px; }
      .card { width: 50px; height: 75px; font-size: 12px; }
      #xp-bar { width: 150px; }
    }
    @media (prefers-reduced-motion) {
      .card, #xp-fill, #ticker span, #crate-animation { transition: none; animation: none; }
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="top-bar">
      <div id="wallet-info">
        <span id="wallet-address">Not Connected</span>
        <span id="wallet-balance">0.00 SOL</span>
        <button id="wallet-connect">Connect Wallet</button>
      </div>
      <div id="xp-progress">
        Level: <span id="level">1</span>
        <div id="xp-bar"><div id="xp-fill" style="width: 0%"></div></div>
        XP: <span id="xp">0</span>
      </div>
      <div id="ticker">
        <span id="ticker-content">Waiting for plays...</span>
      </div>
      <button id="settings-toggle">â˜°</button>
      <div id="settings-menu">
        <button id="toggle-animations">Toggle Animations</button>
        <button id="disconnect-wallet">Disconnect Wallet</button>
      </div>
    </div>
    <div id="game-table">
      <div id="dealer-hand"></div>
      <div id="player-seats"></div>
      <div id="crate-animation"></div>
    </div>
    <div id="bottom-bar">
      <div id="bet-controls">
        <input type="range" id="bet-slider" min="0.01" max="1" step="0.01" value="0.01">
        <div id="quick-bets">
          <button onclick="updateBet(0.01)">+0.01</button>
          <button onclick="updateBet(0.1)">+0.1</button>
          <button onclick="updateBet('max')">MAX</button>
        </div>
        <button id="join-leave" onclick="toggleTable()">Join Table</button>
      </div>
      <div id="chat">
        <div id="chat-feed"></div>
        <div id="chat-input">
          <input type="text" id="chat-message" placeholder="Type a message...">
          <button onclick="sendChat()">Send</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    const gameState = {
      wallet: null,
      publicKey: null,
      balance: 0,
      isConnected: false,
      tableId: null,
      players: [],
      dealerHand: [],
      currentTurn: null,
      xp: 0,
      level: 1,
      betAmount: 0.01,
      isSeated: false,
      isSpectator: false,
      tickerMessages: [],
      socket: null,
      animationsEnabled: true
    };

    const socket = new WebSocket('wss://your-server-url'); // Replace with actual server URL
    socket.onopen = () => {
      socket.send(JSON.stringify({ type: 'joinGame' }));
    };
    socket.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      handleGameEvent(msg);
    };
    socket.onclose = () => {
      addChatMessage('System', 'Disconnected from server.');
    };

    function handleGameEvent(msg) {
      switch (msg.type) {
        case 'table_state':
          gameState.tableId = msg.data.tableId;
          gameState.players = msg.data.players;
          gameState.dealerHand = msg.data.dealerHand;
          gameState.currentTurn = msg.data.currentTurn;
          gameState.isSeated = msg.data.players.some(p => p.publicKey === gameState.publicKey?.toString());
          gameState.isSpectator = !gameState.isSeated;
          updateTable();
          break;
        case 'card_dealt':
          if (msg.data.playerId) {
            const player = gameState.players.find(p => p.publicKey === msg.data.playerId);
            if (player) player.cards.push(msg.data.card);
          } else {
            gameState.dealerHand.push(msg.data.card);
          }
          updateTable();
          break;
        case 'turn_changed':
          gameState.currentTurn = msg.data.playerId;
          updateTable();
          startTurnTimer(msg.data.timeLeft);
          break;
        case 'round_end':
          gameState.dealerHand = msg.data.dealerHand; // Reveal dealer cards
          updateTable();
          setTimeout(() => {
            gameState.dealerHand = [];
            gameState.players.forEach(p => p.cards = []);
            updateTable();
          }, 3000);
          break;
        case 'xp_update':
          gameState.xp = msg.data.xp;
          if (msg.data.level > gameState.level) {
            gameState.level = msg.data.level;
            gameState.xp = 0;
            showCrate();
          }
          updateXP();
          break;
        case 'chat_message':
          addChatMessage(msg.data.username, msg.data.message, msg.data.badge);
          break;
        case 'recent_play':
          gameState.tickerMessages.push(`${msg.data.username} ${msg.data.won ? 'won' : 'lost'} ${msg.data.amount.toFixed(2)} SOL`);
          updateTicker();
          break;
        case 'player_joined':
        case 'player_left':
          gameState.players = msg.data.players;
          updateTable();
          break;
      }
    }

    async function connectWallet() {
      if (!window.solana) {
        alert('Please install a Solana wallet (e.g., Phantom)');
        return;
      }
      try {
        await window.solana.connect();
        gameState.publicKey = window.solana.publicKey;
        gameState.isConnected = true;
        document.getElementById('wallet-address').textContent = gameState.publicKey.toString().slice(0, 4) + '...' + gameState.publicKey.toString().slice(-4);
        document.getElementById('wallet-connect').style.display = 'none';
        updateBalance();
      } catch (err) {
        console.error('Wallet connection failed:', err);
      }
    }

    async function disconnectWallet() {
      if (window.solana && gameState.isConnected) {
        await window.solana.disconnect();
        gameState.isConnected = false;
        gameState.publicKey = null;
        document.getElementById('wallet-address').textContent = 'Not Connected';
        document.getElementById('wallet-balance').textContent = '0.00 SOL';
        document.getElementById('wallet-connect').style.display = 'inline-block';
      }
    }

    async function updateBalance() {
      if (!gameState.isConnected) return;
      const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
      const balance = await connection.getBalance(gameState.publicKey);
      gameState.balance = balance / solanaWeb3.LAMPORTS_PER_SOL;
      document.getElementById('wallet-balance').textContent = gameState.balance.toFixed(2) + ' SOL';
    }

    function toggleTable() {
      if (gameState.isSeated) {
        socket.send(JSON.stringify({ type: 'leaveTable', tableId: gameState.tableId }));
        gameState.isSeated = false;
        document.getElementById('join-leave').textContent = 'Join Table';
        document.getElementById('join-leave').classList.remove('leave');
      } else {
        socket.send(JSON.stringify({ type: 'joinTable' }));
        document.getElementById('join-leave').textContent = 'Leave Table';
        document.getElementById('join-leave').classList.add('leave');
      }
    }

    function updateBet(amount) {
      if (amount === 'max') {
        gameState.betAmount = gameState.balance;
      } else {
        gameState.betAmount = Math.min(gameState.balance, gameState.betAmount + amount);
      }
      document.getElementById('bet-slider').value = gameState.betAmount;
      socket.send(JSON.stringify({ type: 'betChanged', amount: gameState.betAmount }));
    }

    function sendAction(action) {
      socket.send(JSON.stringify({ type: 'action', action }));
    }

    function updateTable() {
      const seats = document.getElementById('player-seats');
      seats.innerHTML = '';
      gameState.players.forEach(player => {
        const isActive = player.publicKey === gameState.currentTurn && player.publicKey === gameState.publicKey?.toString();
        const seat = document.createElement('div');
        seat.className = `player-seat ${isActive ? 'active' : ''}`;
        seat.innerHTML = `
          <img src="/assets/emotes/${player.avatar || 'default.png'}" class="player-avatar">
          <div>${player.username || player.publicKey.slice(0, 4) + '...'}</div>
          <div>Level: ${player.level || 1}</div>
          <div class="player-cards">
            ${player.cards.map(card => `
              <div class="card ${card.faceUp ? 'flipped' : ''}">
                <img src="/assets/cards/${card.suit}_${card.rank}.png" style="width: 100%; height: 100%;">
              </div>
            `).join('')}
          </div>
          ${isActive ? `
            <div id="action-buttons">
              <button onclick="sendAction('hit')">Hit</button>
              <button class="stand" onclick="sendAction('stand')">Stand</button>
            </div>
            <div id="turn-timer"><div id="timer-fill"></div></div>
          ` : ''}
        `;
        seats.appendChild(seat);
      });

      const dealerHand = document.getElementById('dealer-hand');
      dealerHand.innerHTML = gameState.dealerHand.map(card => `
        <div class="card ${card.faceUp ? 'flipped' : ''}">
          <img src="/assets/cards/${card.faceUp ? `${card.suit}_${card.rank}.png` : 'card_back.png'}" style="width: 100%; height: 100%;">
        </div>
      `).join('');

      document.getElementById('join-leave').disabled = !gameState.isConnected;
    }

    function startTurnTimer(timeLeft) {
      if (!gameState.currentTurn || gameState.currentTurn !== gameState.publicKey?.toString()) return;
      const timerFill = document.querySelector('#timer-fill');
      if (!timerFill) return;
      const start = Date.now();
      const duration = timeLeft * 1000;
      function update() {
        const elapsed = Date.now() - start;
        const progress = Math.max(0, 1 - elapsed / duration);
        timerFill.style.width = `${progress * 100}%`;
        if (progress > 0 && gameState.currentTurn === gameState.publicKey?.toString()) {
          requestAnimationFrame(update);
        }
      }
      update();
    }

    function updateXP() {
      document.getElementById('xp').textContent = gameState.xp;
      document.getElementById('level').textContent = gameState.level;
      document.getElementById('xp-fill').style.width = `${gameState.xp}%`;
    }

    function showCrate() {
      if (!gameState.animationsEnabled) return;
      const crate = document.getElementById('crate-animation');
      crate.classList.add('active');
      crate.onclick = () => {
        crate.style.background = 'url(/assets/crates/crate_open.png)';
        setTimeout(() => crate.classList.remove('active'), 1000);
      };
      setTimeout(() => {
        if (crate.classList.contains('active')) {
          crate.classList.remove('active');
        }
      }, 5000);
    }

    function addChatMessage(username, message, badge = 'ðŸ¥‰') {
      const feed = document.getElementById('chat-feed');
      const div = document.createElement('div');
      div.innerHTML = `<span>${username} [${badge}]</span>: ${message}`;
      feed.appendChild(div);
      feed.scrollTop = feed.scrollHeight;
    }

    function sendChat() {
      const input = document.getElementById('chat-message');
      if (!input.value.trim() || !gameState.isConnected) return;
      socket.send(JSON.stringify({ type: 'chat_message', message: input.value }));
      input.value = '';
    }

    function updateTicker() {
      const ticker = document.getElementById('ticker-content');
      ticker.textContent = gameState.tickerMessages.slice(-5).join(' | ');
    }

    document.getElementById('wallet-connect').onclick = connectWallet;
    document.getElementById('disconnect-wallet').onclick = disconnectWallet;
    document.getElementById('settings-toggle').onclick = () => {
      document.getElementById('settings-menu').classList.toggle('active');
    };
    document.getElementById('toggle-animations').onclick = () => {
      gameState.animationsEnabled = !gameState.animationsEnabled;
      document.getElementById('toggle-animations').textContent = `Animations: ${gameState.animationsEnabled ? 'On' : 'Off'}`;
    };
    document.getElementById('bet-slider').oninput = (e) => {
      gameState.betAmount = parseFloat(e.target.value);
      socket.send(JSON.stringify({ type: 'betChanged', amount: gameState.betAmount }));
    };

    if (window.solana && window.solana.isConnected) {
      connectWallet();
    }
  </script>
</body>
</html>