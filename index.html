<!DOCTYPE html>
<html lang="en" x-data="crashApp" x-init="init()">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#121212">
  <meta name="description" content="Play SOL Crash: Bet SOL, ride the rocket, win big!">
  <title>SOL Crash | 1000x Multipliers</title>
  <link rel="manifest" href="/manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js" defer></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" defer></script>
  <style>
    :root {
      --primary: #7B61FF;
      --secondary: #FF6BEC;
      --bg: #121212;
      --card-bg: #1E1E1E;
    }
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-overflow-scrolling: touch;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(45deg, #121212, #1E1E1E, #121212);
      background-size: 200% 200%;
      animation: backgroundPulse 10s ease infinite;
      color: white;
      margin: 0;
      padding: 0;
      overscroll-behavior: none;
      touch-action: manipulation;
    }
    @keyframes backgroundPulse {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      height: -webkit-fill-available;
      overflow: hidden;
    }
    #game {
      flex: 1;
      padding: 15px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #multiplier {
      font-size: 3.5rem;
      font-weight: 800;
      background: linear-gradient(to right, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align: center;
      margin: 10px 0;
      line-height: 1;
      position: relative;
    }
    #multiplier.near-crash {
      animation: flickerTilt 0.2s infinite;
    }
    @keyframes flickerTilt {
      0% { transform: rotate(0deg); opacity: 1; }
      50% { transform: rotate(2deg); opacity: 0.8; }
      100% { transform: rotate(-2deg); opacity: 1; }
    }
    #graph-container {
      flex: 1;
      min-height: 200px;
      background: var(--card-bg);
      border-radius: 12px;
      position: relative;
      margin: 0 0 15px;
      overflow: hidden;
    }
    #graph-container.bonus-mode {
      background: linear-gradient(to top, #FFD700, #FF6BEC);
    }
    #rocket-line {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 3px;
      background: linear-gradient(to top, var(--primary), var(--secondary));
      height: 0;
    }
    #rocket {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      background: url('rocket-sprite.png') no-repeat;
      background-size: 200%;
      animation: rocketGlow 0.5s infinite alternate;
      filter: blur(1px) drop-shadow(0 0 5px #FF6BEC);
      transition: bottom 0.05s linear;
    }
    #rocket.bonus-mode {
      filter: drop-shadow(0 0 10px #00FF00);
    }
    @keyframes rocketGlow {
      from { filter: blur(1px) drop-shadow(0 0 5px #FF6BEC); }
      to { filter: blur(1px) drop-shadow(0 0 10px #FFD700); }
    }
    #game.shake {
      animation: shake 0.3s ease-in-out;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      50% { transform: translateX(-5px); }
    }
    .controls.sticky {
      position: fixed;
      bottom: calc(10px + env(safe-area-inset-bottom));
      right: 10px;
      display: flex;
      gap: 8px;
      z-index: 50;
    }
    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
      min-width: 48px;
      min-height: 48px;
    }
    button:active:not(:disabled) {
      transform: scale(0.98);
    }
    button:disabled {
      opacity: 0.6;
    }
    button.idle {
      animation: craveAttention 1s infinite;
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.7);
    }
    @keyframes craveAttention {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    button.pulse {
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    input {
      padding: 12px;
      border-radius: 8px;
      border: none;
      background: var(--card-bg);
      color: white;
      font-size: 1rem;
      width: 100%;
      -webkit-appearance: none;
    }
    .mobile-tabs {
      display: flex;
      border-top: 1px solid #333;
      background: var(--card-bg);
      padding-bottom: env(safe-area-inset-bottom);
    }
    .tab-button {
      flex: 1;
      padding: 12px;
      text-align: center;
      font-size: 0.8rem;
    }
    .tab-button.active {
      border-bottom: 2px solid var(--primary);
    }
    .tab-content {
      display: none;
      padding: 15px;
      overflow-y: auto;
      max-height: 40vh;
      -webkit-overflow-scrolling: touch;
    }
    .tab-content.active {
      display: block;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 100;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }
    .modal-content {
      background: var(--card-bg);
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      padding: 20px;
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
      -webkit-overflow-scrolling: touch;
    }
    .will-change {
      will-change: transform, opacity;
    }
    .progress-bar-container {
      background: #333;
      border-radius: 8px;
      height: 8px;
      margin-top: 8px;
    }
    .progress-bar {
      background: linear-gradient(to right, #7B61FF, #FF6BEC);
      height: 100%;
      border-radius: 8px;
    }
    .crash-flash {
      position: fixed;
      inset: 0;
      background: rgba(255, 0, 0, 0.5);
      animation: flash 0.3s ease-out;
      z-index: 100;
    }
    @keyframes flash {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    .try-again {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: #FF6BEC;
      padding: 10px 20px;
      border-radius: 8px;
      animation: pop 0.5s ease-out;
      z-index: 90;
    }
    @keyframes pop {
      from { transform: translateX(-50%) scale(0); }
      to { transform: translateX(-50%) scale(1); }
    }
    .confetti {
      position: absolute;
      width: 8px;
      height: 8px;
      background: #FFD700;
      animation: confettiFall 2s linear forwards;
    }
    @keyframes confettiFall {
      0% { transform: translateY(0) rotate(0deg); opacity: 0.8; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    .quick-deposit {
      position: fixed;
      bottom: 150px;
      left: 50%;
      transform: translateX(-50%);
      background: #FF6BEC;
      padding: 10px 20px;
      border-radius: 8px;
    }
    .shake {
      animation: shakeButton 0.5s infinite;
    }
    @keyframes shakeButton {
      0% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(-5px); }
      100% { transform: translateX(-50%) translateY(0); }
    }
  </style>
</head>
<body>
  <div id="app">
    <div style="position: fixed; top: 10px; left: 10px; font-size: 0.8rem; color: #888;">
      Played: <span x-text="`${Math.floor(timeSpent / 60)}m ${timeSpent % 60}s`"></span>
    </div>
    <div style="position: fixed; top: 10px; right: 10px; font-size: 0.8rem; color: #888;">
      Live Players: <span x-text="livePlayers"></span>
    </div>
    <div id="game">
      <h1 style="text-align: center; font-size: 1.5rem; margin: 0;">üöÄ SOL CRASH</h1>
      <div id="multiplier" x-text="`${multiplier.toFixed(2)}x`" class="will-change"></div>
      <div id="graph-container" :class="{ 'bonus-mode': isBonusMode }">
        <div id="rocket-line" class="will-change"></div>
        <div id="rocket" :class="{ 'bonus-mode': isBonusMode }" class="will-change"></div>
      </div>
      <div class="controls sticky">
        <input type="number" x-model="betAmount" min="0.01" step="0.01" placeholder="0.01 SOL" inputmode="decimal">
        <button id="start-btn" @click="startGame()" :disabled="gameRunning">BET</button>
        <button id="auto-btn" @click="toggleAuto()" :style="autoPlay ? 'background: var(--secondary)' : ''">AUTO</button>
        <button id="cashout-btn" @click="cashOut()" :disabled="!gameRunning || !canCashout">CASH OUT</button>
        <div class="progress-bar-container mt-2">
          <span class="text-xs">Hot Streak</span>
          <div class="progress-bar" :style="'width: ' + (consecutiveLosses * 20) + '%'"></div>
          <span class="text-xs" x-text="consecutiveLosses >= 5 ? 'Win Imminent!' : 'Keep Playing!'"></span>
        </div>
        <div class="progress-bar-container mt-2">
          <span class="text-xs">Lucky Drop</span>
          <div class="progress-bar" :style="'width: ' + (totalLosses / 0.5 * 100) + '%'"></div>
          <span class="text-xs" x-text="totalLosses >= 0.4 ? 'Lucky Drop Incoming!' : 'Keep Playing!'"></span>
        </div>
      </div>
    </div>
    <div class="mobile-tabs">
      <div class="tab-button" :class="{ 'active': activeTab === 'chat' }" @click="activeTab = 'chat'">üí¨ Chat</div>
      <div class="tab-button" :class="{ 'active': activeTab === 'wallet' }" @click="activeTab = 'wallet'">üí∞ Wallet</div>
      <div class="tab-button" :class="{ 'active': activeTab === 'stats' }" @click="activeTab = 'stats'">üìä Stats</div>
      <div class="tab-button" :class="{ 'active': activeTab === 'missions' }" @click="activeTab = 'missions'">üéØ Missions</div>
    </div>
    <div class="tab-content" :class="{ 'active': activeTab === 'chat' }">
      <template x-for="message in chatMessages" :key="message.id">
        <div style="padding: 8px 0; border-bottom: 1px solid #333;" :class="{ 'bg-yellow-500/20 animate-pulse': message.isBigWin }">
          <span style="color: var(--secondary); font-weight: bold;" x-text="message.user"></span>: <span x-text="message.text"></span>
        </div>
      </template>
    </div>
    <div class="tab-content" :class="{ 'active': activeTab === 'wallet' }">
      <div style="padding: 10px;">
        <div style="font-size: 1.5rem; margin: 10px 0;" x-text="`${balance.toFixed(2)} SOL`"></div>
        <div x-show="firstDepositMade">Next Bonus: <span x-text="`${(0.2 - totalDeposited).toFixed(2)} SOL to 0.02 SOL`"></span></div>
        <div class="progress-bar-container">
          <div class="progress-bar" :style="'width: ' + (totalDeposited / 0.2 * 100) + '%'"></div>
        </div>
        <button @click="connectWallet()" x-show="!userLoggedIn" style="width: 100%; margin: 5px 0;">CONNECT WALLET</button>
        <button @click="openModal('deposit')" x-show="userLoggedIn" style="width: 100%; margin: 5px 0;">DEPOSIT</button>
        <button @click="openModal('withdraw')" x-show="userLoggedIn" style="width: 100%; margin: 5px 0; background: #F87171;">WITHDRAW</button>
        <button @click="shareReferral()" style="width: 100%; margin: 5px 0;">INVITE & EARN 0.005 SOL</button>
      </div>
    </div>
    <div class="tab-content" :class="{ 'active': activeTab === 'stats' }">
      <div style="padding: 10px;">
        <h3>TOP WINS</h3>
        <template x-for="leader in leaderboard" :key="leader.username">
          <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333;">
            <span x-text="leader.username"></span>
            <span x-text="`${leader.winnings.toFixed(2)} SOL`"></span>
          </div>
        </template>
        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333;">
          <span>You</span>
          <span x-text="`${biggestWin.toFixed(2)}x (${(biggestWin * betAmount).toFixed(2)} SOL)`"></span>
        </div>
      </div>
    </div>
    <div class="tab-content" :class="{ 'active': activeTab === 'missions' }">
      <div style="padding: 10px;">
        <h3>DAILY MISSIONS</h3>
        <div x-text="missions.bet5 ? '‚úÖ Bet 5 times' : 'Bet 5 times (0/5)'"></div>
        <button @click="claimMissionReward('bet5')" :disabled="!missions.bet5">Claim 0.005 SOL</button>
      </div>
    </div>
    <div x-show="modalOpen" class="modal-overlay" @click.self="closeModal()">
      <div class="modal-content">
        <template x-if="modalType === 'deposit'">
          <div>
            <h2>DEPOSIT SOL</h2>
            <p>Send SOL to this address:</p>
            <p style="word-break: break-all; background: #333; padding: 10px; border-radius: 4px; font-family: monospace;">7eSH...fT9q</p>
            <p>Minimum deposit: 0.1 SOL</p>
            <button @click="closeModal()" style="width: 100%; margin-top: 15px;">CLOSE</button>
          </div>
        </template>
        <template x-if="modalType === 'withdraw'">
          <div>
            <h2>WITHDRAW SOL</h2>
            <p>Available: <span x-text="balance.toFixed(2)"></span> SOL</p>
            <p style="color: var(--secondary);">‚ö†Ô∏è First withdrawals take 24 hours</p>
            <input type="number" x-model="withdrawAmount" placeholder="0.1 SOL" style="width: 100%; margin: 10px 0;">
            <button @click="requestWithdraw()" style="width: 100%;">REQUEST</button>
            <button @click="offerDouble()" style="width: 100%; margin-top: 10px; background: gold; color: black;">DOUBLE OR NOTHING</button>
          </div>
        </template>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('crashApp', () => ({
        gameRunning: false,
        multiplier: 1.00,
        crashAt: 2.0,
        betAmount: 0.01,
        balance: 0.05,
        autoPlay: false,
        canCashout: false,
        biggestWin: 0,
        modalOpen: false,
        modalType: '',
        activeTab: 'chat',
        userLoggedIn: false,
        withdrawAmount: 0.1,
        consecutiveLosses: 0,
        consecutiveBets: 0,
        totalBets: 0,
        totalSpent: 0,
        totalLosses: 0,
        totalDeposited: 0,
        firstDepositMade: false,
        timeSpent: 0,
        lastAction: Date.now(),
        roundCount: 0,
        isMysteryRound: false,
        isBonusMode: false,
        hapticTriggered1_5x: false,
        whooshPlayed: false,
        livePlayers: 973,
        missions: { bet5: false },
        leaderboard: [
          { username: 'SolWhale', winnings: 8.42 },
          { username: 'CryptoDegen', winnings: 5.21 },
          { username: 'Anon326', winnings: 3.45 }
        ],
        chatMessages: [
          { id: Date.now(), user: 'SolWhale', text: 'Just won 5 SOL! üöÄ', isBigWin: true },
          { id: Date.now() + 1, user: 'System', text: 'Welcome to SOL Crash!', isBigWin: false }
        ],
        audioContext: null,
        sounds: {},
        init() {
          screen.orientation?.lock('portrait').catch(() => {});
          document.addEventListener('gesturestart', (e) => e.preventDefault());
          history.pushState(null, null, window.location.href);
          window.addEventListener('popstate', () => history.pushState(null, null, window.location.href));
          document.body.addEventListener('touchstart', () => {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => {});
          }, { once: true });
          setInterval(() => {
            const messages = [
              `cashed out at ${(Math.random() * 30 + 5).toFixed(1)}x (${(Math.random() * 15 + 2).toFixed(1)} SOL) üî•`,
              `just rage quit at ${(Math.random() * 0.5 + 1).toFixed(2)}x üò≠`,
              `GRAVITY ${(Math.random() * 50 + 50).toFixed(1)}x with ${(Math.random() * 0.1 + 0.01).toFixed(2)} SOL ü§ë`
            ];
            this.addFakeChatMessage(messages[Math.floor(Math.random() * messages.length)]);
          }, Math.random() * 3000 + 5000);
          setInterval(() => {
            this.timeSpent++;
            if (this.timeSpent === 300) {
              this.showToast('üî• HOT SESSION ‚Äì Most wins come after 7 minutes!', 'info');
            }
          }, 1000);
          setInterval(() => {
            this.livePlayers = Math.floor(Math.random() * 400 + 800);
          }, 10000);
          setInterval(() => {
            this.showToast('Bonus Mode in 30s! All Wins x1.1!', 'info', 30000);
            let countdown = 30;
            const timer = setInterval(() => {
              countdown--;
              if (countdown <= 0) {
                clearInterval(timer);
                this.isBonusMode = true;
                this.showToast('Bonus Mode Active! All Wins x1.1!', 'success', 60000);
                setTimeout(() => this.isBonusMode = false, 60000);
              }
            }, 1000);
          }, Math.random() * 300000 + 600000);
          this.initAudio();
          this.initWaveform();
          this.handleIdle();
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js');
          }
          setInterval(() => {
            if (Notification.permission === 'granted') {
              new Notification('Crash Event Starting! Bet Now!');
            }
          }, 24 * 60 * 60 * 1000);
        },
        initAudio() {
          this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const loadSound = async (url, name) => {
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            this.sounds[name] = await this.audioContext.decodeAudioData(arrayBuffer);
          };
          Promise.all([
            loadSound('https://www.soundjay.com/misc/sounds/whoosh-2.mp3', 'whoosh'),
            loadSound('https://www.soundjay.com/money/sounds/coins-jingle-1.mp3', 'win'),
            loadSound('https://www.soundjay.com/human/sounds/applause-1.mp3', 'bigwin'),
            loadSound('https://www.soundjay.com/misc/sounds/glass-break-1.mp3', 'shatter'),
            loadSound('https://www.soundjay.com/buttons/sounds/button-click-1.mp3', 'chime'),
            loadSound('https://www.soundjay.com/misc/sounds/casino-ambience.mp3', 'ambient')
          ]);
          document.body.addEventListener('click', () => {
            if (this.audioContext.state === 'suspended') this.audioContext.resume();
            this.playSound('ambient', true);
          }, { once: true });
        },
        playSound(name, loop = false) {
          if (this.sounds[name]) {
            const source = this.audioContext.createBufferSource();
            source.buffer = this.sounds[name];
            source.loop = loop;
            source.connect(this.audioContext.destination);
            source.start(0);
          }
        },
        initWaveform() {
          const canvas = document.createElement('canvas');
          canvas.style.position = 'absolute';
          canvas.width = 200;
          canvas.height = 50;
          document.getElementById('multiplier').appendChild(canvas);
          const ctx = canvas.getContext('2d');
          const animateWave = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
            for (let x = 0; x < canvas.width; x++) {
              const y = Math.sin(x * 0.05 + Date.now() * 0.002) * this.multiplier * 5;
              ctx.lineTo(x, canvas.height / 2 + y);
            }
            ctx.strokeStyle = '#FF6BEC';
            ctx.stroke();
            requestAnimationFrame(animateWave);
          };
          animateWave();
        },
        handleIdle() {
          setInterval(() => {
            if (!this.gameRunning && Date.now() - this.lastAction > 2000) {
              document.querySelector('#start-btn').classList.add('idle');
              document.querySelector('#cashout-btn').classList.add('idle');
            } else {
              document.querySelector('#start-btn').classList.remove('idle');
              document.querySelector('#cashout-btn').classList.remove('idle');
            }
            if (!this.gameRunning && Date.now() - this.lastAction > 10000) {
              document.querySelector('#start-btn').classList.add('pulse');
              this.playSound('chime');
            }
          }, 500);
        },
        startGame() {
          if (this.gameRunning) return;
          if (this.balance < this.betAmount) {
            this.openModal('deposit');
            return;
          }
          this.gameRunning = true;
          this.multiplier = 1.00;
          this.canCashout = true;
          this.balance -= this.betAmount;
          this.totalSpent += this.betAmount;
          this.lastAction = Date.now();
          this.hapticTriggered1_5x = false;
          this.whooshPlayed = false;
          const random = Math.random();
          this.crashAt = random < 0.9 ? 9 + Math.random() * 0.9 : 1 + Math.random() * 100;
          if (this.balance > 0.5) this.crashAt = Math.min(this.crashAt, 2.5);
          if (this.balance < 0.02) this.crashAt = Math.max(this.crashAt, 3.0);
          this.roundCount++;
          if (this.roundCount % 15 === 0) {
            this.isMysteryRound = true;
            this.crashAt = 1.5 + Math.random() * 3.5;
            this.showToast('üí´ Mystery Bonus Round: Win up to 5x!', 'success');
          }
          this.consecutiveBets++;
          if (this.consecutiveBets >= 3) {
            this.crashAt += 0.5;
            this.showToast('Streak Bonus! Next Crash +0.5x!', 'success');
            this.consecutiveBets = 0;
          }
          this.totalBets++;
          if (this.totalBets >= 5) this.missions.bet5 = true;
          this.triggerHaptic([50]);
          this.animateGame();
        },
        animateGame() {
          if (!this.gameRunning) return;
          this.multiplier += 0.01;
          const lineHeight = (this.multiplier - 1) * 30;
          document.getElementById('rocket-line').style.height = `${lineHeight}px`;
          document.getElementById('rocket').style.bottom = `${lineHeight}px`;
          if (this.multiplier >= 1.5 && !this.hapticTriggered1_5x) {
            this.triggerHaptic([50, 30, 50]);
            this.hapticTriggered1_5x = true;
          }
          if (this.multiplier > 5 && !this.whooshPlayed) {
            this.playSound('whoosh');
            this.whooshPlayed = true;
          }
          if (this.crashAt - this.multiplier < 0.5) {
            document.getElementById('multiplier').classList.add('near-crash');
          }
          if (this.multiplier >= 10) document.getElementById('game').classList.add('shake');
          if (this.multiplier >= this.crashAt) {
            this.gameRunning = false;
            this.consecutiveLosses++;
            this.totalLosses += this.betAmount;
            this.playSound('shatter');
            document.getElementById('game').classList.add('shake');
            const flash = document.createElement('div');
            flash.className = 'crash-flash';
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 300);
            const retry = document.createElement('div');
            retry.className = 'try-again';
            retry.textContent = 'Try Again!';
            retry.onclick = () => this.startGame();
            document.body.appendChild(retry);
            setTimeout(() => retry.remove(), 5000);
            if (this.crashAt >= 9 && this.crashAt < 10) {
              this.showToast('Just Missed 10x! One More Try!', 'error');
            }
            if (this.consecutiveLosses >= 3 || this.totalLosses >= 0.5) {
              this.balance += 0.01;
              this.showToast('You‚Äôre due! Free 0.01 SOL Drop Added!', 'success');
              this.consecutiveLosses = 0;
              this.totalLosses = 0;
            }
            setTimeout(() => {
              alert(`CRASHED AT ${this.crashAt.toFixed(2)}x!`);
              if (this.autoPlay) this.startGame();
              else document.querySelector('#start-btn').focus();
            }, 50);
          } else {
            requestAnimationFrame(() => this.animateGame());
          }
        },
        cashOut() {
          if (!this.gameRunning || !this.canCashout) return;
          const winnings = this.betAmount * this.multiplier * (this.isBonusMode ? 1.1 : 1);
          this.balance += winnings;
          if (this.multiplier > this.biggestWin) this.biggestWin = this.multiplier;
          this.consecutiveLosses = 0;
          this.totalLosses = 0;
          this.gameRunning = false;
          this.lastAction = Date.now();
          this.isMysteryRound = false;
          this.triggerHaptic([100, 50, 100]);
          if (this.multiplier >= 5) {
            this.playSound('bigwin');
            for (let i = 0; i < 50; i++) {
              const confetti = document.createElement('div');
              confetti.className = 'confetti';
              confetti.style.left = `${Math.random() * window.innerWidth}px`;
              document.body.appendChild(confetti);
              setTimeout(() => confetti.remove(), 2000);
            }
          } else {
            this.playSound('win');
          }
          this.addMessage('You', `Cashed out at ${this.multiplier.toFixed(2)}x! Won ${winnings.toFixed(2)} SOL`);
          this.updateLeaderboard('You', winnings);
          this.showToast(`You‚Äôd have won ${(this.betAmount * this.multiplier * 1.8).toFixed(2)} SOL with 0.05 SOL! Deposit Now?`, 'info', 5000);
          const depositBtn = document.createElement('button');
          depositBtn.className = 'quick-deposit shake';
          depositBtn.textContent = 'Quick Deposit';
          depositBtn.onclick = () => this.openModal('deposit');
          document.body.appendChild(depositBtn);
          setTimeout(() => depositBtn.remove(), 5000);
          if (Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
              if (permission === 'granted') {
                new Notification('Bonus Drop Live! Bet Now!');
              }
            });
          }
          if (this.autoPlay) setTimeout(() => this.startGame(), 500);
        },
        openModal(type) {
          this.modalType = type;
          this.modalOpen = true;
          document.body.style.overflow = 'hidden';
        },
        closeModal() {
          this.modalOpen = false;
          document.body.style.overflow = '';
        },
        connectWallet() {
          this.userLoggedIn = true;
          this.addMessage('System', 'Wallet connected!');
          setTimeout(() => this.openModal('deposit'), 300);
        },
        deposit() {
          this.totalDeposited += parseFloat(this.depositAmount);
          if (!this.firstDepositMade && this.totalDeposited >= 0.1) {
            this.balance += 0.01;
            this.showToast('+0.01 SOL FREE for First Deposit!', 'success');
            this.firstDepositMade = true;
          }
          this.closeModal();
        },
        requestWithdraw() {
          if (confirm('Withdraw now or try Double or Nothing for 2x?')) {
            this.showToast('Withdrawal queued (24h processing).', 'success');
          } else {
            if (Math.random() > 0.4) {
              this.balance += parseFloat(this.withdrawAmount);
              this.showToast('Doubled! Withdrawal increased!', 'success');
            } else {
              this.showToast('Lost! Withdrawal canceled.', 'error');
              this.withdrawAmount = 0.1;
            }
          }
          this.closeModal();
        },
        offerDouble() {
          if (Math.random() > 0.4) {
            this.balance += parseFloat(this.withdrawAmount);
            this.showToast('Doubled! Withdrawal increased!', 'success');
          } else {
            this.showToast('Lost! Withdrawal canceled.', 'error');
            this.withdrawAmount = 0.1;
          }
          this.closeModal();
        },
        addMessage(user, msg) {
          this.chatMessages = [{ id: Date.now(), user, text: msg, isBigWin: msg.includes('Cashed out') }, ...this.chatMessages.slice(0, 19)];
        },
        addFakeChatMessage(text) {
          const users = ['SolWhale', 'DegenLad', 'Anon326', 'CryptoKing'];
          this.chatMessages = [{
            id: Date.now(),
            user: users[Math.floor(Math.random() * users.length)],
            text,
            isBigWin: text.includes('cashed out') || text.includes('hit')
          }, ...this.chatMessages.slice(0, 19)];
          if (Math.random() < 0.2 && !this.gameRunning) {
            this.chatMessages = [{
              id: Date.now(),
              user: 'System',
              text: '10x Streak Active! Cash out big! üî•',
              isBigWin: true
            }, ...this.chatMessages.slice(0, 19)];
          }
        },
        updateLeaderboard(username, winnings) {
          this.leaderboard = [{ username, winnings }, ...this.leaderboard.filter(l => l.username !== username).slice(0, 4)];
          if (winnings > this.leaderboard[0].winnings) {
            this.showToast(`${username} broke the record with ${winnings.toFixed(2)} SOL!`, 'success', 5000);
          }
        },
        shareReferral() {
          const text = 'Join SOL Crash & get 0.01 SOL free! üöÄ https://solcrash.app?ref=123';
          if (navigator.share) {
            navigator.share({ text });
          } else {
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`);
          }
        },
        claimMissionReward(mission) {
          if (this.missions[mission]) {
            this.balance += 0.005;
            this.showToast('Claimed 0.005 SOL!', 'success');
            this.missions[mission] = false;
          }
        },
        showToast(message, type, duration = 3000) {
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          toast.textContent = message;
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), duration);
        },
        triggerHaptic(pattern) {
          if (navigator.vibrate) navigator.vibrate(pattern);
        },
        toggleAuto() {
          this.autoPlay = !this.autoPlay;
        }
      }));
    });
  </script>
</body>
</html>