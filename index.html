<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>MemePicks – Meme Coin Prop Betting</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.93.0/lib/index.iife.min.js"></script>
  <script>
    // Base URL for backend API calls
    const BASE_URL = 'https://memepicks-backend.onrender.com';
  </script>
  <style>
    /* Base styles */
    body {
      font-family: 'Sora', sans-serif;
      /* Updated background gradient for hypnotic pulse */
      background: linear-gradient(180deg, #0F0F2A 0%, #05051A 100%);
      /* Dark, cosmic gradient to draw focus */
      animation: bgPulse 10s infinite ease-in-out;
      transition: filter 0.3s ease;
      color: #FFFFFF;
      min-height: 100vh;
      margin: 0;
      overscroll-behavior: none;
    }

    /* Keyframes for Hypnotic Background Pulse */
    @keyframes bgPulse {
      0%, 100% { filter: brightness(1) saturate(1); }
      50% { filter: brightness(1.1) saturate(1.2); }
    }

    /* Mood-based background shifts */
    body.mood-win {
      background: linear-gradient(180deg, #3A2A0F 0%, #2A1F05 100%);
      filter: brightness(1.2) saturate(1.5);
      /* Euphoric gold rush */
    }
    body.mood-loss {
      background: linear-gradient(180deg, #2A0F0F 0%, #1A0505 100%);
      filter: brightness(0.8) saturate(1.4);
      /* Urgent red tension */
    }

    body.modal-open {
      overflow: hidden;
    }

    /* Cards as Dopamine Triggers */
    .card {
      background: linear-gradient(145deg, #1A1A3A, #2A2A5A); /* Gradient for depth */
      border: 2px solid rgba(255, 77, 77, 0.5); /* Reddish initial border */
      box-shadow: 0 4px 20px rgba(255, 77, 77, 0.3); /* Initial red shadow */
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      position: relative;
      overflow: hidden; /* For the radial gradient effect */
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 100%;
      box-sizing: border-box;
    }
    .card:hover {
      transform: scale(1.08) translateY(-6px); /* Lift and enlarge on hover */
      box-shadow: 0 10px 40px rgba(255, 215, 0, 0.6); /* Gold shadow on hover */
      border-color: #FFD700; /* Gold border on hover */
    }
    /* Radial gradient flash on hover */
    .card::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 215, 0, 0.4), transparent);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none; /* Ensure clicks go through */
    }
    .card:hover::after {
      opacity: 1;
      animation: dopamineFlash 1s infinite; /* Pulsing flash animation */
    }
    /* Keyframes for Dopamine Flash */
    @keyframes dopamineFlash {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 0.5; }
    }
    /* Image styling for token pulse */
    .card img {
      border: 3px solid #FFD700; /* Gold border around image */
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.7); /* Gold shadow around image */
      transition: transform 0.3s ease;
      animation: tokenPulse 2s infinite; /* Subtle pulse animation for image */
      border-radius: 50%; /* Ensure images are round */
      object-fit: contain; /* Maintain aspect ratio */
    }
    /* Keyframes for Token Pulse */
    @keyframes tokenPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* Slot-Machine Card Entry Animation (CSS version - replaced by GSAP) */
    /* @keyframes slotReel {
      0% { transform: translateY(-150%) rotateX(120deg); opacity: 0; filter: blur(10px); }
      50% { transform: translateY(30%) rotateX(-20deg); opacity: 0.6; }
      100% { transform: translateY(0) rotateX(0); opacity: 1; filter: blur(0); }
    } */
    /* .card.slot-reel {
      animation: slotReel 0.6s cubic-bezier(0.5, 0, 0.5, 1) forwards;
    } */


    /* Buttons as Click Magnets */
    .button-primary,
    .button-secondary {
      padding: 12px 16px;
      min-height: 48px;
      min-width: 80px;
      font-size: 14px;
      touch-action: manipulation;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      position: relative; /* For shimmer effect */
      overflow: hidden; /* For shimmer effect */
    }

    .button-primary {
      background: linear-gradient(90deg, #FF1A1A, #FFD700); /* Red-to-gold gradient */
      color: #FFFFFF;
      border: none;
      box-shadow: 0 6px 20px rgba(255, 26, 26, 0.6); /* Red shadow */
      text-shadow: 0 0 5px rgba(255, 215, 0, 0.7); /* Gold text shadow */
    }
    .button-primary:hover:not(:disabled) {
      box-shadow: 0 10px 30px rgba(255, 215, 0, 0.8); /* Enhanced gold shadow on hover */
      transform: scale(1.1) translateY(-3px); /* Lift and enlarge more on hover */
    }
    .button-primary:active:not(:disabled) {
      transform: scale(0.97);
    }
    .button-primary:disabled {
      background: #4A4A4A;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      color: #9CA3AF;
      text-shadow: none;
    }
    /* Shimmer effect for primary buttons */
    .button-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
      /* GSAP animation will control this */
      /* transition: left 0.4s ease; */
    }
    /* .button-primary:hover::before { // GSAP will handle hover effect
      left: 100%;
    } */


    .button-secondary {
      background: transparent;
      border: 3px solid #FF1A1A; /* Red border */
      color: #FFD700; /* Gold text */
      text-shadow: 0 0 5px rgba(255, 26, 26, 0.7); /* Red text shadow */
    }
    .button-secondary:hover:not(:disabled) {
      background: linear-gradient(90deg, #FF1A1A, #FFD700); /* Red-to-gold on hover */
      color: #FFFFFF;
      border: none; /* Remove border on hover */
      transform: scale(1.03) translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 26, 26, 0.4); /* Red shadow on hover */
      text-shadow: 0 0 5px rgba(255, 215, 0, 0.7);
    }
    .button-secondary:active:not(:disabled) {
      transform: scale(0.97);
    }
    .button-secondary.active {
      background: linear-gradient(90deg, #FF1A1A, #FFD700); /* Red-to-gold when active */
      color: #FFFFFF;
      border: none;
      box-shadow: 0 6px 20px rgba(255, 26, 26, 0.6); /* Red shadow when active */
      animation: activePulse 1.5s infinite; /* Pulsing animation when active */
      text-shadow: 0 0 5px rgba(255, 215, 0, 0.7);
    }
    /* Keyframes for Active Pulse */
    @keyframes activePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .button-auth {
      background: linear-gradient(90deg, #FF1A1A 0%, #FFD700 100%); /* Red-to-gold */
      color: #FFFFFF;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 8px;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 44px;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
    }
    .button-auth:hover {
      box-shadow: 0 6px 12px rgba(255, 26, 26, 0.4); /* Red shadow on hover */
      transform: scale(1.03) translateY(-1px);
    }
    .button-auth:active {
      transform: scale(0.97);
    }


    .input-field {
      background: #1E1E1E;
      border: 1px solid #4A4A4A;
      color: #FFFFFF;
      padding: 12px;
      border-radius: 8px;
      width: 100%;
      font-size: 16px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      box-sizing: border-box;
      font-family: 'Sora', sans-serif;
    }
    .input-field:focus {
      outline: none;
      border-color: #FFD700; /* Gold focus */
      box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3); /* Gold glow */
    }

    /* Wager Suggestion Tooltip */
    .wager-tooltip-container {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .wager-tooltip {
      position: absolute;
      bottom: calc(100% + 5px);
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(255, 26, 26, 0.9); /* Reddish background */
      color: #FFD700; /* Gold text */
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 10;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
      text-shadow: 0 0 3px rgba(255, 215, 0, 0.5);
    }
    .wager-tooltip::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -5px;
      border-width: 5px;
      border-style: solid;
      border-color: rgba(255, 26, 26, 0.9) transparent transparent transparent;
    }


    .tab-button {
      background: #2A2A2A;
      color: #B0B0B0;
      font-size: 14px;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 12px;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
      scroll-snap-align: start;
      opacity: 1;
      min-height: 48px;
      font-family: 'Sora', sans-serif;
    }
    .tab-button.active {
      background: linear-gradient(90deg, #FF1A1A, #FFD700); /* Red-to-gold active tab */
      color: #FFFFFF;
      box-shadow: 0 4px 12px rgba(255, 26, 26, 0.4); /* Red shadow */
      transform: scale(1.05);
      opacity: 1;
    }

    .slip-tray {
      background: #1E1E1E;
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease-in-out;
      position: fixed;
      bottom: 56px;
      left: 0;
      width: 100%;
      max-height: 50vh;
      z-index: 30;
      transform: translateY(100%);
      pointer-events: none;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }
    .slip-tray.open {
      transform: translateY(0);
      pointer-events: auto;
    }
    #payout-mobile {
      position: sticky;
      bottom: 64px;
      background: #1E1E1E;
      padding: 8px 0;
      z-index: 10;
      margin-top: auto;
    }
    .slip-tray .button-primary {
      position: sticky;
      bottom: 0;
      background: linear-gradient(90deg, #FF1A1A, #FFD700); /* Red-to-gold */
      z-index: 20;
      width: 100%;
      margin-top: 16px;
    }

    .modal {
      background: linear-gradient(145deg, #1A1A3A, #2A2A5A); /* Gradient */
      border: 3px solid #FFD700; /* Gold border */
      box-shadow: 0 10px 40px rgba(255, 26, 26, 0.7); /* Red shadow */
      animation: rewardPop 0.5s ease-out; /* Pop-in animation */
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      width: 100%;
      max-width: 100%;
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      position: fixed;
      bottom: 0;
      left: 0;
      z-index: 40;
      box-sizing: border-box;
      max-height: 90vh;
      overflow-y: auto;
    }
     /* Keyframes for Modal Pop-in */
    @keyframes rewardPop {
      0% { transform: translate(-50%, -50%) scale(0.7); opacity: 0; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
    .modal-container {
      background: radial-gradient(circle, rgba(255, 26, 26, 0.4), rgba(0, 0, 0, 0.9)); /* Radial gradient overlay */
      transition: opacity 0.3s ease-in-out;
      opacity: 0;
      pointer-events: none;
      position: fixed;
      inset: 0;
      z-index: 35;
    }
    .modal-container.open {
      opacity: 1;
      pointer-events: auto;
    }

    .drawer {
      position: fixed;
      top: 0;
      left: 0;
      width: 75%;
      max-width: 300px;
      height: 100%;
      background: #1E1E1E;
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateX(-100%);
      z-index: 50;
      padding: 16px;
      box-sizing: border-box;
      box-shadow: 4px 0 15px rgba(0,0,0,0.2);
    }
    .drawer.open {
      transform: translateX(0);
    }
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 45;
      transition: opacity 0.3s ease-in-out;
      opacity: 0;
      pointer-events: none;
    }
    .overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px) scale(0.99); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .badge {
      color: #FFFFFF;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
      display: inline-block;
    }
    .badge-hot { background: #FF4D4D; }
    .badge-new { background: #7C3AED; }
    .badge-expiring { background: #FBBF24; color: #1F2937; }

    /* Risk Level Badge Styles */
    .badge-risk {
        font-size: 10px;
        padding: 1px 6px;
        border-radius: 8px;
        font-weight: 700;
        text-transform: uppercase;
        margin-left: 8px;
    }
    .badge-risk-low { background-color: #10B981; color: white; }
    .badge-risk-medium { background-color: #F59E0B; color: white; }
    .badge-risk-high { background-color: #EF4444; color: white; }

    /* Odds Multiplier Style */
    .odds-multiplier {
        font-size: 10px;
        color: #a0aec0;
        margin-left: 4px;
    }

    /* Leaderboard as Trophy Case */
    .glow {
      animation: trophyGlow 1.5s infinite; /* Trophy glow animation */
    }
    /* Keyframes for Trophy Glow */
    @keyframes trophyGlow {
      0%, 100% { box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4); } /* Gold shadow */
      50% { box-shadow: 0 10px 40px rgba(255, 215, 0, 0.8); } /* Stronger gold shadow */
    }

    /* Near-Miss Explosion */
    .almost-won-card {
      border: 4px solid #FFD700; /* Gold border */
      box-shadow: 0 0 30px #FF1A1A, 0 0 15px #FFD700 inset; /* Red outer, gold inner shadow */
      background: linear-gradient(145deg, rgba(255, 26, 26, 0.2), rgba(255, 215, 0, 0.2)); /* Subtle red/gold gradient */
      animation: nearMissExplosion 1.2s infinite; /* Pulsing explosion animation */
    }
    /* Keyframes for Near-Miss Explosion */
    @keyframes nearMissExplosion {
      0%, 100% { box-shadow: 0 0 30px #FF1A1A, 0 0 15px #FFD700 inset; }
      50% { box-shadow: 0 0 50px #FFD700, 0 0 25px #FF1A1A inset; } /* Swap intensity */
    }
    /* "SO CLOSE!" badge */
    .almost-won-card::before {
      content: 'SO CLOSE!';
      position: absolute;
      top: 10px;
      right: 10px;
      background: #FF1A1A; /* Red background */
      color: #FFD700; /* Gold text */
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 800;
      animation: shakeText 0.5s infinite; /* Shaking text animation */
      z-index: 1; /* Ensure it's above content */
    }
    /* Keyframes for Shake Text */
    @keyframes shakeText {
      0%, 100% { transform: translateX(0); }
      50% { transform: translateX(-3px); }
    }


    .slip-preview {
      transition: opacity 0.3s ease;
      opacity: 0;
      z-index: 20;
      position: fixed;
      width: 100%;
      background: #1E1E1E;
      font-size: 0.875rem;
      line-height: 1.25rem;
      padding: 0.5rem;
      text-align: center;
      bottom: calc(56px + env(safe-area-inset-bottom) + 8px);
    }
    .slip-preview.visible {
      opacity: 1;
    }

    /* Toggle Switch Styles */
    .toggle-switch {
        position: relative; display: inline-block; width: 40px; height: 20px;
    }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
        position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
        background-color: #4A4A4A; transition: .4s; border-radius: 20px;
    }
    .toggle-slider:before {
        position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px;
        background-color: white; transition: .4s; border-radius: 50%;
    }
    input:checked + .toggle-slider { background-color: #FFD700; } /* Gold when checked */
    input:checked + .toggle-slider:before { transform: translateX(20px); }

    /* Chat as Social Casino */
    .chat-feed {
        height: 200px; background-color: #2A2A2A; border-radius: 8px; padding: 8px;
        overflow-y: scroll; margin-bottom: 8px; display: flex; flex-direction: column-reverse;
    }
    .chat-message {
        margin-bottom: 6px;
        font-size: 12px;
        animation: socialSlide 0.4s ease-out; /* Slide in animation */
    }
    /* Keyframes for Social Slide */
    @keyframes socialSlide {
      0% { transform: translateX(30px); opacity: 0; }
      100% { transform: translateX(0); opacity: 1; }
    }
    .chat-message .username { font-weight: 600; color: #A0AEC0; margin-right: 4px; }
    /* Hot Chat Message Style */
    .chat-message.hot {
      background: linear-gradient(145deg, #FF1A1A, #FFD700); /* Red-to-gold gradient */
      box-shadow: 0 0 15px #FF1A1A; /* Red glow */
      animation: hotMessage 1.5s infinite; /* Pulsing animation */
      padding: 4px 8px; /* Add padding for hot message */
      border-radius: 4px; /* Rounded corners for hot message */
    }
    /* Keyframes for Hot Message Pulse */
    @keyframes hotMessage {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    /* Auto-scrolling chat when idle */
    .chat-feed.idle-scroll {
        animation: autoScrollChat 15s linear infinite; /* Adjust duration as needed */
    }
    @keyframes autoScrollChat {
        0% { transform: translateY(0); }
        100% { transform: translateY(calc(-100% + 200px)); /* Scroll up by feed height minus visible area */ }
    }


    .chat-input-area { display: flex; gap: 8px; }

    /* Countdown Timer with Heartbeat */
    .countdown-timer {
      color: #FF1A1A; /* Red color */
      text-shadow: 0 0 10px #FF1A1A; /* Red glow */
      font-weight: 800;
      font-size: 10px; /* Ensure size is small */
      margin-left: auto;
      flex-shrink: 0;
      min-width: 50px;
      text-align: right;
    }
    /* Heartbeat animation for low time */
    .countdown-timer.low-time {
      animation: heartbeat 0.8s infinite;
    }
    /* Keyframes for Heartbeat */
    @keyframes heartbeat {
      0%, 100% { transform: scale(1); text-shadow: 0 0 10px #FF1A1A; }
      50% { transform: scale(1.15); text-shadow: 0 0 20px #FF1A1A; }
    }


    /* Live Global Bets Ticker as FOMO Engine */
    .bets-ticker {
      position: fixed;
      /* top: 56px; /* Below header on mobile - Adjusted below */
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.9); /* Darker background */
      border: 2px solid #FFD700; /* Gold border */
      box-shadow: 0 0 20px rgba(255, 26, 26, 0.7); /* Red shadow */
      color: #FFD700; /* Gold text */
      font-size: 12px;
      padding: 8px 0; /* Increased padding */
      z-index: 15;
      overflow: hidden;
      white-space: nowrap;
      /* Adjusted top position for mobile to be below tabs */
      top: calc(56px + 48px); /* Header (56px) + Tabs (48px) */
    }
    .bets-ticker span {
      display: inline-block;
      padding-left: 100%; /* Start off-screen */
      animation: marquee 10s linear infinite, fomoFlicker 2s infinite; /* Marquee and flicker */
      text-shadow: 0 0 10px #FF1A1A; /* Red text shadow */
    }
    /* Keyframes for FOMO Flicker */
    @keyframes fomoFlicker {
      0%, 100% { opacity: 1; text-shadow: 0 0 10px #FF1A1A; }
      50% { opacity: 0.9; text-shadow: 0 0 15px #FFD700; } /* Swap intensity */
    }
    @keyframes marquee {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
     @media (min-width: 768px) {
         .bets-ticker { top: 0; } /* At top on desktop */
     }


    /* Screen Shake */
    @keyframes screenShake {
      0% { transform: translate(1px, 1px) rotate(0deg); }
      10% { transform: translate(-1px, -2px) rotate(-1deg); }
      20% { transform: translate(-3px, 0px) rotate(1deg); }
      30% { transform: translate(3px, 2px) rotate(0deg); }
      40% { transform: translate(1px, -1px) rotate(1deg); }
      50% { transform: translate(-1px, 2px) rotate(-1deg); }
      60% { transform: translate(-3px, 1px) rotate(0deg); }
      70% { transform: translate(3px, 1px) rotate(-1deg); }
      80% { transform: translate(-1px, -1px) rotate(1deg); }
      90% { transform: translate(1px, 2px) rotate(0deg); }
      100% { transform: translate(1px, -2px) rotate(-1deg); }
    }
    body.shake { animation: screenShake 0.5s cubic-bezier(.36,.07,.19,.97) both; transform: translate3d(0, 0, 0); perspective: 1000px; }

    /* Red Outline / Dimming (placeholder) */
    .lose-effect {
        animation: loseFade 1s ease-out forwards; /* Delayed Feedback for Losses */
    }
    @keyframes loseFade {
        0% { opacity: 1; border-color: transparent; box-shadow: none; }
        20% { border-color: red; box-shadow: 0 0 10px red; } /* Flash red */
        50% { opacity: 0.5; border-color: red; box-shadow: 0 0 10px red; } /* Dim */
        100% { opacity: 0; transform: translateY(20px); /* Fade and drop slightly */ display: none; }
    }

    /* Dopamine Progress Meter (SVG) */
    .progress-meter {
        position: absolute;
        top: -10px; /* Adjust position */
        left: -10px; /* Adjust position */
        width: 80px; /* Increased size */
        height: 80px; /* Increased size */
        z-index: 25;
        transform: translate(-50%, -50%);
        filter: drop-shadow(0 0 15px #FFD700); /* Gold drop shadow */
        animation: wheelSpin 10s infinite linear; /* Spinning animation */
    }
     /* Keyframes for Wheel Spin */
    @keyframes wheelSpin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
     .progress-meter circle {
        fill: none;
        stroke: #4A4A4A; /* Background color */
        stroke-width: 8; /* Increased stroke width */
        transition: stroke-dashoffset 0.3s ease-in-out;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
        r: 30; /* Radius */
     }
    .progress-meter .progress-circle {
        stroke: url(#rewardGradient); /* Use gradient for stroke */
        stroke-width: 8;
        stroke-dasharray: 188.5; /* Circumference for a radius of 30 */
        stroke-dashoffset: 188.5; /* Start hidden */
        animation: rewardGlow 1.5s infinite; /* Pulsing glow animation */
    }
     /* Keyframes for Reward Glow */
    @keyframes rewardGlow {
      0%, 100% { filter: drop-shadow(0 0 10px #FFD700); } /* Gold glow */
      50% { filter: drop-shadow(0 0 20px #FF1A1A); } /* Red glow */
    }
    /* SVG Gradient Definition */
    svg defs {
      /* Reward gradient */
    }
    #rewardGradient stop:first-child {
      stop-color: #FF1A1A; /* Red start */
      offset: 0%;
    }
    #rewardGradient stop:last-child {
      stop-color: #FFD700; /* Gold end */
      offset: 100%;
    }

    /* Glow Trails on Active Slips (placeholder) */
    .fab.glow-green { box-shadow: 0 0 10px green, 0 0 20px green inset; }
    .fab.glow-yellow { box-shadow: 0 0 10px yellow, 0 0 20px yellow inset; }
    .fab.glow-red { box-shadow: 0 0 10px red, 0 0 20px red inset; }


    /* Exit-Intent Modal with Urgency */
     #exitIntentModal .modal {
        background: linear-gradient(145deg, #FF1A1A, #FFD700); /* Red-to-gold gradient */
        border: 3px solid #FFD700; /* Gold border */
        box-shadow: 0 10px 40px rgba(255, 26, 26, 0.7); /* Red shadow */
     }
     /* Spinning Coin Icon */
     #exitIntentModal .modal::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 50%;
        width: 80px;
        height: 80px;
        background: url('https://placehold.co/80x80/FFD700/000000?text=COIN'); /* Gold coin placeholder */
        background-size: cover;
        transform: translateX(-50%);
        animation: urgentSpin 1.5s infinite; /* Spinning animation */
        z-index: 1; /* Above modal content */
     }
     /* Keyframes for Urgent Spin */
     @keyframes urgentSpin {
        0% { transform: translateX(-50%) rotateY(0deg); }
        100% { transform: translateX(-50%) rotateY(360deg); }
     }


    /* Leaderboard "Almost Top 10" Trigger */
    .almost-top-10 {
        border: 2px dashed #FBBF24; /* Yellow dashed border */
        background-color: rgba(251, 191, 36, 0.1); /* Subtle yellow background */
        position: relative;
        overflow: hidden;
    }
    /* "SO CLOSE!" badge for leaderboard */
    .almost-top-10::after {
        content: 'SO CLOSE!';
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: #FF1A1A; /* Red background */
        color: #FFD700; /* Gold text */
        font-size: 10px;
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 4px;
        transform: rotate(15deg);
        transform-origin: top right;
        z-index: 5;
        animation: urgentFlash 1s infinite; /* Flashing animation */
    }
     /* Keyframes for Urgent Flash */
    @keyframes urgentFlash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }


    /* "Hunch Score" Meter as Confidence Booster */
    .hunch-meter {
        width: 100%;
        height: 10px;
        background-color: #1A1A3A; /* Dark background */
        border-radius: 5px;
        overflow: hidden;
        position: relative;
        box-shadow: 0 0 15px rgba(255, 26, 26, 0.5); /* Red shadow */
    }
     .hunch-meter .hunch-fill {
        height: 100%;
        background: linear-gradient(90deg, #FF1A1A, #FFD700); /* Red-to-gold gradient */
        width: var(--hunch-percentage, 50%); /* Controlled by JS/Alpine */
        transition: width 0.3s ease-in-out;
        position: relative; /* For shimmer effect */
     }
     /* Shimmer effect for hunch fill */
     .hunch-meter .hunch-fill::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
        animation: confidenceShimmer 1.5s infinite; /* Shimmer animation */
     }
     /* Keyframes for Confidence Shimmer */
     @keyframes confidenceShimmer {
        0% { left: -100%; }
        100% { left: 100%; }
     }
     .hunch-score-label {
         position: absolute;
         top: 50%;
         left: var(--hunch-percentage, 50%);
         transform: translate(-50%, -50%);
         font-size: 10px;
         font-weight: bold;
         color: #FFD700; /* Gold text */
         text-shadow: 0 0 10px #FF1A1A; /* Red text shadow */
         z-index: 2;
         animation: confidencePop 2s infinite; /* Pop animation */
     }
     /* Keyframes for Confidence Pop */
     @keyframes confidencePop {
        0%, 100% { transform: translate(-50%, -50%) scale(1); }
        50% { transform: translate(-50%, -50%) scale(1.2); }
     }

    /* Mystery Box as Slot Machine */
    #mysteryBoxModal img {
        filter: drop-shadow(0 0 20px #FFD700); /* Gold glow */
        animation: slotReveal 1.5s ease-out; /* Spinning reveal animation */
    }
    /* Keyframes for Slot Reveal */
    @keyframes slotReveal {
        0% { transform: rotateY(0deg) scale(0.5); opacity: 0; }
        100% { transform: rotateY(720deg) scale(1); opacity: 1; }
    }


    /* Ambient Slot Machine Particles */
    #slot-particles {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1; /* Behind everything */
        pointer-events: none; /* Don't block clicks */
    }
    .particle {
        position: absolute;
        width: 12px;
        height: 12px;
        background: radial-gradient(circle, #FFD700, transparent); /* Gold gradient */
        border-radius: 50%;
        animation: particleFloat 4s infinite; /* Floating animation */
    }
    /* Keyframes for Particle Float */
    @keyframes particleFloat {
        0% { opacity: 0; transform: translateY(100vh) scale(0); }
        50% { opacity: 0.8; }
        100% { opacity: 0; transform: translateY(0) scale(1); }
    }

    /* Limited Spots Badge */
    .badge-spots {
        background: #FF1A1A; /* Red background */
        color: #FFD700; /* Gold text */
        animation: urgentFlash 1s infinite; /* Flashing animation */
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: bold;
        margin-left: 4px;
        display: inline-block;
    }

    /* Added CSS for Reduced Motion */
    @media (prefers-reduced-motion: reduce), .reduced-motion {
        .card.slot-reel, .progress-meter, .button-primary::before, .particle,
        .almost-won-card, .animate-shake, .badge-spots, .bets-ticker span,
        .chat-message.hot, .countdown-timer.low-time, .modal,
        .button-primary.idle, .chat-feed.idle-scroll { /* Added idle animations */
            animation: none !important;
            transition: none !important;
        }
        /* Also remove GSAP animations */
    }

    /* Added CSS for will-change optimization */
    .card.slot-reel, .particle, .progress-meter, .button-primary::before,
    .almost-won-card, .bets-ticker span, .chat-message.hot, .countdown-timer.low-time {
        will-change: transform, opacity;
    }

    /* Pulse Lock Animation for Idle Buttons */
    @keyframes idlePulse {
      0%, 100% { transform: scale(1); box-shadow: 0 0 0px transparent; }
      50% { transform: scale(1.05); box-shadow: 0 0 15px rgba(255,215,0,0.4); } /* Subtle pulse */
    }
    .button-primary.idle {
      animation: idlePulse 2s infinite ease-in-out;
    }
     .fab.idle {
        animation: idlePulse 2s infinite ease-in-out;
     }


    /* Mobile Specific Adjustments */
    @media (max-width: 767px) {
      .header {
        padding: 0 16px; border-bottom: 1px solid #2A2A2A; height: 56px; display: flex;
        align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0;
        width: 100%; background: #1A1A1A; z-index: 20;
      }
      .header-left { display: flex; align-items: center; gap: 8px; }
      .hamburger {
        width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
        font-size: 24px; color: #B0B0B0;
      }
      .hamburger:hover { color: #FFFFFF; }
      .logo { flex: 1; text-align: center; font-size: 20px; font-weight: 700; color: #FFFFFF; }
      .header-right { display: flex; align-items: center; gap: 8px; }
      .button-auth { padding: 8px 12px; font-size: 14px; }

      .sticky-tabs {
        position: sticky; top: 56px; z-index: 20; /* Increased z-index to be above ticker */
        background: #1A1A1A;
        padding: 0 16px; border-bottom: 1px solid #2A2A2A;
      }
      .tabs {
        display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scroll-padding: 0 16px;
        scroll-behavior: smooth; gap: 8px; padding: 8px 0; -webkit-overflow-scrolling: touch;
        white-space: nowrap; width: 100%; box-sizing: border-box; scrollbar-width: none;
        -ms-overflow-style: none;
      }
      .tabs::-webkit-scrollbar { display: none; }

      /* Adjusted main content top padding considering ticker */
      .main-content {
        padding: 16px;
        /* Header(56) + Tabs(48) + Ticker (~24px) + Spacing(8) */
        padding-top: calc(56px + 48px + 24px + 8px); /* Adjust 24px for ticker height */
        padding-bottom: calc(56px + env(safe-area-inset-bottom) + 16px);
        transition: padding-bottom 0.3s ease-in-out; box-sizing: border-box; width: 100%;
        max-width: 100vw;
      }

      .card .prop-content { display: flex; align-items: flex-start; gap: 12px; }
      .card img { width: 64px; height: 64px; object-fit: contain; border-radius: 50%; flex-shrink: 0; }
      .card .separator { border-top: 1px solid #2A2A2A; margin: 8px 0; }
      .card h3 { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
      .card p.text-sm { font-size: 14px; margin-top: 4px; color: #E0E0E0; line-height: 1.4; }
      .card p.text-xs { font-size: 12px; margin-top: 4px; color: #B0B0B0; }
      .card .stats { border-top: 1px solid #2A2A2A; padding-top: 8px; margin-top: 8px; }

      .fab {
        background: linear-gradient(90deg, #FF1A1A 0%, #FFD700 100%); /* Red-to-gold */
        color: #FFFFFF; padding: 12px 20px; border-radius: 24px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1);
        display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 600;
        position: fixed; bottom: calc(56px + env(safe-area-inset-bottom) + 16px); right: 16px;
        z-index: 20; min-height: 44px;
      }
      .fab .badge {
        background: #FFFFFF; color: #1A1A1A; border-radius: 50%; width: 20px; height: 20px;
        display: flex; justify-content: center; align-items: center; font-size: 12px;
        line-height: 1; margin-left: 0; border: 1px solid rgba(0, 0, 0, 0.2);
      }
       /* Dopamine Progress Meter positioning relative to FAB */
      .fab-container {
          position: fixed;
          bottom: calc(56px + env(safe-area-inset-bottom) + 16px); right: 16px;
          z-index: 20;
          display: flex;
          align-items: center;
          justify-content: center;
          width: 44px; /* Match FAB min-height */
          height: 44px; /* Match FAB min-height */
      }
      .progress-meter {
           position: absolute;
           width: 80px; /* Larger than FAB */
           height: 80px; /* Larger than FAB */
           top: 50%;
           left: 50%;
           transform: translate(-50%, -50%);
           z-index: 25;
      }
      .progress-meter circle {
          r: 30; /* Radius */
      }


      .bottom-nav {
        background: #1A1A1A; border-top: 1px solid #2A2A2A; height: 56px;
        padding-bottom: env(safe-area-inset-bottom); position: fixed; bottom: 0; left: 0;
        width: 100%; z-index: 60; display: flex; justify-content: space-around;
        align-items: center; box-sizing: border-box;
      }
      .bottom-nav button {
        min-height: 48px; width: 20%; display: flex; flex-direction: column;
        align-items: center; justify-content: center; gap: 4px; font-size: 10px;
        color: #B0B0B0; transition: color 0.2s ease, transform 0.2s ease; padding: 4px 0;
      }
      .bottom-nav button.active { color: #FFFFFF; transform: scale(1.05); }
      .bottom-nav button:hover { color: #FFFFFF; }
      .bottom-nav .icon { font-size: 20px; }
      .bottom-nav .label { font-size: 10px; }
    }

    /* Desktop Adjustments */
    @media (min-width: 768px) {
      .header {
         padding: 0 24px; border-bottom: 1px solid #2A2A2A; height: 64px; display: flex;
         align-items: center; justify-content: space-between; position: sticky; top: 0;
         background: #1A1A1A; z-index: 20;
      }
      .header-left { display: none; } /* Hide hamburger on desktop */
      .logo { text-align: left; font-size: 24px; flex: none;}
      .header-right { display: flex; align-items: center; gap: 16px; }
      .header-right > p { display: block !important; } /* Show wallet address */


      .sticky-tabs {
          position: static; /* Not sticky on desktop */
          padding: 16px 24px;
          border-bottom: none;
      }
      .tabs {
          display: flex;
          gap: 16px; /* More space */
          justify-content: center; /* Center tabs */
          overflow-x: visible; /* No horizontal scroll */
          scroll-snap-type: none;
          padding: 0;
          white-space: normal;
          width: auto;
          scrollbar-width: auto;
          -ms-overflow-style: auto;
      }
       .tabs::-webkit-scrollbar { display: block; } /* Show scrollbar if needed */

       .main-content {
           padding: 24px; /* More padding on desktop */
           padding-top: calc(64px + 16px + 24px); /* Header + Tabs top padding + Ticker height */
           max-width: 800px; /* Max width for content */
           margin-left: auto;
           margin-right: auto;
       }

      .fab { display: none; } /* Hide FAB on desktop */
      .bottom-nav { display: none; } /* Hide bottom nav on desktop */

      /* Show slip tray on desktop */
      .slip-tray {
         position: static;
         transform: translateY(0);
         pointer-events: auto;
         max-height: none;
         overflow-y: visible;
         border-top-left-radius: 12px;
         border-top-right-radius: 12px;
         padding: 24px;
         box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      .slip-tray-wrapper {
          width: 300px; /* Fixed width for slip tray on desktop */
          flex-shrink: 0;
      }
      .main-layout {
          display: flex;
          gap: 24px;
          padding-top: calc(64px + 16px); /* Header + Tabs top padding */
          max-width: 1200px; /* Wider max width for main layout */
          margin: 0 auto;
      }
       .main-content {
           flex-grow: 1;
           padding-top: 24px; /* Remove top padding here as it's on main-layout */
       }
       .slip-tray {
           flex-grow: 0;
       }
        #payout-mobile {
            position: static;
            padding: 0;
            margin-top: 16px;
            background: transparent;
            bottom: auto;
        }
        .slip-tray .button-primary {
             position: static;
             margin-top: 16px;
        }
        .modal {
            position: fixed; /* Keep modals fixed */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 400px; /* Smaller modals */
            width: 90%;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            transform: translate(-50%, -50%) scale(0.9);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
         .modal.open {
             transform: translate(-50%, -50%) scale(1);
         }
         .modal-container {
             background: rgba(0, 0, 0, 0.7);
         }

        .bets-ticker { top: 0; } /* Ticker at top on desktop */

    }

  </style>
</head>
<body x-data="memePicks"
    @wallet-connected.window="walletAddress = $event.detail.address; getWalletBalance($event.detail.address); updateOddsDisplay()"
    @balance-updated.window="walletBalance = $event.detail.balance"
    @click.outside="if(activeModal && activeModal !== 'teaserModal' && activeModal !== 'ageGateModal') closeAllModals()"
    @keydown.escape.window="if(activeModal && activeModal !== 'teaserModal' && activeModal !== 'ageGateModal') closeModal(activeModal); else if(showDrawer) showDrawer = false; else if(showSlipTray && window.innerWidth < 768) showSlipTray = false;"
    x-init="init()">

  <div id="slot-particles"></div>
  <div id="coin-flip" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-16 h-16 z-[9999] hidden pointer-events-none">
    <img src="https://placehold.co/64x64/FFD700/000000?text=COIN" alt="Coin Flip" class="w-full h-full animate-spin" onerror="this.src='https://placehold.co/64x64/707070/FFFFFF?text=ERR'">
  </div>


  <div class="overlay" :class="{ 'open': showDrawer || activeModal }" @click="if(activeModal !== 'teaserModal' && activeModal !== 'ageGateModal') closeAllModals(); else if(showDrawer) showDrawer = false;" aria-hidden="true"></div>
  <aside class="drawer p-4" :class="{ 'open': showDrawer }" x-show="showDrawer" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="-translate-x-full" x-transition:enter-end="translate-x-0" x-transition:leave="transition ease-in duration-300" x-transition:leave-start="translate-x-0" x-transition:leave-end="-translate-x-full" role="dialog" aria-modal="true" aria-labelledby="drawer-title">
    <div class="flex justify-between items-center mb-6">
      <h2 id="drawer-title" class="text-lg font-semibold text-[#FFD700]">MemePicks</h2> <button class="text-[#B0B0B0] hover:text-red-500 w-8 h-8 flex items-center justify-center text-2xl" @click="showDrawer = false" aria-label="Close menu">✕</button>
    </div>
    <nav class="space-y-2">
      <div x-show="!walletAddress" class="space-y-2">
        <button class="button-auth w-full text-sm" @click="showDrawer = false; openModal('walletChoiceModal')" aria-label="Connect Wallet">Connect Wallet</button>
      </div>
      <button x-show="walletAddress" class="block w-full text-left py-2 text-sm text-[#E0E0E0] hover:text-[#FFD700]" @click="openProfile()" aria-label="My Profile">My Profile</button> <button x-show="walletAddress" class="block w-full text-left py-2 text-sm text-[#E0E0E0] hover:text-[#FFD700]" @click="getInviteLink()" aria-label="Get Invite Link">Get Invite Link</button> <button class="block w-full text-left py-2 text-sm text-[#E0E0E0] hover:text-[#FFD700]" @click="showDrawer = false; openModal('limitModal')" aria-label="Set Wager Limit">Set Wager Limit</button> <button x-show="walletAddress" class="block w-full text-left py-2 text-sm text-[#E0E0E0] hover:text-red-500" @click="showDrawer = false; disconnectWallet()" aria-label="Disconnect Wallet">Disconnect Wallet</button> <div class="mt-6 border-t border-gray-700 pt-4">
           <h3 class="text-xs font-semibold text-gray-500 uppercase mb-2">Help & Support</h3>
            <a href="#" class="block py-2 text-sm text-[#E0E0E0] hover:text-[#FFD700]" @click="showDrawer = false; tab = 'help'" aria-label="Help Center">Help Center / FAQs</a> <a href="#" class="block py-2 text-sm text-[#E0E0E0] hover:text-[#FFD700]" aria-label="Responsible Betting">Responsible Betting</a> <a href="https://t.me/+7dSkZ_j-i5tlMTNh" target="_blank" rel="noopener noreferrer" class="block py-2 text-sm text-[#E0E0E0] hover:text-[#FFD700]" aria-label="Telegram">Telegram</a> <a href="#" class="block py-2 text-sm text-[#E0E0E0] hover:text-[#FFD700]" aria-label="Terms & Privacy">Terms & Privacy</a>
            <div class="mt-4">
                <label class="flex items-center justify-between text-sm text-gray-300">
                    Reduced Motion
                    <label class="toggle-switch">
                        <input type="checkbox" @change="toggleReducedMotion($event.target.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </label>
            </div>
         </div>
    </nav>
  </aside>

  <header class="header">
    <div class="header-left">
      <button 
  class="hamburger"
  @click="showDrawer = true"
  aria-label="Open menu"
  aria-controls="drawer-menu"
  :aria-expanded="showDrawer.toString()"
>
  ☰
</button>
    </div>
    <h1 class="logo text-[#FFD700]">MemePicks</h1> <div class="header-right">
      <p class="text-xs text-[#B0B0B0] cursor-pointer hover:text-white mr-4"
         x-show="walletAddress"
         x-text="walletAddress ? walletAddress.slice(0, 4) + '...' + walletAddress.slice(-4) : ''"
         @click="copyAddress()"
         title="Copy address">
      </p>
       <div class="flex items-center gap-2">
            <p class="text-xs text-gray-400"><span class="hidden sm:inline">Balance:</span> <span x-text="walletAddress ? (walletBalance !== null ? walletBalance.toFixed(2) + ' SOL' : 'Loading...') : ''"></span></p>
       </div>
      <div class="flex items-center gap-2" x-show="!walletAddress">
          <button class="button-auth text-sm" @click="openModal('walletChoiceModal')" aria-label="Connect Wallet">Connect Wallet</button>
      </div>
      <button class="button-auth text-sm" x-show="walletAddress" @click="disconnectWallet()" aria-label="Disconnect Wallet">
        <span>Disconnect</span>
      </button>
    </div>
  </header>

  <div class="text-center text-xs text-gray-400 pt-1 fixed top-14 md:top-0 left-0 right-0 z-[5] bg-gradient-to-b from-[#1A1A1A] to-transparent pb-2 md:pb-0 md:pt-0">
    Live SOL Price: $<span id="price-display">Loading...</span>
  </div>

   <div class="bets-ticker md:top-16">
       <span x-text="liveBetFeed"></span>
  </div>

  <div class="sticky-tabs md:relative" role="tablist" aria-label="Game Categories">
    <div class="tabs" x-ref="tabs">
      <button :class="{ 'tab-button active': tab === 'trending', 'tab-button': tab !== 'trending' }" @click="tab = 'trending'; scrollTabIntoView($el); closeAllModals()" role="tab" :aria-selected="tab === 'trending'" aria-controls="trending-panel" :tabindex="tab === 'trending' ? 0 : -1">Trending</button>
      <button :class="{ 'tab-button active': tab === 'marketcap', 'tab-button': tab !== 'marketcap' }" @click="tab = 'marketcap'; scrollTabIntoView($el); closeAllModals()" role="tab" :aria-selected="tab === 'marketcap'" aria-controls="marketcap-panel" :tabindex="tab === 'marketcap' ? 0 : -1">MCap</button>
      <button :class="{ 'tab-button active': tab === 'volume', 'tab-button': tab !== 'volume' }" @click="tab = 'volume'; scrollTabIntoView($el); closeAllModals()" role="tab" :aria-selected="tab === 'volume'" aria-controls="volume-panel" :tabindex="tab === 'volume' ? 0 : -1">Volume</button>
      <button :class="{ 'tab-button active': tab === 'headtohead', 'tab-button': tab !== 'headtohead' }" @click="tab = 'headtohead'; scrollTabIntoView($el); closeAllModals();" role="tab" :aria-selected="tab === 'headtohead'" aria-controls="headtohead-panel" :tabindex="tab === 'headtohead' ? 0 : -1">H2H</button>
      <button :class="{ 'tab-button active': tab === 'memefactor', 'tab-button': tab !== 'memefactor' }" @click="tab = 'memefactor'; scrollTabIntoView($el); closeAllModals()" role="tab" :aria-selected="tab === 'memefactor'" aria-controls="memefactor-panel" :tabindex="tab === 'memefactor' ? 0 : -1">Meme Factor</button>
      <button :class="{ 'tab-button active': tab === 'expiring', 'tab-button': tab !== 'expiring' }" @click="tab = 'expiring'; scrollTabIntoView($el); closeAllModals()" role="tab" :aria-selected="tab === 'expiring'" aria-controls="expiring-panel" :tabindex="tab === 'expiring' ? 0 : -1">Expiring</button>
    </div>
  </div>

   <div class="main-layout">
       <main class="main-content" :class="{ 'slip-tray-open': showSlipTray && window.innerWidth < 768 }">
         <div x-show="tab === 'trending'" role="tabpanel" id="trending-panel" aria-labelledby="trending-tab" class="fade-in">
           <div id="trending-props" class="max-w-xl mx-auto space-y-4 md:mx-0 md:max-w-full">
               <p class="text-center text-gray-400 py-8">Loading Trending Props...</p>
           </div>
         </div>
         <div x-show="tab === 'marketcap'" role="tabpanel" id="marketcap-panel" aria-labelledby="marketcap-tab" class="fade-in">
             <div id="marketcap-props" class="max-w-xl mx-auto space-y-4 md:mx-0 md:max-w-full">
                <p class="text-center text-gray-400 py-8">Loading Market Cap Props...</p>
             </div>
         </div>
         <div x-show="tab === 'volume'" role="tabpanel" id="volume-panel" aria-labelledby="volume-tab" class="fade-in">
             <div id="volume-props" class="max-w-xl mx-auto space-y-4 md:mx-0 md:max-w-full">
                  <p class="text-center text-gray-400 py-8">Loading Volume Props...</p>
             </div>
         </div>
         <div x-show="tab === 'headtohead'" role="tabpanel" id="headtohead-panel" aria-labelledby="headtohead-tab" class="fade-in">
             <div id="headtohead-props" class="max-w-xl mx-auto space-y-4 md:mx-0 md:max-w-full">
                  <p class="text-center text-gray-400 py-8">Loading H2H Props...</p>
             </div>
         </div>
           <div x-show="tab === 'memefactor'" role="tabpanel" id="memefactor-panel" aria-labelledby="memefactor-tab" class="fade-in">
             <div id="memefactor-props" class="max-w-xl mx-auto space-y-4 md:mx-0 md:max-w-full">
                  <p class="text-center text-gray-400 py-8">Loading Meme Factor Props...</p>
             </div>
           </div>
           <div x-show="tab === 'expiring'" role="tabpanel" id="expiring-panel" aria-labelledby="expiring-tab" class="fade-in">
             <div id="expiring-props" class="max-w-xl mx-auto space-y-4 md:mx-0 md:max-w-full">
                  <p class="text-center text-gray-400 py-8">Loading Expiring Props...</p>
             </div>
           </div>
           <div x-show="tab === 'mypicks'" role="tabpanel" id="mypicks-panel" aria-labelledby="mypicks-tab" class="fade-in">
             <div id="mypicks-props" class="max-w-xl mx-auto space-y-4 md:mx-0 md:max-w-full">
                  <h2 class="text-lg font-semibold mb-2"> Pick History</h2>
                  <p class="text-center text-gray-400" x-show="!walletAddress">Connect wallet to see your picks.</p>
                  <div x-show="walletAddress">
                      <p class="text-center text-gray-500 italic">Loading history...</p>
                      </div>
             </div>
           </div>
           <div x-show="tab === 'leaderboard'" role="tabpanel" id="leaderboard-panel" aria-labelledby="leaderboard-tab" class="fade-in">
             <div id="leaderboard-content" class="max-w-xl mx-auto space-y-4 md:mx-0 md:max-w-full">
                  <p class="text-center text-gray-400 py-8">Loading Leaderboard...</p>
             </div>
           </div>
           <div x-show="tab === 'help'" role="tabpanel" id="help-panel" aria-labelledby="help-tab" class="fade-in">
               <div id="help-content" class="max-w-xl mx-auto space-y-4 md:mx-0 md:max-w-full">
                  <div class="card p-6">
                    <h2 class="text-lg font-semibold mb-4">Help & Support</h2>
                    <div class="space-y-6">
                      <div>
                        <h3 class="text-sm font-semibold mb-2 text-[#FFD700]">FAQs</h3> <div class="space-y-4">
                          <div>
                            <p class="text-xs text-[#E0E0E0] font-semibold">Q: How do I place a bet?</p>
                            <p class="text-xs text-[#B0B0B0]">A: Select 2–5 picks from the tabs, open the slip using the button at the bottom right (or view on desktop), set a wager (0.1–10 SOL), and submit your slip.</p>
                          </div>
                          <div>
                            <p class="text-xs text-[#E0E0E0] font-semibold">Q: How are winnings calculated?</p>
                            <p class="text-xs text-[#B0B0B0]">A: Winnings = Wager × Multiplier. Multipliers: 2 picks = 1.5x, 3 picks = 2x, 4 picks = 3x, 5 picks = 5x.</p> </div>
                           <div>
                            <p class="text-xs text-[#E0E0E0] font-semibold">Q: Can I play without a wallet?</p>
                            <p class="text-xs text-[#B0B0B0]">A: Yes! You can use the free faucet balance (starting at 10.0 SOL) to try out the game without connecting a real wallet.</p> </div>
                        </div>
                      </div>
                      <div>
                        <h3 class="text-sm font-semibold mb-2 text-[#FFD700]">Get in Touch</h3> <a href="https://t.me/+7dSkZ_j-i5tlMTNh" target="_blank" rel="noopener noreferrer" class="block text-sm text-[#FFD700] hover:underline mb-2" aria-label="Join Telegram">Join our Telegram</a> <a href="mailto:support@memepicks.fun" class="block text-sm text-[#FFD700] hover:underline" aria-label="Contact Support">Contact Support</a> </div>
                    </div>
                  </div>
               </div>
           </div>

           <div x-show="tab === 'profile'" role="tabpanel" id="profile-panel" aria-labelledby="profile-tab" class="fade-in">
               <div class="max-w-xl mx-auto space-y-6 md:mx-0 md:max-w-full">
                   <div class="card p-4">
                       <h2 class="text-lg font-semibold mb-3">My Profile</h2>
                       <div class="flex items-center space-x-4">
                           <img :src="userProfile.avatar || 'https://placehold.co/64x64/FFD700/000000?text=MP'" alt="User Avatar" class="w-16 h-16 rounded-full object-cover flex-shrink-0" onerror="this.src='https://placehold.co/64x64/707070/FFFFFF?text=ERR'"> <div class="flex-1">
                               <p class="text-sm font-semibold" x-text="userProfile.username || (walletAddress ? walletAddress.slice(0, 6) + '...' + walletAddress.slice(-4) : 'Not Connected')"></p>
                               <div class="flex space-x-1 mt-1">
                                   <span class="text-xs bg-yellow-500 text-black px-2 py-0.5 rounded-full font-medium" x-text="userProfile.badge || 'Newbie'"></span>
                                    <span class="badge" :class="`badge-${getVIPLevel().toLowerCase()}`" x-text="getVIPLevel()" x-show="getVIPLevel() !== 'Bronze'"></span>
                                   </div>
                           </div>
                            <button class="button-secondary text-xs py-1 px-3">Edit</button>
                         </div>
                       <div class="mt-4 border-t border-gray-700 pt-3 space-y-1 text-sm">
                           <p>Total Wins: <span class="font-semibold text-green-400" x-text="userProfile.totalWins">0</span></p>
                           <p>Total Losses: <span class="font-semibold text-red-400" x-text="userProfile.totalLosses">0</span></p>
                           <p>Win Rate: <span class="font-semibold" x-text="((userProfile.totalWins / (userProfile.totalWins + userProfile.totalLosses || 1)) * 100).toFixed(1) + '%'">N/A</span></p>
                           <p>Slip Streak: <span class="font-semibold text-[#FFD700]" x-text="userProfile.streak">0</span> 🔥</p>
                           <div class="w-full h-2 bg-[#2A2A2A] rounded-full mt-2 overflow-hidden">
                             <div class="h-full bg-gradient-to-r from-red-500 to-yellow-300 animate-pulse" :style="{ width: Math.min(100, (userProfile.streak / 7) * 100) + '%' }"></div> </div>
                           <p class="text-xs text-gray-400 mt-1" x-text="`Wagered: ${userProfile.totalWagers.toFixed(2)} SOL`"></p>
                            </div>
                       </div>
                   <div class="card p-4">
                       <h3 class="text-md font-semibold mb-2">Recent Activity</h3>
                       <p class="text-sm text-gray-400 italic">Your recent picks and results will appear here.</p>
                       </div>
               </div>
           </div>

           <div x-show="tab === 'community'" role="tabpanel" id="community-panel" aria-labelledby="community-tab" class="fade-in">
               <div class="max-w-xl mx-auto space-y-6 md:mx-0 md:max-w-full">

                   <div class="card p-4">
                       <h2 class="text-lg font-semibold mb-3">Community Hub</h2>
                       <p class="text-sm text-gray-400">Connect with other players, get tips, and more!</p>
                   </div>

                   <div class="card p-4" x-show="walletAddress">
                       <h3 class="text-md font-semibold mb-2">Referral Link</h3>
                       <div class="flex items-center space-x-2 bg-gray-700 p-2 rounded-md">
                           <input type="text" readonly :value="`${window.location.origin}${window.location.pathname}?ref=${walletAddress}`" class="input-field bg-gray-700 border-none text-xs flex-1 p-1">
                           <button class="button-secondary text-xs py-1 px-3" @click="getInviteLink()">Copy Link</button>
                       </div>
                       <p class="text-xs text-gray-400 mt-1">Share your link to earn rewards!</p>
                       </div>

                   <div class="card p-4" x-show="tab === 'community'">
                       <p x-text="challengeMessage"></p>
                       <button class="button-primary" @click="acceptChallenge()">Accept</button>
                       <button class="button-secondary" @click="tauntUser()">Decline</button>
                   </div>

                   <div class="card p-4">
                       <h3 class="text-md font-semibold mb-2">Send a Tip (SOL)</h3>
                        <div class="space-y-2">
                           <input type="text" x-model="tipRecipient" placeholder="Recipient Wallet Address" class="input-field text-sm">
                           <div class="flex items-center gap-2">
                               <input type="number" step="0.01" min="0.01" max="1" x-model.number="tipAmount" placeholder="Amount" class="input-field text-sm w-1/2">
                               <button class="button-primary flex-1 text-sm" @click="sendTip()">Send Tip</button>
                           </div>
                        </div>
                   </div>

                   <div class="card p-4">
                       <h3 class="text-md font-semibold mb-2">Daily Quests</h3>
                       <ul class="space-y-1 text-sm">
                           <li class="flex items-center justify-between">
                               <span> Make 3 bets today</span>
                               <span class="text-green-400">1/3</span>
                           </li>
                           <li class="flex items-center justify-between opacity-50">
                               <span> Win 1 slip</span>
                               <span class="text-gray-400">0/1</span>
                           </li>
                            <li class="flex items-center justify-between opacity-50">
                               <span> Invite 1 friend this week</span>
                               <span class="text-gray-400">0/1</span>
                           </li>
                       </ul>
                   </div>

                   <div class="card p-4">
                       <h3 class="text-md font-semibold mb-2">Live Chat (Global)</h3>
                       <div id="global-chat-feed" class="chat-feed" :class="{'idle-scroll': isIdle}">
                           <div class="chat-message"><span class="username">AdminBot:</span> Welcome to MemePicks! Play responsibly.</div>
                           <div class="chat-message hot"><span class="username">User123:</span> Anyone betting on $MYRO?</div> <div class="chat-message"><span class="username">DegenerateApe:</span> All in $PONKE expiring soon!</div>
                       </div>
                        <form class="chat-input-area" @submit.prevent="sendChatMessage">
                           <input type="text" name="messageInput" placeholder="Type message..." class="input-field text-sm flex-1">
                           <button type="submit" class="button-primary text-sm px-4">Send</button>
                       </form>
                   </div>

                   <div class="card p-4" x-data="{ show2FA: false }">
                       <div class="flex justify-between items-center cursor-pointer" @click="show2FA = !show2FA">
                           <h3 class="text-md font-semibold">Security Settings</h3>
                           <span x-text="show2FA ? '−' : '+'" class="text-xl text-gray-400"></span>
                       </div>
                       <div x-show="show2FA" x-transition class="mt-3 border-t border-gray-700 pt-3">
                           <div class="flex items-center justify-between">
                               <span class="text-sm text-gray-300">Enable 2FA (Coming Soon)</span>
                               <label class="toggle-switch">
                                   <input type="checkbox" disabled>
                                   <span class="toggle-slider"></span>
                               </label>
                           </div>
                           <p class="text-xs text-gray-500 mt-1">Enhance your account security with two-factor authentication.</p>
                       </div>
                   </div>

               </div>
           </div>

       </main>

        <div class="slip-tray-wrapper md:block" x-show="showSlipTray || window.innerWidth >= 768">
           <div id="slip-tray" class="slip-tray md:static md:transform-none md:shadow-none md:max-h-none md:overflow-y-visible md:border-radius-12 md:p-6 md:min-w-[300px] md:flex-shrink-0" :class="{ 'open': showSlipTray && window.innerWidth < 768 }"
                @mousedown="startLongPress($event)"
                @touchstart="startLongPress($event)"
                @mouseup="endLongPress($event)"
                @touchend="endLongPress($event)"
                @mousemove="cancelLongPress()"
                @touchmove="cancelLongPress()">
               <div class="flex justify-between items-center mb-3 flex-shrink-0">
                   <h3 id="slip-tray-title" class="text-base font-semibold">Your Slip</h3>
                   <button class="text-[#B0B0B0] hover:text-red-500 w-8 h-8 flex items-center justify-center text-2xl md:hidden" @click="showSlipTray = false" aria-label="Close entry slip">✕</button>
               </div>
                <div x-show="referrerAddress && !firstSlipSubmitted" class="text-xs text-green-400 mb-2 p-2 bg-green-900 rounded-md">
                   Referral from <span class="font-semibold" x-text="referrerAddress ? referrerAddress.slice(0,4) + '...' + referrerAddress.slice(-4) : ''"></span> tracked. Thanks for joining!
               </div>
               <div id="slip-picks-mobile" class="space-y-2 mb-4 flex-grow overflow-y-auto md:overflow-y-visible">
                   <template x-if="slip.picks.length === 0">
                       <p class="text-[#B0B0B0] text-sm text-center py-4">Add 2 to 5 picks to start your slip.</p>
                   </template>
                   <template x-for="pick in slip.picks" :key="pick.propId">
                       <div class="bg-[#2A2A2A] p-2 rounded-lg flex justify-between items-center">
                           <div class="flex-1 mr-2">
                               <p class="text-xs font-semibold" x-text="pick.token"></p>
                               <p class="text-xs text-[#B0B0B0] truncate" x-text="pick.description"></p>
                               <p class="text-xs text-[#FFD700]" x-text="pick.choice"></p> </div>
                           <button class="text-[#B0B0B0] hover:text-red-500 w-8 h-8 flex items-center justify-center flex-shrink-0" @click="removePick(pick.propId)" :aria-label="'Remove ' + pick.token + ' prediction from slip'">✕</button>
                       </div>
                   </template>
               </div>
               <div class="mt-auto flex-shrink-0 md:mt-0">
                   <div class="mb-4 wager-tooltip-container">
                       <label for="wager-mobile" class="text-xs text-[#B0B0B0] mb-2 flex items-center">
                           Wager (SOL)
                            <div class="hunch-meter ml-auto w-1/2">
                               <div class="hunch-fill"></div>
                               <span class="hunch-score-label" x-text="currentHunchScore + '% Hunch'"></span>
                           </div>
                        </label>
                       <input id="wager-mobile" type="number" step="0.01" min="0.01" max="10" class="input-field text-sm" placeholder="0.1–10 SOL" aria-label="Wager amount in SOL (0.1 to 10)" x-model.number="slip.wager" @input="updateSlipWager()">
                       <div class="wager-tooltip" :class="{'show': showWagerTooltip}" x-text="wagerTooltipText"></div>
                   </div>
                   <div id="payout-mobile" class="flex justify-between items-center text-xs mb-4" x-show="slip.picks.length >= 2">
                       <div class="flex items-center">
                           <p class="text-[#B0B0B0]">Potential Payout (<span x-text="multipliers[slip.picks.length] || 0"></span>x):</p>
                           </div>
                       <p class="text-green-400 font-semibold" x-text="(slip.wager * (multipliers[slip.picks.length] || 0)).toFixed(2) + ' SOL'"></p>
                       </div>
                    <div x-show="slip.picks.length > 0 && slip.wager > 0" class="relative">
                         <div class="absolute inset-0 bg-gray-900 bg-opacity-80 backdrop-filter backdrop-blur-sm flex items-center justify-center z-10 opacity-0 pointer-events-none">
                            <span class="text-lg font-semibold text-white">Reveal Your Potential Winnings</span>
                       </div>
                         <div class="flex justify-between items-center text-xs mb-4" x-show="slip.picks.length >= 2">
                           <div class="flex items-center">
                               <p class="text-[#B0B0B0]">Multiplier:</p>
                               </div>
                           <p class="text-[#FFD700] font-semibold" x-text="multipliers[slip.picks.length] || 0"></p> </div>
                         <div class="flex justify-between items-center text-xs mb-4" x-show="slip.picks.length >= 2">
                           <div class="flex items-center">
                               <p class="text-[#B0B0B0]">Potential Payout:</p>
                               </div>
                           <p class="text-green-400 font-semibold text-base" x-text="(slip.wager * (multipliers[slip.picks.length] || 0)).toFixed(2) + ' SOL'"></p>
                       </div>
                    </div>

                   <p class="text-xs text-[#FFD700] text-center mt-2" x-show="slip.picks.length > 0 && slip.wager > 0 && Math.random() < 0.5">
                       🔥 Boost chance: +<span x-text="(Math.floor(Math.random() * 10) + 5)"></span>%
                   </p>


                   <button class="button-primary w-full text-sm flex items-center justify-center" :disabled="!isValidSlip()" @click="submitSlipAction()" aria-label="Submit entry slip" :class="{'idle': isIdle && !showSlipTray}">
                       Submit Slip
                   </button>

                    <button x-show="showDoubleWagerButton" @click="doubleWager()" class="button-secondary w-full text-sm flex items-center justify-center mt-2 animate-pulse" aria-label="Double down on your last wager">
                       Double down now? (Fear of Missing Out)
                   </button>

                   <p class="text-[#B0B0B0] text-xs mt-3 text-center">
                        <span x-show="walletAddress">Balance: <span x-text="walletBalance !== null ? walletBalance.toFixed(2) : 'Loading...'"></span> SOL</span>
                        <span x-show="!walletAddress">Free Mode Balance: <span x-text="faucetBalance.toFixed(1)"></span> SOL</span>
                   </p>
                    <button class="button-primary w-full text-sm flex items-center justify-center mt-2" @click="quickBet()">Quick Bet</button>
               </div>
           </div>
       </div>
   </div>


  <button id="slip-tray-trigger" class="fab md:hidden" @click="toggleSlipTray()" aria-label="Open entry slip" aria-controls="slip-tray" :aria-expanded="showSlipTray.toString()" :class="{ 'glow-green': slip.picks.length > 0 && slip.picks.length < 3, 'glow-yellow': slip.picks.length >= 3 && slip.picks.length < 5, 'glow-red': slip.picks.length === 5, 'idle': isIdle && !showSlipTray }">
    <svg class="progress-meter" viewBox="0 0 64 64">
        <circle cx="32" cy="32" r="30"></circle>
        <circle class="progress-circle" cx="32" cy="32" r="30" :style="{ 'stroke-dashoffset': 188.5 - (188.5 * (betCount % 5 / 5)) }"></circle> <defs>
            <linearGradient id="rewardGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#FF1A1A;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#FFD700;stop-opacity:1" />
            </linearGradient>
        </defs>
    </svg>
    <span>Slip</span>
    <span id="pick-count" class="badge" x-text="slip.picks.length"></span>
  </button>


  <nav class="bottom-nav md:hidden" aria-label="Main Navigation">
    <button :class="{ 'active': tab === 'trending' }" @click="tab = 'trending'; showSlipTray = false; closeAllModals()" aria-label="Home" aria-controls="trending-panel" :aria-selected="tab === 'trending'">
      <span class="icon"></span>
      <span class="label">Home</span>
    </button>
    <button :class="{ 'active': tab === 'mypicks' }" @click="tab = 'mypicks'; showSlipTray = false; closeAllModals()" aria-label="My Picks" aria-controls="mypicks-panel" :aria-selected="tab === 'mypicks'">
      <span class="icon"></span>
      <span class="label">My Picks</span>
    </button>
    <button :class="{ 'active': tab === 'community' }" @click="tab = 'community'; showSlipTray = false; closeAllModals()" aria-label="Community" aria-controls="community-panel" :aria-selected="tab === 'community'">
      <span class="icon"></span> <span class="label">Community</span>
    </button>
    <button :class="{ 'active': tab === 'leaderboard' }" @click="tab = 'leaderboard'; showSlipTray = false; closeAllModals()" aria-label="Leaderboard" aria-controls="leaderboard-panel" :aria-selected="tab === 'leaderboard'">
      <span class="icon"></span>
      <span class="label">Leaders</span>
    </button>
    <button :class="{ 'active': tab === 'help' }" @click="tab === 'help'; showSlipTray = false; closeAllModals()" aria-label="Help" aria-controls="help-panel" :aria-selected="tab === 'help'">
      <span class="icon"></span>
      <span class="label">Help</span>
    </button>
  </nav>

  <div id="helpModal" x-show="modals.helpModal" x-ref="helpModal" class="fixed inset-0 flex items-end justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="help-modal-title">
      <div class="modal-container" :class="{'open': modals.helpModal}" @click="closeModal('helpModal')"></div> <div class="modal" :class="{'open': modals.helpModal}"> <div class="flex justify-between items-center mb-4">
          <h3 id="help-modal-title" class="text-base font-semibold">Help & Support</h3>
          <button class="text-[#B0B0B0] hover:text-red-500 w-8 h-8 flex items-center justify-center text-2xl" @click="closeModal('helpModal')" aria-label="Close help modal">✕</button>
      </div>
      <div class="space-y-3 text-sm">
          <a href="#" class="block text-[#B0B0B0] hover:text-[#FFD700]" aria-label="Help Center">Help Center / FAQs</a> <a href="#" class="block text-[#B0B0B0] hover:text-[#FFD700]" aria-label="Responsible Betting">Responsible Betting</a> <a href="https://t.me/+7dSkZ_j-i5tlMTNh" target="_blank" rel="noopener noreferrer" class="block text-[#B0B0B0] hover:text-[#FFD700]" aria-label="Join Telegram">Join our Telegram</a> <a href="mailto:support@memepicks.fun" class="block text-[#B0B0B0] hover:text-[#FFD700]" aria-label="Contact Support">Contact Support</a> </div>
      <button class="button-primary w-full text-sm mt-6" @click="closeModal('helpModal')" aria-label="Close help modal">Close</button>
      </div>
  </div>

  <div id="modal" x-show="modals.modal" x-ref="modal" class="fixed inset-0 flex items-end justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-container" :class="{'open': modals.modal}" @click="closeModal('modal')"></div> <div class="modal" :class="{'open': modals.modal}"> <h3 id="modal-title" class="text-base font-semibold mb-3"></h3>
      <p id="modal-message" class="text-[#B0B0B0] text-sm mb-4"></p>
      <button class="button-primary w-full text-sm py-2" @click="closeModal('modal')" aria-label="Close modal">OK</button>
    </div>
  </div>

  <div id="walletChoiceModal" x-show="modals.walletChoiceModal" x-ref="walletChoiceModal" class="fixed inset-0 flex items-end justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="wallet-choice-modal-title" @keydown.escape.window="closeModal('walletChoiceModal')">
    <div class="modal-container" :class="{'open': modals.walletChoiceModal}" @click="closeModal('walletChoiceModal')"></div>
    <div class="modal" :class="{'open': modals.walletChoiceModal}">
      <div class="flex justify-between items-center mb-4">
        <h3 id="wallet-choice-modal-title" class="text-base font-semibold">Choose Wallet</h3>
        <button class="text-[#B0B0B0] hover:text-red-500 w-8 h-8 flex items-center justify-center text-2xl" @click="closeModal('walletChoiceModal')" aria-label="Close wallet choice">✕</button>
      </div>
      <div class="space-y-3">
        <button class="button-primary w-full text-sm flex items-center justify-center gap-2" @click="connectWallet('phantom'); closeModal('walletChoiceModal')" aria-label="Connect Phantom Wallet">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"></path></svg> Phantom Wallet
        </button>
        <button class="button-primary w-full text-sm flex items-center justify-center gap-2" @click="connectWallet('solflare'); closeModal('walletChoiceModal')" aria-label="Connect Solflare Wallet">
           <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path></svg> Solflare Wallet
        </button>
      </div>
       <p class="text-green-400 text-sm mt-4 text-center">Deposit 5 SOL, get 1 SOL free!</p>
      <button class="button-secondary w-full text-sm mt-4" @click="closeModal('walletChoiceModal')" aria-label="Cancel connection">Cancel</button>
    </div>
  </div>

   <div id="mysteryBoxModal" x-show="modals.mysteryBoxModal" x-ref="mysteryBoxModal" class="fixed inset-0 flex items-end justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="mystery-box-title" @keydown.escape.window="closeModal('mysteryBoxModal')">
       <div class="modal-container" :class="{'open': modals.mysteryBoxModal}" @click="closeModal('mysteryBoxModal')"></div>
       <div class="modal text-center" :class="{'open': modals.mysteryBoxModal}">
           <div class="flex justify-between items-center mb-4">
                <h3 id="mystery-box-title" class="text-base font-semibold" x-text="boxTier ? boxTier + ' Mystery Box!' : 'Mystery Box!'">Mystery Box!</h3>
                <button class="text-[#B0B0B0] hover:text-red-500 w-8 h-8 flex items-center justify-center text-2xl" @click="closeModal('mysteryBoxModal')" aria-label="Close mystery box">✕</button>
           </div>
           <img :src="boxImage || 'https://placehold.co/80x80/FFD700/000000?text=BOX'" alt="Mystery Box" class="mx-auto mb-4 animate-bounce" onerror="this.src='https://placehold.co/80x80/707070/FFFFFF?text=ERR'"> <p class="text-[#B0B0B0] text-sm mb-4">You unlocked a Mystery Box!</p>
            <div x-data="{ revealed: false }">
                <button x-show="!revealed" @click="revealed = true; revealReward()" class="button-primary w-full text-sm py-2">Open Box</button>
                <div x-show="revealed" class="space-y-3 text-sm mt-4">
                    <p class="text-green-400 font-semibold">You won:</p>
                    <p x-text="boxReward"></p>
                </div>
                <button x-show="revealed" class="button-secondary w-full text-sm py-2 mt-4" @click="closeModal('mysteryBoxModal'); revealed = false;">Claim Reward</button>
            </div>
       </div>
   </div>

    <div id="winModal" x-show="modals.winModal" class="fixed inset-0 flex items-center justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="win-modal-title">
        <div class="modal-container" :class="{'open': modals.winModal}"></div>
        <div class="modal text-center">
            <h3 class="text-lg font-bold text-[#FFD700] animate-pulse">Epic Win!</h3> <p class="text-[#FF1A1A] text-sm mb-4" x-text="`You won ${(lastSlip.wager * multipliers[lastSlip.picks.length]).toFixed(2)} SOL!`"></p> <button class="button-primary w-full" @click="closeModal('winModal')">Claim Now!</button>
        </div>
    </div>

    <div id="retryModal" x-show="modals.retryModal" class="fixed inset-0 flex items-end justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="retry-modal-title">
        <div class="modal-container" :class="{'open': modals.retryModal}" @click="closeModal('retryModal')"></div>
        <div class="modal text-center" :class="{'open': modals.retryModal}">
            <h3 id="retry-modal-title" class="text-lg font-bold text-[#FFD700] animate-pulse">SO CLOSE!</h3>
            <p class="text-[#FF1A1A] text-sm mb-4">Retry with 1.5x multiplier?</p>
            <button class="button-primary w-full text-sm" @click="retrySlip()">Retry Now!</button>
            <button class="button-secondary w-full text-sm mt-2" @click="closeModal('retryModal')">Cancel</button>
        </div>
    </div>


    <div id="teaserModal" x-show="modals.teaserModal" class="fixed inset-0 flex items-end justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="teaser-modal-title">
      <div class="modal-container" :class="{'open': modals.teaserModal}"></div> <div class="modal text-center" :class="{'open': modals.teaserModal}">
        <h3 id="teaser-modal-title" class="text-base font-semibold mb-3">Checking Your Slip...</h3>
        <div class="slot-spinner" style="width: 80px; height: 80px; margin: 0 auto 16px auto; background: url('https://placehold.co/80x80/FFD700/000000?text=SPIN'); background-size: cover; animation: slotReel 0.8s infinite linear;"></div>
        <p class="text-[#B0B0B0] text-sm mb-4">Results in <span x-text="teaserCountdown"></span>...</p>
      </div>
    </div>

    <div id="hotPropModal" x-show="modals.hotPropModal" class="fixed inset-0 flex items-end justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="hot-prop-modal-title">
      <div class="modal-container" :class="{'open': modals.hotPropModal}" @click="closeModal('hotPropModal')"></div>
      <div class="modal text-center" :class="{'open': modals.hotPropModal}">
        <h3 id="hot-prop-modal-title" class="text-base font-semibold mb-3 animate-shake">Hot Prop Alert! 🔥</h3>
        <p class="text-[#B0B0B0] text-sm mb-4">Bet on $WIF now for a chance to win big!</p> <button class="button-primary w-full text-sm py-2" @click="closeModal('hotPropModal')">Check It Out</button>
      </div>
    </div>

    <div id="exitIntentModal" x-show="modals.exitIntentModal" class="fixed inset-0 flex items-end justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="exit-intent-modal-title">
      <div class="modal-container" :class="{'open': modals.exitIntentModal}" @click="closeModal('exitIntentModal')"></div>
      <div class="modal text-center" :class="{'open': modals.exitIntentModal}">
        <h3 id="exit-intent-modal-title" class="text-base font-semibold mb-3">Don’t Leave!</h3>
        <p class="text-[#B0B0B0] text-sm mb-4">Claim 0.2 SOL to keep betting!</p>
        <button class="button-primary w-full text-sm py-2" @click="claimExitBonus(); closeModal('exitIntentModal')">Claim Now</button>
      </div>
    </div>

    <div id="limitModal" x-show="modals.limitModal" class="fixed inset-0 flex items-end justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="limit-modal-title">
      <div class="modal-container" :class="{'open': modals.limitModal}" @click="closeModal('limitModal')"></div>
      <div class="modal" :class="{'open': modals.limitModal}">
        <h3 id="limit-modal-title" class="text-base font-semibold mb-3">Set Wager Limit</h3>
        <p class="text-[#B0B0B0] text-sm mb-2">Set a daily limit to gamble responsibly.</p>
        <input x-model.number="dailyWagerLimit" type="number" step="0.1" min="0" class="input-field text-sm mb-4" placeholder="Daily SOL Limit">
        <button class="button-primary w-full text-sm py-2" @click="saveWagerLimit()">Save Limit</button>
         <button class="button-secondary w-full text-sm py-2 mt-2" @click="closeModal('limitModal')">Cancel</button>
      </div>
    </div>

     <div id="ageGateModal" x-show="modals.ageGateModal" class="fixed inset-0 flex items-end justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="age-gate-title">
      <div class="modal-container" :class="{'open': modals.ageGateModal}"></div> <div class="modal text-center" :class="{'open': modals.ageGateModal}">
        <h3 id="age-gate-title" class="text-base font-semibold mb-3">Age Verification</h3>
        <p class="text-[#B0B0B0] text-sm mb-4">You must be 18 or older to use this platform.</p>
        <label class="flex items-center justify-center space-x-2 mb-4">
            <input type="checkbox" x-model="isOver18" class="form-checkbox h-5 w-5 text-[#FFD700] rounded"> <span class="text-sm text-[#E0E0E0]">I am 18 or older</span>
        </label>
        <button class="button-primary w-full text-sm py-2" :disabled="!isOver18" @click="closeModal('ageGateModal')">Confirm</button>
      </div>
    </div>


  <script>
    // --- Howler.js Sound Objects ---
    // Initialize sounds on first user interaction to comply with mobile autoplay policies
    const sounds = {};
    // Randomized win sounds
    const winSounds = ['/sounds/win1.mp3', '/sounds/win2.mp3', '/sounds/win3.mp3']; // Placeholder paths

    function initializeSounds() {
        const soundFiles = {
            pick: ['/sounds/pick-ding.mp3', 'https://assets.codepen.io/t-1/pick-ding.mp3'],
            submit: ['/sounds/slot-pull.mp3', 'https://assets.codepen.io/t-1/slot-pull.mp3'],
            lossThud: ['/sounds/loss-thud.mp3', 'https://assets.codepen.io/t-1/loss-thud.mp3'],
            sadTrombone: ['/sounds/sad-trombone.mp3', 'https://assets.codepen.io/t-1/sad-trombone.mp3'],
            ambient: ['/sounds/casino-ambience.mp3', 'https://assets.codepen.io/t-1/casino-ambience.mp3']
        };

        Object.keys(soundFiles).forEach(key => {
            try {
                sounds[key] = new Howl({
                    src: soundFiles[key],
                    loop: key === 'ambient',
                    volume: key === 'ambient' ? 0.2 : 1.0,
                    onloaderror: (id, err) => {
                        console.warn(`Failed to load sound ${key}: ${err}`);
                        // showToast(`Sound ${key} unavailable.`, 'warning'); // Avoid spamming toasts
                    },
                    onplayerror: (id, err) => {
                        console.warn(`Cannot play sound ${key}: ${err}`);
                    }
                });
            } catch (e) {
                console.error(`Error initializing sound ${key}:`, e);
            }
        });

        // Initialize randomized win sounds
         winSounds.forEach((src, index) => {
             try {
                 sounds[`win${index + 1}`] = new Howl({
                     src: [src],
                     onloaderror: (id, err) => console.warn(`Failed to load win sound ${index + 1}: ${err}`),
                     onplayerror: (id, err) => console.warn(`Cannot play win sound ${index + 1}: ${err}`)
                 });
             } catch (e) {
                 console.error(`Error initializing win sound ${index + 1}:`, e);
             }
         });


        // Remove the event listener after sounds are initialized
        document.removeEventListener('click', initializeSounds, { once: true });
         console.log('Sounds initialized.');
         // Optionally start ambient sound after initialization
         if (sounds.ambient && sounds.ambient.state() === 'unloaded') {
             sounds.ambient.once('load', () => { sounds.ambient.play(); });
         } else if (sounds.ambient) {
              sounds.ambient.play();
         }
    }

     // Add event listener to initialize sounds on first user interaction
    document.addEventListener('click', initializeSounds, { once: true });


    // Play sound using Howler.js
    function playSound(type) {
       if (sounds[type]?.play) { // Use optional chaining for safety
           sounds[type].play();
       } else {
           console.warn(`Sound ${type} not available or not loaded`);
       }
    }
     // Play a random win sound
     function playRewardSound() {
         const randomIndex = Math.floor(Math.random() * winSounds.length);
         const soundKey = `win${randomIndex + 1}`;
         if (sounds[soundKey]?.play) {
             sounds[soundKey].play();
         } else {
             console.warn(`Random win sound ${soundKey} not available.`);
         }
     }


    // --- Global Helper Functions ---

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `fixed bottom-24 md:bottom-8 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-xl text-white text-sm z-[1000] shadow-lg ${
        type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-gray-700'
      }`;
      toast.textContent = message;
      // Prevent multiple toasts stacking weirdly
      const existingToasts = document.querySelectorAll('.fixed.bottom-24');
      existingToasts.forEach(t => t.remove());
      document.body.appendChild(toast);
      setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transition = 'opacity 0.3s ease-out';
          setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Trigger vibration using patterns
    function triggerVibration(type) {
      if ('vibrate' in navigator) {
        const patterns = {
          pick: [20, 10, 20],
          submit: [50, 20, 50],
          win: [100, 50, 100, 50, 100],
          loss: [50, 50, 50], // Added loss pattern
          almostWon: [50, 100, 50] // Added almost won pattern
        };
        navigator.vibrate(patterns[type] || 20); // Default to 20ms if type not found
      }
    }

    // Trigger confetti effect
    function triggerConfetti(intensity = 1) {
      confetti({
        particleCount: 150 * intensity,
        spread: 80,
        colors: ['#FFD700', '#FF4D4D', '#7C3AED'], // Gold, Red, Purple confetti
        origin: { y: 0.6 }
      });
    }

     // Trigger sparkle effect (for modal close)
     function triggerSparkles(originX, originY) {
         confetti({
             particleCount: 50,
             spread: 60,
             origin: { x: originX, y: originY },
             colors: ['#FFD700', '#FF1A1A', '#FFFFFF'],
             disableForReducedMotion: true
         });
     }


    async function getWalletBalance(address) {
        if (!address) return null;
        console.log('Fetching balance for:', address);
        try {
            if (typeof solanaWeb3 === 'undefined') throw new Error('Solana Web3 library not loaded.');
            const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl('mainnet-beta'));
            const publicKey = new solanaWeb3.PublicKey(address);
            const balance = await connection.getBalance(publicKey);
            const balanceInSol = balance / solanaWeb3.LAMPORTS_PER_SOL;
            console.log('Balance fetched:', balanceInSol, 'SOL');
            document.body.dispatchEvent(new CustomEvent('balance-updated', { detail: { balance: balanceInSol } }));
            return balanceInSol;
        } catch (error) {
            console.error('Error fetching balance:', error);
            showToast('Could not fetch wallet balance.', 'error');
            document.body.dispatchEvent(new CustomEvent('balance-updated', { detail: { balance: null } }));
            return null;
        }
    }

    async function connectWallet(walletType) {
      let provider = null;
      console.log(`Attempting to connect with ${walletType}...`);

      if (walletType === 'phantom') {
        if ('phantom' in window) {
            const phantomProvider = window.phantom?.solana;
            if (phantomProvider?.isPhantom) provider = phantomProvider;
        }
      } else if (walletType === 'solflare') {
        if ('solflare' in window) {
            const solflareProvider = window.solflare;
            if (solflareProvider) provider = solflareProvider;
        }
      }

      if (!provider) {
        showToast(`${walletType.charAt(0).toUpperCase() + walletType.slice(1)} Wallet not found. Install it and try again.`, 'error');
        console.error(`${walletType} provider not found.`);
        if (/Mobi|Android/i.test(navigator.userAgent)) {
            const appUrl = encodeURIComponent(window.location.href);
            const redirectLink = encodeURIComponent(window.location.href + '?connected=true');
            if (walletType === 'phantom') window.location.href = `https://phantom.app/ul/v1/connect?app_url=${appUrl}&redirect_link=${redirectLink}`;
            else if (walletType === 'solflare') window.location.href = `https://solflare.com/ul/v1/connect?app_url=${appUrl}&redirect_link=${redirectLink}`;
        }
        return;
      }

      try {
        console.log(`Connecting to ${walletType} provider...`);
        if (!provider.isConnected) {
            await provider.connect({ onlyIfTrusted: false });
        }
        const publicKey = provider.publicKey;
        if (!publicKey) throw new Error('Could not get public key.');
        const publicKeyString = publicKey.toString();
        console.log(`Connected to ${walletType}:`, publicKeyString);
        showToast(`Connected: ${publicKeyString.slice(0,6)}...${publicKeyString.slice(-4)}`, 'success');

        localStorage.setItem('walletAddress', publicKeyString);
        document.body.dispatchEvent(new CustomEvent('wallet-connected', { detail: { address: publicKeyString } }));

      } catch (err) {
        console.error(`Connection error with ${walletType}:`, err);
        let errorMessage = 'Connection failed. Please try again.';
        if (err.message?.toLowerCase().includes('user rejected') || err.code === 4001) {
            errorMessage = 'Connection rejected by user.';
        }
        showToast(errorMessage, 'error');
        localStorage.removeItem('walletAddress');
        document.body.dispatchEvent(new CustomEvent('wallet-connected', { detail: { address: null } }));
      }
    }

    // --- Content Injection & Tagging ---

    function injectDummyContent() {
        const propContainers = {
            'trending-props': [
                { token: 'DOGWIFHAT', desc: 'Will $WIF flip $BONK market cap by EOD?', risk: 'high', id: 'wif-001' },
                { token: 'POPCAT', desc: 'Will $POPCAT reach 10k holders today?', risk: 'medium', id: 'pop-002' },
                { token: 'SOLAMA', desc: 'Will $SOLAMA volume exceed $1M in 24h?', risk: 'low', id: 'solama-003' },
                { token: 'BONK', desc: 'Will $BONK stay above $0.000025?', risk: 'low', id: 'bonk-004' },
                 { token: 'MYRO', desc: 'Will $MYRO price increase in next 4 hours?', risk: 'medium', id: 'myro-005' },
                 { token: 'SLERF', desc: 'Will $SLERF dip below $0.3?', risk: 'high', id: 'slerf-006' }
            ],
            'marketcap-props': [
                { token: 'MYRO', desc: 'Will $MYRO hit $500M MC this week?', risk: 'medium', id: 'myro-mc1' },
                { token: 'WEN', desc: 'Will $WEN reach $300M MC before Friday?', risk: 'medium', id: 'wen-mc2' },
                { token: 'BODEN', desc: 'Will $BODEN reclaim $1B MC?', risk: 'high', id: 'boden-mc3' },
                 { token: 'CAT', desc: 'Will $CAT exceed $50M MC today?', risk: 'high', id: 'cat-mc4' }
            ],
            'volume-props': [
                { token: 'SLERF', desc: 'Will $SLERF 24h volume stay above $50M?', risk: 'low', id: 'slerf-vol1' },
                { token: 'BONK', desc: 'Will $BONK daily volume exceed $100M?', risk: 'medium', id: 'bonk-vol2' },
                { token: 'GME', desc: 'Will $GME (Solana) volume hit $10M today?', risk: 'high', id: 'gme-vol3' },
                 { token: 'POPCAT', desc: 'Will $POPCAT 24h volume increase by 20%?', risk: 'medium', id: 'pop-vol4' }
            ],
            'headtohead-props': [
                { token: 'WIF vs PEPE', desc: 'Which token has higher % gain in next 1hr?', risk: 'high', id: 'wifpepe-h2h1' },
                { token: 'POPCAT vs MEW', desc: 'Which token gets more buys in next 30min?', risk: 'medium', id: 'popmew-h2h2' },
                { token: 'MYRO vs WEN', desc: 'Which token has lower % drop in 24h?', risk: 'low', id: 'myrowen-h2h3' }
            ],
            'memefactor-props': [
                { token: 'TREMP', desc: 'Will $TREMP get mentioned by a politician?', risk: 'high', id: 'tremp-mf1' },
                { token: 'HARAMBE', desc: 'Will $HARAMBE trend on X (Twitter)?', risk: 'medium', id: 'harambe-mf2' },
                { token: 'GIGA', desc: 'Will $GIGA Chad meme resurface this week?', risk: 'low', id: 'giga-mf3' }
            ],
            'expiring-props': [
                { token: 'PONKE', desc: 'Will $PONKE pump 15% in 10 minutes?', risk: 'high', id: 'ponke-exp1', expires: Date.now() + 10 * 60 * 1000 }, // Expires in 10 mins
                { token: 'SILLY', desc: 'Will $SILLY drop 5% in next 5 minutes?', risk: 'medium', id: 'silly-exp2', expires: Date.now() + 5 * 60 * 1000 }, // Expires in 5 mins
                { token: 'MANEKI', desc: 'Will $MANEKI volume spike in 1 hour?', risk: 'low', id: 'maneki-exp3', expires: Date.now() + 60 * 60 * 1000 } // Expires in 60 mins
            ]
        };

        Object.keys(propContainers).forEach(containerId => {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = ''; // Clear loading text
                propContainers[containerId].forEach((prop, index) => { // Added index for staggered animation
                    // Add Limited Spots Badges randomly
                    const spots = Math.floor(Math.random() * 5) + 1; // Random spots (1-5)
                    const spotsBadge = Math.random() < 0.3 ? `<span class="badge badge-spots animate-pulse">${spots} Spots Left!</span>` : '';

                    const cardHTML = `
                        <div class="card" data-risk="${prop.risk}" data-prop-id="${prop.id}">
                            <div class="prop-content">
                                <img src="https://placehold.co/64x64/333333/FFFFFF?text=${prop.token.substring(0,4)}" alt="${prop.token} logo" class="w-16 h-16 rounded-full object-cover flex-shrink-0" onerror="this.src='https://placehold.co/64x64/707070/FFFFFF?text=ERR'">
                                <div class="flex-1">
                                    <h3 class="text-base font-bold">${prop.token} ${spotsBadge}</h3> <p class="text-sm">${prop.desc}</p>
                                </div>
                            </div>
                             ${containerId === 'expiring-props' ? `<p class="text-xs text-gray-500 mt-1 flex justify-end items-center"><span class="countdown-timer" data-expires="${prop.expires}"></span></p>` : ''}
                            <div class="flex justify-between items-center gap-2 mt-2">
                                <div class="flex space-x-2">
                                    <button class="button-secondary text-sm" data-prop="${prop.id}" data-option="Yes" @click="addToSlip($event)" aria-label="Pick Yes for ${prop.token}">
                                        Yes
                                        </button>
                                    <button class="button-secondary text-sm" data-prop="${prop.id}" data-option="No" @click="addToSlip($event)" aria-label="Pick No for ${prop.token}">
                                        No
                                        </button>
                                </div>
                            </div>
                            <div class="stats">
                                <div class="flex justify-between text-xs text-[#B0B0B0]">
                                     <p>📈 Analyst Pick: <span class="font-semibold text-green-400">${Math.floor(Math.random() * (75 - 50 + 1)) + 50}% Success</span></p>
                                    <p>MC: $${(Math.random() * 1000).toFixed(1)}M · Vol: $${(Math.random() * 50).toFixed(1)}M</p>
                                </div>
                            </div>
                        </div>
                    `;
                     // Simulate Visual Load Delay for Props with GSAP animation
                    setTimeout(() => {
                         if(container) {
                             container.insertAdjacentHTML('beforeend', cardHTML);
                             const newCard = container.lastElementChild;
                             if(newCard) {
                                 // Apply GSAP slot-machine entry animation
                                 gsap.from(newCard, {
                                     y: -150,
                                     rotateX: 120,
                                     opacity: 0,
                                     filter: 'blur(10px)',
                                     duration: 0.6,
                                     ease: 'power2.out'
                                 });
                             }
                         }
                    }, index * 150 + Math.random() * 100); // Staggered delay + small random variation

                });
            }
        });
    }

    function injectLeaderboardContent() {
        const leaderboardContainer = document.getElementById('leaderboard-content');
        if (!leaderboardContainer) return;
        const leaders = [
            { rank: 1, wallet: '4xd5...0eF2', wins: 4.7, avatar: '🥇' },
            { rank: 2, wallet: '7G2A...9D1c', wins: 3.2, avatar: '🥈' },
            { rank: 3, wallet: '9T5Q...1X7N', wins: 2.5, avatar: '🥉' },
            { rank: 4, wallet: 'B3rN...y7U8', wins: 1.9, avatar: '4' },
            { rank: 5, wallet: 'F1aM...z9P0', wins: 1.5, avatar: '5' },
            { rank: 6, wallet: 'H8jL...p2R3', wins: 1.1, avatar: '6' },
            { rank: 7, wallet: 'K9zQ...a4V6', wins: 0.9, avatar: '7' },
            { rank: 8, wallet: 'M1nO...q7W9', wins: 0.8, avatar: '8' },
            { rank: 9, wallet: 'P4sT...u0Y1', wins: 0.7, avatar: '9' },
            { rank: 10, wallet: 'R7uV...x3Z4', wins: 0.6, avatar: '10' },
             // Add placeholder user row that might trigger Almost Top 10
             { rank: '...', wallet: 'Your Wallet', wins: '...', avatar: '👤', isUser: true, placeholderRank: 15}
        ];
        leaderboardContainer.innerHTML = `
            <div class="card p-4">
              <p class="text-sm font-semibold mb-3"> Top Winners (Daily)</p>
              <div class="space-y-2">
                ${leaders.map(leader => `
                  <div class="flex items-center space-x-3 p-2 rounded-lg bg-[#2A2A2A] ${leader.rank === 1 ? 'glow' : ''} ${leader.isUser ? 'leaderboard-user-row' : ''}" data-simulated-rank="${leader.placeholderRank || leader.rank}">
                    <span class="text-lg font-bold w-6 text-center ${leader.rank <= 3 ? 'text-yellow-400' : 'text-gray-400'}">${leader.avatar}</span>
                    <p class="text-[#B0B0B0] text-xs flex-1">${leader.wallet}</p>
                    <p class="text-green-400 text-xs font-semibold">${leader.wins} ${leader.wins !== '...' ? 'SOL' : ''}</p>
                  </div>
                `).join('')}
              </div>
            </div>
             <div class="card">
              <h3>Top Picks</h3>
              <p class="text-sm text-gray-400" x-text="topPick"></p>
            </div>
        `;
    }

    function addRiskTags() {
        document.querySelectorAll('.card[data-risk]').forEach(card => {
            const risk = card.dataset.risk;
            const titleElement = card.querySelector('h3');
            if (!risk || !titleElement || titleElement.querySelector('.badge-risk')) return;
            let badgeClass = '';
            switch (risk.toLowerCase()) {
                case 'low': badgeClass = 'badge-risk-low'; break;
                case 'medium': badgeClass = 'badge-risk-medium'; break;
                case 'high': badgeClass = 'badge-risk-high'; break;
                default: return;
            }
            const tag = document.createElement('span');
            tag.className = `badge-risk ${badgeClass}`;
            tag.textContent = risk;
            titleElement.appendChild(tag);
        });
    }

    function injectCountdownTimers() {
         document.querySelectorAll('.countdown-timer').forEach(timerElement => {
             const expiryTimestamp = parseInt(timerElement.dataset.expires, 10);
             if (isNaN(expiryTimestamp)) return;

             // Clear any existing interval for this element
             if (timerElement.dataset.intervalId) {
                 clearInterval(parseInt(timerElement.dataset.intervalId, 10));
             }

             const updateTimer = () => {
                 const now = Date.now();
                 const timeLeft = expiryTimestamp - now;

                 if (timeLeft <= 0) {
                     timerElement.textContent = 'Expired';
                      timerElement.classList.remove('badge-expiring', 'low-time'); // Remove low-time class
                     clearInterval(parseInt(timerElement.dataset.intervalId, 10)); // Clear interval
                     // Trigger vibration on countdown to zero
                     triggerVibration('loss'); // Using loss vibration for countdown end
                     // Optionally hide or disable the related prop card
                 } else {
                     const minutes = Math.floor(timeLeft / (60 * 1000));
                     const seconds = Math.floor((timeLeft % (60 * 1000)) / 1000);
                     timerElement.textContent = `${minutes}m ${seconds}s`;
                      // Add low-time class for heartbeat animation
                      if (timeLeft < 300000) { // Less than 5 minutes
                          timerElement.classList.add('low-time');
                      } else {
                          timerElement.classList.remove('low-time');
                      }
                      timerElement.classList.add('badge-expiring'); // Keep badge class for styling
                 }
             };

             updateTimer(); // Initial display
             const intervalId = setInterval(updateTimer, 1000); // Update every second
             timerElement.dataset.intervalId = intervalId.toString(); // Store interval ID

             // Cleanup on element removal using MutationObserver
             const observer = new MutationObserver(() => {
                 if (!document.contains(timerElement)) {
                     console.log(`Cleaning up interval ${timerElement.dataset.intervalId} for removed timer.`);
                     clearInterval(parseInt(timerElement.dataset.intervalId, 10));
                     observer.disconnect();
                 }
             });
             observer.observe(document.body, { childList: true, subtree: true });
         });
    }

     // Fake "Hot Prop" Indicators (Placeholder)
    function addHotPropIndicators() {
        const cards = document.querySelectorAll('.main-content .card');
        const cardsArray = Array.from(cards);
        const numToTag = Math.min(3, cardsArray.length); // Tag up to 3 random cards

        // Shuffle array
        for (let i = cardsArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [cardsArray[i], cardsArray[j]] = [cardsArray[j], cardsArray[i]];
        }

        for (let i = 0; i < numToTag; i++) {
            const card = cardsArray[i];
            const titleElement = card.querySelector('h3');
            if (titleElement && !titleElement.querySelector('.badge-hot')) {
                 const hotBadge = document.createElement('span');
                 hotBadge.className = 'badge badge-hot';
                 hotBadge.textContent = 'HOT';
                 titleElement.appendChild(hotBadge);
            }
        }
    }


    // --- Frontend-Backend Connectivity ---

    async function getPrice(coin) {
      const displayElement = document.getElementById('price-display');
      if (!displayElement) return;
      try {
        console.log(`Fetching price for ${coin}...`);
        // Replace with actual backend API call
        // const res = await fetch(`${BASE_URL}/api/price/${coin}`);
        // if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        // const data = await res.json();
        // console.log(`Price data for ${coin}:`, data);
        // const price = data.price;

        // Simulate fake data for demo
        const price = (Math.random() * 0.00005 + 0.00001).toFixed(5); // Simulate small price movements

        let formattedPrice = 'N/A';
        if (typeof price === 'string' || typeof price === 'number') {
             const numPrice = parseFloat(price);
             if (!isNaN(numPrice)) {
                formattedPrice = numPrice < 0.001 ? numPrice.toFixed(6) : numPrice.toFixed(4); // Show more decimals for very small prices
             }
        }
        displayElement.innerText = formattedPrice;
      } catch (e) {
        console.error('Error fetching price:', e);
        displayElement.innerText = 'Error';
      }
    }

    // Mock API call to check slip result
    async function checkSlipResult(picks) {
        console.log('Simulating backend slip check for:', picks);
        // In a real app, this would be an API call
        // try {
        //     const res = await fetch(`${BASE_URL}/api/check-slip-result`, {
        //         method: 'POST',
        //         headers: { 'Content-Type': 'application/json' },
        //         body: JSON.stringify({ picks })
        //     });
        //     if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        //     return await res.json(); // Should return { correctPicks: N, didWin: boolean }
        // } catch (error) {
        //     console.error('Error fetching slip result from API, using fallback:', error);
            // Fallback to simulation if API fails
            const didWin = Math.random() > 0.4; // 60% chance to lose for testing near-miss
            let correctPicks = 0;
            if (didWin) {
                correctPicks = picks.length; // Simulate all correct on win
            } else {
                // Simulate random correct picks on loss, with a chance of near-misses
                if (picks.length === 5 && Math.random() < 0.5) { // 50% chance of 4/5 near-miss on loss for 5-pick slips
                     correctPicks = 4;
                } else if (picks.length === 4 && Math.random() < 0.5) { // 50% chance of 3/4 near-miss on loss for 4-pick slips
                     correctPicks = 3;
                } else if (picks.length === 3 && Math.random() < 0.5) { // 50% chance of 2/3 near-miss on loss for 3-pick slips
                     correctPicks = 2;
                }
                 else {
                     correctPicks = Math.floor(Math.random() * picks.length); // Random correct picks otherwise
                }
            }
            console.log('Simulated slip result:', { didWin, correctPicks });
            return { didWin, correctPicks };
        // }
    }


    async function submitSlipToBackend(picksData = null, wagerAmount = null, walletAddr = null, multiplierVal = null, referrerAddr = null) {
        let payload;
        let actualWalletAddress;

        if (picksData && wagerAmount) {
            actualWalletAddress = walletAddr;
             payload = {
                 walletAddress: actualWalletAddress,
                 picks: picksData.map(p => ({ propId: p.propId, choice: p.choice, token: p.token, description: p.description })),
                 wager: wagerAmount,
                 duration: '1h', // This should likely be derived from the props
                 multiplier: multiplierVal,
                 referrerWallet: referrerAddr
             };
             console.log('Submitting actual slip data:', payload);
        } else {
            // This block seems unnecessary if submitSlipAction is always called with data
            // Keeping it for now based on original code structure
             const alpineData = document.querySelector('[x-data]')?.__x?.$data;
             actualWalletAddress = alpineData?.walletAddress;
             payload = {
                 walletAddress: actualWalletAddress,
                 picks: [{ propId: 'doge-test-001', token: '$DOGE', description: 'Test DOGE prop', choice: 'up' }],
                 wager: 0.1,
                 duration: '5m',
                 multiplier: 2,
                 referrerWallet: null
             };
             console.log('Submitting TEST slip data:', payload);
        }

        const token = localStorage.getItem('authToken');
        const headers = { 'Content-Type': 'application/json' };
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        } else if (actualWalletAddress) {
             console.warn("No JWT found, but wallet connected. Ensure backend handles this if needed.");
        }

        try {
            // Mock API call for submission
            // const res = await fetch(`${BASE_URL}/api/submit-slip`, {
            //     method: 'POST',
            //     headers: headers,
            //     body: JSON.stringify(payload)
            // });
            // const result = await res.json();
            // if (!res.ok) {
            //     console.error('Slip submission failed:', result);
            //     showToast(`Error: ${result.message || 'Submission failed'}`, 'error');
            // } else {
            //     console.log('Slip submitted successfully:', result);
                // showToast(`Slip submitted! ID: ${result.slipId?.slice(-6) || 'N/A'}`, 'success'); // Replaced by win/loss toast
                const alpineData = document.querySelector('[x-data]').__x.$data;
                if (alpineData.referrerAddress && !alpineData.firstSlipSubmitted) {
                    const shortRef = alpineData.referrerAddress.slice(0, 4) + '...' + alpineData.referrerAddress.slice(-4);
                    showToast(`Referral from ${shortRef} tracked!`, 'success');
                    localStorage.setItem('firstSlipSubmitted', 'true');
                    alpineData.firstSlipSubmitted = true;
                }
                // Handle simulated win/loss after successful *submission* (see submitSlipAction)
            // }
        } catch (err) {
            console.error('Submit slip network error:', err);
            showToast('Network error during submission.', 'error');
        }
    }


    // --- Initialization ---
    document.addEventListener('alpine:init', () => {
      Alpine.data('memePicks', () => ({
        // State variables
        walletAddress: localStorage.getItem('walletAddress') || null,
        walletBalance: parseFloat(localStorage.getItem('walletBalance')) || 0,
        faucetBalance: parseFloat(localStorage.getItem('faucetBalance')) || 10, // Initial faucet balance 10
        slip: { picks: [], wager: 0 },
        lastSlip: null,
        showSlipTray: false,
        betCount: parseInt(localStorage.getItem('betCount') || '0', 10),
        lossCount: parseInt(localStorage.getItem('lossCount') || '0', 10),
        dailyWagerLimit: parseFloat(localStorage.getItem('dailyWagerLimit') || '0'), // Load saved limit
        showDoubleWagerButton: false,
        tab: 'trending', // Default tab
        modals: {
          modal: false,
          hotPropModal: false,
          exitIntentModal: false,
          teaserModal: false,
          walletModal: false,
          ageVerificationModal: !localStorage.getItem('ageVerified'), // Use ageVerified from localStorage
          mysteryBoxModal: false, // Ensure it's included
          limitModal: false, // Added for Wager Limits
          winModal: false, // Added for Win Modal
          retryModal: false, // Added for Retry Modal
        },
        teaserCountdown: 0,
        isOver18: localStorage.getItem('ageVerified') === 'true' || false, // Use ageVerified
        boxTier: 'bronze', // Default mystery box tier
        boxImage: 'https://placehold.co/80x80/CD7F32/FFFFFF?text=BRONZE', // Placeholder
        boxReward: null,
        userProfile: {
          username: '', // Placeholder
          avatar: 'https://placehold.co/64x64/FFD700/000000?text=MP', // Placeholder
          badge: 'Newbie', // Placeholder
          totalWins: parseInt(localStorage.getItem('totalWins') || '0', 10),
          totalLosses: parseInt(localStorage.getItem('totalLosses') || '0', 10),
          streak: parseInt(localStorage.getItem('streak') || '0', 10),
          totalWagers: parseFloat(localStorage.getItem('totalWagers') || '0'),
        },
        multipliers: { 2: 1.5, 3: 2, 4: 3, 5: 5 }, // Updated multipliers
        referrerAddress: localStorage.getItem('referrerAddress') || null,
        firstSlipSubmitted: localStorage.getItem('firstSlipSubmitted') === 'true' || false,
        liveBetFeed: '',
        spotsLeft: { // Initial spotsLeft for dynamic badges
             'wif-001': Math.floor(Math.random() * 5) + 1,
             'pop-002': Math.floor(Math.random() * 5) + 1,
             'slerf-006': Math.floor(Math.random() * 5) + 1
        },
        rewardMeter: 0, // Placeholder for reward meter progress
        vipProgress: 0, // Placeholder for VIP progress
        currentHunchScore: 50, // Placeholder for Hunch Score (0-100)
        showWagerTooltip: false,
        wagerTooltipText: '', // Placeholder for wager tooltip text
        suggestedWager: 1.5, // Added for Wager Upsell
        topPick: '', // Added for Social Proof (Top Picks)
        challengeMessage: '', // Added for Live Challenge Feed
        isIdle: false, // Added for Idle detection
        longPressTimer: null, // Added for Long Press detection
        longPressThreshold: 500, // 500ms for long press


        // Initialization
        init() {
          console.log('Alpine initializing...');

          // Load saved state
          this.walletAddress = localStorage.getItem('walletAddress') || null;
          this.referrerAddress = localStorage.getItem('referrerAddress') || null;
          this.firstSlipSubmitted = localStorage.getItem('firstSlipSubmitted') === 'true';
          this.dailyWagerLimit = parseFloat(localStorage.getItem('dailyWagerLimit') || '0');
          this.lossCount = parseInt(localStorage.getItem('lossCount') || '0', 10);
          this.userProfile.totalWagers = parseFloat(localStorage.getItem('totalWagers') || '0');
          this.userProfile.streak = parseInt(localStorage.getItem('streak') || '0', 10);
          this.betCount = parseInt(localStorage.getItem('betCount') || '0', 10);
          this.userProfile.totalWins = parseInt(localStorage.getItem('totalWins') || '0', 10);
          this.userProfile.totalLosses = parseInt(localStorage.getItem('totalLosses') || '0', 10);
          this.isOver18 = localStorage.getItem('ageVerified') === 'true' || false;
          // Initialize reduced motion state
          if (localStorage.getItem('reducedMotion') === 'true') {
              document.body.classList.add('reduced-motion');
          }


          if (this.walletAddress) {
              console.log('Wallet address found in localStorage, fetching balance:', this.walletAddress);
              getWalletBalance(this.walletAddress);
          } else {
              // Check for referral code in URL
              const urlParams = new URLSearchParams(window.location.search);
              const refAddress = urlParams.get('ref');
              if (refAddress && !localStorage.getItem('referrerAddress')) {
                  console.log('Referral code found:', refAddress);
                  if (refAddress.length > 30 && refAddress.length < 50) { // Basic validation
                     localStorage.setItem('referrerAddress', refAddress);
                     this.referrerAddress = refAddress;
                     showToast(`Referral code ${refAddress.slice(0,4)}...${refAddress.slice(-4)} applied!`);
                  } else {
                     console.warn('Invalid referral code format ignored.');
                  }
              }
          }


          document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded. Injecting content and tags.');
            if (!window.Alpine) {
              console.error('Alpine.js not loaded');
              showToast('Failed to load the application.', 'error');
              return;
            }
            try {
              injectDummyContent.call(this); // Use .call(this) to pass Alpine context
              injectLeaderboardContent();
              addRiskTags();
              injectCountdownTimers();
              this.updateOddsDisplay();
              getPrice('SOL'); // Initial price fetch
              setInterval(() => getPrice('SOL'), 60000); // Update every minute
              this.setupIdleNudge();
              this.setupExitIntent();
              setTimeout(() => this.checkLeaderboardRank(), 2000);
              setTimeout(() => addHotPropIndicators(), 1000);
              this.updateRewardMeter();
              this.updateVIPProgress();
              this.updateBetFeed();
              this.updateChallengeFeed(); // Start challenge feed updates
              this.updateScarcity(); // Start scarcity updates
              this.updateTopPicks(); // Start top picks updates
              this.initGSAPAnimations(); // Initialize GSAP animations


              // Initialize Slot Particles
              const particleContainer = document.createElement('div');
              particleContainer.id = 'slot-particles';
              document.body.appendChild(particleContainer);
              function createParticle() {
                  const particleContainer = document.getElementById('slot-particles');
                   // Limit active particles
                  if (particleContainer && particleContainer.childElementCount < 20) { // Cap particles at 20
                      const particle = document.createElement('div');
                      particle.className = 'particle';
                      particle.style.left = Math.random() * 100 + '%';
                      particle.style.top = Math.random() * 100 + '%';
                      particle.style.animationDelay = Math.random() * 3 + 's';
                      particleContainer.appendChild(particle);
                      setTimeout(() => particle.remove(), 4000);
                  }
              }
              setInterval(createParticle, 300); // Create a new particle every 300ms

              // Ambient sound is now initialized on first click via event listener
              // sounds.ambient.play(); // Needs to be called after sounds object is defined and loaded
            } catch (e) {
              console.error('Initialization error:', e);
              showToast('Error loading content.', 'error');
            }
          });

          // Show age verification modal if not verified
          if (!this.isOver18) {
            this.modals.ageVerificationModal = true;
          }

          // Adjust showSlipTray based on screen size on load and resize
          this.showSlipTray = window.innerWidth >= 768;
          window.addEventListener('resize', () => {
              this.showSlipTray = window.innerWidth >= 768;
              // Reset scroll lock on resize if no modals/tray are open
              if (!this.showSlipTray && !this.activeModal && !Object.values(this.modals).some(isOpen => isOpen)) {
                 this.toggleBodyScroll(true);
              } else if (this.showSlipTray || this.activeModal || Object.values(this.modals).some(isOpen => isOpen)) {
                  this.toggleBodyScroll(false);
              }
               this.setupExitIntent(); // Re-setup exit intent on resize
          });

          console.log('Alpine initialized.');
        },

        // Method to toggle reduced motion class
        toggleReducedMotion(enabled) {
            document.body.classList.toggle('reduced-motion', enabled);
            localStorage.setItem('reducedMotion', enabled);
             // If enabling reduced motion, kill any ongoing GSAP animations
            if (enabled) {
                gsap.globalTimeline.clear();
            } else {
                // If disabling, re-initialize GSAP animations (might need more specific targeting)
                this.initGSAPAnimations();
            }
        },

        // Method to initialize GSAP animations
        initGSAPAnimations() {
            // Button Shimmer Animation
            document.querySelectorAll('.button-primary').forEach(btn => {
                const shimmer = btn.querySelector('::before');
                 if (shimmer) {
                     gsap.to(shimmer, {
                         xPercent: 200,
                         duration: 0.4,
                         ease: 'linear',
                         repeat: -1
                     });
                 }
            });
             // Add other GSAP animations here if needed
        },

        // Methods
        toggleBodyScroll(enabled) {
          document.body.classList.toggle('modal-open', !enabled);
        },

        openModal(name) {
          this.closeAllModals();
          this.showSlipTray = false; // Close slip tray when opening modal
          this.modals[name] = true;
          this.activeModal = name;
          this.toggleBodyScroll(false);
          console.log('Opening modal:', name);
        },

        closeModal(name) {
             // Trigger sparkle animation from modal corners on close
            const modalElement = document.getElementById(name + 'Modal'); // Assuming modal IDs follow this pattern
            if (modalElement) {
                const rect = modalElement.getBoundingClientRect();
                // Trigger sparkles from top-left and top-right corners
                triggerSparkles(rect.left / window.innerWidth, rect.top / window.innerHeight);
                triggerSparkles(rect.right / window.innerWidth, rect.top / window.innerHeight);
            }

          this.modals[name] = false;
          if (this.activeModal === name) {
              this.activeModal = null;
              // Re-enable scroll only if NO modals and NO slip tray are open
              if (!this.showSlipTray && !Object.values(this.modals).some(isOpen => isOpen)) {
                  this.toggleBodyScroll(true);
              }
          }
           // Handle Age Gate confirmation
           if (name === 'ageVerificationModal' && this.isOver18) { // Corrected modal name
               localStorage.setItem('ageVerified', 'true');
           }
           // Handle Limit Modal save
           if (name === 'limitModal') {
               this.saveWagerLimit();
           }
        },

        closeAllModals() {
          Object.keys(this.modals).forEach(name => {
               // Trigger sparkle animation from modal corners on close
              const modalElement = document.getElementById(name + 'Modal'); // Assuming modal IDs follow this pattern
              if (modalElement) {
                  const rect = modalElement.getBoundingClientRect();
                   // Trigger sparkles from top-left and top-right corners
                  triggerSparkles(rect.left / window.innerWidth, rect.top / window.innerHeight);
                  triggerSparkles(rect.right / window.innerWidth, rect.top / window.innerHeight);
              }
              this.modals[name] = false;
          });
          this.activeModal = null;
           // Re-enable scroll only if NO modals and NO slip tray are open
          if (!this.showSlipTray && !Object.values(this.modals).some(isOpen => isOpen)) {
              this.toggleBodyScroll(true);
          }
        },

        scrollTabIntoView(element) {
          element.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
        },

        openProfile() {
            this.tab = 'profile';
            this.showDrawer = false; // Close drawer if open
            console.log('Switched to Profile tab');
        },

        toggleSlipTray() {
          // Only toggle on mobile (screen width < 768px)
          if (window.innerWidth < 768) {
            this.showSlipTray = !this.showSlipTray;
            if (this.showSlipTray) {
              this.closeAllModals(); // Close modals when opening slip tray
              this.toggleBodyScroll(false);
            } else {
               // Re-enable scroll only if NO modals and NO slip tray are open
              if (!this.activeModal && !Object.values(this.modals).some(isOpen => isOpen)) {
                  this.toggleBodyScroll(true);
              }
            }
          } else {
              // On desktop, slip tray is always visible, maybe just highlight it?
              // Or show a 'Slip' section in the main content?
              // For now, do nothing on desktop toggle click.
              console.log('Slip tray toggle clicked on desktop (no action)');
          }
        },

        addToSlip(event) {
          const button = event.currentTarget;
          // Rewarding Clicks Micro-feedback
          triggerVibration('pick'); // Use vibration pattern
          playSound('pick'); // Use Howler sound

          const propId = button.dataset.prop;
          const choice = button.dataset.option;
          const card = button.closest('.card');
          if (!card) return;

          const tokenElement = card.querySelector('h3');
          const token = tokenElement ? tokenElement.textContent.trim().split(' ')[0] : 'Unknown';
          const descriptionElement = card.querySelector('p.text-sm');
          const description = descriptionElement ? descriptionElement.textContent.trim() : 'No description';

          const otherOptionButton = card.querySelector(`.button-secondary[data-prop='${propId}']:not([data-option='${choice}'])`);
          if (otherOptionButton && otherOptionButton.classList.contains('active')) {
              this.removePick(propId);
              otherOptionButton.classList.remove('active');
          }

          const existingPickIndex = this.slip.picks.findIndex(pick => pick.propId === propId);

          if (existingPickIndex !== -1) {
              if (this.slip.picks[existingPickIndex].choice === choice) {
                  this.removePick(propId);
                  button.classList.remove('active');
                  showToast(`${token}: ${choice} removed from slip.`);
              } else {
                  this.slip.picks[existingPickIndex].choice = choice;
                  card.querySelectorAll(`.button-secondary[data-prop='${propId}']`).forEach(btn => btn.classList.remove('active'));
                  button.classList.add('active');
                  showToast(`${token}: Choice updated to ${choice}.`);
              }
          } else {
              if (this.slip.picks.length >= 5) {
                  showToast('Max 5 picks allowed.');
                  return;
              }
              this.slip.picks.push({ propId, token, description, choice });
              button.classList.add('active');
              showToast(`${token}: ${choice} added to slip.`);
          }
            this.updateOddsDisplay();
             // Show slip tray on first pick added (mobile)
            if (window.innerWidth < 768 && !this.showSlipTray && this.slip.picks.length > 0) {
                this.toggleSlipTray();
            }
             // Token-Based Suggestions (Placeholder)
             const lastBetToken = localStorage.getItem('lastBetToken');
             if (lastBetToken && lastBetToken !== token) { // Only suggest if different from current pick
                 this.suggestProp();
             }
             localStorage.setItem('lastBetToken', token); // Store the token of the current pick
        },

        removePick(propId) {
          this.slip.picks = this.slip.picks.filter(pick => pick.propId !== propId);
          document.querySelectorAll(`.button-secondary[data-prop='${propId}'].active`).forEach(btn => {
              btn.classList.remove('active');
          });
          this.updateOddsDisplay();
           if (window.innerWidth < 768 && this.showSlipTray && this.slip.picks.length === 0) {
                this.toggleSlipTray(); // Close slip tray if empty on mobile
           }
        },

        updateOddsDisplay() {
            const currentMultiplier = this.multipliers[this.slip.picks.length] || 0; // Use 0 if no picks
            document.querySelectorAll('.button-secondary[data-prop]').forEach(button => {
                const existingOdds = button.querySelector('.odds-multiplier');
                if (existingOdds) existingOdds.remove();
                if (this.slip.picks.length > 0) {
                    const oddsSpan = document.createElement('span');
                    oddsSpan.className = 'odds-multiplier';
                    oddsSpan.textContent = `(+${currentMultiplier}x)`;
                    button.appendChild(oddsSpan);
                }
            });
            // Update FAB glow based on risk level (placeholder logic)
            const fab = document.getElementById('slip-tray-trigger');
            if (fab) {
                fab.classList.remove('glow-green', 'glow-yellow', 'glow-red');
                 if (this.slip.picks.length > 0) {
                     // Simple risk assessment: assume more picks = higher risk for now
                     if (this.slip.picks.length >= 4) fab.classList.add('glow-red');
                     else if (this.slip.picks.length >= 3) fab.classList.add('glow-yellow');
                     else if (this.slip.picks.length >= 1) fab.classList.add('glow-green');
                 }
            }

             // Update Hunch Score based on picks (placeholder logic)
            if (this.slip.picks.length === 0) {
                this.currentHunchScore = 50;
            } else {
                // Dummy logic: increase score slightly with each pick
                this.currentHunchScore = Math.min(100, 50 + this.slip.picks.length * 10); // Start at 50, add 10 per pick
            }
             document.documentElement.style.setProperty('--hunch-percentage', `${this.currentHunchScore}%`);
        },


        updateSlipWager() {
          const wagerInput = document.getElementById('wager-mobile');
          this.slip.wager = Number(wagerInput.value) || 0;
           // Show/hide/update wager tooltip (placeholder logic)
           // Suggested wager logic: if current wager is 0, suggest 1.5. If between 0 and 5, suggest 3 or 5.
          this.suggestedWager = this.slip.wager === 0 ? 1.5 : (this.slip.wager < 5 ? 3 : 5);
          this.wagerTooltipText = `Try ${this.suggestedWager} SOL?`;
          this.showWagerTooltip = this.slip.wager > 0 && this.slip.wager < 5; // Show tooltip if wager is set but less than 5

           const tooltip = document.querySelector('.wager-tooltip');
           if(tooltip) tooltip.style.opacity = this.showWagerTooltip ? 1 : 0;

        },

        isValidSlip() {
          const numPicks = this.slip.picks.length;
          const wager = this.slip.wager;
          return numPicks >= 2 && numPicks <= 5 && typeof wager === 'number' && wager > 0 && wager <= 10; // Wager must be > 0
        },

        async submitSlipAction() {
          // Play submit sound and vibration immediately
          playSound('submit');
          triggerVibration('submit');

          try {
            // Validate slip
            if (!this.isValidSlip()) {
              this.openModal('modal');
              document.getElementById('modal-title').textContent = 'Invalid Slip';
              document.getElementById('modal-message').textContent = 'Select 2–5 picks and set a wager between 0.1–10 SOL.';
              return;
            }

             // Check Wager Limit
             if (this.dailyWagerLimit > 0 && this.slip.wager > this.dailyWagerLimit) {
               showToast('Wager exceeds daily limit.', 'error');
               triggerVibration('loss');
               return;
             }


            let submissionMode = '';
            let sufficientBalance = false;

            if (this.walletAddress) {
                // In a real app, you'd check the actual wallet balance via RPC or backend
                // For now, simulate based on the loaded walletBalance
                sufficientBalance = this.walletBalance >= this.slip.wager;
                submissionMode = 'wallet';
                if (!sufficientBalance) {
                    showToast('Insufficient wallet balance.', 'error');
                    triggerVibration('loss');
                    return;
                }
            } else {
                if (this.faucetBalance >= this.slip.wager) {
                    sufficientBalance = true;
                    submissionMode = 'faucet';
                } else {
                    showToast(`Insufficient faucet balance. You have ${this.faucetBalance.toFixed(1)} SOL left.`, 'error');
                    triggerVibration('loss');
                    return;
                }
            }

            if (sufficientBalance) {
                console.log(`Submitting slip in ${submissionMode} mode:`, JSON.stringify(this.slip));

                // Store slip before clearing for Double Wager and Retry
                this.lastSlip = { picks: [...this.slip.picks], wager: this.slip.wager };

                // Deduct wager immediately
                if (submissionMode === 'faucet') {
                    this.faucetBalance = Math.max(0, this.faucetBalance - this.slip.wager);
                    localStorage.setItem('faucetBalance', this.faucetBalance.toFixed(2)); // Save faucet balance
                    console.log(`Faucet balance updated: ${this.faucetBalance.toFixed(1)}`);
                } else {
                     // Deduct from wallet balance (placeholder - needs actual transaction logic)
                     this.walletBalance = Math.max(0, (this.walletBalance || 0) - this.slip.wager);
                     localStorage.setItem('walletBalance', this.walletBalance.toFixed(2)); // Save wallet balance
                }

                // Trigger Coin Flip Micro-Reward Animation after submission
                 this.triggerCoinFlip();

                // Submit slip to backend (placeholder)
                await submitSlipToBackend(this.lastSlip.picks, this.lastSlip.wager, this.walletAddress, this.multipliers[this.lastSlip.picks.length], this.referrerAddress);


                // Check slip result (placeholder - replace with actual API call result)
                const result = await checkSlipResult(this.lastSlip.picks); // Call the checkSlipResult function

                // ** Trigger Win/Loss Effects **
                if (result.didWin) {
                    // Simulate Win: Trigger Confetti/Shake
                     document.body.classList.add('shake'); // Screen Shake
                     setTimeout(() => document.body.classList.remove('shake'), 500);
                    triggerConfetti(1.5); // Confetti Explosions
                    playRewardSound(); // Play random win sound
                    triggerVibration('win'); // Win vibration
                    this.userProfile.totalWins++; // Update profile
                    this.userProfile.streak++; // Increase streak
                     this.lossCount = 0; // Reset loss count
                     localStorage.setItem('totalWins', this.userProfile.totalWins); // Save profile stats
                     localStorage.setItem('streak', this.userProfile.streak);
                     localStorage.setItem('lossCount', '0');

                     // Show Win Modal
                     this.modals.winModal = true;


                    // Show Double Wager Button
                    this.showDoubleWagerButton = true;
                    setTimeout(() => this.showDoubleWagerButton = false, 10000); // Hide after 10s

                     // Instant Payouts (Faucet Mode)
                     if (submissionMode === 'faucet') {
                         const payout = this.lastSlip.wager * this.multipliers[this.lastSlip.picks.length];
                         this.faucetBalance += payout;
                         localStorage.setItem('faucetBalance', this.faucetBalance.toFixed(2)); // Save faucet balance
                         // showToast(`You won ${payout.toFixed(2)} SOL!`, 'success'); // Toast is now handled by win modal
                     } else {
                          // Wallet payout (placeholder - needs actual transaction logic)
                          const payout = this.lastSlip.wager * this.multipliers[this.lastSlip.picks.length];
                          this.walletBalance += payout;
                          localStorage.setItem('walletBalance', this.walletBalance.toFixed(2)); // Save wallet balance
                          // showToast(`You won ${payout.toFixed(2)} SOL!`, 'success'); // Toast is now handled by win modal
                     }


                 } else {
                    // Simulate Loss: Flash Red Outline / Dim / Coin Burst
                     showToast('Better luck next time!', 'error');
                     playSound('lossThud'); // Howler Loss Sound
                     triggerVibration('loss'); // Loss vibration
                     this.userProfile.totalLosses++; // Update profile
                     this.userProfile.streak = 0; // Reset streak
                     this.lossCount++; // Increment loss count
                     localStorage.setItem('totalLosses', this.userProfile.totalLosses); // Save profile stats
                     localStorage.setItem('streak', '0');
                     localStorage.setItem('lossCount', this.lossCount);


                      // Trigger "Almost Won" if applicable and show Retry Modal
                     if ((this.lastSlip.picks.length === 5 && result.correctPicks === 4) ||
                         (this.lastSlip.picks.length === 4 && result.correctPicks === 3) ||
                         (this.lastSlip.picks.length === 3 && result.correctPicks === 2)) { // Added 3/4 and 2/3 checks
                         const slipTray = document.getElementById('slip-tray');
                         if (slipTray) {
                             slipTray.classList.add('almost-won-card');
                             playSound('sadTrombone'); // Sad Trombone sound
                             triggerVibration('almostWon'); // Almost won vibration
                             showToast('SO CLOSE! One more pick could’ve won!', 'info');
                             setTimeout(() => slipTray.classList.remove('almost-won-card'), 5000); // Remove class after animation
                         }
                         this.modals.retryModal = true; // Show retry modal for near-misses
                     } else {
                         // Trigger Fake Win Teaser on regular loss (Placeholder - random chance on loss)
                         if (Math.random() < 0.3) { // 30% chance
                             await this.triggerTeaserModal(); // Wait for teaser modal to close
                         }
                     }


                     // Loss Alerts (Placeholder)
                     if (this.lossCount >= 5) {
                        showToast('Take a break? You’ve had 5 losses.', 'info');
                        triggerVibration('loss'); // Add vibration for loss alert
                     }
                 }

                // Update Reward Meter (Placeholder)
                this.betCount++;
                localStorage.setItem('betCount', this.betCount); // Save bet count
                this.updateRewardMeter();

                // Update VIP Progress (Placeholder)
                this.userProfile.totalWagers += this.slip.wager;
                localStorage.setItem('totalWagers', this.userProfile.totalWagers.toFixed(2)); // Save total wagers
                this.updateVIPProgress();

                // Clear slip and update UI
                this.slip.picks.forEach(pick => {
                    const buttonYes = document.querySelector(`.button-secondary[data-prop='${pick.propId}'][data-option='Yes']`);
                    const buttonNo = document.querySelector(`.button-secondary[data-prop='${pick.propId}'][data-option='No']`);
                    if (buttonYes) buttonYes.classList.remove('active');
                    if (buttonNo) buttonNo.classList.remove('active');
                });
                this.slip.picks = [];
                this.slip.wager = 0;
                const wagerInput = document.getElementById('wager-mobile');
                if(wagerInput) wagerInput.value = '';
                 if (window.innerWidth < 768) {
                     this.showSlipTray = false;
                     this.toggleBodyScroll(true);
                 }
                this.updateOddsDisplay(); // Update odds display after clearing slip

                 // Trigger Mystery Box (placeholder logic - now handled by updateRewardMeter)
            }
          } catch (error) {
            console.error('Error in submitSlipAction:', error);
            showToast('Failed to process slip. Please try again.', 'error');
            triggerVibration('loss'); // Add vibration on error
          }
        },

        // Added retrySlip method
        retrySlip() {
             console.log('Attempting to retry slip:', this.lastSlip);
            if (this.lastSlip && this.lastSlip.picks.length >= 2 && this.lastSlip.picks.length <= 5) {
                 // Calculate new wager (1.5x, capped at 10 SOL)
                 const newWager = Math.min(this.lastSlip.wager * 1.5, 10);

                 // Check if new wager exceeds daily limit
                 if (this.dailyWagerLimit > 0 && newWager > this.dailyWagerLimit) {
                    showToast('Retry wager exceeds daily limit.', 'error');
                    triggerVibration('loss');
                    this.modals.retryModal = false; // Close modal
                    return;
                 }

                 // Check if sufficient balance for new wager
                 let sufficientBalance = false;
                 if (this.walletAddress) {
                     sufficientBalance = this.walletBalance >= newWager;
                 } else {
                     sufficientBalance = this.faucetBalance >= newWager;
                 }
                  if (!sufficientBalance) {
                     showToast(`Insufficient balance for retry wager.`, 'error');
                     triggerVibration('loss');
                     this.modals.retryModal = false; // Close modal
                     return;
                  }


                // Set the current slip to the last slip with the new wager
                this.slip = { picks: [...this.lastSlip.picks], wager: newWager };

                // Visually select the picks in the UI
                this.slip.picks.forEach(pick => {
                    const button = document.querySelector(`.button-secondary[data-prop='${pick.propId}'][data-option='${pick.choice}']`);
                    if (button) {
                        button.classList.add('active');
                    }
                });

                this.updateOddsDisplay(); // Update odds display

                // Submit the slip
                this.submitSlipAction();

                // Close the retry modal
                this.modals.retryModal = false;

                 // Open slip tray on mobile after retry
                 if (window.innerWidth < 768) {
                     this.showSlipTray = true;
                     this.toggleBodyScroll(false);
                 }

            } else {
                console.warn('No valid last slip to retry.');
                showToast('No valid slip to retry.', 'error');
                this.modals.retryModal = false; // Close modal even if invalid
            }
        },


        doubleWager() {
            if (!this.showDoubleWagerButton || !this.lastSlip) {
                showToast('No valid slip to double.', 'error');
                return;
            }
            const doubledWager = this.lastSlip.wager * 2;
            // Check if doubled wager is within limits and slip is valid (2-5 picks)
            if (doubledWager > 0.1 && doubledWager <= 10 && this.lastSlip.picks.length >= 2 && this.lastSlip.picks.length <= 5) {
                // Check if doubled wager exceeds daily limit
                if (this.dailyWagerLimit > 0 && doubledWager > this.dailyWagerLimit) {
                   showToast('Doubled wager exceeds daily limit.', 'error');
                   triggerVibration('loss');
                   return;
                }

                // Check if sufficient balance for doubled wager
                let sufficientBalance = false;
                if (this.walletAddress) {
                    sufficientBalance = this.walletBalance >= doubledWager;
                } else {
                    sufficientBalance = this.faucetBalance >= doubledWager;
                }
                 if (!sufficientBalance) {
                    showToast(`Insufficient balance for doubled wager.`, 'error');
                    return;
                 }


                // Restore the last slip with doubled wager
                this.slip = { picks: [...this.lastSlip.picks], wager: doubledWager };

                 // Visually select the picks in the UI for the doubled slip
                this.slip.picks.forEach(pick => {
                    const button = document.querySelector(`.button-secondary[data-prop='${pick.propId}'][data-option='${pick.choice}']`);
                    if (button) {
                        button.classList.add('active');
                    }
                });
                 this.updateOddsDisplay(); // Update odds display

                this.submitSlipAction(); // Resubmit
                showToast('Wager doubled for next slip!', 'success');
            } else {
                showToast(doubledWager > 10 ? 'Doubled wager exceeds max (10 SOL).' : 'Invalid slip for doubling.', 'error');
            }
            this.showDoubleWagerButton = false; // Hide button after clicking
        },


        disconnectWallet() {
          console.log('Disconnect Wallet button clicked');
          localStorage.removeItem('walletAddress');
          localStorage.removeItem('firstSlipSubmitted');
          localStorage.removeItem('walletBalance'); // Clear wallet balance from storage
          this.walletAddress = null;
          this.walletBalance = 0; // Reset wallet balance in state
          this.firstSlipSubmitted = false;
          showToast('Wallet disconnected.');
          this.updateOddsDisplay(); // Update UI based on no wallet
        },

        copyAddress() {
            if (!this.walletAddress) return;
            navigator.clipboard.writeText(this.walletAddress).then(() => {
                showToast('Copied!');
                 triggerVibration(30);
            }).catch(err => {
                console.error('Failed to copy address: ', err);
                showToast('Failed to copy address.', 'error');
            });
        },

        getInviteLink() {
            if (!this.walletAddress) {
                showToast('Connect wallet to get invite link.', 'error');
                return;
            }
            const inviteLink = `${window.location.origin}${window.location.pathname}?ref=${this.walletAddress}`;
            navigator.clipboard.writeText(inviteLink).then(() => {
                showToast('Invite link copied!');
                 triggerVibration(30);
            }).catch(err => {
                console.error('Failed to copy invite link: ', err);
                showToast('Failed to copy link.', 'error');
            });
        },

        sendTip() {
            if (!this.walletAddress) {
                showToast('Connect wallet to send tips.', 'error');
                return;
            }
            if (!this.tipRecipient || this.tipAmount <= 0) {
                showToast('Invalid recipient or amount.', 'error');
                return;
            }
             // Check if sufficient balance for tip
            let sufficientBalance = false;
            if (this.walletAddress) {
                sufficientBalance = this.walletBalance >= this.tipAmount;
            } else {
                sufficientBalance = this.faucetBalance >= this.tipAmount;
            }
             if (!sufficientBalance) {
                showToast(`Insufficient balance to send tip.`, 'error');
                return;
             }


            console.log(`Placeholder: Sending ${this.tipAmount} SOL tip from ${this.walletAddress} to ${this.tipRecipient}`);
            showToast(`Simulating tip of ${this.tipAmount} SOL to ${this.tipRecipient.slice(0,6)}...`, 'success');
            triggerVibration(50);
             // Deduct tip from balance (placeholder)
            if (this.walletAddress) {
                this.walletBalance = Math.max(0, (this.walletBalance || 0) - this.tipAmount);
                localStorage.setItem('walletBalance', this.walletBalance.toFixed(2));
            } else {
                this.faucetBalance = Math.max(0, this.faucetBalance - this.tipAmount);
                localStorage.setItem('faucetBalance', this.faucetBalance.toFixed(2));
            }

            this.tipRecipient = '';
            this.tipAmount = 0.1;
        },

        sendChatMessage(event) {
            const input = event.target.elements.messageInput;
            const message = input.value.trim();
            if (!message) return;

            console.log(`Placeholder: Sending chat message to room ${this.selectedChatRoom}: ${message}`);

            const chatFeed = document.getElementById(`global-chat-feed`); // Assuming global chat feed
            if (chatFeed) {
                 const msgDiv = document.createElement('div');
                 // Randomly add 'hot' class (20% chance)
                 msgDiv.className = 'chat-message' + (Math.random() < 0.2 ? ' hot' : '');
                 const usernameSpan = document.createElement('span');
                 usernameSpan.className = 'username';
                 usernameSpan.textContent = 'You:'; // In real app, use connected username
                 const messageText = document.createTextNode(` ${message}`);
                 msgDiv.appendChild(usernameSpan);
                 msgDiv.appendChild(messageText);
                 chatFeed.prepend(msgDiv);
                 chatFeed.scrollTop = 0; // Keep latest messages at the top
            }

            input.value = '';
             // Trigger click feedback on send button (handled by button:active CSS)
        },

        // Placeholder function to trigger the Fake Win Teaser modal
        async triggerTeaserModal() {
          return new Promise(resolve => {
            this.modals.teaserModal = true;
            let countdown = 3;
            this.teaserCountdown = countdown; // Initial display
            const interval = setInterval(() => {
                countdown--;
                this.teaserCountdown = countdown;
                if (countdown < 0) {
                    clearInterval(interval);
                    this.modals.teaserModal = false;
                    // The loss toast is now triggered in submitSlipAction after the teaser modal closes
                    resolve(); // Resolve the promise to allow submitSlipAction to continue
                }
            }, 1000);
          });
        },

        // Placeholder function to trigger the Mystery Box modal
        triggerMysteryBox() {
            const boxTiers = {
                bronze: { image: 'https://placehold.co/80x80/CD7F32/FFFFFF?text=BRONZE', rewards: ['0.1 SOL', 'Free Pick'] },
                silver: { image: 'https://placehold.co/80x80/C0C0C0/000000?text=SILVER', rewards: ['0.5 SOL', '2x Multiplier'] },
                gold: { image: 'https://placehold.co/80x80/FFD700/000000?text=GOLD', rewards: ['1 SOL', 'Exclusive Badge'] }
            };
             // Tier logic based on betCount or totalWagers? Let's use betCount for simplicity here (every 5 bets)
             const tier = this.betCount > 0 && this.betCount % 10 === 0 ? 'gold' : (this.betCount > 0 && this.betCount % 5 === 0 ? 'silver' : 'bronze'); // Simplified logic
             if (this.betCount === 0 || this.betCount % 5 !== 0) return; // Only trigger on every 5th bet (excluding bet 0)

            this.boxTier = tier.charAt(0).toUpperCase() + tier.slice(1); // Capitalize tier name
            this.boxImage = boxTiers[tier].image;
            this.boxReward = boxTiers[tier].rewards[Math.floor(Math.random() * boxTiers[tier].rewards.length)];
            this.modals.mysteryBoxModal = true;
            triggerConfetti(tier === 'gold' ? 2 : 1);
        },

        // Placeholder function to reveal the Mystery Box reward
        revealReward() {
            // This function is called when the user clicks "Open Box" inside the modal
            // The reward is already determined in triggerMysteryBox
            showToast(`You got ${this.boxReward}!`, 'success');
            // Apply reward (e.g., add SOL to faucetBalance) - Placeholder logic
            if (this.boxReward.includes('SOL')) {
                const amount = parseFloat(this.boxReward);
                if (this.walletAddress) {
                    this.walletBalance += amount;
                    localStorage.setItem('walletBalance', this.walletBalance.toFixed(2));
                } else {
                    this.faucetBalance += amount;
                    localStorage.setItem('faucetBalance', this.faucetBalance.toFixed(2));
                }
            }
            // In a real app, apply other rewards like multipliers or badges
        },

        // Placeholder function to update the Reward Meter progress
        updateRewardMeter() {
            // Progress based on 5 bets for a box
            const progress = Math.min(1, (this.betCount % 5) / 5); // Progress cycles every 5 bets
            // document.documentElement.style.setProperty('--progress', progress); // This was for a different meter
            // The SVG progress is updated directly in the FAB HTML using betCount % 5
            if (this.betCount > 0 && this.betCount % 5 === 0) { // Trigger box every 5 bets
                this.triggerMysteryBox();
                // Do NOT reset betCount here, let it keep counting for VIP etc.
            }
        },

        // Placeholder function for Live Challenge Feed
        updateChallengeFeed() {
            const challengeActions = [
                `User${Math.floor(Math.random() * 1000)} challenges you to bet on $WIF!`,
                `User${Math.floor(Math.random() * 1000)} dares you to hit a 5-pick slip!`,
                `User${Math.floor(Math.random() * 1000)} wants to see you double down on $BONK!`
            ];
            this.challengeMessage = challengeActions[Math.floor(Math.random() * challengeActions.length)];
            setTimeout(() => this.updateChallengeFeed(), 15000); // Update every 15 seconds
        },

        // Placeholder function to accept a challenge
        acceptChallenge() {
            // Auto-fill slip with challenge prop (placeholder)
            // This would require parsing the challengeMessage or getting challenge details from a backend
            showToast('Challenge accepted! Slip updated (placeholder).', 'success');
             // For demo, just close the modal or hide the challenge card
             // This needs more specific implementation based on how challenges are structured
        },

        // Placeholder function to taunt a user (e.g., for declining a challenge)
        tauntUser() {
            showToast('Scared to take on the challenge?', 'info');
             // For demo, just close the modal or hide the challenge card
        },

        // Placeholder function to suggest a prop based on user behavior
        suggestProp() {
            const lastToken = localStorage.getItem('lastBetToken');
            if (lastToken) {
                // In a real app, fetch a related prop for this token from the backend
                showToast(`New ${lastToken} prop available! Check the list.`, 'info');
            }
        },

        // Placeholder function to set up the Inactivity Nudge and Idle Pulse
        setupIdleNudge() {
            let idleTimeout;
            const submitButton = document.querySelector('.button-primary'); // Get the submit button
             const fabButton = document.getElementById('slip-tray-trigger'); // Get the FAB

            const resetTimer = () => {
                clearTimeout(idleTimeout);
                 // Remove idle class from buttons when activity is detected
                 if (submitButton) submitButton.classList.remove('idle');
                 if (fabButton) fabButton.classList.remove('idle');
                 this.isIdle = false; // Set Alpine state

                idleTimeout = setTimeout(() => {
                     console.log('User is idle. Triggering hot prop alert and idle pulse.');
                     this.modals.hotPropModal = true;
                     triggerVibration('pick'); // Vibrate on nudge
                     // Add idle class to buttons
                     if (submitButton) submitButton.classList.add('idle');
                     if (fabButton) fabButton.classList.add('idle');
                     this.isIdle = true; // Set Alpine state
                }, 20000); // Trigger after 20 seconds of inactivity (Updated)
            };

            // Reset timer on user activity
            ['mousemove', 'mousedown', 'keydown', 'scroll', 'touchstart'].forEach(event => {
                document.addEventListener(event, resetTimer, { passive: true });
            });

            resetTimer(); // Start the timer initially
        },

        // Placeholder function to set up Exit Intent
        setupExitIntent() {
          // Only enable on desktop
          if (window.innerWidth >= 768) {
            document.addEventListener('mouseout', (e) => {
              // Check if the mouse is leaving the document
              if (e.toElement === null && e.relatedTarget === null) {
                console.log('Exit intent detected.');
                // Only show if no other modals are open
                if (!this.activeModal && !Object.values(this.modals).some(isOpen => isOpen)) {
                   this.modals.exitIntentModal = true;
                }
              }
            }); // Removed { once: true } to allow multiple triggers
          }
        },


        // Placeholder function to claim the Exit Intent bonus
        claimExitBonus() {
            this.faucetBalance += 0.2; // Add 0.2 SOL to faucet balance (Updated)
            localStorage.setItem('faucetBalance', this.faucetBalance.toFixed(2)); // Save faucet balance
            showToast('0.2 SOL added to your balance!', 'success'); // Updated toast message
        },

        // Placeholder function to request browser notifications
        requestNotifications() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('Notification permission granted.');
                        // You can now send notifications, e.g., new prop alerts
                        // new Notification('New $WIF prop expires soon!'); // Example notification
                    } else {
                        console.warn('Notification permission denied.');
                    }
                }).catch(error => {
                    console.error('Error requesting notification permission:', error);
                });
            } else {
                console.warn('Browser does not support notifications.');
            }
        },

        // Placeholder function to get the user's VIP level
        getVIPLevel() {
            const wagers = this.userProfile.totalWagers;
            if (wagers >= 500) return 'Diamond';
            if (wagers >= 100) return 'Gold';
            if (wagers >= 50) return 'Silver';
            return 'Bronze';
        },

        // Placeholder function to update VIP progress
        updateVIPProgress() {
            const wagers = this.userProfile.totalWagers;
            const thresholds = { Bronze: 0, Silver: 50, Gold: 100, Diamond: 500 };
            const currentLevel = this.getVIPLevel();
            let nextLevelThreshold = 0;
            let currentLevelThreshold = 0;

            if (currentLevel === 'Bronze') {
                nextLevelThreshold = thresholds.Silver;
                currentLevelThreshold = thresholds.Bronze;
            } else if (currentLevel === 'Silver') {
                nextLevelThreshold = thresholds.Gold;
                currentLevelThreshold = thresholds.Silver;
            } else if (currentLevel === 'Gold') {
                nextLevelThreshold = thresholds.Diamond;
                currentLevelThreshold = thresholds.Gold;
            } else { // Diamond
                this.vipProgress = 100;
                return;
            }

            const progress = (wagers - currentLevelThreshold) / (nextLevelThreshold - currentLevelThreshold) * 100;
            this.vipProgress = Math.min(100, Math.max(0, progress)); // Ensure progress is between 0 and 100
        },

        // Placeholder function to fetch token stats (replace with actual API call)
        async fetchTokenStats(token) {
          try {
            console.log(`Fetching stats for ${token}...`);
            // Replace with actual backend API call
            // const res = await fetch(`${BASE_URL}/api/token/${token}`);
            // if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            // const data = await res.json();
            // return data; // Should return { price: N, volume: N, holders: N }

            // Simulate fake data for demo
            return {
                price: (Math.random() * 0.5 + 0.0001).toFixed(4),
                volume: (Math.random() * 100 + 1).toFixed(1) + 'M',
                holders: Math.floor(Math.random() * 50000 + 1000).toLocaleString()
            };
          } catch (e) {
            console.error('Failed to fetch token stats:', e);
            return {};
          }
        },

        // Placeholder Quick Bet function
        quickBet() {
            // This should fetch popular props from the backend
            const popularProps = ['wif-001', 'pop-002']; // Placeholder IDs

            // Clear current slip
            this.slip.picks.forEach(pick => {
                const buttonYes = document.querySelector(`.button-secondary[data-prop='${pick.propId}'][data-option='Yes']`);
                const buttonNo = document.querySelector(`.button-secondary[data-prop='${pick.propId}'][data-option='No']`);
                if (buttonYes) buttonYes.classList.remove('active');
                if (buttonNo) buttonNo.classList.remove('active');
            });
            this.slip.picks = [];

            // Add popular props to slip (assuming 'Yes' is the popular pick for demo)
            popularProps.forEach(propId => {
                const button = document.querySelector(`.button-secondary[data-prop='${propId}'][data-option='Yes']`);
                if (button) {
                     // Simulate adding to slip without triggering the full addToSlip logic to avoid nested calls
                     const card = document.querySelector(`.card[data-prop-id='${propId}']`); // Find the card
                     const tokenElement = card.querySelector('h3');
                     const token = tokenElement ? tokenElement.textContent.trim().split(' ')[0] : 'Unknown';
                     const descriptionElement = card.querySelector('p.text-sm');
                     const description = descriptionElement ? descriptionElement.textContent.trim() : 'No description';
                     this.slip.picks.push({ propId, token, description, choice: 'Yes' });
                     button.classList.add('active');
                }
            });

            this.updateOddsDisplay();
            showToast('Quick Bet slip created!', 'success');
            if (window.innerWidth < 768) {
                this.toggleSlipTray(); // Open slip tray on mobile
            }
        },

        // Placeholder function to update Top Picks display
        updateTopPicks() {
            // Fetch top picks from backend (placeholder)
            const topPicks = [
                '80% of users picked $WIF Yes!',
                'Most bets on $POPCAT this hour!',
                'Highest volume prop: $SLERF'
            ];
            this.topPick = topPicks[Math.floor(Math.random() * topPicks.length)];
            setTimeout(() => this.updateTopPicks(), 20000); // Update every 20 seconds
        },

        // Placeholder function to update Live Bet Feed
        updateBetFeed() {
          // Diversified bet actions
          const betActions = [
            `User${Math.floor(Math.random() * 1000)} bet ${(Math.random() * 10 + 0.1).toFixed(2)} SOL on $WIF!`, // Bet action
            `User${Math.floor(Math.random() * 1000)} won ${(Math.random() * 15 + 5).toFixed(2)} SOL on $POPCAT!`, // Win action
            `User${Math.floor(Math.random() * 1000)} lost big on $BONK!`, // Loss action
            `User${Math.floor(Math.random() * 1000)} almost won 10 SOL on $SLERF!` // Near-miss action
          ];
          this.liveBetFeed = betActions[Math.floor(Math.random() * betActions.length)];
          setTimeout(() => this.updateBetFeed(), 10000); // Update every 10 seconds
        },

        // Placeholder function to update Scarcity indicators
        updateScarcity() {
          // Update badge text for all props with limited spots
          Object.keys(this.spotsLeft).forEach(propId => {
              const badge = document.querySelector(`.card[data-prop-id="${propId}"] .badge-spots`);
              if (badge) {
                  badge.textContent = `${this.spotsLeft[propId]} Spots Left!`;
                  // Simulate spots decreasing randomly
                  if (this.spotsLeft[propId] > 1 && Math.random() < 0.5) {
                      this.spotsLeft[propId]--;
                  } else if (this.spotsLeft[propId] === 1 && Math.random() < 0.8) {
                       this.spotsLeft[propId]--; // Make the last spot disappear faster
                  }
                   if (this.spotsLeft[propId] <= 0) {
                       // Handle prop expiring/closing when spots run out (placeholder)
                       const card = document.querySelector(`.card[data-prop-id="${propId}"]`);
                       if (card) {
                           card.classList.add('lose-effect'); // Use a visual effect for removal
                           setTimeout(() => card.remove(), 1000); // Remove card after animation
                       }
                   }
              }
          });
          setTimeout(() => this.updateScarcity(), 10000); // Update every 10 seconds
        },

        // Placeholder function to check Leaderboard Rank and trigger Almost Top 10 effect
        checkLeaderboardRank() {
          // Simulate user's rank (using the placeholderRank data attribute)
           document.querySelectorAll('.leaderboard-user-row').forEach(userRow => {
               const rank = parseInt(userRow.dataset.simulatedRank, 10);
               if (!isNaN(rank) && rank >= 11 && rank <= 15) { // If rank is between 11 and 15
                 userRow.classList.add('almost-top-10'); // Add the CSS class
                 showToast(`Rank ${rank}! So close to Top 10!`, 'info');
                 triggerVibration('almostWon'); // Add vibration
               }
           });
        },

        // Placeholder function to save the daily wager limit
        saveWagerLimit() {
            if (typeof this.dailyWagerLimit !== 'number' || this.dailyWagerLimit < 0) {
                showToast('Invalid limit value.', 'error');
                return;
            }
            localStorage.setItem('dailyWagerLimit', this.dailyWagerLimit.toFixed(2));
            showToast(`Daily wager limit set to ${this.dailyWagerLimit.toFixed(2)} SOL.`, 'success');
            this.closeModal('limitModal'); // Close modal after saving
        },

        // Placeholder for Long Press detection (for Wheel of Multipliers)
        startLongPress(event) {
            // Prevent default touch behavior (like scrolling) on touchstart if needed
            // event.preventDefault();
            this.cancelLongPress(); // Clear any existing timer
            this.longPressTimer = setTimeout(() => {
                console.log('Long press detected!');
                this.triggerMultiplierWheel(); // Trigger the wheel animation
            }, this.longPressThreshold);
        },

        endLongPress(event) {
            clearTimeout(this.longPressTimer);
            this.longPressTimer = null;
             // If it was a quick tap, let the default click/tap event handle it
        },

        cancelLongPress() {
            clearTimeout(this.longPressTimer);
            this.longPressTimer = null;
        },

        // Placeholder for Trigger Multiplier Wheel animation
        triggerMultiplierWheel() {
            console.log('Triggering Multiplier Wheel animation (placeholder)');
            const slipTray = document.getElementById('slip-tray');
            if (slipTray) {
                // Simulate a spinning wheel effect on the slip tray or a dedicated element
                gsap.to(slipTray, {
                    rotation: 360, // Spin effect
                    duration: 1,
                    ease: "power2.out",
                    onComplete: () => {
                        gsap.set(slipTray, { rotation: 0 }); // Reset rotation
                        // Simulate revealing a multiplier or bonus
                        showToast(`Multiplier Boost! (+${(Math.random() * 0.5 + 0.1).toFixed(1)}x)`, 'info');
                        triggerVibration('win'); // Use win vibration for positive feedback
                    }
                });
            }
        },

        // Placeholder for Trigger Coin Flip animation
        triggerCoinFlip() {
            const coinFlipElement = document.getElementById('coin-flip');
            if (coinFlipElement) {
                coinFlipElement.classList.remove('hidden');
                gsap.fromTo(coinFlipElement,
                    { opacity: 0, scale: 0.5, rotationY: 0 },
                    { opacity: 1, scale: 1, rotationY: 720, duration: 0.8, ease: "power2.out" }
                );
                setTimeout(() => {
                    gsap.to(coinFlipElement, {
                        opacity: 0, scale: 0.5, duration: 0.4, ease: "power2.in",
                        onComplete: () => coinFlipElement.classList.add('hidden')
                    });
                }, 1500); // Show for 1.5 seconds
            }
        },

        // Placeholder for Auto-Scrolling Chat
        startChatAutoScroll() {
             const chatFeed = document.getElementById('global-chat-feed');
             if (chatFeed) {
                 // Check if chat content is taller than the feed height before scrolling
                 if (chatFeed.scrollHeight > chatFeed.clientHeight) {
                     chatFeed.classList.add('idle-scroll');
                 }
             }
        },

        stopChatAutoScroll() {
             const chatFeed = document.getElementById('global-chat-feed');
             if (chatFeed) {
                 chatFeed.classList.remove('idle-scroll');
                 // Reset scroll position to top when user interacts
                 chatFeed.scrollTop = 0;
             }
        }


      }));
    });


  </script>
</body>
</html>
