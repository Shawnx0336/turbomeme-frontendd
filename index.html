<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>DegenJack</title>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Basic Reset and Body Styles */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #111; /* Dark background */
            color: #eee;
            overflow: hidden; /* Prevent scrolling */
            display: flex;
            flex-direction: column;
            /* Use 100dvh for dynamic viewport height on mobile */
            height: 100dvh;
            min-height: 100vh; /* Fallback for browsers that don't support dvh */
            /* Ensure full coverage on mobile */
            width: 100%;
            box-sizing: border-box;

            /* Apply safe area insets */
            padding-top: env(safe-area-inset-top);
            /* padding-bottom will be handled by the fixed bottom bar */
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);

            overscroll-behavior-y: contain; /* Prevent pull-to-refresh */
            scroll-behavior: smooth; /* Smooth scrolling */

            /* Subtle animated background glow */
            background: radial-gradient(circle at center, #2e003e 0%, transparent 80%), /* Darker core purple */
                        radial-gradient(circle at top left, rgba(139, 92, 246, 0.15) 0%, transparent 50%), /* Purple glow */
                        radial-gradient(circle at top right, rgba(232, 121, 249, 0.15) 0%, transparent 50%), /* Pink glow */
                        radial-gradient(circle at bottom left, rgba(16, 185, 129, 0.15) 0%, transparent 50%), /* Green glow */
                        #0d001a; /* Deep dark background */
             background-size: 200% 200%; /* Larger than viewport for animation */
             animation: background-pan 30s linear infinite alternate; /* Slower panning animation */
        }

        @keyframes background-pan {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

         /* Optional: Subtle background flicker */
         /* animation: background-pan 30s linear infinite alternate, flicker 5s infinite; */

         /* @keyframes flicker {
             0%, 100% { opacity: 1; }
             50% { opacity: 0.98; }
         } */


        /* Utility classes for display toggling */
        .hidden { display: none !important; }
        .block { display: block !important; }
        .flex { display: flex !important; }
        .grid { display: grid !important; }


        /* Custom Scrollbar for Chat */
        .custom-scrollbar::-webkit-scrollbar {
            width: 0.375rem; /* Use rem */
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #333;
            border-radius: 0.1875rem; /* Use rem */
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 0.1875rem; /* Use rem */
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* Layout Zones */
        #top-bar {
            flex-shrink: 0; /* Prevent shrinking */
            background-color: rgba(10, 10, 10, 0.9); /* Slightly darker, semi-transparent */
            backdrop-filter: blur(5px); /* Frosted glass effect */
            padding: 1rem 1rem; /* Use rem for padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #222;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            border-bottom-left-radius: 0.5rem; /* Use rem for border-radius */
            border-bottom-right-radius: 0.5rem;
            width: 100%; /* Ensure full width */
            box-sizing: border-box;
            position: relative; /* Needed for absolute positioning of dropdown */
            z-index: 100; /* Ensure it's above other content */
             /* Ensure content is within safe areas */
            padding-left: calc(1rem + env(safe-area-inset-left));
            padding-right: calc(1rem + env(safe-area-inset-right));
        }

        #game-table {
            flex-grow: 1; /* Take available space */
            background-color: rgba(26, 26, 26, 0.8); /* Middle dark, semi-transparent */
            backdrop-filter: blur(3px); /* Subtle blur */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem; /* Use rem for padding */
            width: 100%; /* Ensure full width */
            box-sizing: border-box;
            overflow: hidden; /* Prevent game table content from causing scroll */
            position: relative; /* Needed for absolute positioning of near-miss, next-hand */
            /* Add padding at the bottom to prevent game table content from being hidden by the fixed bottom bar */
            padding-bottom: calc(8rem + env(safe-area-inset-bottom)); /* Adjust 8rem based on bottom bar height */

            /* Game Table Texture */
            background-image: url('/assets/textures/green-felt.png'), radial-gradient(circle, rgba(255, 255, 255, 0.1), transparent); /* Felt texture + spotlight */
            background-size: cover, 100% 100%;
            background-position: center, center;
            background-blend-mode: overlay; /* Blend gradient over texture */
        }

        #bottom-bar {
            flex-shrink: 0; /* Prevent shrinking */
            background-color: rgba(10, 10, 10, 0.9); /* Slightly darker, semi-transparent */
            backdrop-filter: blur(5px); /* Frosted glass effect */
            padding: 1rem; /* Use rem for padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 2px solid #222;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.3);
            border-top-left-radius: 0.5rem; /* Use rem for border-radius */
            border-top-right-radius: 0.5rem;
            width: 100%; /* Ensure full width */
            box-sizing: border-box;
            position: fixed; /* Make it sticky at the bottom */
            bottom: env(safe-area-inset-bottom); /* Position above safe area */
            left: 0;
            z-index: 90; /* Ensure it's above game table but below top bar */
            /* Ensure content is within safe areas */
            padding-left: calc(1rem + env(safe-area-inset-left));
            padding-right: calc(1rem + env(safe-area-inset-right));
        }

        /* Top Bar Styles */
        .top-bar-section { /* Use a class for flex items in top bar */
            display: flex;
            align-items: center;
            /* Allow sections to shrink/grow */
            flex-shrink: 1;
            flex-grow: 1; /* Allow sections to grow */
            /* Add some spacing between sections */
            margin: 0 0.5rem; /* Use rem for margin */
        }

         .top-bar-section:first-child { margin-left: 0; }
         .top-bar-section:last-child { margin-right: 0; justify-content: flex-end; }
         .top-bar-section:nth-child(2) { justify-content: center; } /* Center the XP section */


        .wallet-info span {
            margin-right: 0.5rem; /* Use rem for margin */
            white-space: nowrap; /* Prevent wrapping */
            font-size: 0.875rem; /* Use rem for font size */
        }

         #wallet-icon {
             font-size: 1.2rem; /* Use rem */
             margin-right: 0.25rem; /* Use rem */
         }

        .xp-progress {
             flex-grow: 1; /* Allow XP progress to take available space */
             justify-content: center; /* Center content within its section */
        }

        .xp-bar-container {
            width: 10rem; /* Use rem for width */
            max-width: 100%; /* Ensure it doesn't exceed container width */
            height: 0.5rem; /* Use rem for height */
            background-color: #333;
            border-radius: 0.25rem; /* Use rem for border-radius */
            overflow: hidden;
            margin: 0 0.5rem; /* Use rem for margin */
        }

        .xp-bar-fill {
            height: 100%;
            width: 0%; /* Initial width */
            background: linear-gradient(90deg, #8b5cf6, #e879f9); /* Purple gradient */
            transition: width 0.5s ease-in-out;
        }

        .recent-plays-ticker {
            width: 12rem; /* Use rem for width */
            max-width: 100%; /* Ensure it doesn't exceed container width */
            overflow: hidden;
            white-space: nowrap;
            font-style: italic;
            color: #aaa;
            font-size: 0.75rem; /* Use rem for font size */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
        }

        .recent-play-item {
            margin-right: 0.75rem; /* Use rem for margin */
            display: inline-block;
        }

        .win { color: #10b981; /* Green */ }
        .loss { color: #ef4444; /* Red */ }

        .menu-icon {
            width: 1.5rem; /* Use rem for width */
            height: 1.5rem; /* Use rem for height */
            cursor: pointer;
            fill: #eee;
            min-width: 2.75rem; /* Touch target (44px) */
            min-height: 2.75rem; /* Touch target (44px) */
            padding: 0.5rem; /* Add padding for easier tapping */
            box-sizing: border-box;
        }

        /* Game Table Styles */
        .dealer-hand, .player-hand {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem; /* Use rem for margin */
            flex-wrap: wrap; /* Allow cards to wrap on smaller screens */
        }

        .card {
            width: 3.75rem; /* Use rem for width (60px) */
            height: 5.625rem; /* Use rem for height (90px) */
            background-color: #fff;
            border-radius: 0.375rem; /* Use rem for border-radius (6px) */
            margin: 0 0.25rem; /* Use rem for margin (5px) */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem; /* Use rem for font size */
            font-weight: bold;
            color: #333;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
             /* Promote to hardware layer for smoother animation */
            will-change: transform;
             /* Entry animation */
             animation: fade-in 0.3s ease-in-out;

             /* Card Design Enhancements */
             background-size: cover;
             background-position: center;
             color: transparent; /* Hide text content when using background images */
             border: 1px solid #d4af37; /* Gold border */
             box-shadow: 3px 3px 5px rgba(0, 0, 0, 0.4), inset -1px -1px 2px rgba(0, 0, 0, 0.2); /* Layered shadow */
             /* Add subtle linen texture overlay if desired */
             /* background-image: url('/assets/textures/linen.png'), var(--card-image); */
             /* background-size: cover, cover; */
             /* background-blend-mode: overlay; */
        }

        .card-back {
            background-color: #1d3557; /* Deep navy blue back */
            color: transparent; /* Hide text on back */
             /* Gold filigree pattern */
             background-image: url('/assets/textures/filigree-gold.png'); /* Placeholder */
             background-size: cover;
             background-position: center;
             /* Subtle embossed logo */
             /* background-image: url('/assets/logo/degenjack-back.png'), url('/assets/textures/filigree-gold.png'); */
             /* background-size: 50%, cover; */
             /* background-position: center, center; */
             /* background-repeat: no-repeat, no-repeat; */
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

         /* Card Deal Animation */
         @keyframes slide-in {
             0% { transform: translateY(-6.25rem) rotate(10deg); opacity: 0; } /* Use rem */
             100% { transform: translateY(0) rotate(0deg); opacity: 1; }
         }

         .card.deal-animation {
             animation: slide-in 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* Cubic bezier for bounce */
         }

         /* Card Hover Effect */
         .card:hover:not(.card-back) {
             transform: translateY(-0.3125rem); /* Lift slightly */
             box-shadow: 0 0 0.625rem #ffd700; /* Gold glow */
         }


        .player-seats {
            display: grid; /* Use grid for player seats */
            grid-template-columns: repeat(auto-fit, minmax(8rem, 1fr)); /* Fluid columns, min width 8rem */
            gap: 0.5rem; /* Use rem for gap */
            justify-content: center;
            width: 100%;
            margin-bottom: 1rem; /* Add margin below seats */
        }

        .player-seat {
            height: 3rem; /* Compressed height (48px) */
            max-width: 100%; /* Ensure it doesn't overflow */
            margin: 0; /* Remove individual seat margin, use grid gap */
            padding: 0.5rem; /* Use rem for padding */
            background-color: #2a2a2a;
            border-radius: 0.5rem; /* Use rem for border-radius */
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 2px solid transparent;
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            box-sizing: border-box; /* Include padding and border in element's total width and height */
            font-size: 0.875rem; /* Use rem for font size */
             overflow: hidden; /* Prevent content overflow */
             overflow-wrap: anywhere; /* Allow breaking long words */
             /* Entry animation */
             animation: fade-in 0.3s ease-in-out;

             /* Seat Design Enhancements */
             background-image: url('/assets/textures/velvet-purple.png'); /* Velvet texture */
             background-size: cover;
             border: 2px solid #d4af37; /* Gold trim */
             box-shadow: inset 0 0 0.3125rem #a78bfa; /* Inner glow */
        }

        @keyframes fade-in {
           from { opacity: 0; transform: scale(0.95); }
           to { opacity: 1; transform: scale(1); }
        }


        .player-seat.active {
            border-color: #ffd700; /* Pulsating gold glow */
            box-shadow: 0 0 0.9375rem #ffd700; /* Use rem */
            animation: glow 1.5s infinite ease-in-out; /* Pulsating glow animation */
             /* Subtle spotlight effect above active seat */
             background: radial-gradient(circle at top center, rgba(255, 215, 0, 0.2), transparent), url('/assets/textures/velvet-purple.png');
             background-size: 100% 100%, cover;
             background-position: center, center;
             background-blend-mode: overlay;
        }

         @keyframes glow {
             0%, 100% { box-shadow: 0 0 0.9375rem #ffd700; }
             50% { box-shadow: 0 0 1.25rem #ffd700; }
         }


        .player-info {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem; /* Use rem for margin */
        }

        .avatar {
            width: 2rem; /* Use rem */
            height: 2rem; /* Use rem */
            background-color: #5b21b6; /* Violet */
            border-radius: 50%;
            margin-right: 0.25rem; /* Use rem */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem; /* Use rem */
             /* Avatar pop-in animation */
             animation: pop-in 0.3s ease-out;
             position: relative; /* For badge overlay */
        }

         @keyframes pop-in {
             0% { transform: scale(0); }
             80% { transform: scale(1.1); }
             100% { transform: scale(1); }
         }

         /* VIP Badge Overlay */
         .avatar.vip::after {
             content: '';
             position: absolute;
             top: -0.25rem; /* Use rem */
             right: -0.25rem; /* Use rem */
             width: 1rem; /* Use rem */
             height: 1rem; /* Use rem */
             background-image: url('/assets/ui/vip-crown.png'); /* Placeholder VIP crown */
             background-size: cover;
             animation: sparkle 1.5s infinite ease-in-out; /* Subtle sparkle animation */
         }

         @keyframes sparkle {
             0%, 100% { opacity: 1; }
             50% { opacity: 0.5; }
         }


        .username {
            font-size: 0.875rem; /* Use rem */
            font-weight: bold;
            color: #fff;
            white-space: nowrap; /* Prevent wrapping */
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .xp-badge {
            background-color: #facc15; /* Yellow */
            color: #333;
            font-size: 0.7rem; /* Use rem */
            padding: 0.125rem 0.375rem; /* Use rem */
            border-radius: 0.625rem; /* Use rem */
            margin-left: 0.25rem; /* Use rem */
            white-space: nowrap; /* Prevent wrapping */
        }

         /* Hide player hand in compressed view initially */
         .player-seat .player-hand {
             display: none;
         }


        .action-buttons {
            margin-top: 0.5rem; /* Use rem */
            display: flex; /* Use flex for button layout */
            justify-content: center;
            width: 100%; /* Ensure buttons take full width of seat */
        }

        .action-buttons button {
            padding: 0.75rem 1.25rem; /* Increased padding for touch (12px 20px) */
            border: none;
            border-radius: 0.3125rem; /* Use rem (5px) */
            cursor: pointer;
            font-size: 1rem; /* Increased font size */
            font-weight: bold;
            transition: background-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            min-width: 3rem; /* Ensure touch target size (48px) */
            min-height: 3rem; /* Ensure touch target size (48px) */
            flex-grow: 1; /* Allow buttons to grow */
            margin: 0 0.25rem; /* Add spacing between buttons (4px) */
             /* Remove 300ms click delay */
            touch-action: manipulation;
             /* Optional: Disable tap highlight */
            -webkit-tap-highlight-color: transparent;

            /* Button Pulse Animation (Idle Feedback) */
            /* Applied via JS class .pulse-button */
        }

         @keyframes pulse {
             0%, 100% { box-shadow: 0 0 0 0 rgba(0,255,150,0.4); } /* Green glow */
             50% { box-shadow: 0 0 0 0.625rem rgba(0,255,150,0); } /* Use rem */
         }

         .pulse-button {
             animation: pulse 2s infinite;
         }

         /* Remove pulse animation when disabled or not active player's turn */
         .action-buttons button:disabled,
         .player-seat:not(.active) .action-buttons button {
             animation: none;
             box-shadow: none;
         }

         /* Button Active State */
         button:active {
             transform: scale(0.96);
             filter: brightness(1.1);
         }


        .turn-timer-bar {
            width: 100%;
            height: 0.1875rem; /* Use rem (3px) */
            background-color: #333;
            margin-top: 0.3125rem; /* Use rem (5px) */
            border-radius: 0.125rem; /* Use rem (2px) */
            overflow: hidden;
        }

        .turn-timer-fill {
            height: 100%;
            width: 100%; /* Initial width */
            background-color: #3b82f6; /* Blue */
            transition: width linear; /* Transition handled by JS */
        }

        /* Hot Streak Placeholder */
        .hot-streak-bar {
            width: 80%;
            height: 0.3125rem; /* Use rem (5px) */
            background-color: #333;
            border-radius: 0.15625rem; /* Use rem */
            margin-top: 0.3125rem; /* Use rem */
            overflow: hidden;
        }

        .hot-streak-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #facc15, #ef4444); /* Yellow to Red */
            transition: width 0.3s ease-in-out;
        }

        /* Near Miss Placeholder */
        .near-miss-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 0, 0.8); /* Yellowish semi-transparent */
            color: #333;
            padding: 0.625rem 1.25rem; /* Use rem */
            border-radius: 0.3125rem; /* Use rem */
            font-weight: bold;
            z-index: 15;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none; /* Don't block clicks */
             /* Near miss background gradient */
             background: linear-gradient(45deg, #e63946, #facc15); /* Red to Yellow */
             color: #0a0a0a;
        }

        .near-miss-popup.show {
            opacity: 1;
        }

        /* Dealer Anchor */
        .dealer-anchor {
            background: radial-gradient(circle at center, #2e2e2e, transparent);
            border-radius: 0.75rem; /* Use rem */
            padding: 0.5rem; /* Use rem */
            margin-bottom: 0.75rem; /* Use rem */
            display: flex;
            flex-direction: column;
            align-items: center;
             /* Optional: Dealer glow animation */
             /* animation: dealer-glow 3s infinite ease-in-out; */
        }

        /* Dealer Glow Animation Placeholder */
        @keyframes dealer-glow {
             0%, 100% { box-shadow: 0 0 5px rgba(167, 139, 250, 0.3); } /* Subtle purple glow */
             50% { box-shadow: 0 0 15px rgba(167, 139, 250, 0.6); }
        }

        .dealer-anchor.glowing {
            animation: dealer-glow 3s infinite ease-in-out;
        }


        /* Bottom Bar Styles */
        .bottom-bar-section { /* Use a class for flex items in bottom bar */
            display: flex;
            align-items: center;
            /* Allow sections to shrink/grow */
            flex-shrink: 1;
            flex-grow: 1; /* Allow both sections to grow */
            /* Add some spacing between sections */
            margin: 0 0.5rem; /* Use rem */
        }

         .bottom-bar-section:first-child { margin-left: 0; justify-content: flex-start; }
         .bottom-bar-section:last-child { margin-right: 0; justify-content: flex-end; }


        .betting-controls {
            display: flex;
            align-items: center;
            flex-wrap: wrap; /* Allow controls to wrap */
            justify-content: center; /* Center controls */
            flex-grow: 1; /* Allow betting controls to grow */
        }

        .betting-controls > span {
            white-space: nowrap; /* Prevent wrapping */
            margin-right: 0.5rem; /* Use rem */
            font-size: 1rem; /* Use rem */
        }

        .betting-controls input[type="range"] {
            width: 9.375rem; /* Use rem (150px) */
            max-width: 100%; /* Ensure it doesn't exceed container */
            margin: 0 0.5rem; /* Use rem */
            accent-color: #10b981; /* Green accent */
             min-height: 3rem; /* Ensure touch target (48px) */
             box-sizing: border-box;
        }

        .quick-bet-buttons {
            display: flex;
            align-items: center;
            margin-left: 0.5rem; /* Use rem */
        }

        .quick-bet-buttons button {
            padding: 0.625rem 0.9375rem; /* Increased padding (10px 15px) */
            border: none;
            border-radius: 0.25rem; /* Use rem (4px) */
            background-color: #333;
            color: #eee;
            cursor: pointer;
            font-size: 0.9rem; /* Use rem */
            margin-right: 0.5rem; /* Increased margin (8px) */
            transition: background-color 0.3s ease-in-out;
            min-width: 3rem; /* Ensure touch target size (48px) */
            min-height: 3rem; /* Ensure touch target size (48px) */
             /* Remove 300ms click delay */
            touch-action: manipulation;
             /* Optional: Disable tap highlight */
            -webkit-tap-highlight-color: transparent;
        }

        .quick-bet-buttons button:last-child {
            margin-right: 0;
        }

        .quick-bet-buttons button:hover {
            background-color: #555;
        }

         /* Chip Button Styles */
         .chip-button {
             background-size: cover;
             background-position: center;
             color: transparent; /* Hide text if using image background */
             font-size: 0; /* Hide text if using image background */
             position: relative; /* For pseudo-elements or overlays */
         }

         .green-chip { background-image: url('/assets/ui/green-chip.png'); } /* Placeholder */
         .purple-chip { background-image: url('/assets/ui/purple-chip.png'); } /* Placeholder */
         .max-chip {
             background-image: url('/assets/ui/max-chip.png'); /* Placeholder */
             color: #fff; /* Show text for MAX button */
             font-size: 0.9rem; /* Use rem */
             text-align: center;
         }


        .join-leave-button {
             padding: 0.75rem 1.5625rem; /* Increased padding (12px 25px) */
             border: none;
             border-radius: 0.5rem; /* Use rem (8px) */
             cursor: pointer;
             font-size: 1rem; /* Increased font size */
             font-weight: bold;
             transition: background-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
             margin-left: 1.25rem; /* Use rem (20px) */
             min-width: 3rem; /* Ensure touch target size (48px) */
             min-height: 3rem; /* Ensure touch target size (48px) */
              /* Remove 300ms click delay */
            touch-action: manipulation;
             /* Optional: Disable tap highlight */
            -webkit-tap-highlight-color: transparent;
         }

         .join-button {
            background-color: #10b981; /* Green */
            color: #0a0a0a;
         }

         .join-button:hover {
            background-color: #059669;
            box-shadow: 0 0 0.5rem #10b981; /* Use rem */
         }

         .leave-button {
            background-color: #ef4444; /* Red */
            color: #0a0a0a;
         }

         .leave-button:hover {
            background-color: #d92d2d;
            box-shadow: 0 0 0.5rem #ef4444; /* Use rem */
         }

        .chat-container {
            width: 18.75rem; /* Default width (300px) */
            max-width: 100%; /* Ensure it doesn't overflow */
            height: 7.5rem; /* Default height (120px) */
            background-color: rgba(26, 26, 26, 0.8); /* Semi-transparent */
            backdrop-filter: blur(3px); /* Subtle blur */
            border-radius: 0.5rem; /* Use rem */
            padding: 0.625rem; /* Use rem */
            display: flex;
            flex-direction: column;
            box-shadow: inset 0 0 0.3125rem rgba(0, 0, 0, 0.5); /* Use rem */
            box-sizing: border-box;
             flex-grow: 1; /* Allow chat to grow */
             margin-left: 1rem; /* Add margin to separate from betting controls */
        }

        .chat-feed {
            flex-grow: 1;
            overflow-y: auto;
            font-size: 0.875rem; /* Use rem */
            color: #bbb;
            margin-bottom: 0.3125rem; /* Use rem */
            padding-right: 0.3125rem; /* Add padding to prevent scrollbar overlaying text */
             overflow-wrap: anywhere; /* Allow breaking long words */
        }

        .chat-message {
            margin-bottom: 0.1875rem; /* Use rem */
            word-break: break-word; /* Break long words */
        }

         /* New Message Flash Animation */
         @keyframes flash-bg {
             0% { background-color: #333; }
             50% { background-color: transparent; }
             100% { background-color: #333; }
         }

         .chat-message.flash {
             animation: flash-bg 1s ease-in-out;
         }


        .chat-sender {
            font-weight: bold;
            color: #60a5fa; /* Blue */
            margin-right: 0.3125rem; /* Use rem */
        }

         .chat-badge {
             color: #facc15; /* Yellow */
             margin-right: 0.3125rem; /* Use rem */
         }

        .chat-input-area {
            display: flex;
            align-items: center;
            margin-top: 0.3125rem; /* Use rem */
        }

        .chat-input-area input[type="text"] {
            flex-grow: 1;
            padding: 0.625rem; /* Increased padding (10px) */
            border: none;
            border-radius: 0.25rem 0 0 0.25rem; /* Use rem */
            background-color: #333;
            color: #eee;
            font-size: 1rem; /* Increased font size */
            outline: none;
             min-height: 3rem; /* Ensure touch target size (48px) */
             box-sizing: border-box;
        }

        .chat-input-area button {
            padding: 0.625rem 0.9375rem; /* Increased padding (10px 15px) */
            border: none;
            border-radius: 0 0.25rem 0.25rem 0; /* Use rem */
            background-color: #3b82f6; /* Blue */
            color: #fff;
            cursor: pointer;
            font-size: 1rem; /* Increased font size */
            transition: background-color 0.3s ease-in-out;
            min-width: 3rem; /* Ensure touch target size (48px) */
            min-height: 3rem; /* Ensure touch target size (48px) */
             /* Remove 300ms click delay */
            touch-action: manipulation;
             /* Optional: Disable tap highlight */
            -webkit-tap-highlight-color: transparent;
        }

        .chat-input-area button:hover {
            background-color: #2563eb;
        }

        /* Crate Animation Placeholder */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-0.625rem); /* Use rem */
            }
            60% {
                transform: translateY(-0.3125rem); /* Use rem */
            }
        }

        .crate-icon {
            width: 1.875rem; /* Use rem */
            height: 1.875rem; /* Use rem */
            fill: #facc15; /* Yellow */
            cursor: pointer;
            animation: bounce 1s infinite;
            margin-left: 0.625rem; /* Use rem */
             min-width: 2.75rem; /* Touch target (44px) */
             min-height: 2.75rem; /* Touch target (44px) */
             padding: 0.5rem; /* Add padding for easier tapping */
             box-sizing: border-box;
        }

        /* Placeholder for Confetti Canvas */
        #confetti-canvas {
            position: fixed; /* Use fixed for full viewport coverage */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allow clicks through */
            z-index: 10; /* Above game elements */
        }

        /* Hot Table Banner Placeholder */
        #hot-table-banner {
            position: fixed;
            top: calc(3.75rem + env(safe-area-inset-top)); /* Position below top bar (60px), accounting for safe area */
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(90deg, #ff6bec, #a78bfa); /* Neon pink to purple gradient */
            color: #0a0a0a;
            padding: 0.3125rem 0.9375rem; /* Use rem */
            border-radius: 0.3125rem; /* Use rem */
            font-weight: bold;
            z-index: 15;
            display: none; /* Hidden by default */
            box-shadow: 0 0 0.625rem #ff6bec; /* Use rem */
             /* Blinking border animation */
             border: 2px solid #ffd700; /* Gold border */
             animation: blink 1s infinite;
             text-shadow: 0 0 0.3125rem #ff6bec, 0 0 0.625rem #ff6bec; /* Neon text glow */
        }

         @keyframes blink {
             0%, 100% { border-color: #ffd700; }
             50% { border-color: transparent; }
         }


         /* Next Hand Button Placeholder */
         #next-hand-button {
             position: absolute;
             bottom: calc(9.375rem + env(safe-area-inset-bottom)); /* Position above bottom bar (150px), accounting for safe area */
             left: 50%;
             transform: translateX(-50%);
             padding: 0.75rem 1.5625rem; /* Use rem */
             border: none;
             border-radius: 0.5rem; /* Use rem */
             background-color: #10b981; /* Green */
             color: #0a0a0a;
             font-size: 1.1rem; /* Use rem */
             font-weight: bold;
             cursor: pointer;
             z-index: 15;
             display: none; /* Hidden by default */
             box-shadow: 0 0 0.9375rem #10b981; /* Use rem */
             transition: background-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
             min-width: 3rem; /* Ensure touch target size (48px) */
             min-height: 3rem; /* Ensure touch target size (48px) */
              /* Remove 300ms click delay */
            touch-action: manipulation;
             /* Optional: Disable tap highlight */
            -webkit-tap-highlight-color: transparent;
         }

         #next-hand-button:hover {
            background-color: #059669;
            box-shadow: 0 0 1.25rem #059669; /* Use rem */
         }

         /* Coin Shower Animation Placeholder */
         .coin {
             position: fixed;
             width: 1.25rem; /* Use rem */
             height: 1.25rem; /* Use rem */
             background-color: gold; /* Gold coin color */
             border-radius: 50%;
             z-index: 20; /* Above everything */
             animation: coin-fall 2s ease-in forwards;
             opacity: 0.8;
              /* Optional: Add coin sprite */
             /* background-image: url('/assets/ui/coin-sprite.png'); */
             /* background-size: cover; */
             /* background-color: transparent; */
             /* Add rotation with shadows */
             /* box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5); */
         }

         @keyframes coin-fall {
             0% { transform: translateY(-100vh) translateX(0) rotate(0deg); opacity: 0.5; }
             100% { transform: translateY(100vh) translateX(var(--end-x, 0)) rotate(var(--end-rotate, 360deg)); opacity: 0; }
         }

         /* Optional: Coin bounce animation */
         /* @keyframes bounce {
             0%, 100% { transform: translateY(0); }
             50% { transform: translateY(-0.5rem); }
         } */


         /* Ticker Strip Animation Placeholder */
         @keyframes slide-left {
             0% { transform: translateX(100%); }
             100% { transform: translateX(-100%); }
         }

         .ticker {
             overflow: hidden;
             white-space: nowrap;
             box-sizing: border-box;
             width: 100%;
             background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
             padding: 0.25rem 0; /* Use rem */
             font-size: 0.8rem; /* Use rem */
             color: #10b981; /* Green neon */
             margin-top: 0.5rem; /* Use rem */
         }

         .ticker span {
             display: inline-block;
             padding-left: 100%;
             animation: slide-left 15s linear infinite; /* Adjust duration as needed */
         }

         /* Phase 2 - Profile/Lounge Section Placeholders */
         #profile-lounge-section {
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background-color: rgba(0, 0, 0, 0.9); /* Semi-transparent dark background */
             z-index: 200; /* Above everything */
             display: none; /* Hidden by default */
             flex-direction: column;
             align-items: center;
             justify-content: center;
             padding-top: env(safe-area-inset-top);
             padding-bottom: env(safe-area-inset-bottom);
             box-sizing: border-box;
         }

         #profile-lounge-content {
             background-color: #1a1a1a;
             border-radius: 1rem;
             padding: 1.5rem;
             max-width: 90%;
             max-height: 90%;
             overflow-y: auto;
             box-sizing: border-box;
         }

         #profile-lounge-close {
             position: absolute;
             top: calc(1rem + env(safe-area-inset-top));
             right: calc(1rem + env(safe-area-inset-right));
             font-size: 2rem;
             color: #eee;
             cursor: pointer;
         }


        /* REMOVE Mobile Specific Styles */
        /* @media (max-width: 768px) {
            body {
                font-size: 16px;
            }
            #top-bar { flex-direction: column; align-items: flex-start; padding: 10px; height: auto; }
            .top-bar-section { width: 100%; justify-content: space-between; margin: 5px 0; }
            .wallet-info span { margin-right: 5px; }
            .xp-bar-container { flex-grow: 1; margin: 0 8px; }
            .recent-plays-ticker { width: 120px; font-size: 0.7em; }
            #game-table { padding: 10px; justify-content: flex-start; }
            .dealer-hand { margin-bottom: 10px; }
            .card { width: 45px; height: 67.5px; margin: 0 3px; font-size: 1em; }
            .player-seats { flex-direction: column; align-items: center; }
            .player-seat { width: 95%; margin: 5px 0; padding: 8px; }
            .player-info { width: 100%; justify-content: center; margin-bottom: 8px; }
            .action-buttons { margin-top: 8px; }
            .action-buttons button { padding: 10px 20px; font-size: 1em; }
            #bottom-bar { flex-direction: column; align-items: center; height: auto; padding: 10px; }
            .bottom-bar-section { width: 100%; margin: 5px 0; justify-content: center; }
            .betting-controls { width: 100%; flex-direction: column; align-items: center; margin-bottom: 10px; }
            .betting-controls > span, .betting-controls input[type="range"], .quick-bet-buttons { margin-bottom: 8px; }
            .betting-controls input[type="range"] { width: 80%; margin: 8px 0; }
            .quick-bet-buttons { width: 100%; justify-content: center; }
            .quick-bet-buttons button { flex-grow: 1; margin: 0 4px; padding: 10px 5px; }
            .join-leave-button { margin-left: 0; width: 100%; padding: 12px 20px; }
            .chat-container { width: 100%; height: 200px; position: fixed; bottom: 0; left: 0; border-radius: 8px 8px 0 0; transform: translateY(100%); transition: transform 0.3s ease-in-out; z-index: 20; box-sizing: border-box; padding-bottom: 50px; padding-bottom: calc(50px + env(safe-area-inset-bottom)); }
            .chat-container.active { transform: translateY(0); height: 50vh; }
            .chat-feed { height: calc(100% - 40px); margin-bottom: 0; }
            .chat-input-area { position: absolute; bottom: env(safe-area-inset-bottom); left: 0; width: 100%; padding: 5px; background-color: #1a1a1a; box-sizing: border-box; }
            .chat-input-area input[type="text"] { font-size: 1em; min-height: 44px; }
            .chat-input-area button { min-height: 44px; }
            #toggle-chat { display: block; padding: 8px 15px; border: none; border-radius: 5px; background-color: #3b82f6; color: #fff; font-weight: bold; cursor: pointer; margin-top: 10px; min-width: 48px; min-height: 48px; }
            .player-seat .player-hand { justify-content: center; }
            .player-seat:not(.is-user) .player-hand { }
            #toggle-other-hands { display: block; margin-top: 10px; padding: 8px 15px; border: none; border-radius: 5px; background-color: #555; color: #eee; cursor: pointer; min-width: 48px; min-height: 48px; }
        } */

        /* Hide toggle button on desktop */
        #toggle-chat, #toggle-other-hands {
            display: none;
        }

        /* Ensure elements are within safe areas even if not fixed */
        /* This is handled by padding on body and fixed elements */
        /* .wallet-info, .xp-progress, .recent-plays,
        .betting-controls, .chat-container {
            padding-left: env(safe-area-inset-left, 0);
            padding-right: env(safe-area-inset-right, 0);
        } */


    </style>
</head>
<body>

    <div id="top-bar">
        <div class="top-bar-section wallet-info">
            <span id="wallet-icon">üë§</span> <span id="wallet-address">Not Connected</span>
            <span id="wallet-balance">-- SOL</span>
            <button id="connect-wallet-button">Connect Wallet</button>
            <button id="disconnect-wallet-button" class="hidden">Disconnect</button>
             <a id="phantom-deeplink" href="#" class="hidden" style="color: #a78bfa; font-size: 0.8em; margin-left: 10px;">Open in Phantom App</a>
             <span id="wallet-guidance" class="hidden" style="color: #facc15; font-size: 0.8em; margin-left: 10px;"></span>
        </div>
        <div class="top-bar-section xp-progress">
            <span id="user-level">Level 1</span>
            <div class="xp-bar-container">
                <div id="xp-bar-fill" class="xp-bar-fill"></div>
            </div>
            <span id="user-xp">0/100 XP</span>
            <svg id="crate-icon" class="crate-icon hidden" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M7.293 2.293a1 1 0 011.414 0L10 3.586l1.293-1.293a1 1 0 111.414 1.414L11.414 5l1.293 1.293a1 1 0 11-1.414 1.414L10 6.414l-1.293 1.293a1 1 0 01-1.414-1.414L8.586 5l-1.293-1.293a1 1 0 010-1.414zM10 14a1 1 0 100-2 1 1 0 000 2zm0 4a1 1 0 100-2 1 1 0 000 2zM5 10a1 1 0 11-2 0 1 1 0 012 0zm10 0a1 1 0 11-2 0 1 1 0 012 0z" clip-rule="evenodd"></path>
            </svg>
        </div>
        <div class="top-bar-section recent-plays">
            <div id="recent-plays-ticker" class="ticker">
                <span>No recent plays...</span>
            </div>
             <div id="leaderboard" style="font-size: 0.8em; margin-left: 10px;">
                 </div>
             <span id="referral-count" style="color: #facc15; font-size: 0.8em; margin-left: 10px;">üë• 0 referrals</span>

            <svg class="menu-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
            <div id="settings-dropdown" class="hidden" style="position: absolute; top: 50px; right: 20px; background-color: #333; border-radius: 5px; padding: 10px; z-index: 20;">
                <div style="margin-bottom: 10px;">
                    <span>Game Mode:</span>
                    <button id="free-mode-toggle" style="background: #555; color: #eee; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">üîÅ SOL Mode</button>
                </div>
                <div style="display: flex; flex-direction: column;">
                    <button id="profile-tab-button" style="background: none; border: none; color: #eee; text-align: left; padding: 5px; cursor: pointer;">üë§ Profile</button>
                    <button id="lounge-tab-button" style="background: none; border: none; color: #eee; text-align: left; padding: 5px; cursor: pointer;">üõãÔ∏è Lounge</button>
                </div>
            </div>
        </div>
    </div>

    <div id="game-table">
        <div class="dealer-anchor">
            <h3>Dealer <span id="dealer-emoji">üÉè</span></h3> <div id="dealer-cards" class="player-hand">
                </div>
        </div>
        <div id="player-seats" class="player-seats">
            </div>
         <div id="hot-table-banner" class="hidden">Hot Table!</div>
         <div id="near-miss-popup" class="near-miss-popup">Almost!</div>
         <div id="hot-streak-bar" class="hot-streak-bar hidden">
             <div class="hot-streak-fill"></div>
         </div>

         <button id="toggle-other-hands" class="hidden">Show/Hide Other Hands</button>

    </div>

    <div id="bottom-bar">
        <div class="bottom-bar-section betting-controls">
            <span id="current-bet-display">Bet: 0.00 SOL</span>
            <input type="range" id="bet-slider" min="0" max="10" step="0.01" value="0">
            <div class="quick-bet-buttons">
                <button data-bet-amount="0.01" class="chip-button green-chip">+0.01</button>
                <button data-bet-amount="0.1" class="chip-button purple-chip">+0.1</button>
                <button data-bet-amount="MAX" class="chip-button max-chip">üî•MAX Bet</button>
            </div>
            <button id="join-leave-button" class="join-leave-button join-button">Join Table</button>
             <span id="spectator-status" class="hidden" style="color: #facc15; font-size: 0.9em; margin-left: 10px;">You are a spectator.</span>
             <button id="refer-friends-button" style="margin-left: 10px; padding: 8px 15px; border: none; border-radius: 5px; background-color: #5b21b6; color: #fff; font-weight: bold; cursor: pointer; min-width: 48px; min-height: 48px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;">üéÅ Invite & Earn 0.05 SOL</button> </div>
        <div class="bottom-bar-section chat-container">
            <div id="chat-feed" class="chat-feed custom-scrollbar">
                </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Type message...">
                <button id="send-chat-button">Send</button>
            </div>
        </div>
         <button id="toggle-chat" class="hidden">Chat</button>
         <button id="next-hand-button" class="hidden">Next Hand?</button>
    </div>

    <canvas id="confetti-canvas"></canvas>
    <canvas id="background-particles" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0;"></canvas> <div id="profile-lounge-section" class="hidden">
        <div id="profile-lounge-content">
            <span id="profile-lounge-close">&times;</span>
            <h2>Profile / Lounge</h2>
            <div id="profile-content">
                <h3>üë§ Your Profile</h3>
                <p>Avatar: <span id="profile-avatar">üòä</span></p>
                <p>Level: <span id="profile-level">1</span></p>
                <div class="xp-bar-container" style="width: 100%;">
                    <div id="profile-xp-bar-fill" class="xp-bar-fill"></div>
                </div>
                <p>XP: <span id="profile-xp">0/100</span></p>
                <p>Win %: <span id="profile-win-rate">--</span></p>
                <p>Highest Wager: <span id="profile-highest-wager">--</span></p>
                <p>Longest Streak: <span id="profile-longest-streak">--</span></p>
                <h4>Badges:</h4>
                <ul id="profile-badges">
                    </ul>
                <p>Favorite Game: <span id="profile-favorite-game">Blackjack</span></p>
            </div>
            <div id="lounge-content" class="hidden">
                <h3>üõãÔ∏è Lounge</h3>
                <h4>Games:</h4>
                <div id="game-tabs">
                    <button data-game="blackjack" class="game-tab-button">Blackjack</button>
                    <button data-game="dice" class="game-tab-button">Dice (Coming Soon)</button>
                    <button data-game="roulette" class="game-tab-button">Roulette (Coming Soon)</button>
                    <button data-game="war" class="game-tab-button">War (Coming Soon)</button>
                </div>
                <h4>Live Leaderboards:</h4>
                <div id="lounge-leaderboards">
                    </div>
                <div id="lounge-chat" style="height: 200px; background: #222; margin-top: 10px; padding: 10px; overflow-y: auto;">
                    Lounge chat messages...
                </div>
            </div>
        </div>
    </div>


    <audio id="card-deal-sound" src="/assets/sounds/card-deal.mp3" preload="none"></audio> <audio id="win-sound" src="/assets/sounds/win.mp3" preload="none"></audio> <audio id="loss-sound" src="/assets/sounds/loss.mp3" preload="none"></audio> <audio id="button-click-sound" src="/assets/sounds/button-click.mp3" preload="none"></audio> <audio id="coin-drop-sound" src="/assets/sounds/coin-drop.mp3" preload="none"></audio> <audio id="background-loop-sound" src="/assets/sounds/background-loop.mp3" preload="none" loop></audio> <audio id="chip-sound" src="/assets/sounds/chip.mp3" preload="none"></audio> <audio id="whoosh-sound" src="/assets/sounds/whoosh.mp3" preload="none"></audio> <audio id="card-thud-sound" src="/assets/sounds/card-thud.mp3" preload="none"></audio> <audio id="jackpot-sound" src="/assets/sounds/jackpot.mp3" preload="none"></audio> <audio id="crowd-cheer-sound" src="/assets/sounds/crowd-cheer.mp3" preload="none"></audio> <div id="floating-emoji-container" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20;"></div>


    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
    <script>
        // --- Global State ---
        const gameState = {
            walletAddress: null,
            walletBalance: 0,
            userXP: parseInt(localStorage.getItem('userXP') || '0'), // Load from localStorage
            userLevel: parseInt(localStorage.getItem('userLevel') || '1'), // Load from localStorage
            dealerHand: [],
            players: [], // Array of player objects { id, name, level, avatar, hand, isUser, timer, hotStreak }
            activePlayerId: null,
            turnTimerDuration: 10, // seconds
            betAmount: 0,
            chatMessages: [], // Array of { sender, message, badge }
            recentPlays: [], // Array of { player, amount, win }
            isSpectator: false,
            isSeated: false,
            websocket: null,
            confettiCanvas: null,
            confettiCtx: null,
            backgroundParticlesCanvas: null, // New background particles canvas
            backgroundParticlesCtx: null, // New background particles context
            chatVisible: window.innerWidth > 768, // Chat visible by default on desktop
            otherHandsVisible: false, // State for mobile other hands toggle
            backgroundSoundPlaying: false,
            isFreeMode: false, // Phase 2: Free Mode state
            referralCount: parseInt(localStorage.getItem('referralCount') || '0'), // New: Referral count
            // Add other state properties as needed
        };

        // --- DOM Elements ---
        const dom = {
            walletIcon: document.getElementById('wallet-icon'), // New wallet icon
            walletAddress: document.getElementById('wallet-address'),
            walletBalance: document.getElementById('wallet-balance'),
            connectWalletButton: document.getElementById('connect-wallet-button'),
            disconnectWalletButton: document.getElementById('disconnect-wallet-button'),
            phantomDeeplink: document.getElementById('phantom-deeplink'),
            walletGuidance: document.getElementById('wallet-guidance'),
            userLevel: document.getElementById('user-level'),
            xpBarFill: document.getElementById('xp-bar-fill'),
            userXP: document.getElementById('user-xp'),
            crateIcon: document.getElementById('crate-icon'),
            recentPlaysTicker: document.getElementById('recent-plays-ticker'),
            leaderboard: document.getElementById('leaderboard'), // New
            referralCount: document.getElementById('referral-count'), // New: Referral count
            settingsDropdown: document.getElementById('settings-dropdown'), // Placeholder
            freeModeToggle: document.getElementById('free-mode-toggle'), // Phase 2: Free Mode Toggle
            profileTabButton: document.getElementById('profile-tab-button'), // Phase 2: Profile Tab Button
            loungeTabButton: document.getElementById('lounge-tab-button'), // Phase 2: Lounge Tab Button
            profileLoungeSection: document.getElementById('profile-lounge-section'), // Phase 2: Profile/Lounge Section
            profileLoungeClose: document.getElementById('profile-lounge-close'), // Phase 2: Profile/Lounge Close Button
            profileContent: document.getElementById('profile-content'), // Phase 2: Profile Content
            loungeContent: document.getElementById('lounge-content'), // Phase 2: Lounge Content
            profileAvatar: document.getElementById('profile-avatar'), // Phase 2: Profile Avatar
            profileLevel: document.getElementById('profile-level'), // Phase 2: Profile Level
            profileXpBarFill: document.getElementById('profile-xp-bar-fill'), // Phase 2: Profile XP Bar
            profileXP: document.getElementById('profile-xp'), // Phase 2: Profile XP
            profileWinRate: document.getElementById('profile-win-rate'), // Phase 2: Profile Win Rate
            profileHighestWager: document.getElementById('profile-highest-wager'), // Phase 2: Profile Highest Wager
            profileLongestStreak: document.getElementById('profile-longest-streak'), // Phase 2: Profile Longest Streak
            profileBadges: document.getElementById('profile-badges'), // Phase 2: Profile Badges
            profileFavoriteGame: document.getElementById('profile-favorite-game'), // Phase 2: Profile Favorite Game
            gameTabs: document.getElementById('game-tabs'), // Phase 2: Game Tabs
            loungeLeaderboards: document.getElementById('lounge-leaderboards'), // Phase 2: Lounge Leaderboards
            loungeChat: document.getElementById('lounge-chat'), // Phase 2: Lounge Chat
            dealerCards: document.getElementById('dealer-cards'),
            playerSeats: document.getElementById('player-seats'),
            dealerAnchor: document.querySelector('.dealer-anchor'), // New dealer anchor
            dealerEmoji: document.getElementById('dealer-emoji'), // New dealer emoji
            hotTableBanner: document.getElementById('hot-table-banner'), // New
            nearMissPopup: document.getElementById('near-miss-popup'), // New
            hotStreakBar: document.getElementById('hot-streak-bar'), // New
            toggleOtherHandsButton: document.getElementById('toggle-other-hands'), // New
            currentBetDisplay: document.getElementById('current-bet-display'),
            betSlider: document.getElementById('bet-slider'),
            quickBetButtons: document.querySelectorAll('.quick-bet-buttons button'),
            joinLeaveButton: document.getElementById('join-leave-button'),
            spectatorStatus: document.getElementById('spectator-status'),
            referFriendsButton: document.getElementById('refer-friends-button'), // New
            chatContainer: document.querySelector('.chat-container'), // New
            chatFeed: document.getElementById('chat-feed'),
            chatInput: document.getElementById('chat-input'),
            sendChatButton: document.getElementById('send-chat-button'),
            toggleChatButton: document.getElementById('toggle-chat'), // New
            nextHandButton: document.getElementById('next-hand-button'), // New
            confettiCanvas: document.getElementById('confetti-canvas'),
            backgroundParticlesCanvas: document.getElementById('background-particles'), // New background particles canvas
            floatingEmojiContainer: document.getElementById('floating-emoji-container'), // New: Floating emoji container
            // Audio Elements
            cardDealSound: document.getElementById('card-deal-sound'),
            winSound: document.getElementById('win-sound'),
            lossSound: document.getElementById('loss-sound'),
            buttonClickSound: document.getElementById('button-click-sound'),
            coinDropSound: document.getElementById('coin-drop-sound'), // New Coin Drop Sound
            backgroundLoopSound: document.getElementById('background-loop-sound'), // New Background Loop
            chipSound: document.getElementById('chip-sound'), // New Chip Sound
            whooshSound: document.getElementById('whoosh-sound'), // New Whoosh Sound
            cardThudSound: document.getElementById('card-thud-sound'), // New Card Thud Sound
            jackpotSound: document.getElementById('jackpot-sound'), // New Jackpot Sound
            crowdCheerSound: document.getElementById('crowd-cheer-sound'), // New Crowd Cheer Sound
        };

        // --- Global State ---
        const gameState = {
            walletAddress: null,
            walletBalance: 0,
            userXP: parseInt(localStorage.getItem('userXP') || '0'), // Load from localStorage
            userLevel: parseInt(localStorage.getItem('userLevel') || '1'), // Load from localStorage
            dealerHand: [],
            players: [], // Array of player objects { id, name, level, avatar, hand, isUser, timer, hotStreak }
            activePlayerId: null,
            turnTimerDuration: 10, // seconds
            betAmount: 0,
            chatMessages: [], // Array of { sender, message, badge }
            recentPlays: [], // Array of { player, amount, win }
            isSpectator: false,
            isSeated: false,
            websocket: null,
            confettiCanvas: null,
            confettiCtx: null,
            backgroundParticlesCanvas: null, // New background particles canvas
            backgroundParticlesCtx: null, // New background particles context
            chatVisible: window.innerWidth > 768, // Chat visible by default on desktop
            otherHandsVisible: false, // State for mobile other hands toggle
            backgroundSoundPlaying: false,
            isFreeMode: false, // Phase 2: Free Mode state
            referralCount: parseInt(localStorage.getItem('referralCount') || '0'), // New: Referral count
            // Add other state properties as needed
        };


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Canvases
            dom.confettiCanvas = document.getElementById('confetti-canvas');
            dom.confettiCtx = dom.confettiCanvas.getContext('2d');
            dom.backgroundParticlesCanvas = document.getElementById('background-particles');
            dom.backgroundParticlesCtx = dom.backgroundParticlesCanvas.getContext('2d');

            resizeCanvases(); // Set initial size
            window.addEventListener('resize', resizeCanvases); // Resize on window resize

            // Start background particles animation
            startBackgroundParticlesAnimation();


            // Set initial UI state
            updateUI();

            // Setup Event Listeners
            setupEventListeners();

            // Attempt to auto-connect wallet
            checkAutoConnectWallet();

            // Connect to WebSocket
            connectWebSocket();

            // Check for Daily Reward
            checkForDailyReward();

            // Placeholder: Simulate some initial game state for testing UI layout
            simulateInitialGameState();

             // Play background sound on first user interaction (e.g., click anywhere)
             document.body.addEventListener('click', playBackgroundSound, { once: true });
             document.body.addEventListener('touchstart', playBackgroundSound, { once: true }); // Add touchstart fallback
        });

        // Resize Canvases function
        function resizeCanvases() {
            dom.confettiCanvas.width = window.innerWidth;
            dom.confettiCanvas.height = window.innerHeight;
            dom.backgroundParticlesCanvas.width = window.innerWidth;
            dom.backgroundParticlesCanvas.height = window.innerHeight;
        }


        // --- Solana Wallet Integration (using window.solana) ---
        async function checkAutoConnectWallet() {
             const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);

            if (window.solana && window.solana.isConnected) {
                try {
                    // Attempt to connect silently if already authorized
                    await window.solana.connect({ onlyIfTrusted: true });
                    handleWalletConnected(window.solana.publicKey);
                } catch (error) {
                    console.error('Auto-connect failed:', error);
                     if (isIOS) {
                         showPhantomDeeplink();
                     } else {
                         showWalletGuidance('Please install Phantom wallet.');
                     }
                }
            } else if (isIOS) {
                 showPhantomDeeplink();
            } else {
                 showWalletGuidance('Please install Phantom wallet or another Solana wallet.');
            }
        }

        async function connectWallet() {
             const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);

            if (window.solana) {
                try {
                    const response = await window.solana.connect();
                    handleWalletConnected(response.publicKey);
                } catch (error) {
                    console.error('Wallet connection failed:', error);
                     if (isIOS) {
                         showPhantomDeeplink();
                     } else {
                         showWalletGuidance('Wallet connection failed. Please try again or install Phantom.');
                     }
                }
            } else {
                 if (isIOS) {
                     showPhantomDeeplink();
                 } else {
                     showWalletGuidance('Solana wallet not found! Please install Phantom, Backpack, Solflare, or Coinbase wallet.');
                 }
            }
        }

        async function disconnectWallet() {
            if (window.solana && window.solana.isConnected) {
                try {
                    await window.solana.disconnect();
                    handleWalletDisconnected();
                } catch (error) {
                    console.error('Wallet disconnection failed:', error);
                }
            }
        }

        function handleWalletConnected(publicKey) {
            gameState.walletAddress = publicKey.toBase58();
            dom.walletAddress.textContent = `${gameState.walletAddress.slice(0, 4)}...${gameState.walletAddress.slice(-4)}`;
            dom.connectWalletButton.classList.add('hidden');
            dom.disconnectWalletButton.classList.remove('hidden');
            dom.phantomDeeplink.classList.add('hidden');
            dom.walletGuidance.classList.add('hidden');
            dom.walletIcon.classList.remove('hidden'); // Show wallet icon
            // Placeholder: Fetch balance (requires more web3.js interaction)
            fetchWalletBalance(publicKey);
            updateUI(); // Update UI based on connected state
        }

        function handleWalletDisconnected() {
            gameState.walletAddress = null;
            gameState.walletBalance = 0;
            dom.walletAddress.textContent = 'Not Connected';
            dom.walletBalance.textContent = '-- SOL';
            dom.connectWalletButton.classList.remove('hidden');
            dom.disconnectWalletButton.classList.add('hidden');
             dom.phantomDeeplink.classList.add('hidden'); // Hide deeplink on disconnect
             dom.walletGuidance.classList.add('hidden'); // Hide guidance on disconnect
             dom.walletIcon.classList.add('hidden'); // Hide wallet icon
            updateUI(); // Update UI based on disconnected state
        }

        async function fetchWalletBalance(publicKey) {
             // Placeholder: In a real app, use Solana Web3.js Connection object
             // Example:
             // const connection = new Connection(Solana.Web3.clusterApiUrl('devnet'), 'confirmed');
             // const balance = await connection.getBalance(publicKey);
             // gameState.walletBalance = balance / 10**9; // Convert lamports to SOL
             // dom.walletBalance.textContent = `${gameState.walletBalance.toFixed(2)} SOL`;

             // Simulate fetching balance
             setTimeout(() => {
                 gameState.walletBalance = Math.random() * 5 + 1; // Random balance between 1 and 6
                 dom.walletBalance.textContent = `${gameState.walletBalance.toFixed(2)} SOL`;
             }, 500);
         }

         function showPhantomDeeplink() {
             const currentUrl = window.location.href;
             // IMPORTANT: Replace with your actual game URL
             const deeplinkUrl = `https://phantom.app/ul/v1/browse?url=${encodeURIComponent(currentUrl)}`;
             dom.phantomDeeplink.href = deeplinkUrl;
             dom.phantomDeeplink.classList.remove('hidden');
             dom.walletGuidance.classList.remove('hidden');
             dom.walletGuidance.textContent = 'For iOS, use Phantom\'s in-app browser:';
             dom.connectWalletButton.classList.add('hidden'); // Hide connect button if deeplink shown
         }

         function showWalletGuidance(message) {
             dom.walletGuidance.textContent = message;
             dom.walletGuidance.classList.remove('hidden');
             dom.phantomDeeplink.classList.add('hidden');
         }


        // --- WebSocket Integration ---
        function connectWebSocket() {
            // Replace with your actual WebSocket server URL
            const wsUrl = "wss://your-game-server-url";
            gameState.websocket = new WebSocket(wsUrl);

            gameState.websocket.onopen = () => {
                console.log("WebSocket Connected");
                // Send initial message, e.g., join game, if wallet is connected
                if (gameState.walletAddress) {
                     sendMessage({ type: 'joinGame', wallet: gameState.walletAddress });
                } else {
                     // Maybe join as spectator if not connected? Depends on backend logic.
                     sendMessage({ type: 'joinGameAsSpectator' });
                }
                 // Trigger confetti on join (optional addictive UX)
                triggerConfettiOnJoin();
            };

            gameState.websocket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                console.log("WebSocket Message:", msg);
                handleGameEvent(msg);
            };

            gameState.websocket.onerror = (error) => {
                console.error("WebSocket Error:", error);
                // Handle errors, attempt reconnect
            };

            gameState.websocket.onclose = () => {
                console.log("WebSocket Disconnected");
                // Handle disconnection, attempt reconnect
            };
        }

        function sendMessage(message) {
            if (gameState.websocket && gameState.websocket.readyState === WebSocket.OPEN) {
                gameState.websocket.send(JSON.stringify(message));
            } else {
                console.warn("WebSocket not connected. Cannot send message:", message);
                // Maybe queue messages or try to reconnect
            }
        }

        // Handle incoming WebSocket messages
        function handleGameEvent(msg) {
            switch (msg.type) {
                case 'table_state':
                    // Update entire table state
                    gameState.players = msg.data.players;
                    gameState.dealerHand = msg.data.dealerHand;
                    gameState.activePlayerId = msg.data.activePlayerId;
                    gameState.isSpectator = msg.data.isSpectator;
                    gameState.isSeated = msg.data.isSeated; // Assuming backend sends this
                    updateUI();
                    break;
                case 'card_dealt':
                    // Add card to specific player or dealer hand
                    // msg.data should contain { playerId, card } or { target: 'dealer', card }
                    if (msg.data.target === 'dealer') {
                        gameState.dealerHand.push(msg.data.card);
                        renderDealerHand();
                    } else {
                        const player = gameState.players.find(p => p.id === msg.data.playerId);
                        if (player) {
                            player.hand.push(msg.data.card);
                            renderPlayerSeats(); // Re-render all seats for simplicity
                        }
                    }
                    playSound(dom.cardDealSound); // Play card deal sound
                    playSound(dom.whooshSound); // Play whoosh sound for deal
                    playSound(dom.cardThudSound); // Play thud sound for deal
                    break;
                case 'turn_changed':
                    gameState.activePlayerId = msg.data.playerId;
                    // Start or reset turn timer animation
                    startTurnTimer(msg.data.duration || gameState.turnTimerDuration);
                    renderPlayerSeats(); // Update active player highlight
                    // Add dealer glow when it's dealer's turn (placeholder)
                    if (gameState.activePlayerId === 'dealer') { // Assuming dealer ID is 'dealer'
                         dom.dealerAnchor.classList.add('glowing');
                    } else {
                         dom.dealerAnchor.classList.remove('glowing');
                    }
                    break;
                case 'round_end':
                    // Handle round end logic (reveal dealer cards, show results)
                    gameState.dealerHand = msg.data.dealerHand; // Full dealer hand revealed
                    // Update player results (win/loss status)
                    // msg.data might contain results for each player
                    updateUI(); // Update all relevant UI elements

                    // Trigger confetti or other win/loss animations
                    if (msg.data.userWon) {
                         triggerConfetti();
                         triggerCoinShower(); // Trigger coin shower on win
                         playSound(dom.winSound); // Play win sound
                         playSound(dom.jackpotSound); // Play jackpot sound for big wins
                         playSound(dom.crowdCheerSound); // Play crowd cheer sound
                         triggerHaptic([100, 50, 100]); // Win haptic
                         // Show win banner/badge (placeholder)
                         showWinBanner(msg.data.winAmount);
                         // Trigger floating win emojis
                         triggerFloatingWinEmojis();
                    } else if (msg.data.userLost) {
                         playSound(dom.lossSound); // Play loss sound
                         triggerHaptic([200]); // Loss haptic
                    }

                     // Show "Next Hand?" button
                     showNextHandButton();
                    break;
                case 'xp_update':
                    // Update user XP and level
                    gameState.userXP = msg.data.newXP;
                    gameState.userLevel = msg.data.newLevel;
                    localStorage.setItem('userXP', gameState.userXP); // Persist XP
                    localStorage.setItem('userLevel', gameState.userLevel); // Persist Level
                    updateXPBar();
                    if (msg.data.levelUp) {
                        showCrateIcon();
                         // Add sparkles/shine animation on level up (placeholder)
                         triggerLevelUpAnimation();
                    }
                    break;
                case 'crate_awarded':
                    // Trigger crate animation/display
                    showCrateIcon();
                    break;
                case 'chat_message':
                    // Add new chat message
                    gameState.chatMessages.push(msg.data);
                    addChatMessageToFeed(msg.data);
                    break;
                case 'recent_play':
                    // Add new recent play to the ticker
                    gameState.recentPlays.unshift(msg.data); // Add to the beginning
                    // Keep ticker length reasonable
                    if (gameState.recentPlays.length > 10) {
                        gameState.recentPlays.pop();
                    }
                    updateRecentPlaysTicker();
                    break;
                 case 'hot_table':
                     // Show/hide hot table banner
                     if (msg.data.isActive) {
                         dom.hotTableBanner.textContent = msg.data.message || 'Hot Table!';
                         dom.hotTableBanner.classList.remove('hidden');
                     } else {
                         dom.hotTableBanner.classList.add('hidden');
                     }
                     break;
                 case 'near_miss':
                     // Trigger near miss animation
                     showNearMissPopup(msg.data.message || 'Almost!');
                     triggerHaptic([100, 100, 100, 100]); // Heartbeat haptic for near miss
                     break;
                 case 'hot_streak_update':
                     // Update hot streak bar and potentially display streak emoji
                     updateHotStreakBar(msg.data.streakCount);
                     // Trigger celebratory haptic for streak milestone (placeholder)
                     if (msg.data.milestone) { // Assuming backend sends milestone flag
                         triggerHaptic([100, 50, 100, 50, 100]);
                     }
                     break;
                 case 'leaderboard_update':
                     // Update leaderboard
                     updateLeaderboard(msg.data.leaderboard);
                     break;
                 case 'mystery_event':
                     // Handle mystery event (e.g., Bonus Round)
                     showMysteryEvent(msg.data);
                     break;
                // Handle other event types as needed
                default:
                    console.warn("Unknown WebSocket message type:", msg.type);
            }
        }

        // --- UI Rendering Functions ---

        function updateUI() {
            // Update wallet info (already done in handleWalletConnected/Disconnected)
            // Update XP bar and level
            updateXPBar();
            // Update recent plays ticker
            updateRecentPlaysTicker();
            // Render game table elements
            renderDealerHand();
            renderPlayerSeats();
            // Update betting controls and join/leave button
            updateBettingControls();
            // Render chat messages (initial load)
            renderChatFeed();
             // Update chat container visibility based on state
             updateChatContainerVisibility();
             // Update other players hands visibility based on state
             updateOtherHandsVisibility();
             // Update leaderboard
             updateLeaderboard(gameState.leaderboard || []); // Pass current leaderboard state

             // Update Free Mode Toggle text
             updateFreeModeToggleText();

             // Update referral count display
             updateReferralCountDisplay();
        }

        function updateXPBar() {
            dom.userLevel.textContent = `Level ${gameState.userLevel}`;
            const xpProgress = gameState.userXP % 100; // Assuming 100 XP per level
            dom.xpBarFill.style.width = `${xpProgress}%`;
            dom.userXP.textContent = `${xpProgress}/100 XP`;
        }

        function showCrateIcon() {
            dom.crateIcon.classList.remove('hidden');
            // Add logic for crate opening animation on click
            dom.crateIcon.onclick = openCrate; // Assign click handler
        }

        function openCrate() {
             console.log("Crate opened!");
             // Placeholder: Implement crate opening animation (Canvas or image sequence)
             // For now, just hide the icon
             dom.crateIcon.classList.add('hidden');
             // Placeholder: Show crate contents (inline, no popup)
             // Maybe a temporary text display or simple animation near the icon
             alert("You got a reward!"); // Replace with inline display
         }

         // Placeholder for Level Up Animation
         function triggerLevelUpAnimation() {
             console.log("Triggering level up animation!");
             // Example: Briefly change text color or add a sparkle effect
             dom.userLevel.style.transition = 'color 0.3s ease-in-out';
             dom.userLevel.style.color = '#facc15'; // Yellow sparkle color
             setTimeout(() => {
                 dom.userLevel.style.color = '#eee'; // Revert color
             }, 500);
             // Could also add a particle effect around the level text
         }


        function updateRecentPlaysTicker() {
            dom.recentPlaysTicker.innerHTML = ''; // Clear current ticker
            if (gameState.recentPlays.length === 0) {
                dom.recentPlaysTicker.textContent = 'No recent plays...';
                return;
            }
            // Create a single span for the ticker content
            const tickerContent = document.createElement('span');
            gameState.recentPlays.forEach(play => {
                const span = document.createElement('span');
                span.classList.add('recent-play-item', play.win ? 'win' : 'loss');
                span.textContent = `${play.player}: ${play.win ? '+' : '-'}${play.amount.toFixed(2)} SOL ‚Ä¢ `; // Added bullet point
                tickerContent.appendChild(span);
            });
             // Remove the last bullet point
             if (tickerContent.lastChild) {
                 tickerContent.lastChild.textContent = tickerContent.lastChild.textContent.slice(0, -2);
             }

            dom.recentPlaysTicker.appendChild(tickerContent);

            // Apply animation to the ticker content span
            tickerContent.style.animation = 'none'; // Reset animation
            tickerContent.offsetHeight; // Trigger reflow
            tickerContent.style.animation = `slide-left 15s linear infinite`; // Apply animation
        }

        function updateLeaderboard(leaderboardData) {
             dom.leaderboard.innerHTML = ''; // Clear current leaderboard
             if (!leaderboardData || leaderboardData.length === 0) {
                 dom.leaderboard.textContent = 'Leaderboard: --';
                 return;
             }
             const leaderboardTitle = document.createElement('span');
             leaderboardTitle.textContent = 'Leaderboard: ';
             leaderboardTitle.style.fontWeight = 'bold';
             dom.leaderboard.appendChild(leaderboardTitle);

             leaderboardData.forEach((entry, index) => {
                 const entrySpan = document.createElement('span');
                 entrySpan.textContent = `${index + 1}. ${entry.player}: ${entry.wins} Wins | `;
                 dom.leaderboard.appendChild(entrySpan);
             });
        }

        // New: Update Referral Count Display
        function updateReferralCountDisplay() {
            dom.referralCount.textContent = `üë• ${gameState.referralCount} referrals`;
        }


        function renderDealerHand() {
            dom.dealerCards.innerHTML = ''; // Clear current cards
             if (gameState.dealerHand.length === 0) {
                  const placeholder = document.createElement('div');
                  placeholder.classList.add('card', 'card-back');
                  dom.dealerCards.appendChild(placeholder);
                  return;
             }
            gameState.dealerHand.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.classList.add('card');
                 // For the first card, show back initially if not revealed
                 if (index === 0 && !card.revealed) { // Assuming a 'revealed' property on card objects
                      cardElement.classList.add('card-back');
                 } else {
                     // Set card image background and text color based on suit
                     const suitColor = (card.suit === '‚ô•' || card.suit === '‚ô¶') ? '#e63946' : '#1d3557'; // Ruby Red or Sapphire Blue
                     cardElement.style.color = suitColor;
                     cardElement.textContent = `${card.value}${card.suit}`; // Placeholder text
                     // In a real app, use an image:
                     // cardElement.style.backgroundImage = `url('/assets/cards/${card.value}_${card.suit}.png')`;
                     // cardElement.style.color = 'transparent'; // Hide text if using image
                 }
                 // Add deal animation class
                 cardElement.classList.add('deal-animation');
                 // Remove animation class after it finishes
                 cardElement.addEventListener('animationend', () => {
                     cardElement.classList.remove('deal-animation');
                 }, { once: true });

                dom.dealerCards.appendChild(cardElement);
            });
        }

        function renderPlayerSeats() {
            dom.playerSeats.innerHTML = ''; // Clear current seats
            const isMobile = window.innerWidth <= 768;

            gameState.players.forEach(player => {
                const seatElement = document.createElement('div');
                seatElement.classList.add('player-seat');
                 // Add ID to seat for easier targeting in updateOtherHandsVisibility
                 seatElement.id = `player-seat-${player.id}`;

                 if (player.id === gameState.walletAddress) {
                     seatElement.classList.add('is-user'); // Mark the user's seat
                 }
                if (player.id === gameState.activePlayerId) {
                    seatElement.classList.add('active');
                }

                // Player Info
                const playerInfo = document.createElement('div');
                playerInfo.classList.add('player-info');
                const avatar = document.createElement('div');
                avatar.classList.add('avatar');
                 // Add VIP badge overlay if player is VIP (placeholder)
                 if (player.isVIP) { // Assuming player object has isVIP property
                     avatar.classList.add('vip');
                 }
                avatar.textContent = player.avatar || 'üòä'; // Placeholder avatar
                const username = document.createElement('span');
                username.classList.add('username');
                username.textContent = player.name || 'Player';
                const xpBadge = document.createElement('span');
                xpBadge.classList.add('xp-badge');
                xpBadge.textContent = player.level || 1;
                playerInfo.appendChild(avatar);
                playerInfo.appendChild(username);
                playerInfo.appendChild(xpBadge);

                 // Add Flair next to username (placeholder)
                 const flair = document.createElement('span');
                 flair.classList.add('player-flair');
                 flair.style.fontSize = '0.8em';
                 flair.style.marginLeft = '0.25rem';
                 // Example flair based on streak or VIP status
                 if (player.hotStreak >= 5) flair.textContent = 'üî•'; // Hot streak flair
                 else if (player.isVIP) flair.textContent = 'üëë'; // VIP flair
                 playerInfo.appendChild(flair);


                seatElement.appendChild(playerInfo);

                // Player Hand
                const playerHand = document.createElement('div');
                playerHand.classList.add('player-hand');
                // Hand visibility handled by updateOtherHandsVisibility

                if (player.hand && player.hand.length > 0) {
                    player.hand.forEach(card => {
                        const cardElement = document.createElement('div');
                        cardElement.classList.add('card');
                         // Card back/face handled by updateOtherHandsVisibility and renderDealerHand
                         cardElement.textContent = `${card.value}${card.suit}`; // Placeholder text
                         // Add deal animation class
                         cardElement.classList.add('deal-animation');
                         // Remove animation class after it finishes
                         cardElement.addEventListener('animationend', () => {
                             cardElement.classList.remove('deal-animation');
                         }, { once: true });

                        playerHand.appendChild(cardElement);
                    });
                } else {
                     const placeholder = document.createElement('div');
                     placeholder.classList.add('card', 'card-back');
                     playerHand.appendChild(placeholder);
                }
                seatElement.appendChild(playerHand);

                // Action Buttons (Hit/Stand)
                const actionButtons = document.createElement('div');
                actionButtons.classList.add('action-buttons');
                // Use class 'hidden' instead of inline style
                if (!(player.id === gameState.walletAddress && player.id === gameState.activePlayerId && !gameState.isSpectator)) {
                    actionButtons.classList.add('hidden');
                } else {
                    actionButtons.classList.remove('hidden');
                }


                const hitButton = document.createElement('button');
                hitButton.classList.add('hit-button');
                hitButton.textContent = 'Hit';
                hitButton.onclick = () => { sendPlayerAction('hit'); playSound(dom.buttonClickSound); triggerHaptic([50]); }; // Add sound and haptic

                const standButton = document.createElement('button');
                standButton.classList.add('stand-button');
                standButton.textContent = 'Stand';
                standButton.onclick = () => { sendPlayerAction('stand'); playSound(dom.buttonClickSound); triggerHaptic([50]); }; // Add sound and haptic

                actionButtons.appendChild(hitButton);
                actionButtons.appendChild(standButton);
                seatElement.appendChild(actionButtons);

                // Turn Timer Bar
                const timerBar = document.createElement('div');
                timerBar.classList.add('turn-timer-bar');
                 if (!(player.id === gameState.activePlayerId)) { // Use class 'hidden'
                     timerBar.classList.add('hidden');
                 } else {
                     timerBar.classList.remove('hidden');
                 }

                const timerFill = document.createElement('div');
                timerFill.classList.add('turn-timer-fill');
                 // Timer fill width will be controlled by startTurnTimer function
                timerBar.appendChild(timerFill);
                seatElement.appendChild(timerBar);

                // Hot Streak Bar (Visible only for the user's seat)
                if (player.id === gameState.walletAddress) {
                    const hotStreakBar = document.createElement('div');
                    hotStreakBar.classList.add('hot-streak-bar');
                    hotStreakBar.id = 'user-hot-streak-bar'; // Assign an ID for easy access
                     if (!(player.hotStreak > 0)) { // Use class 'hidden'
                         hotStreakBar.classList.add('hidden');
                     } else {
                         hotStreakBar.classList.remove('hidden');
                     }

                    const hotStreakFill = document.createElement('div');
                    hotStreakFill.classList.add('hot-streak-fill');
                    hotStreakBar.appendChild(hotStreakFill);
                    seatElement.appendChild(hotStreakFill);
                }

                 // Add Streak Emoji Placeholder
                 const streakEmoji = document.createElement('span');
                 streakEmoji.classList.add('streak-emoji', 'hidden'); // Hidden by default
                 streakEmoji.style.fontSize = '1.5rem'; // Use rem
                 streakEmoji.style.marginLeft = '0.5rem'; // Use rem
                 streakEmoji.textContent = 'üî•'; // Default streak emoji
                 seatElement.appendChild(streakEmoji);


                dom.playerSeats.appendChild(seatElement);
            });

             // Add empty seats if less than 5 players
             for (let i = gameState.players.length; i < 5; i++) {
                 const emptySeat = document.createElement('div');
                 emptySeat.classList.add('player-seat');
                 emptySeat.style.backgroundColor = '#333'; // Slightly lighter for empty
                 emptySeat.style.border = '2px dashed #555';
                 emptySeat.innerHTML = `<div style="color: #777; font-size: 0.9em;">Empty Seat</div>`;
                 dom.playerSeats.appendChild(emptySeat);
             }
        }

        function startTurnTimer(duration) {
            const activePlayerSeatFill = document.querySelector('.player-seat.active .turn-timer-fill');
            if (activePlayerSeatFill) {
                // Reset timer animation
                activePlayerSeatFill.style.transition = 'none';
                activePlayerSeatFill.style.width = '100%';
                // Force reflow to apply width: 100% immediately
                activePlayerSeatFill.offsetHeight;
                // Start animation
                activePlayerSeatFill.style.transition = `width ${duration}s linear`;
                activePlayerSeatFill.style.width = '0%';
            }
        }

        function updateHotStreakBar(streakCount) {
             const userHotStreakFill = document.getElementById('user-hot-streak-bar')?.querySelector('.hot-streak-fill');
             const userStreakEmoji = document.querySelector('.player-seat.is-user .streak-emoji');

             if (userHotStreakFill) {
                 // Assuming streakCount is between 0 and some max value (e.g., 5 or 10)
                 // Adjust width calculation based on your max streak logic
                 const maxWidth = 10; // Example max streak before a bonus or reset
                 const widthPercentage = Math.min(streakCount / maxWidth * 100, 100);
                 userHotStreakFill.style.width = `${widthPercentage}%`;
                 // Use class 'hidden'
                 if (streakCount > 0) {
                     userHotStreakFill.parentElement.classList.remove('hidden');
                     if (userStreakEmoji) userStreakEmoji.classList.remove('hidden'); // Show emoji
                     // Update emoji based on streak count (placeholder)
                     if (streakCount >= 5) userStreakEmoji.textContent = 'üëë';
                     else if (streakCount >= 3) userStreakEmoji.textContent = 'üî•';
                     else userStreakEmoji.textContent = 'üëç';
                 } else {
                     userHotStreakFill.parentElement.classList.add('hidden');
                     if (userStreakEmoji) userStreakEmoji.classList.add('hidden'); // Hide emoji
                 }
             }
        }

        function showNearMissPopup(message) {
            dom.nearMissPopup.textContent = message;
            dom.nearMissPopup.classList.add('show');
            setTimeout(() => {
                dom.nearMissPopup.classList.remove('show');
            }, 1500); // Show for 1.5 seconds
             triggerHaptic([50]); // Haptic feedback for near miss
        }

        // Placeholder for Win Banner/Badge
        function showWinBanner(amount) {
            console.log(`Showing Win Banner for ${amount} SOL`);
            // Implement a temporary banner or badge animation here
            // Example: Create a div, add content, animate it in and out
        }


        function updateBettingControls() {
            dom.currentBetDisplay.textContent = `Bet: ${gameState.betAmount.toFixed(2)} SOL`;
            dom.betSlider.value = gameState.betAmount;

            if (gameState.isSeated) {
                dom.joinLeaveButton.textContent = 'Leave Table';
                dom.joinLeaveButton.classList.remove('join-button');
                dom.joinLeaveButton.classList.add('leave-button');
                // Disable betting controls if seated and not active player or spectator
                const disableBetting = gameState.isSeated && !gameState.isSpectator && gameState.activePlayerId !== gameState.walletAddress;
                 dom.betSlider.disabled = disableBetting;
                 dom.quickBetButtons.forEach(button => button.disabled = disableBetting);

            } else {
                dom.joinLeaveButton.textContent = 'Join Table';
                dom.joinLeaveButton.classList.remove('leave-button');
                dom.joinLeaveButton.classList.add('join-button');
                 // Enable betting controls if not seated
                 dom.betSlider.disabled = false;
                 dom.quickBetButtons.forEach(button => button.disabled = false);
            }

            // Show spectator status if applicable (use class 'hidden')
            if (gameState.isSpectator) {
                dom.spectatorStatus.classList.remove('hidden');
            } else {
                dom.spectatorStatus.classList.add('hidden');
            }

             // Disable chat input for spectators
             dom.chatInput.disabled = gameState.isSpectator;
             dom.sendChatButton.disabled = gameState.isSpectator;
             dom.chatInput.placeholder = gameState.isSpectator ? "Spectators cannot chat" : "Type message...";
        }

        function renderChatFeed() {
            dom.chatFeed.innerHTML = ''; // Clear current feed
            gameState.chatMessages.forEach(msg => {
                addChatMessageToFeed(msg);
            });
             // Ensure chat container is visible on desktop, hidden on mobile initially
             updateChatContainerVisibility();
        }

        function addChatMessageToFeed(msg) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat-message');
            messageElement.innerHTML = `<span class="chat-sender">[${msg.sender}]</span><span class="chat-badge">[${msg.badge}]</span> ${msg.message}`;
            dom.chatFeed.appendChild(messageElement);

             // Limit chat messages to prevent DOM bloat
             const maxChatMessages = 50;
             if (dom.chatFeed.children.length > maxChatMessages) {
                 dom.chatFeed.removeChild(dom.chatFeed.children[0]); // Remove the oldest message
             }

            // Auto-scroll to the bottom
            dom.chatFeed.scrollTop = dom.chatFeed.scrollHeight;

            // Add flash animation to the new message
            messageElement.classList.add('flash');
            messageElement.addEventListener('animationend', () => {
                messageElement.classList.remove('flash');
            }, { once: true });
        }

        function updateChatContainerVisibility() {
             // On mobile, chat is toggleable. On desktop, it's always visible.
             const isMobile = window.innerWidth <= 768;
             if (isMobile) {
                 if (gameState.chatVisible) {
                     dom.chatContainer.classList.add('active');
                     dom.chatContainer.classList.remove('hidden'); // Ensure it's not hidden by utility class
                 } else {
                     dom.chatContainer.classList.remove('active');
                     // Add 'hidden' class when not active on mobile
                     dom.chatContainer.classList.add('hidden');
                 }
                  dom.toggleChatButton.classList.remove('hidden'); // Show toggle button on mobile
             } else {
                 dom.chatContainer.classList.add('active'); // Always active on desktop
                 dom.chatContainer.classList.remove('hidden');
                 dom.toggleChatButton.classList.add('hidden'); // Hide toggle button on desktop
             }
        }

        function updateOtherHandsVisibility() {
             const isMobile = window.innerWidth <= 768;
             const otherPlayerSeats = document.querySelectorAll('.player-seat:not(.is-user)');

             if (!isMobile) {
                 // Always show hands on desktop
                 otherPlayerSeats.forEach(seat => {
                     const hand = seat.querySelector('.player-hand');
                     hand.classList.remove('hidden'); // Ensure hand is not hidden
                     seat.querySelectorAll('.card').forEach(card => card.classList.remove('card-back'));
                 });
                 dom.toggleOtherHandsButton.classList.add('hidden'); // Hide button on desktop
                 return;
             }

             // Mobile logic
             dom.toggleOtherHandsButton.classList.remove('hidden'); // Show button on mobile

             otherPlayerSeats.forEach(seat => {
                 const hand = seat.querySelector('.player-hand');
                 if (gameState.otherHandsVisible) {
                      hand.classList.remove('hidden'); // Show hand
                      // Show cards face up (assuming card object has 'revealed' or similar)
                      seat.querySelectorAll('.card').forEach(cardElement => {
                           cardElement.classList.remove('card-back');
                           // Restore text content if using text placeholders
                           if (cardElement.textContent === '') {
                                // Find the corresponding card in gameState.players and set textContent
                                const playerId = seat.id; // Assuming player seat has ID matching player.id
                                const player = gameState.players.find(p => p.id === playerId);
                                if (player && player.hand.length > Array.from(seat.querySelectorAll('.card')).indexOf(cardElement)) {
                                     const card = player.hand[Array.from(seat.querySelectorAll('.card')).indexOf(cardElement)];
                                     cardElement.textContent = `${card.value}${card.suit}`;
                                }
                           }
                      });
                 } else {
                      hand.classList.remove('hidden'); // Keep hand container visible
                      // Show cards face down
                      seat.querySelectorAll('.card').forEach(cardElement => {
                          cardElement.classList.add('card-back');
                          cardElement.textContent = ''; // Hide text
                      });
                 }
             });
        }

        function showNextHandButton() {
             dom.nextHandButton.classList.remove('hidden');
             // Add pulse animation to Next Hand button
             dom.nextHandButton.classList.add('pulse-button');
        }

        function hideNextHandButton() {
             dom.nextHandButton.classList.add('hidden');
             // Remove pulse animation
             dom.nextHandButton.classList.remove('pulse-button');
        }


        // --- Event Handlers ---

        function setupEventListeners() {
            dom.connectWalletButton.addEventListener('click', connectWallet);
            dom.disconnectWalletButton.addEventListener('click', disconnectWallet);

            dom.betSlider.addEventListener('input', (event) => {
                gameState.betAmount = parseFloat(event.target.value);
                dom.currentBetDisplay.textContent = `Bet: ${gameState.betAmount.toFixed(2)} SOL`;
                // Optional: Send bet update to server on slider change or on a separate "Place Bet" button
                 // sendMessage({ type: 'betChanged', amount: gameState.betAmount });
            });

            dom.quickBetButtons.forEach(button => {
                button.addEventListener('click', (event) => {
                    const amount = event.target.dataset.betAmount;
                    if (amount === 'MAX') {
                        // Placeholder: Implement MAX bet logic (e.g., based on wallet balance or table limit)
                        gameState.betAmount = 10; // Example MAX bet
                         // Trigger MAX bet animation (shake)
                         triggerMaxBetAnimation();
                    } else {
                        gameState.betAmount = Math.max(0, gameState.betAmount + parseFloat(amount));
                    }
                    // Clamp bet amount to max slider value
                    gameState.betAmount = Math.min(gameState.betAmount, parseFloat(dom.betSlider.max));
                    dom.betSlider.value = gameState.betAmount;
                    dom.currentBetDisplay.textContent = `Bet: ${gameState.betAmount.toFixed(2)} SOL`;
                     // Optional: Send bet update
                     // sendMessage({ type: 'betChanged', amount: gameState.betAmount });
                     playSound(dom.chipSound); // Play chip sound
                     triggerHaptic([50]); // Haptic feedback
                });
            });

            dom.joinLeaveButton.addEventListener('click', () => {
                if (gameState.isSeated) {
                    sendMessage({ type: 'leaveTable' });
                } else {
                    sendMessage({ type: 'joinTable', bet: gameState.betAmount }); // Send bet when joining
                }
                 playSound(dom.buttonClickSound); // Play sound
                 triggerHaptic([50]); // Haptic feedback
            });

            dom.sendChatButton.addEventListener('click', sendChatMessage);
            dom.chatInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    sendChatMessage();
                }
            });

             // Placeholder for Settings Menu Toggle
             const menuIcon = document.querySelector('.menu-icon');
             menuIcon.addEventListener('click', () => {
                 const dropdown = dom.settingsDropdown;
                 // Use class 'hidden'
                 dropdown.classList.toggle('hidden');
                  playSound(dom.buttonClickSound); // Play sound
             });

             // Close settings dropdown if clicked outside
             document.addEventListener('click', (event) => {
                 if (!menuIcon.contains(event.target) && !dom.settingsDropdown.contains(event.target)) {
                     dom.settingsDropdown.classList.add('hidden'); // Use class 'hidden'
                 }
             });

             // Mobile Chat Toggle
             dom.toggleChatButton.addEventListener('click', () => {
                 gameState.chatVisible = !gameState.chatVisible;
                 updateChatContainerVisibility();
                  playSound(dom.buttonClickSound); // Play sound
             });

             // Mobile Other Hands Toggle
             dom.toggleOtherHandsButton.addEventListener('click', () => {
                 gameState.otherHandsVisible = !gameState.otherHandsVisible;
                 updateOtherHandsVisibility();
                  playSound(dom.buttonClickSound); // Play sound
             });

             // Next Hand Button
             dom.nextHandButton.addEventListener('click', () => {
                 sendMessage({ type: 'nextHand' });
                 hideNextHandButton();
                  playSound(dom.buttonClickSound); // Play sound
                  triggerHaptic([50]); // Haptic feedback
             });

             // Refer Friends Button
             dom.referFriendsButton.addEventListener('click', shareReferral);

             // Phase 2: Free Mode Toggle
             dom.freeModeToggle.addEventListener('click', () => {
                 gameState.isFreeMode = !gameState.isFreeMode;
                 updateFreeModeToggleText();
                 // Placeholder: Send update to backend or handle state change
                 console.log(`Free Mode: ${gameState.isFreeMode}`);
                 playSound(dom.buttonClickSound); // Play sound
             });

             // Phase 2: Profile/Lounge Tab Buttons
             dom.profileTabButton.addEventListener('click', () => {
                 showProfileLoungeSection('profile');
                 playSound(dom.buttonClickSound);
             });
             dom.loungeTabButton.addEventListener('click', () => {
                 showProfileLoungeSection('lounge');
                 playSound(dom.buttonClickSound);
             });
             dom.profileLoungeClose.addEventListener('click', () => {
                 dom.profileLoungeSection.classList.add('hidden');
                 playSound(dom.buttonClickSound);
             });

             // Phase 2: Game Tab Buttons (within Lounge)
             dom.gameTabs.querySelectorAll('.game-tab-button').forEach(button => {
                 button.addEventListener('click', (event) => {
                     const game = event.target.dataset.game;
                     console.log(`Switched to game tab: ${game}`);
                     // Placeholder: Load content for the selected game tab
                     // This would involve fetching data and updating the loungeLeaderboards/loungeChat areas
                      playSound(dom.buttonClickSound);
                 });
             });
        }

        function sendPlayerAction(action) {
             if (gameState.walletAddress && gameState.walletAddress === gameState.activePlayerId && !gameState.isSpectator) {
                  sendMessage({ type: 'player_action', action: action });
             } else {
                 console.warn("Cannot send action: Not your turn, not connected, or spectator.");
             }
        }

        function sendChatMessage() {
            const message = dom.chatInput.value.trim();
            if (message && !gameState.isSpectator) {
                // In a real app, sender and badge would come from gameState or backend
                const sender = gameState.walletAddress ? `${gameState.walletAddress.slice(0, 4)}...` : 'Anon';
                const badge = gameState.userLevel;
                sendMessage({ type: 'chat_message', message: message, sender: sender, badge: badge });
                dom.chatInput.value = ''; // Clear input
            }
        }

        // Phase 2: Update Free Mode Toggle Text
        function updateFreeModeToggleText() {
             dom.freeModeToggle.textContent = gameState.isFreeMode ? '‚úÖ Free Mode' : 'üîÅ SOL Mode';
             // Optional: Update UI elements based on mode (e.g., bet currency symbol)
        }

        // Phase 2: Show Profile/Lounge Section
        function showProfileLoungeSection(section) {
             dom.profileLoungeSection.classList.remove('hidden');
             // Toggle content visibility
             if (section === 'profile') {
                 dom.profileContent.classList.remove('hidden');
                 dom.loungeContent.classList.add('hidden');
                 // Placeholder: Populate profile data
                 updateProfileDisplay();
             } else if (section === 'lounge') {
                 dom.profileContent.classList.add('hidden');
                 dom.loungeContent.classList.remove('hidden');
                 // Placeholder: Load initial lounge content (e.g., Blackjack leaderboard)
                 loadLoungeContent('blackjack');
             }
        }

        // Phase 2: Placeholder for Populating Profile Data
        function updateProfileDisplay() {
             dom.profileAvatar.textContent = gameState.players.find(p => p.id === gameState.walletAddress)?.avatar || 'üòä';
             dom.profileLevel.textContent = gameState.userLevel;
             const xpProgress = gameState.userXP % 100;
             dom.profileXpBarFill.style.width = `${xpProgress}%`;
             dom.profileXP.textContent = `${xpProgress}/100`;
             // Placeholder: Fetch and display other profile data (Win %, Wager, Streak, Badges)
             dom.profileWinRate.textContent = '55%';
             dom.profileHighestWager.textContent = '10 SOL';
             dom.longestStreak.textContent = '5'; // Corrected variable name
             dom.profileFavoriteGame.textContent = 'Blackjack'; // Example
             // Placeholder: Render badges
             dom.profileBadges.innerHTML = '<li>Risk Lord</li><li>Low Roller</li>'; // Example badges
        }

        // Phase 2: Placeholder for Loading Lounge Content
        function loadLoungeContent(game) {
             console.log(`Loading lounge content for: ${game}`);
             // Placeholder: Fetch and display leaderboards and chat for the selected game
             dom.loungeLeaderboards.innerHTML = `Leaderboard for ${game}...`;
             dom.loungeChat.innerHTML = `Chat for ${game}...`;
        }


        // --- Sound and Haptics ---
        function playSound(audioElement) {
             if (audioElement) {
                 audioElement.currentTime = 0; // Rewind to start
                 audioElement.play().catch(error => console.error("Error playing sound:", error));
             }
        }

         function playBackgroundSound() {
             if (dom.backgroundLoopSound && !gameState.backgroundSoundPlaying) {
                 dom.backgroundLoopSound.volume = 0.1; // Adjust volume as needed
                 dom.backgroundLoopSound.play().then(() => {
                     gameState.backgroundSoundPlaying = true;
                 }).catch(error => console.error("Error playing background sound:", error));
             }
         }


        function triggerHaptic(pattern) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }


        // --- Animation Placeholders ---

        // Placeholder for Confetti Animation (Canvas)
        function triggerConfetti() {
            console.log("Triggering confetti!");
            const confettiCount = window.innerWidth < 768 ? 50 : 100; // Adjust count for mobile
            const colors = ['#10b981', '#ec4899', '#a78bfa', '#facc15']; // Green, Pink, Purple, Yellow
            const particles = [];

            for (let i = 0; i < confettiCount; i++) {
                particles.push({
                    x: Math.random() * dom.confettiCanvas.width,
                    y: dom.confettiCanvas.height, // Start from bottom
                    radius: Math.random() * 5 + 2,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    speedX: Math.random() * 10 - 5, // Random horizontal speed
                    speedY: Math.random() * -15 - 5, // Upward speed
                    gravity: 0.5,
                    dampening: 0.9, // Reduce speed over time
                    rotation: Math.random() * 360,
                    rotationSpeed: Math.random() * 20 - 10,
                });
            }

            function updateConfetti() {
                dom.confettiCtx.clearRect(0, 0, dom.confettiCanvas.width, dom.confettiCtx.canvas.height); // Use canvas height

                particles.forEach(p => {
                    p.speedY += p.gravity;
                    p.x += p.speedX;
                    p.y += p.speedY;
                    p.speedX *= p.dampening;
                    p.speedY *= p.dampening;
                    p.rotation += p.rotationSpeed;

                    // Draw particle (simplified square for now)
                    dom.confettiCtx.save();
                    dom.confettiCtx.translate(p.x, p.y);
                    dom.confettiCtx.rotate(p.rotation * Math.PI / 180);
                    dom.confettiCtx.fillStyle = p.color;
                    dom.confettiCtx.fillRect(-p.radius / 2, -p.radius / 2, p.radius, p.radius);
                    dom.confettiCtx.restore();
                });

                // Remove particles that are off-screen
                particles.filter(p => p.y < dom.confettiCanvas.height && p.x > 0 && p.x < dom.confettiCanvas.width); // Filter particles within bounds

                if (particles.length > 0) {
                    requestAnimationFrame(updateConfetti);
                }
            }

            updateConfetti(); // Start animation
        }

        // Placeholder for Coin Shower Animation
        function triggerCoinShower() {
            console.log("Triggering coin shower!");
            const coinCount = window.innerWidth < 768 ? 30 : 50; // Adjust count for mobile
            const coins = [];

            for (let i = 0; i < coinCount; i++) {
                const coin = document.createElement('div');
                coin.classList.add('coin');
                // Random start position at the top
                coin.style.left = `${Math.random() * 100}vw`;
                // Random end horizontal position
                coin.style.setProperty('--end-x', `${(Math.random() - 0.5) * 200}px`); // Drift left or right
                // Random end rotation
                 coin.style.setProperty('--end-rotate', `${Math.random() * 720 - 360}deg`); // Rotate in either direction

                document.body.appendChild(coin);
                coins.push(coin);

                // Remove coin element after animation
                coin.addEventListener('animationend', () => {
                    coin.remove();
                }, { once: true });
            }
            playSound(dom.coinDropSound); // Play coin drop sound
        }

        // New: Placeholder for Floating Win Emojis
        function triggerFloatingWinEmojis() {
             console.log("Triggering floating win emojis!");
             const emojiCount = window.innerWidth < 768 ? 10 : 20; // Adjust count for mobile
             const emojis = ['üéâ', 'üí∞', 'üí∏', '‚ú®', 'üëë']; // Win emojis
             const container = dom.floatingEmojiContainer;

             for (let i = 0; i < emojiCount; i++) {
                 const emoji = document.createElement('span');
                 emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                 emoji.classList.add('floating-emoji');
                 // Random start position near the center/bottom of the screen
                 emoji.style.left = `${50 + (Math.random() - 0.5) * 20}vw`;
                 emoji.style.bottom = `${Math.random() * 10}vh`; // Start near the bottom
                 emoji.style.fontSize = `${Math.random() * 1 + 1}rem`; // Random size
                 emoji.style.opacity = Math.random() * 0.5 + 0.5; // Random opacity

                 container.appendChild(emoji);

                 // Remove emoji element after animation
                 emoji.addEventListener('animationend', () => {
                     emoji.remove();
                 }, { once: true });
             }
        }

         // New: Placeholder for MAX Bet Animation (Shake)
         function triggerMaxBetAnimation() {
             console.log("Triggering MAX Bet animation!");
             const maxBetButton = document.querySelector('.quick-bet-buttons button[data-bet-amount="MAX"]');
             if (maxBetButton) {
                 maxBetButton.style.animation = 'none'; // Reset animation
                 maxBetButton.offsetHeight; // Trigger reflow
                 maxBetButton.style.animation = 'shake 0.3s ease-in-out'; // Apply shake animation
             }
         }


        // --- Additional Engagement Features ---

        function checkForDailyReward() {
             const lastLogin = localStorage.getItem('lastLogin');
             const today = new Date().toDateString();

             if (lastLogin !== today) {
                 let streak = parseInt(localStorage.getItem('loginStreak') || '0') + 1;
                 localStorage.setItem('lastLogin', today);
                 localStorage.setItem('loginStreak', streak);

                 if (streak >= 5) {
                     // Award daily reward (e.g., 0.01 SOL)
                     gameState.walletBalance += 0.01; // Simulate adding balance
                     localStorage.setItem('walletBalance', gameState.walletBalance); // Persist balance (simple)
                     dom.walletBalance.textContent = `${gameState.walletBalance.toFixed(2)} SOL`;
                     alert('Daily Reward: 0.01 SOL Free Bet!'); // Replace with inline message
                     localStorage.setItem('loginStreak', '0'); // Reset streak after reward
                 }
             } else {
                 // Already logged in today, maybe show streak status?
                 const streak = localStorage.getItem('loginStreak') || '0';
                 console.log(`Login Streak: ${streak} days`);
             }
        }

        function shareReferral() {
             const referralLink = "YOUR_REFERRAL_LINK_HERE"; // Replace with your actual referral link
             const text = `Join DegenJack & get a bonus! Play blackjack on Solana. ${referralLink} üöÄ`;

             if (navigator.share) {
                 navigator.share({
                     title: 'DegenJack Referral',
                     text: text,
                     url: referralLink, // Optional: share the link directly
                 }).catch(error => console.error('Error sharing:', error));
             } else {
                 // Fallback for browsers that don't support navigator.share
                 window.open(`https://x.com/intent/tweet?text=${encodeURIComponent(text)}`, '_blank'); // Example: Share on X (Twitter)
                 // Or copy to clipboard:
                 // navigator.clipboard.writeText(text).then(() => {
                 //     alert('Referral link copied to clipboard!'); // Replace with inline message
                 // }).catch(err => console.error('Failed to copy:', err));
             }
             playSound(dom.buttonClickSound); // Play sound
        }

        function updateLeaderboard(leaderboardData) {
            dom.leaderboard.innerHTML = ''; // Clear current leaderboard
            if (!leaderboardData || leaderboardData.length === 0) {
                dom.leaderboard.textContent = 'Leaderboard: --';
                return;
            }
            const leaderboardTitle = document.createElement('span');
            leaderboardTitle.textContent = 'Leaderboard: ';
            leaderboardTitle.style.fontWeight = 'bold';
            dom.leaderboard.appendChild(leaderboardTitle);

            leaderboardData.forEach((entry, index) => {
                const entrySpan = document.createElement('span');
                entrySpan.textContent = `${index + 1}. ${entry.player}: ${entry.wins} Wins | `;
                dom.leaderboard.appendChild(entrySpan);
            });
        }

        function showMysteryEvent(eventData) {
             console.log("Mystery Event Triggered:", eventData);
             // Placeholder: Implement UI for mystery event (e.g., Bonus Round banner)
             if (eventData.type === 'bonus_round') {
                 dom.hotTableBanner.textContent = `Bonus Round Active! ${eventData.message || 'Double Payouts!'}`;
                 dom.hotTableBanner.classList.remove('hidden');
                 // Optional: Hide after a duration
                 setTimeout(() => {
                     dom.hotTableBanner.classList.add('hidden');
                 }, eventData.duration || 5000); // Hide after 5 seconds by default
             }
        }

        // Placeholder for Confetti on Join animation
        function triggerConfettiOnJoin() {
             console.log("Triggering confetti on join!");
             // Reuse the existing triggerConfetti function
             triggerConfetti();
        }

        // Placeholder for Auto-Play Timer/Spinner
        function startAutoPlayTimer() {
             console.log("Starting auto-play timer...");
             // Implement a visual timer or spinner animation here
             // This would likely involve adding/updating a DOM element
        }

         // New: Placeholder for Background Particles Animation
         function startBackgroundParticlesAnimation() {
             console.log("Starting background particles animation...");
             const canvas = dom.backgroundParticlesCanvas;
             const ctx = dom.backgroundParticlesCtx;
             const particles = [];
             const particleCount = window.innerWidth < 768 ? 20 : 50; // Adjust count for mobile

             // Create particles (simplified chips/sparkles)
             for (let i = 0; i < particleCount; i++) {
                 particles.push({
                     x: Math.random() * canvas.width,
                     y: Math.random() * canvas.height,
                     size: Math.random() * 5 + 2,
                     color: Math.random() > 0.5 ? '#ffd700' : '#a78bfa', // Gold or Purple
                     speedY: Math.random() * 1 + 0.5, // Float downwards
                     speedX: (Math.random() - 0.5) * 0.5, // Drift horizontally
                     opacity: Math.random() * 0.5 + 0.2, // Semi-transparent
                 });
             }

             function drawParticles() {
                 ctx.clearRect(0, 0, canvas.width, canvas.height);

                 particles.forEach(p => {
                     p.y += p.speedY;
                     p.x += p.speedX;

                     // Reset particle if it goes off screen
                     if (p.y > canvas.height) {
                         p.y = -p.size;
                         p.x = Math.random() * canvas.width;
                     }

                     ctx.fillStyle = p.color;
                     ctx.globalAlpha = p.opacity;
                     ctx.beginPath();
                     ctx.arc(p.x, p.y, p.size / 2, 0, Math.PI * 2); // Draw as circles (simplified chips)
                     ctx.fill();
                 });

                 requestAnimationFrame(drawParticles);
             }

             drawParticles(); // Start animation
         }


        // --- Placeholder Simulation Data (for initial UI testing) ---
        function simulateInitialGameState() {
             // Load persisted state
             gameState.userXP = parseInt(localStorage.getItem('userXP') || '0');
             gameState.userLevel = parseInt(localStorage.getItem('userLevel') || '1');
             gameState.walletBalance = parseFloat(localStorage.getItem('walletBalance') || '0'); // Load simulated balance

             gameState.players = [
                 { id: 'player1', name: 'CryptoKing', level: 7, avatar: 'üòé', hand: [{value: 'K', suit: '‚ô•', revealed: true}, {value: '5', suit: '‚ô¶', revealed: true}], isUser: false, timer: 10, hotStreak: 3, isVIP: false }, // Added revealed and isVIP
                 { id: 'user-wallet-id', name: 'You', level: gameState.userLevel, avatar: 'üòä', hand: [{value: 'Q', suit: '‚ô†', revealed: true}, {value: '8', suit: '‚ô£', revealed: true}], isUser: true, timer: 10, hotStreak: 2, isVIP: true }, // Added revealed and isVIP
                 { id: 'player3', name: 'DegenJane', level: 3, avatar: 'üòÇ', hand: [{value: '2', suit: '‚ô•', revealed: true}, {value: '7', suit: '‚ô¶', revealed: true}], isUser: false, timer: 10, hotStreak: 0, isVIP: false },
             ];
             gameState.dealerHand = [{value: '?', suit: '?', revealed: false}, {value: '10', suit: '‚ô†', revealed: true}]; // Dealer shows one card
             gameState.activePlayerId = 'user-wallet-id'; // Set user as active initially
             gameState.betAmount = parseFloat(localStorage.getItem('currentBet') || '0.5'); // Persist bet amount
             gameState.isSeated = true;
             gameState.chatMessages = [
                 { sender: 'Anon', message: 'gm degens!', badge: '1' },
                 { sender: 'CryptoKing', message: 'let\'s go!', badge: '7' },
             ];
             gameState.recentPlays = [
                 { player: 'Whale', amount: 2.0, win: true },
                 { player: 'You', amount: 0.5, win: false },
                 { player: 'DegenJane', amount: 0.1, win: true },
             ];

             // Simulate a leaderboard
             gameState.leaderboard = [
                 { player: 'CryptoKing', wins: 10 },
                 { player: 'DegenJane', wins: 8 },
                 { player: 'Anon', wins: 5 },
                 { player: 'You', wins: 4 },
                 { player: 'Whale', wins: 3 },
             ];

             // Simulate referral count
             gameState.referralCount = parseInt(localStorage.getItem('referralCount') || '0');


             // Update UI with simulated data
             updateUI();
             // Start the timer animation for the active player
             startTurnTimer(gameState.turnTimerDuration);

             // Simulate a fake chat message every few seconds
             setInterval(() => {
                 const fakeMessages = [
                     { sender: 'Anon' + Math.floor(Math.random() * 100), message: 'wow!', badge: Math.floor(Math.random() * 10) + 1 },
                     { sender: 'WhaleWatcher', message: 'big win!', badge: Math.floor(Math.random() * 20) + 5 },
                     { sender: 'Degen', message: 'lfg!', badge: Math.floor(Math.random() * 5) + 1 },
                 ];
                 const randomMsg = fakeMessages[Math.floor(Math.random() * fakeMessages.length)];
                 // Only add if chat is visible on desktop or chat container is active on mobile
                 if (window.innerWidth > 768 || gameState.chatVisible) {
                      addChatMessageToFeed(randomMsg);
                 }
             }, 10000); // Every 10 seconds

             // Simulate a fake recent play every few seconds
             setInterval(() => {
                 const fakePlays = [
                     { player: 'Anon' + Math.floor(Math.random() * 100), amount: parseFloat((Math.random() * 0.5 + 0.01).toFixed(2)), win: Math.random() > 0.5 },
                     { player: 'WhaleWatcher', amount: parseFloat((Math.random() * 1 + 0.1).toFixed(2)), win: Math.random() > 0.5 },
                 ];
                 const randomPlay = fakePlays[Math.floor(Math.random() * fakePlays.length)];
                 gameState.recentPlays.unshift(randomPlay);
                  if (gameState.recentPlays.length > 10) {
                      gameState.recentPlays.pop();
                  }
                  updateRecentPlaysTicker();
             }, 15000); // Every 15 seconds

             // Simulate Mystery Event (Bonus Round) periodically
             setInterval(() => {
                 showMysteryEvent({ type: 'bonus_round', message: 'Double Payouts!', duration: 10000 }); // Bonus round for 10 seconds
             }, 60000); // Every 60 seconds (1 minute)

             // Simulate referral count increase (for testing)
             setInterval(() => {
                 gameState.referralCount++;
                 localStorage.setItem('referralCount', gameState.referralCount);
                 updateReferralCountDisplay();
             }, 30000); // Every 30 seconds
        }


    </script>

    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>

</body>
</html>
