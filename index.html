<!DOCTYPE html>
<html lang="en" x-data="cryptoDropApp" x-init="init()" :class="{ 'modal-open': modalOpen || walletModalOpen || challengeModalOpen || depositModalOpen }">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#1A1A1A" />
  <meta name="description" content="Play CryptoDrop on MemePicks: Stake SOL, drop orbs, win NFTs and DropTokens!" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>CryptoDrop – MemePicks</title>
  <link rel="icon" href="/favicon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.0/dist/cdn.min.js" defer></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.93.0/lib/index.iife.min.js" defer></script>
  <script>
    const LS_PREFIX = 'memepicks_';
    const BASE_URL = new URLSearchParams(window.location.search).get('env') === 'dev'
      ? 'http://localhost:5001'
      : 'https://memepicks-backend.onrender.com';
    console.log('Using BASE_URL:', BASE_URL);
    const colorMap = {
      '0x': '#9CA3AF',
      '0.5x': '#60A5FA',
      '1x': '#34D399',
      '2x': '#FBBF24',
      '5x': '#F87171',
      '10x': '#A78BFA',
      'Jackpot': '#F472B6'
    };
  </script>
  <style>
    body {
      font-family: 'Sora', sans-serif;
      background: #121212;
      color: #FFFFFF;
      min-height: 100vh;
      margin: 0;
      overscroll-behavior: none;
      position: relative;
      overflow-x: hidden;
    }
    body.modal-open { overflow: hidden; }
    html.dark body {
      background: #0A0A0A;
      color: #FFFFFF;
    }
    .card {
      @apply bg-gray-800 rounded-xl p-4 mb-4 shadow-lg flex flex-col gap-3 transition-all duration-300 ease-out;
      position: relative;
      will-change: transform, box-shadow;
    }
    @media (hover: hover) and (pointer: fine) {
      .card:hover {
        @apply shadow-purple-400/40 scale-[1.02] -translate-y-0.5;
        box-shadow: 0 8px 25px rgba(167, 139, 250, 0.3);
      }
    }
    .card:active { @apply scale-[0.98]; }
    .button-primary, .button-secondary, .button-auth {
      @apply px-4 py-3 min-h-[48px] min-w-[80px] text-sm font-semibold rounded-lg transition-all duration-200 ease-out cursor-pointer inline-flex items-center justify-center shadow-md disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none disabled:transform-none;
      touch-action: manipulation;
      will-change: transform, box-shadow, background-color;
    }
    .button-primary { @apply bg-gradient-to-r from-purple-500 to-blue-500 text-white border-transparent; }
    .button-secondary { @apply bg-transparent border border-purple-500 text-purple-400; }
    .button-auth { @apply bg-gradient-to-r from-purple-500 to-blue-500 text-white font-semibold px-4 py-2 rounded-lg min-h-[44px] shadow-md; }
    @media (hover: hover) and (pointer: fine) {
      .button-primary:hover:not(:disabled), .button-secondary:hover:not(:disabled), .button-auth:hover:not(:disabled) {
        @apply shadow-lg shadow-purple-500/50 scale-[1.03] -translate-y-px;
      }
    }
    .button-primary:active:not(:disabled), .button-secondary:active:not(:disabled), .button-auth:active:not(:disabled) {
      @apply scale-[0.97] transform-none shadow-md;
      animation: buttonSquash 0.2s ease-out;
    }
    .button-primary:disabled, .button-secondary:disabled, .button-auth:disabled {
      @apply bg-gray-600 text-gray-400 border-gray-600;
    }
    .button-primary:focus-visible, .button-secondary:focus-visible, .button-auth:focus-visible {
      outline: 2px solid #7B61FF;
      outline-offset: 2px;
    }
    @keyframes buttonSquash {
      0% { transform: scale(1, 1); }
      50% { transform: scale(0.95, 0.85); }
      100% { transform: scale(1, 1); }
    }
    .modal {
      @apply bg-gray-900 rounded-t-xl p-4 w-full max-w-full shadow-[-4px_0px_12px_rgba(0,0,0,0.3)] transition-transform duration-350 ease-out fixed bottom-0 left-0 z-[80] box-border max-h-[90vh] overflow-y-auto;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      transform: translateY(100%);
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }
    .modal.open { @apply translate-y-0; }
    .modal-container {
      @apply bg-black/60 transition-opacity duration-300 ease-in-out fixed inset-0 z-[75] opacity-0 pointer-events-none;
      backdrop-filter: blur(6px);
    }
    .modal-container.open { @apply opacity-100 pointer-events-auto; }
    .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px) scale(0.99); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .glow { animation: glow 1.8s ease-in-out infinite; }
    @keyframes glow {
      0%, 100% { @apply shadow-lg shadow-purple-500/20; }
      50% { @apply shadow-xl shadow-purple-500/40; }
    }
    #plinko-board {
      position: relative;
      width: 100%;
      max-width: 400px;
      height: 450px;
      margin: 0 auto;
      border-radius: 8px;
      overflow: hidden;
      transition: box-shadow 0.5s ease-out;
    }
    .board-pulse {
      animation: boardPulse 2s ease-in-out infinite;
    }
    @keyframes boardPulse {
      0%, 100% { box-shadow: 0 0 20px rgba(123, 97, 255, 0.5); }
      50% { box-shadow: 0 0 40px rgba(244, 114, 182, 0.8); }
    }
    #orb {
      position: absolute;
      width: 16px;
      height: 16px;
      background: radial-gradient(circle, #fecdd3, #f472b6);
      border-radius: 50%;
      box-shadow: 0 0 10px #f472b6, 0 0 5px white;
      z-index: 10;
      will-change: top, left, transform;
    }
    #orb.explode {
      animation: orbExplode 0.6s ease-out forwards;
    }
    @keyframes orbExplode {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(2); opacity: 0; }
    }
    .peg {
      position: absolute;
      width: 8px;
      height: 8px;
      background-color: #a78bfa;
      border-radius: 50%;
      box-shadow: 0 0 4px rgba(167,139,250,0.7);
      transition: background-color 0.2s ease;
    }
    .peg.hit {
      animation: pegHit 0.3s ease-out;
    }
    @keyframes pegHit {
      0% { transform: scale(1); background-color: #c4b5fd; }
      50% { transform: scale(1.5); background-color: #ffffff; }
      100% { transform: scale(1); background-color: #a78bfa; }
    }
    .slot-container {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      display: flex;
      justify-content: space-around;
      padding: 0 5px;
    }
    .slot {
      width: 30px;
      height: 30px;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      padding-bottom: 2px;
      font-size: 10px;
      font-weight: 600;
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      position: relative;
      cursor: default;
      transition: transform 0.3s ease-out, box-shadow 0.3s ease-out;
    }
    .slot.winning {
      animation: slotBounce 0.8s ease-in-out;
      box-shadow: 0 0 15px currentColor, 0 0 30px currentColor;
    }
    @keyframes slotBounce {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-12px) scale(1.2); }
    }
    .slot-glow {
      animation: slotGlow 0.5s ease-in-out 2;
    }
    @keyframes slotGlow {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
    }
    .slot-label {
      @apply text-xs font-semibold text-center mt-1;
    }
    .chat-feed {
      @apply h-48 bg-gray-900 rounded-lg p-2 overflow-y-auto mb-2 flex flex-col-reverse;
      scrollbar-width: thin;
      scrollbar-color: #7B61FF #374151;
    }
    .chat-message { @apply mb-1.5 text-xs; }
    .chat-message .username { @apply font-semibold text-purple-400 mr-1; }
    .chat-message .win-amount { @apply font-bold text-green-400 ml-1; }
    .toast {
      @apply fixed bottom-20 left-1/2 transform -translate-x-1/2 text-white text-sm py-2 px-4 rounded-lg z-[100] shadow-lg;
      animation: toastFade 0.4s ease-out forwards, toastSlideUp 0.4s ease-out forwards;
      max-width: 90%;
    }
    @keyframes toastFade {
      0% { opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { opacity: 0; }
    }
    @keyframes toastSlideUp {
      from { transform: translate(-50%, 20px); }
      to { transform: translate(-50%, 0); }
    }
    .toast-success { @apply bg-gradient-to-r from-green-500 to-emerald-500; }
    .toast-error { @apply bg-gradient-to-r from-red-500 to-pink-500; }
    .toast-info { @apply bg-gradient-to-r from-blue-500 to-indigo-500; }
    .dynamic-background {
      position: fixed;
      inset: 0;
      z-index: -1;
      animation: backgroundFlow 10s linear infinite;
      background: linear-gradient(
        45deg,
        rgba(123,97,255,0.3),
        rgba(255,105,180,0.3),
        rgba(52,211,153,0.3),
        rgba(123,97,255,0.3)
      );
      background-size: 600% 600%;
    }
    @keyframes backgroundFlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .dynamic-background.celebrate {
      background: linear-gradient(
        45deg,
        rgba(255,215,0,0.5),
        rgba(255,165,0,0.5),
        rgba(255,215,0,0.5)
      );
      animation: celebrateFlow 2s linear infinite;
    }
    @keyframes celebrateFlow {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    #plinko-board.addiction-glow {
      transition: box-shadow 0.5s ease-out;
    }
    .anticipation-glow {
      position: absolute;
      inset: -10px;
      border-radius: 12px;
      background: rgba(123,97,255,0);
      box-shadow: 0 0 0px rgba(123,97,255,0);
      animation: anticipation 1.5s cubic-bezier(0.4,0,0.2,1) infinite;
      z-index: 5;
      pointer-events: none;
    }
    @keyframes anticipation {
      0%, 100% { opacity: 0.4; box-shadow: 0 0 15px rgba(123,97,255,0.3); transform: scale(1); }
      50% { opacity: 1; box-shadow: 0 0 35px rgba(123,97,255,0.7); transform: scale(1.05); }
    }
    .reward-explosion {
      position: absolute;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      pointer-events: none;
      z-index: 20;
      animation: rewardPop 0.8s cubic-bezier(0.175,0.885,0.32,1.275) forwards;
    }
    @keyframes rewardPop {
      0% { transform: scale(0); opacity: 1; }
      60% { transform: scale(2.5); opacity: 0.7; }
      100% { transform: scale(2); opacity: 0; }
    }
    .win-streak {
      @apply fixed top-20 right-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-full text-base font-bold z-[90] shadow-xl;
      animation: streakPop 0.6s cubic-bezier(0.175,0.885,0.32,1.275);
    }
    @keyframes streakPop {
      0% { transform: scale(0) rotate(-15deg); opacity: 0; }
      70% { transform: scale(1.15) rotate(5deg); }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    #particle-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      pointer-events: none;
    }
    .jackpot-pulse {
      background: linear-gradient(270deg, #ff6f00, #ff4081, #7b61ff);
      background-size: 600% 600%;
      animation: gradientShift 4s ease infinite;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .orb-trail {
      position: absolute;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(244,114,182,0.5);
      opacity: 1;
      filter: blur(2px);
      transition: opacity 0.8s ease-out, transform 0.8s ease-out;
      z-index: 9;
      pointer-events: none;
    }
    .sticky-drop-button {
      @apply fixed bottom-[70px] right-4 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-full px-5 py-3 shadow-lg z-[70] text-sm font-semibold transition-all duration-300 ease-out opacity-0 pointer-events-none;
      transform: translateY(20px);
      animation: pulseSticky 2s ease-in-out infinite;
    }
    @keyframes pulseSticky {
      0%, 100% { transform: translateY(20px) scale(1); }
      50% { transform: translateY(20px) scale(1.1); }
    }
    .sticky-drop-button.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }
    .slot-tooltip {
      @apply absolute bottom-full left-1/2 mb-2 -translate-x-1/2 bg-gray-700 text-white text-xs px-2 py-1 rounded shadow-lg whitespace-nowrap opacity-0 invisible transition-opacity duration-200 pointer-events-none;
      z-index: 30;
    }
    .slot:hover .slot-tooltip {
      @apply opacity-100 visible;
    }
    .progress-bar-container {
      @apply w-full bg-gray-700 h-2 rounded-full overflow-hidden;
    }
    .progress-bar {
      @apply bg-gradient-to-r from-purple-500 to-blue-500 h-full rounded-full transition-all duration-500 ease-out;
    }
    .orb-drop-trigger {
      animation: craveAttention 1.2s cubic-bezier(0.68,-0.55,0.27,1.55) infinite;
    }
    @keyframes craveAttention {
      0% { transform: scale(1); }
      50% { transform: scale(1.15) rotate(3deg); }
      100% { transform: scale(1); }
    }
    .faux-progress {
      position: relative;
      overflow: hidden;
    }
    .faux-progress::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 50%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      animation: fakeProgress 2.5s infinite;
    }
    @keyframes fakeProgress {
      100% { left: 200%; }
    }
    .near-miss-flash {
      animation: nearMiss 0.8s ease-out;
    }
    @keyframes nearMiss {
      0% { background: #ff000080; }
      100% { background: transparent; }
    }
    .addiction-timer {
      position: fixed;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: #ff4757;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      box-shadow: 0 0 15px #ff475740;
    }
    .loader-orb {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 60px;
      height: 60px;
      background: radial-gradient(circle, #f472b6, #7b61ff);
      border-radius: 50%;
      animation: pulseLoader 2s ease-in-out infinite;
      z-index: 1000;
    }
    @keyframes pulseLoader {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.5); opacity: 0.7; }
      100% { transform: scale(1); opacity: 1; }
    }
    .confetti {
      position: absolute;
      width: 8px;
      height: 8px;
      background: #f472b6;
      opacity: 0.8;
      animation: confettiFall 2s linear forwards;
      pointer-events: none;
      z-index: 20;
    }
    @keyframes confettiFall {
      0% { transform: translateY(0) rotate(0deg); opacity: 0.8; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    .floating-orb {
      position: absolute;
      width: 10px;
      height: 10px;
      background: radial-gradient(circle, #a78bfa, transparent);
      border-radius: 50%;
      animation: floatUp 10s linear infinite;
      z-index: -1;
    }
    @keyframes floatUp {
      0% { transform: translateY(100vh); opacity: 0.5; }
      100% { transform: translateY(-100vh); opacity: 0; }
    }
    .win-text {
      @apply fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-2xl font-bold z-[100] text-yellow-300;
      animation: winTextPop 1.5s ease-out forwards;
    }
    @keyframes winTextPop {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
    }
    .vignette {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle, transparent 50%, rgba(0,0,0,0.7) 100%);
      opacity: 0;
      pointer-events: none;
      z-index: 50;
      transition: opacity 0.5s ease-out;
    }
    .vignette.active {
      opacity: 1;
    }
    .coin-shower {
      position: absolute;
      width: 12px;
      height: 12px;
      background: #FFD700;
      border-radius: 50%;
      animation: coinFall 1.5s linear forwards;
      pointer-events: none;
      z-index: 20;
    }
    @keyframes coinFall {
      0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
    }
    .crypto-mascot {
      position: absolute;
      top: -40px;
      right: -40px;
      width: 60px;
      height: 60px;
      background: url('/assets/mascot.png') no-repeat center;
      background-size: cover;
      animation: mascotFloat 3s ease-in-out infinite;
      z-index: 30;
    }
    @keyframes mascotFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    .crypto-mascot.win {
      animation: mascotCelebrate 1s ease-out;
    }
    @keyframes mascotCelebrate {
      0% { transform: scale(1) rotate(0); }
      50% { transform: scale(1.5) rotate(15deg); }
      100% { transform: scale(1) rotate(0); }
    }
    .screen-shake {
      animation: shake 0.5s ease-in-out;
    }
    @keyframes shake {
      0%, 100% { transform: translate(0, 0); }
      25% { transform: translate(-5px, 2px); }
      50% { transform: translate(5px, -2px); }
      75% { transform: translate(-2px, 1px); }
    }
  </style>
</head>
<body class="text-white"
      @click.outside="if(modalOpen || walletModalOpen || challengeModalOpen || depositModalOpen) closeModals()"
      @keydown.escape.window="if(modalOpen || walletModalOpen || challengeModalOpen || depositModalOpen) closeModals()"
      @mousemove="updateMousePos($event)"
      @scroll="handleScroll()">
  <div class="dynamic-background" :class="{ 'celebrate': celebrating }"></div>
  <canvas id="particle-canvas"></canvas>
  <div x-show="!walletConnected" class="fixed top-4 left-4 bg-indigo-700 text-white text-sm font-bold py-1 px-3 rounded-full z-[90] animate-pulse" aria-live="polite">
    Free Mode: <span x-text="faucetBalance.toFixed(3)"></span> SOL
  </div>
  <div class="fixed top-14 left-0 right-0 bg-gradient-to-r from-purple-600 to-pink-600 text-white text-center py-2 z-[90] animate-pulse">
    <span>Global Jackpot: <span x-text="jackpotAmount.toFixed(3)"></span> SOL</span>
  </div>
  <header class="fixed top-0 left-0 w-full z-[70] h-14 bg-gray-900/80 backdrop-blur-sm border-b border-gray-700/50 flex items-center justify-between px-4" data-component="header">
    <div class="text-lg font-semibold text-[#7B61FF]">MemePicks</div>
    <h1 class="text-xl font-bold text-white">CryptoDrop</h1>
    <div class="flex items-center space-x-2">
      <a href="/" class="button-secondary text-sm min-h-[44px] px-3 py-2" aria-label="Back to MemePicks">Back</a>
      <button class="button-auth text-sm min-h-[44px] px-3 py-2" @click="walletConnected ? disconnectWallet() : openWalletModal()" x-text="walletConnected ? 'Disconnect' : 'Connect'" :aria-label="walletConnected ? 'Disconnect Wallet' : 'Connect Wallet'"></button>
    </div>
  </header>
  <main class="container mx-auto px-4 pt-20 pb-24 flex flex-col md:flex-row gap-6 relative z-10" data-component="main-content">
    <section class="flex-grow md:w-2/3" data-component="game-board">
      <div id="plinko-board" class="card bg-gray-800/70 backdrop-blur-sm p-4 rounded-xl relative overflow-visible board-pulse" :class="{ 'addiction-glow': consecutivePlays > 0 }">
        <div x-ref="plinkoBoardRef" class="w-full h-[450px] relative">
          <div class="crypto-mascot" :class="{ 'win': celebrating }"></div>
        </div>
        <div class="slot-container"></div>
        <div class="vignette" :class="{ 'active': dropping || celebrating }"></div>
      </div>
      <section id="controls" class="card bg-gray-800/70 backdrop-blur-sm p-4 rounded-xl mt-4 fade-in" data-component="controls">
        <div class="flex justify-between items-center mb-3">
          <h2 class="text-base font-semibold text-[#7B61FF]">Place Your Drop</h2>
          <button class="button-secondary text-xs px-3 py-1 min-h-[32px]" @click="openBoardModal" x-text="`Board: ${selectedBoard}`" aria-label="Change board type"></button>
        </div>
        <div class="mb-3">
          <label for="bet-amount" class="block text-xs text-gray-400 mb-1">Bet Amount (SOL)</label>
          <div class="flex items-center gap-2">
            <input type="number" id="bet-amount" step="0.001" min="0.001" max="1" x-model.number="betAmount"
                   class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                   :disabled="dropping"
                   aria-label="Bet amount in SOL">
            <button class="button-secondary text-xs px-2 py-1" @click="betAmount = Math.max(0.001, betAmount - 0.001)" :disabled="dropping" aria-label="Decrease bet">-</button>
            <button class="button-secondary text-xs px-2 py-1" @click="betAmount = Math.min(1, betAmount + 0.001)" :disabled="dropping" aria-label="Increase bet">+</button>
          </div>
        </div>
        <div class="flex gap-2 mb-3">
          <button class="button-secondary text-xs px-3 py-1" @click="betAmount = 0.001" :disabled="dropping" aria-label="Set minimum bet">Min</button>
          <button class="button-secondary text-xs px-3 py-1" @click="betAmount = walletConnected ? Math.min(walletBalance, 1) : Math.min(faucetBalance, 1)" :disabled="dropping" aria-label="Set maximum bet">Max</button>
          <button class="button-secondary text-xs px-3 py-1" @click="betAmount *= 2" :disabled="dropping || (walletConnected ? betAmount * 2 > walletBalance : betAmount * 2 > faucetBalance)" aria-label="Double bet">2x</button>
          <button class="button-secondary text-xs px-3 py-1" @click="betAmount /= 2" :disabled="dropping || betAmount / 2 < 0.001" aria-label="Half bet">½</button>
        </div>
        <div class="flex gap-2 mb-3">
          <button class="button-primary text-sm px-3 py-2 flex-1" @click="toggleAutoDrop()" :class="{ 'bg-red-500': autoDrop }" x-text="autoDrop ? 'Stop Auto-Drop' : 'Auto-Drop'" :disabled="dropping && !autoDrop" aria-label="Toggle auto-drop"></button>
          <button class="button-primary text-sm px-3 py-2 flex-1" @click="dropMultiple(10)" :disabled="dropping || (walletConnected ? walletBalance < betAmount * 10 : faucetBalance < betAmount * 10)" aria-label="Drop 10 times">Drop x10</button>
          <button class="button-primary text-sm px-3 py-2 flex-1" @click="fastMode = !fastMode" :class="{ 'bg-green-500': fastMode }" x-text="fastMode ? 'Normal Mode' : 'Fast Mode'" aria-label="Toggle fast mode"></button>
        </div>
        <button id="drop-button" class="orb-drop-trigger button-primary w-full text-lg font-bold py-4 glow" @click="dropOrb()" :disabled="dropping || (!walletConnected && faucetBalance < betAmount) || (walletConnected && (walletBalance === null || walletBalance < betAmount))">
          <span x-show="!dropping">INSTANT WIN! <span x-text="betAmount.toFixed(3)"></span> SOL 🎰</span>
          <span x-show="dropping">Dropping...</span>
        </button>
        <div class="flex justify-between items-center mt-3 text-xs text-gray-400">
          <span>Balance:</span>
          <span x-text="walletConnected ? (walletBalance !== null ? walletBalance.toFixed(5) + ' SOL' : 'Loading...') : faucetBalance.toFixed(3) + ' SOL (Free)'"></span>
        </div>
        <div class="flex justify-between items-center mt-2 text-xs text-gray-400">
          <span>Drop Streak: <span class="font-semibold text-white" x-text="consecutiveWins > 0 ? `🔥 ${consecutiveWins} Wins` : '0'"></span></span>
          <span>Total Drops: <span class="font-semibold text-white" x-text="totalDrops"></span></span>
        </div>
        <div class="mt-3">
          <span class="text-xs text-gray-400 block mb-1">XP to Level <span x-text="level + 1"></span></span>
          <div class="progress-bar-container">
            <div class="progress-bar" :style="`width: ${(xp % 100)}%`"></div>
          </div>
        </div>
        <div class="text-xs text-gray-400 mt-2">
          <span>Today's Spent: <span x-text="(plays * betAmount).toFixed(3)"></span> SOL</span>
          <span class="mx-2">•</span>
          <span>Potential Wins: <span x-text="(plays * betAmount * 2).toFixed(3)"></span> SOL</span>
        </div>
      </section>
    </section>
    <aside class="md:w-1/3 space-y-4" data-component="info-feed">
      <section class="card bg-gray-800/70 backdrop-blur-sm p-4 rounded-xl fade-in" data-component="last-drop">
        <h2 class="text-sm font-semibold text-[#7B61FF] mb-2">Last Drop</h2>
        <div class="text-sm text-gray-300 min-h-[20px]" x-html="dropResult" aria-live="polite">No drop yet.</div>
      </section>
      <section class="card bg-gray-800/70 backdrop-blur-sm p-4 rounded-xl fade-in" data-component="leaderboard">
        <h2 class="text-sm font-semibold text-[#7B61FF] mb-2">Top Droppers</h2>
        <ul class="text-xs text-gray-300" role="list">
          <template x-for="player in leaderboard" :key="player.id">
            <li class="flex justify-between py-1">
              <span x-text="player.username"></span>
              <span x-text="player.wins + ' SOL'"></span>
            </li>
          </template>
        </ul>
      </section>
      <section class="card bg-gray-800/70 backdrop-blur-sm p-4 rounded-xl fade-in" data-component="community-feed">
        <h2 class="text-sm font-semibold text-[#7B61FF] mb-2">Recent Wins</h2>
        <div class="chat-feed" x-ref="chatFeed" role="log" aria-label="Recent CryptoDrop Wins">
          <template x-for="message in communityMessages" :key="message.id">
            <div class="chat-message">
              <span class="username" x-text="message.username"></span>
              <span x-text="message.text"></span>
              <span class="win-amount" x-text="message.reward ? `(+${message.reward} SOL)` : ''"></span>
            </div>
          </template>
          <div x-show="communityMessages.length === 0" class="text-center text-gray-500 text-xs mt-4">No recent wins yet.</div>
        </div>
      </section>
    </aside>
  </main>
  <button class="sticky-drop-button" :class="{ 'visible': showStickyButton }" @click="dropOrb()" :disabled="dropping || (!walletConnected && faucetBalance < betAmount) || (walletConnected && (walletBalance === null || walletBalance < betAmount))">
    Drop Again? ⏳
  </button>
  <div id="boardModal" class="fixed inset-0 z-[80]" x-show="modalOpen" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" role="dialog" aria-modal="true" aria-labelledby="board-modal-title" data-component="board-modal">
    <div class="modal-container" :class="{ 'open': modalOpen }" @click="closeModals"></div>
    <div class="modal" :class="{ 'open': modalOpen }" @click.stop>
      <div class="flex justify-between items-center mb-4">
        <h2 id="board-modal-title" class="text-base font-semibold text-[#7B61FF]">Choose Board</h2>
        <button class="text-gray-400 hover:text-red-500 w-8 h-8 flex items-center justify-center text-2xl" @click="closeModals" aria-label="Close board selection modal">✕</button>
      </div>
      <div class="grid grid-cols-2 gap-2">
        <button class="button-primary text-sm min-h-[44px]" :class="{ 'opacity-70': selectedBoard === 'Standard' }" @click="selectBoard('Standard')" aria-label="Select Standard Plinko Board">Standard</button>
        <button class="button-primary text-sm min-h-[44px]" :class="{ 'opacity-70': selectedBoard === 'High Risk' }" @click="selectBoard('High Risk')" aria-label="Select High Risk Plinko Board">High Risk</button>
        <button class="button-primary text-sm min-h-[44px]" :class="{ 'opacity-70': selectedBoard === 'NFT Boost' }" @click="selectBoard('NFT Boost')" aria-label="Select NFT Boost Plinko Board">NFT Boost</button>
        <button class="button-primary text-sm min-h-[44px]" :class="{ 'opacity-70': selectedBoard === 'Jackpot' }" @click="selectBoard('Jackpot')" aria-label="Select Jackpot Plinko Board">Jackpot</button>
      </div>
      <button class="button-secondary w-full text-sm mt-4 min-h-[44px]" @click="closeModals" aria-label="Cancel board selection">Cancel</button>
    </div>
  </div>
  <div id="walletChoiceModal" class="fixed inset-0 z-[80]" x-show="walletModalOpen" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" role="dialog" aria-modal="true" aria-labelledby="wallet-choice-modal-title" data-component="wallet-modal">
    <div class="modal-container" :class="{ 'open': walletModalOpen }" @click="closeModals"></div>
    <div class="modal" :class="{ 'open': walletModalOpen }" @click.stop>
      <div class="flex justify-between items-center mb-4">
        <h3 id="wallet-choice-modal-title" class="text-base font-semibold text-[#7B61FF]">Choose Wallet</h3>
        <button class="text-gray-400 hover:text-red-500 w-8 h-8 flex items-center justify-center text-2xl" @click="closeModals" aria-label="Close wallet choice modal">✕</button>
      </div>
      <div class="space-y-3">
        <button class="button-primary w-full text-sm flex items-center justify-center gap-2 min-h-[44px]" @click="connectWallet('phantom')" aria-label="Connect with Phantom Wallet">
          <svg class="w-5 h-5" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M18.0002 48C8.05822 48 0 39.9418 0 30V18.0002C0 8.05822 8.05822 0 18.0002 0H30C39.9418 0 48 8.05822 48 18.0002V30C48 39.9418 39.9418 48 30 48H18.0002ZM24.0003 31.861C28.718 31.861 32.5717 28.0073 32.5717 23.2896C32.5717 18.5719 28.718 14.7182 24.0003 14.7182C19.2826 14.7182 15.4289 18.5719 15.4289 23.2896C15.4289 28.0073 19.2826 31.861 24.0003 31.861Z" fill="currentColor"></path></svg>
          Phantom
        </button>
        <button class="button-primary w-full text-sm flex items-center justify-center gap-2 min-h-[44px]" @click="connectWallet('solflare')" aria-label="Connect with Solflare Wallet">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8zm4.818-10.585l-2.828 2.828-1.414-1.414 4.242-4.242 1.414 1.414-1.414 1.414zm-9.636 0l4.242 4.242-1.414 1.414-4.242-4.242 1.414-1.414z" fill="currentColor"></path></svg>
          Solflare
        </button>
      </div>
      <button class="button-secondary w-full text-sm mt-4 min-h-[44px]" @click="closeModals" aria-label="Cancel wallet connection">Cancel</button>
    </div>
  </div>
  <div id="challengeModal" class="fixed inset-0 z-[80]" x-show="challengeModalOpen" role="dialog" aria-modal="true" aria-labelledby="challenge-modal-title">
    <div class="modal-container" :class="{ 'open': challengeModalOpen }" @click="challengeModalOpen = false"></div>
    <div class="modal" :class="{ 'open': challengeModalOpen }">
      <h2 id="challenge-modal-title" class="text-base font-semibold text-[#7B61FF] mb-4">Daily Challenges</h2>
      <ul class="space-y-3">
        <li class="flex justify-between text-sm">
          <span>Drop 10 Orbs</span>
          <span x-text="challenges.drop10 ? '✅ Completed' : '0.01 SOL'"></span>
        </li>
        <li class="flex justify-between text-sm">
          <span>Win 0.005 SOL</span>
          <span x-text="challenges.win005 ? '✅ Completed' : '0.02 SOL'"></span>
        </li>
      </ul>
      <button class="button-primary w-full mt-4" @click="challengeModalOpen = false" aria-label="Close challenges">Claim Later</button>
    </div>
  </div>
  <div id="depositModal" class="fixed inset-0 z-[80]" x-show="depositModalOpen" role="dialog" aria-modal="true" aria-labelledby="deposit-modal-title">
    <div class="modal-container" :class="{ 'open': depositModalOpen }" @click="depositModalOpen = false"></div>
    <div class="modal" :class="{ 'open': depositModalOpen }">
      <h2 id="deposit-modal-title" class="text-base font-semibold text-[#7B61FF] mb-4">Low Balance!</h2>
      <p class="text-sm text-gray-300 mb-4">Deposit SOL to keep dropping and win big!</p>
      <button class="button-primary w-full" @click="depositSOL" aria-label="Deposit SOL">Deposit Now</button>
      <button class="button-secondary w-full mt-2" @click="depositModalOpen = false" aria-label="Continue in free mode">Continue Free</button>
    </div>
  </div>
  <footer class="fixed bottom-0 left-0 w-full bg-gray-900/80 backdrop-blur-sm border-t border-gray-700/50 text-center text-xs text-gray-400 py-2 z-[50]" style="padding-bottom: calc(8px + env(safe-area-inset-bottom))" data-component="footer">
    3% staking fee | <a href="/bet" class="text-purple-500 hover:underline" aria-label="Try MemePicks Betting">Try MemePicks Betting</a> | Powered by MemePicks
  </footer>
  <audio id="bgMusic" loop preload="auto" src="/assets/sounds/casino-ambience.mp3" x-ref="bgMusic"></audio>
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('cryptoDropApp', () => ({
        walletConnected: false,
        walletAddress: null,
        walletBalance: null,
        faucetBalance: 5.000,
        connection: null,
        selectedBoard: 'Standard',
        betAmount: 0.001,
        dropping: false,
        dropResult: 'Place your first drop!',
        orbElement: null,
        pegElements: [],
        slotElements: [],
        boardRect: null,
        currentAnimationId: null,
        consecutivePlays: 0,
        consecutiveWins: 0,
        lastWinTime: null,
        totalDrops: 0,
        progress: 0,
        plays: 0,
        level: 1,
        xp: 0,
        loginStreak: 0,
        modalOpen: false,
        walletModalOpen: false,
        challengeModalOpen: false,
        depositModalOpen: false,
        communityMessages: [],
        socket: null,
        showStickyButton: false,
        particleCtx: null,
        particles: [],
        mouseX: window.innerWidth / 2,
        mouseY: window.innerHeight / 2,
        audioContext: null,
        sounds: {},
        celebrating: false,
        jackpotAmount: 10.0,
        autoDrop: false,
        fastMode: false,
        username: 'Guest',
        leaderboard: [
          { id: 1, username: 'CryptoKing', wins: 5.123 },
          { id: 2, username: 'NFTWhale', wins: 3.456 },
          { id: 3, username: 'SolSniper', wins: 2.789 },
          { id: 4, username: 'DropMaster', wins: 1.234 },
          { id: 5, username: 'LuckyStar', wins: 0.987 }
        ],
        challenges: { drop10: false, win005: false },
        showTutorial: !localStorage.getItem(LS_PREFIX + 'tutorialSeen'),
        BOARD_WIDTH: 400,
        BOARD_HEIGHT: 450,
        PEG_ROWS: 12,
        PEG_SIZE: 8,
        SLOT_COUNT: 9,
       _clockwise: true,
        SLOT_WIDTH: 30,
        SLOT_HEIGHT: 30,
        outcomes: [
          { slot: '0x', rewardMult: 0, weight: 0.20, color: colorMap['0x'] },
          { slot: '0.5x', rewardMult: 0.5, weight: 0.25, color: colorMap['0.5x'] },
          { slot: '1x', rewardMult: 1, weight: 0.25, color: colorMap['1x'] },
          { slot: '2x', rewardMult: 2, weight: 0.15, color: colorMap['2x'] },
          { slot: '5x', rewardMult: 5, weight: 0.10, color: colorMap['5x'] },
          { slot: '10x', rewardMult: 10, weight: 0.04, color: colorMap['10x'] },
          { slot: 'Jackpot', rewardMult: 50, weight: 0.01, color: colorMap['Jackpot'] }
        ],
        addictionMechanics: {
          fakeLuckyStreak: 0,
          timeSpent: 0,
          forcedFOMO: null,
          calculateReward(betAmount, lossesInRow) {
            const baseChance = 0.15;
            const lossAdjustment = lossesInRow > 3 ? 0.05 * Math.min(lossesInRow - 3, 5) : 0;
            const addictionFactor = 1 + (this.timeSpent * 0.01);
            let winChance = baseChance * addictionFactor + lossAdjustment;
            if (Math.random() < 0.5) {
              const nearMissSlot = this.outcomes[Math.floor(Math.random() * (this.outcomes.length - 3)) + 3];
              this.showToast(`So close to ${nearMissSlot.slot}! Try again!`, 'error');
              const slotElement = document.querySelector(`.slot[data-tooltip*="${nearMissSlot.slot}"]`);
              if (slotElement) {
                slotElement.classList.add('near-miss-flash');
                setTimeout(() => slotElement.classList.remove('near-miss-flash'), 800);
                this.playSound('near-miss');
              }
              const adjacentSlots = [
                this.slotElements[Math.max(0, slotIndex - 1)],
                this.slotElements[Math.min(this.slotElements.length - 1, slotIndex + 1)]
              ].filter(s => s && s.outcome.rewardMult >= 2);
              adjacentSlots.forEach(s => {
                s.element.classList.add('slot-glow');
                setTimeout(() => s.element.classList.remove('slot-glow'), 1000);
              });
            }
            if (Math.random() < winChance) {
              return this.forceWin(betAmount);
            }
            return this.generateLoss();
          },
          forceWin(betAmount) {
            this.fakeLuckyStreak++;
            if (this.fakeLuckyStreak > 2 && !this.walletConnected) {
              setTimeout(() => this.depositModalOpen = true, 3000);
            }
            const winOutcomes = this.outcomes.filter(o => o.rewardMult >= 0.5 && o.rewardMult <= 5);
            const outcome = winOutcomes[Math.floor(Math.random() * winOutcomes.length)];
            return { slot: outcome.slot, reward: (betAmount * outcome.rewardMult).toFixed(5) + ' SOL' };
          },
          generateLoss() {
            this.fakeLuckyStreak = 0;
            return { slot: '0x', reward: '0 SOL' };
          },
          startFOMO() {
            this.forcedFOMO = setInterval(() => {
              const fakeUsers = ['ProGambler42', 'CryptoWhale', 'NFTKingpin', 'SolCelebrity'];
              const fakeWin = this.outcomes[Math.floor(Math.random() * (this.outcomes.length - 2)) + 2];
              this.communityMessages = [{
                id: Date.now(),
                username: fakeUsers[Math.floor(Math.random() * fakeUsers.length)],
                text: `just won ${fakeWin.rewardMult}x on ${fakeWin.slot}!`,
                reward: (this.betAmount * fakeWin.rewardMult).toFixed(5)
              }, ...this.communityMessages.slice(0, 9)];
            }, 4000);
          }
        },
        init() {
          console.log('Initializing CryptoDrop App...');
          this.showLoader();
          if (!this.walletAddress) {
            this.showToast('Playing in Free Mode! Connect wallet for real rewards.', 'info', 5000);
          }
          try {
            this.walletAddress = localStorage.getItem(LS_PREFIX + 'walletAddress') || null;
            this.walletConnected = !!this.walletAddress;
            if (this.walletConnected) {
              this.connection = new SolanaWeb3.Connection(
                SolanaWeb3.clusterApiUrl(BASE_URL.includes('localhost') ? 'devnet' : 'mainnet-beta'),
                'confirmed'
              );
              this.getWalletBalance(this.walletAddress).catch(err => {
                console.error('Initial balance fetch failed:', err);
                this.showToast('Failed to load balance.', 'error');
              });
              this.username = this.walletAddress.slice(0, 4) + '...' + this.walletAddress.slice(-4);
            }
          } catch (err) {
            console.error('Wallet init failed:', err);
            this.showToast('Wallet initialization error.', 'error');
            localStorage.removeItem(LS_PREFIX + 'walletAddress');
            this.walletConnected = false;
            this.walletAddress = null;
          }
          this.initSocket();
          this.initBoard();
          this.initParticles();
          this.initAudio();
          this.totalDrops = parseInt(localStorage.getItem(LS_PREFIX + 'totalDrops') || '0');
          this.plays = parseInt(localStorage.getItem(LS_PREFIX + 'plays') || '0');
          this.xp = parseInt(localStorage.getItem(LS_PREFIX + 'xp') || '0');
          this.level = Math.floor(this.xp / 100) + 1;
          this.loginStreak = parseInt(localStorage.getItem(LS_PREFIX + 'loginStreak') || '0');
          this.checkDailyLogin();
          this.updateBoardGlow();
          this.addictionMechanics.startFOMO();
          setTimeout(() => this.hideLoader(), 2000);
          setInterval(() => this.timeSpent += 10, 10000);
          setInterval(() => this.triggerJackpotEvent(), 900000);
          setInterval(() => this.triggerMultiplierBoost(), 300000);
          setInterval(() => this.jackpotAmount += 0.001, 1000);
          if (this.showTutorial) localStorage.setItem(LS_PREFIX + 'tutorialSeen', '1');
          let lastInteraction = Date.now();
          setInterval(() => {
            if (Date.now() - lastInteraction > 30000 && !this.dropping) {
              this.showToast('Keep dropping to climb the leaderboard!', 'info');
            }
          }, 10000);
          document.addEventListener('click', () => lastInteraction = Date.now());
          this.$refs.bgMusic.volume = 0.2;
          this.$refs.bgMusic.play().catch(() => console.log('Autoplay blocked'));
          console.log('CryptoDrop App Initialized.');
        },
        showLoader() {
          const loader = document.createElement('div');
          loader.className = 'loader-orb';
          document.body.appendChild(loader);
        },
        hideLoader() {
          const loader = document.querySelector('.loader-orb');
          if (loader) loader.remove();
        },
        initSocket() {
          try {
            this.socket = io(BASE_URL, {
              auth: { token: localStorage.getItem(LS_PREFIX + 'authToken') },
              reconnectionAttempts: 5,
              transports: ['websocket']
            });
            this.socket.on('connect', () => {
              console.log('Socket connected:', this.socket.id);
              this.socket.emit('getRecentWins');
            });
            this.socket.on('disconnect', (reason) => {
              console.log('Socket disconnected:', reason);
              if (reason === 'io server disconnect') {
                this.showToast('Server disconnected.', 'error');
              }
            });
            this.socket.on('connect_error', (err) => {
              console.error('Socket connection error:', err.message, err.data);
              this.showToast(`Connection failed: ${err.message}`, 'error');
            });
            this.socket.on('dropResult', (data) => {
              console.log('Received dropResult:', data);
              const message = {
                id: data.timestamp || Date.now(),
                username: data.username === this.walletAddress ? 'You' : (data.username ? data.username.slice(0, 4) + '...' + data.username.slice(-4) : 'Guest'),
                text: `landed on ${data.slot}!`,
                reward: data.reward > 0 ? data.reward.toFixed(5) : null
              };
              this.communityMessages = [message, ...this.communityMessages.slice(0, 19)];
              this.scrollToChatBottom();
            });
            this.socket.on('recentWins', (wins) => {
              console.log('Received recent wins:', wins);
              this.communityMessages = wins.map(w => ({
                id: w.timestamp || Date.now(),
                username: w.username === this.walletAddress ? 'You' : (w.username ? w.username.slice(0, 4) + '...' + w.username.slice(-4) : 'Guest'),
                text: `landed on ${w.slot}!`,
                reward: w.reward > 0 ? w.reward.toFixed(5) : null
              })).slice(0, 20);
            });
            this.socket.on('leaderboardUpdate', (topPlayers) => {
              this.leaderboard = topPlayers.slice(0, 5);
            });
          } catch (error) {
            console.error("Socket initialization failed:", error);
            this.showToast("Cannot connect to live feed.", "error");
          }
        },
        initBoard() {
          const boardContainer = this.$refs.plinkoBoardRef;
          if (!boardContainer) return;
          boardContainer.innerHTML = '<div class="crypto-mascot"></div>';
          this.pegElements = [];
          this.slotElements = [];
          const boardWidth = boardContainer.clientWidth || this.BOARD_WIDTH;
          const boardHeight = this.BOARD_HEIGHT;
          this.boardRect = boardContainer.getBoundingClientRect();
          const rowHeight = boardHeight * 0.8 / (this.PEG_ROWS + 1);
          for (let i = 0; i < this.PEG_ROWS; i++) {
            const pegsInRow = i + 3;
            const y = rowHeight * (i + 1);
            const spacing = boardWidth / (pegsInRow + 1);
            for (let j = 0; j < pegsInRow; j++) {
              const x = spacing * (j + 1);
              const peg = document.createElement('div');
              peg.className = 'peg';
              peg.style.left = `${x - this.PEG_SIZE / 2}px`;
              peg.style.top = `${y - this.PEG_SIZE / 2}px`;
              boardContainer.appendChild(peg);
              this.pegElements.push({ element: peg, x, y, radius: this.PEG_SIZE / 2 });
            }
          }
          const totalSlotWidth = this.outcomes.length * this.SLOT_WIDTH;
          const totalSpacing = boardWidth - totalSlotWidth;
          const spacing = totalSpacing / (this.outcomes.length + 1);
          const slotContainer = boardContainer.querySelector('.slot-container') || document.createElement('div');
          if (!slotContainer.classList.contains('slot-container')) {
            slotContainer.className = 'slot-container';
            boardContainer.appendChild(slotContainer);
          } else {
            slotContainer.innerHTML = '';
          }
          this.outcomes.forEach((outcome, i) => {
            const slot = document.createElement('div');
            slot.className = 'slot';
            slot.style.backgroundColor = outcome.color || '#4B5563';
            slot.style.width = `${this.SLOT_WIDTH}px`;
            slot.style.height = `${this.SLOT_HEIGHT}px`;
            if (outcome.slot === 'Jackpot') {
              slot.classList.add('jackpot-pulse');
            }
            const label = document.createElement('span');
            label.className = 'slot-label';
            label.textContent = outcome.slot;
            slot.appendChild(label);
            const tooltip = document.createElement('div');
            tooltip.className = 'slot-tooltip';
            tooltip.innerHTML = `
              Multiplier: ${outcome.slot}<br>
              Reward: ${(this.betAmount * outcome.rewardMult).toFixed(5)} SOL<br>
              Chance: ~${(outcome.weight * 100).toFixed(1)}%
            `;
            slot.appendChild(tooltip);
            slotContainer.appendChild(slot);
            this.slotElements.push({ element: slot, outcome: outcome, index: i });
          });
          for (let i = 0; i < 20; i++) {
            const orb = document.createElement('div');
            orb.className = 'floating-orb';
            orb.style.left = `${Math.random() * 100}vw`;
            orb.style.animationDelay = `${Math.random() * 10}s`;
            document.body.appendChild(orb);
          }
        },
        initParticles() {
          const canvas = document.getElementById('particle-canvas');
          if (!canvas) return;
          this.particleCtx = canvas.getContext('2d');
          canvas.width = window.innerWidth;
          canvas.height = window.innerHeight;
          const colors = ['#7B61FF', '#FF6BEC', '#61FF7B', '#FFB861', '#60A5FA'];
          this.particles = Array.from({ length: 80 }, () => ({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            radius: Math.random() * 2 + 0.5,
            vx: (Math.random() - 0.5) * 0.5,
            vy: (Math.random() - 0.5) * 0.5,
            baseVx: (Math.random() - 0.5) * 0.5,
            baseVy: (Math.random() - 0.5) * 0.5,
            color: colors[Math.floor(Math.random() * colors.length)],
            mass: Math.random() * 2 + 1
          }));
          const animateParticles = () => {
            if (!this.particleCtx) return;
            const ctx = this.particleCtx;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            this.particles.forEach(p => {
              let dx = this.mouseX - p.x;
              let dy = this.mouseY - p.y;
              if (this.celebrating) {
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                dx = centerX - p.x;
                dy = centerY - p.y;
                p.color = '#FFD700';
              }
              const distance = Math.sqrt(dx * dx + dy * dy);
              const maxDist = 150;
              if (distance < maxDist) {
                const force = (maxDist - distance) / maxDist;
                p.vx += (dx / distance) * force * 0.08;
                p.vy += (dy / distance) * force * 0.08;
              } else {
                p.vx += (p.baseVx - p.vx) * 0.01;
                p.vy += (p.baseVy - p.vy) * 0.01;
              }
              p.vx = Math.max(-2, Math.min(2, p.vx));
              p.vy = Math.max(-2, Math.min(2, p.vy));
              p.x += p.vx;
              p.y += p.vy;
              if (p.x < -p.radius) p.x = canvas.width + p.radius;
              if (p.x > canvas.width + p.radius) p.x = -p.radius;
              if (p.y < -p.radius) p.y = canvas.height + p.radius;
              if (p.y > canvas.height + p.radius) p.y = -p.radius;
              ctx.beginPath();
              ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
              ctx.fillStyle = p.color;
              ctx.globalAlpha = Math.max(0.1, 1 - distance / (maxDist * 2));
              ctx.fill();
              ctx.globalAlpha = 1.0;
            });
            requestAnimationFrame(animateParticles);
          };
          animateParticles();
          window.addEventListener('resize', () => {
            if (!canvas) return;
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
          });
        },
        initAudio() {
          try {
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const loadSound = async (url, name) => {
              const response = await fetch(url);
              const arrayBuffer = await response.arrayBuffer();
              const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);
              this.sounds[name] = audioBuffer;
            };
            Promise.all([
              loadSound('/assets/sounds/plink.mp3', 'plink'),
              loadSound('/assets/sounds/win.mp3', 'win'),
              loadSound('/assets/sounds/loss.mp3', 'loss'),
              loadSound('/assets/sounds/bigwin.mp3', 'bigwin'),
              loadSound('/assets/sounds/jackpot.mp3', 'jackpot'),
              loadSound('/assets/sounds/click.mp3', 'click'),
              loadSound('/assets/sounds/near-miss.mp3', 'near-miss'),
              loadSound('/assets/sounds/coin-shower.mp3', 'coin-shower'),
              loadSound('/assets/sounds/crowd-cheer.mp3', 'cheer'),
              loadSound('/assets/sounds/0.5x.mp3', '0.5x'),
              loadSound('/assets/sounds/1x.mp3', '1x'),
              loadSound('/assets/sounds/2x.mp3', '2x'),
              loadSound('/assets/sounds/5x.mp3', '5x'),
              loadSound('/assets/sounds/10x.mp3', '10x')
            ]).catch(err => console.error('Sound loading failed:', err));
          } catch (err) {
            console.error('AudioContext initialization failed:', err);
          }
        },
        playSound(name, volume = 1.0) {
          if (!this.audioContext || !this.sounds[name]) return;
          const source = this.audioContext.createBufferSource();
          source.buffer = this.sounds[name];
          const gainNode = this.audioContext.createGain();
          gainNode.gain.value = volume;
          source.connect(gainNode);
          gainNode.connect(this.audioContext.destination);
          if (name === 'plink') {
            source.playbackRate.value = 0.8 + Math.random() * 0.4;
          }
          source.start(0);
        },
        updateMousePos(event) {
          this.mouseX = event.clientX;
          this.mouseY = event.clientY;
        },
        handleScroll() {
          const controlsElement = document.getElementById('controls');
          if (!controlsElement) {
            this.showStickyButton = false;
            return;
          }
          const rect = controlsElement.getBoundingClientRect();
          this.showStickyButton = rect.bottom < 0;
        },
        async connectWallet(walletType) {
          this.showToast('Connecting wallet...', 'info');
          this.playSound('click');
          try {
            let provider;
            if (walletType === 'phantom' && ('phantom' in window) && window.phantom.solana) {
              provider = window.phantom.solana;
            } else if (walletType === 'solflare' && ('solflare' in window) && window.solflare) {
              provider = window.solflare;
            } else {
              this.showToast(`Wallet ${walletType} not found. Please install it.`, 'error');
              window.open(walletType === 'phantom' ? 'https://phantom.app/' : 'https://solflare.com/', '_blank');
              return;
            }
            if (!provider.isSolana) throw new Error('Selected provider is not a Solana wallet.');
            console.log(`Attempting to connect with ${walletType}`);
            const response = await provider.connect();
            const address = response.publicKey.toString();
            console.log('Wallet connected:', address);
            localStorage.setItem(LS_PREFIX + 'walletAddress', address);
            this.walletAddress = address;
            this.walletConnected = true;
            this.username = address.slice(0, 4) + '...' + address.slice(-4);
            this.connection = new SolanaWeb3.Connection(
              SolanaWeb3.clusterApiUrl(BASE_URL.includes('localhost') ? 'devnet' : 'mainnet-beta'),
              'confirmed'
            );
            await this.getWalletBalance(address);
            this.showToast('Wallet connected!', 'success');
            this.closeModals();
            window.dispatchEvent(new CustomEvent('wallet-connected', { detail: { address } }));
            this.initBoard();
          } catch (err) {
            console.error('Wallet connection failed:', err);
            let message = 'Failed to connect wallet.';
            if (err.message.includes('User rejected')) {
              message = 'Connection request rejected.';
            } else if (err.message.includes('not found')) {
              message = `Please install ${walletType} wallet.`;
            }
            this.showToast(message, 'error');
            this.disconnectWallet();
          }
        },
        async getWalletBalance(address) {
          if (!address || !this.connection) {
            console.warn('Cannot fetch balance: No address or connection.');
            this.walletBalance = null;
            return;
          }
          try {
            console.log(`Fetching balance for ${address}...`);
            const publicKey = new SolanaWeb3.PublicKey(address);
            const balanceLamports = await this.connection.getBalance(publicKey);
            this.walletBalance = balanceLamports / SolanaWeb3.LAMPORTS_PER_SOL;
            console.log('Balance updated:', this.walletBalance);
            window.dispatchEvent(new CustomEvent('balance-updated', { detail: { balance: this.walletBalance } }));
          } catch (err) {
            console.error('Balance fetch failed:', err);
            this.showToast('Failed to fetch balance.', 'error');
            this.walletBalance = null;
          }
        },
        disconnectWallet() {
          try {
            if (window.phantom?.solana?.disconnect) window.phantom.solana.disconnect();
            if (window.solflare?.disconnect) window.solflare.disconnect();
          } catch (e) { console.warn("Error during wallet disconnect:", e); }
          localStorage.removeItem(LS_PREFIX + 'walletAddress');
          this.walletAddress = null;
          this.walletConnected = false;
          this.walletBalance = null;
          this.connection = null;
          this.username = 'Guest';
          this.showToast('Wallet disconnected.', 'info');
          this.closeModals();
          this.initBoard();
        },
        openBoardModal() {
          this.modalOpen = true;
          this.playSound('click');
        },
        openWalletModal() {
          this.walletModalOpen = true;
          this.playSound('click');
        },
        closeModals() {
          this.modalOpen = false;
          this.walletModalOpen = false;
          this.challengeModalOpen = false;
          this.depositModalOpen = false;
          this.playSound('click');
        },
        selectBoard(board) {
          this.selectedBoard = board;
          this.dropResult = `Switched to ${board} board.`;
          this.closeModals();
          this.initBoard();
          this.showToast(`Switched to ${board} board`, 'info');
        },
        checkDailyLogin() {
          const lastLogin = localStorage.getItem(LS_PREFIX + 'lastLogin');
          const now = new Date();
          const today = now.toDateString();
          if (lastLogin !== today) {
            this.loginStreak = lastLogin ? this.loginStreak + 1 : 1;
            localStorage.setItem(LS_PREFIX + 'lastLogin', today);
            localStorage.setItem(LS_PREFIX + 'loginStreak', this.loginStreak.toString());
            this.showToast(`Day ${this.loginStreak} of 7 – Claim your bonus drop tomorrow!`, 'success');
            this.challengeModalOpen = true;
            localStorage.setItem(LS_PREFIX + 'lastChallengeDate', today);
          }
        },
        triggerJackpotEvent() {
          this.showToast('Jackpot Round Begins in 2:00!', 'info');
          const countdown = document.createElement('div');
          countdown.className = 'addiction-timer';
          countdown.textContent = 'Jackpot Round: 2:00';
          document.body.appendChild(countdown);
          let timeLeft = 120;
          const interval = setInterval(() => {
            timeLeft--;
            countdown.textContent = `Jackpot Round: ${Math.floor(timeLeft / 60)}:${(timeLeft % 60).toString().padStart(2, '0')}`;
            if (timeLeft <= 0) {
              clearInterval(interval);
              countdown.remove();
              this.showToast('Jackpot Round Active!', 'success');
              this.outcomes = this.outcomes.map(o => {
                if (o.slot === 'Jackpot') {
                  return { ...o, weight: o.weight * 2 };
                }
                return o;
              });
              this.initBoard();
              setTimeout(() => {
                this.showToast('Jackpot Round Ended!', 'info');
                this.outcomes = this.outcomes.map(o => {
                  if (o.slot === 'Jackpot') {
                    return { ...o, weight: 0.01 };
                  }
                  return o;
                });
                this.initBoard();
              }, 60000);
            }
          }, 1000);
        },
        triggerMultiplierBoost() {
          this.showToast('2x Rewards for 60s!', 'success');
          const timer = document.createElement('div');
          timer.className = 'addiction-timer';
          timer.textContent = '2x Rewards: 1:00';
          document.body.appendChild(timer);
          let timeLeft = 60;
          const interval = setInterval(() => {
            timeLeft--;
            timer.textContent = `2x Rewards: 0:${timeLeft.toString().padStart(2, '0')}`;
            if (timeLeft <= 0) {
              clearInterval(interval);
              timer.remove();
            }
          }, 1000);
          this.outcomes = this