<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, viewport-fit=cover" name="viewport"/>
<meta content="yes" name="apple-mobile-web-app-capable" />
<meta content="yes" name="mobile-web-app-capable">
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style" />
<title>SolRoulette LIVE - Spin to Win</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.com/css2?family=Press+Start+2P&amp;display=swap" rel="stylesheet"/>
<style>
        /* Reset and Base Styles */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: 'Inter', -apple-system, sans-serif;
            background: linear-gradient(180deg, #0A0A0A, #1A1A1A);
            color: #FFFFFF;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            position: relative; /* Needed for absolute positioning of overlays */
        }
        :root {
            --primary: #9945FF; /* Purple branding */
            --danger: #FF375F; /* Red for losses */
            --success: #14F195; /* Green for wins */
            --accent: #FFD700; /* Gold for highlights */
            --secondary: #1A1A1A; /* Dark panels */
            --text: #FFFFFF;
            --background-gradient: linear-gradient(180deg, #0A0A0A, #1A1A1A);
            --panel-background: rgba(26, 26, 26, 0.8); /* Semi-transparent dark */
            --panel-border-radius: 12px;
            --button-border-radius: 8px;
            --input-border-radius: 8px;
        }
        .container {
            max-width: 100%;
            height: 100%;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1; /* Ensure content is above background effects */
        }

        /* Background Effects */
        .background-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(153, 69, 255, 0.1) 0%, rgba(10, 10, 10, 0) 50%);
            pointer-events: none;
            z-index: 0;
            overflow: hidden; /* Hide particles outside */
        }

        /* Particle FX */
        .particle {
            position: absolute;
            width: 5px;
            height: 5px;
            background-color: var(--accent);
            border-radius: 50%;
            pointer-events: none;
            animation: particle-float 5s infinite ease-out;
            opacity: 0;
        }

        @keyframes particle-float {
            0% { transform: translateY(0) translateX(0) scale(1); opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateY(-200px) translateX(50px) scale(0.5); opacity: 0; }
        }

         .background-overlay.intensify-particles .particle {
             animation-duration: 3s; /* Faster float */
             animation-timing-function: cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Different easing */
             opacity: 1; /* Always visible during intensification */
         }


        /* Money Rain Effect */
        .money-rain {
            position: absolute;
            width: 15px;
            height: 15px;
            background-color: var(--success);
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%); /* Simple triangle coin */
            pointer-events: none;
            animation: money-fall 2s ease-in forwards;
            opacity: 0;
        }

        @keyframes money-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* Strobe Effect during spin */
        .strobe-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1); /* Subtle white overlay */
            pointer-events: none;
            z-index: 0;
            opacity: 0;
        }

        .strobe-overlay.active {
            animation: strobe 0.2s infinite alternate;
        }

        @keyframes strobe {
            0% { opacity: 0; }
            100% { opacity: 0.1; }
        }


        /* Animations */
        @keyframes pulse-glow {
            0% { filter: drop-shadow(0 0 4px var(--primary)); }
            100% { filter: drop-shadow(0 0 16px var(--primary)); }
        }
         @keyframes pulse-glow-red {
            0% { filter: drop-shadow(0 0 4px var(--danger)); }
            100% { filter: drop_shadow(0 0 16px var(--danger)); }
         }
        @keyframes enter {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-60px); opacity: 0; }
        }
        /* Spin animation will be controlled by JS for precise landing */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
            }
        @keyframes vibrate {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
            }
         @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
         @keyframes timer-pulse-fast {
             0% { transform: translateX(-50%) scale(1); }
             50% { transform: translateX(-50%) scale(1.1); }
             100% { transform: translateX(-50%) scale(1); }
         }
         @keyframes pointer-pulse {
             0% { filter: drop-shadow(0 0 4px var(--accent)); }
             50% { filter: drop-shadow(0 0 20px var(--accent)); }
             100% { filter: drop-shadow(0 0 4px var(--accent)); }
         }
         @keyframes subtle-vibrate {
             0%, 100% { transform: translateX(0); }
             25% { transform: translateX(-1px); }
             75% { transform: translateX(1px); }
         }
         /* Glow effect for onboarding tooltip target */
         @keyframes onboarding-glow {
             0% { box-shadow: 0 0 5px var(--accent); }
             50% { box-shadow: 0 0 20px var(--accent), 0 0 30px var(--accent); }
             100% { box-shadow: 0 0 5px var(--accent); }
         }
         /* Wheel Pulse during countdown */
         @keyframes wheel-pulse-glow {
             0% { box-shadow: 0 0 64px rgba(153, 69, 255, 0.3), 0 0 32px rgba(255, 215, 0, 0.3); }
             50% { box-shadow: 0 0 80px rgba(153, 69, 255, 0.5), 0 0 40px rgba(255, 215, 0, 0.5); }
             100% { box-shadow: 0 0 64px rgba(153, 69, 255, 0.3), 0 0 32px rgba(255, 215, 0, 0.3); }
         }


        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: var(--panel-background);
            border-radius: var(--panel-border-radius);
            margin: 10px;
            width: calc(100% - 20px); /* Adjust for margin */
            max-width: 800px; /* Limit header width on larger screens */
            backdrop-filter: blur(6px);
            z-index: 10;
            /* Added gap for spacing between header elements */
            gap: 10px;
        }
         .site-title {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary);
            text-shadow: 0 0 8px rgba(153, 69, 255, 0.5);
            /* Prevent shrinking */
            flex-shrink: 0;
        }
        .players-online, .user-profile {
            background: rgba(26, 26, 26, 0.5); /* More transparent */
            padding: 8px 12px;
            border-radius: var(--button-border-radius);
            font-size: 0.9em;
             /* Added gap for spacing inside these elements */
            gap: 8px;
             /* Allow shrinking */
            flex-shrink: 1;
             min-width: 0; /* Allow flex items to shrink below content size */
        }
        .user-profile {
            display: flex;
            align-items: center;
            cursor: pointer; /* Indicate clickable */
             transition: transform 0.2s;
             /* Added gap for spacing inside user profile */
             gap: 8px;
             /* Added flex-wrap for smaller screens */
             flex-wrap: wrap;
        }
        .user-profile:hover {
             transform: translateY(-2px);
        }
        .avatar {
            width: 28px; /* Slightly larger */
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            display: grid;
            place-items: center;
            font-size: 0.9em;
            border: 2px solid var(--text);
             flex-shrink: 0; /* Prevent shrinking */
        }
         .user-info {
             display: flex;
             flex-direction: column;
             min-width: 0; /* Allow text to wrap */
         }
        .xp-bar {
            width: 70px; /* Slightly wider */
            height: 8px; /* Taller */
            background: #333;
            border-radius: 4px; /* More rounded */
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
             flex-shrink: 0; /* Prevent shrinking */
        }
        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #7A37CC); /* Gradient fill */
            transition: width 0.3s ease-in-out;
        }
         .sol-balance-display {
             font-weight: bold;
             /* Added gap for icon spacing */
             display: flex;
             align-items: center;
             gap: 4px;
             flex-shrink: 0; /* Prevent shrinking */
         }
         .fake-winnings-display {
              font-size: 0.8em;
              color: #aaa;
              margin-left: 10px;
              flex-shrink: 0; /* Prevent shrinking */
         }

         /* Demo Mode Banner */
         .guest-banner {
             position: absolute; /* Changed to absolute for better control */
             top: 60px; /* Position below header */
             left: 50%;
             transform: translateX(-50%);
             background: var(--primary);
             color: var(--text);
             padding: 5px 10px;
             border-radius: var(--button-border-radius);
             font-size: 0.8em; /* Slightly smaller font */
             font-weight: bold;
             z-index: 15; /* Above most elements */
             box-shadow: 0 2px 5px rgba(0,0,0,0.3);
             white-space: nowrap; /* Prevent wrapping */
         }


        /* Global Timer */
        .global-timer {
            position: absolute !important;
            top: 135px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            font-size: 0.8em !important;
            padding: 4px 8px !important;
            white-space: nowrap !important;
            max-width: 180px;
            z-index: 25;
            text-align: center !important;
        }
         .global-timer.urgent {
             background: linear-gradient(45deg, var(--danger), #FF6B8A); /* Red gradient */
             animation: timer-pulse-fast 0.5s ease-in-out infinite alternate; /* Faster pulse */
         }

         /* Pre-Spin CTA */
         .pre-spin-cta {
             position: absolute !important;
             top: 160px !important;
             left: 50% !important;
             transform: translateX(-50%) !important;
             font-size: 0.8em !important;
             padding: 4px 8px !important;
             white-space: nowrap !important;
             max-width: 180px;
             z-index: 25;
             text-align: center !important;
         }


        /* Roulette Wheel */
        .wheel-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 40px auto 20px auto; /* More space */
            perspective: 1000px;
            animation: enter 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 5; /* Below timer, above background */
             margin-top: 10px !important;
        }
         #rouletteCanvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 12px solid #222; /* Thicker border */
            box-shadow: 0 0 64px rgba(153, 69, 255, 0.3), 0 0 32px rgba(255, 215, 0, 0.3); /* Multiple shadows */
            /* No conic gradient here, drawn on canvas */
            /* Metallic texture overlay handled by canvas drawing or filter */
             transition: box-shadow 0.3s ease-in-out; /* Smooth transition for glow */
         }
         #rouletteCanvas.countdown-glow {
             animation: wheel-pulse-glow 1s infinite alternate;
         }


        .pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 40px;
            clip-path: polygon(50% 100%, 0% 0%, 100% 0%);
            background: var(--accent);
            filter: drop-shadow(0 0 12px var(--accent));
            z-index: 2;
        }
        .pointer.vibrate {
            animation: vibrate 0.2s infinite;
        }
        .wheel-container.bounce {
            animation: bounce 0.3s;
        }
         .pointer.pulse {
             animation: pointer-pulse 1s infinite alternate;
         }

         /* Recent Spins Display */
         .recent-spins {
             position: absolute;
             bottom: 10px;
             left: 50%;
             transform: translateX(-50%);
             background: var(--panel-background);
             padding: 8px 12px;
             border-radius: var(--button-border-radius);
             font-size: 0.8em;
             z-index: 10;
             box-shadow: 0 2px 10px rgba(0,0,0,0.3);
             display: flex;
             gap: 5px;
             align-items: center;
             /* Allow wrapping on small screens */
             flex-wrap: wrap;
             justify-content: center;
         }
         .recent-spins .label {
             font-weight: bold;
             color: var(--accent);
             flex-shrink: 0; /* Prevent shrinking */
         }
         .recent-spins .outcome {
             padding: 3px 6px;
             border-radius: 4px;
             font-weight: bold;
             /* Animation for slide-in */
             animation: slideInFromRight 0.3s ease-out;
             flex-shrink: 0; /* Prevent shrinking */
         }
         .recent-spins .outcome.win { background-color: var(--success); color: #000; }
         .recent-spins .outcome.lose { background-color: var(--danger); color: #fff; }
         .recent-spins .outcome.primary { background-color: var(--primary); color: #fff; }
         .recent-spins .outcome.accent { background-color: var(--accent); color: #000; }


         @keyframes slideInFromRight {
             0% { transform: translateX(10px); opacity: 0; }
             100% { transform: translateX(0); opacity: 1; }
         }

        /* Chat System Fixes - REMOVED SEPARATE CHAT BUBBLE/CONTAINER */


        /* Unified Live Panel (Bets + Chat) */
        .live-panel-container {
            position: fixed; /* Changed to fixed for mobile drawer */
            top: 0; /* Position from top */
            right: 0; /* Position from right */
            width: 300px; /* Fixed width */
            height: 100%; /* Full height */
            z-index: 1000; /* High z-index */
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            /* Initial state (closed) - slide out from right */
            transform: translateX(100%);
        }

        .live-panel-container.active {
            /* Active state (open) */
            transform: translateX(0);
        }
         /* Removed .live-panel-container.closed as active/non-active handles state */


        .live-panel-toggle-btn {
            position: fixed; /* Changed to fixed */
            top: 120px; /* Position mid-right */
            right: 10px; /* Position from right edge */
            width: 44px; /* Increased touch target size */
            height: 44px; /* Increased touch target size */
            background: var(--panel-background);
            color: var(--accent);
            border: none;
            border-radius: 8px 0 0 8px; /* Rounded left side */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001; /* Above the panel */
            box-shadow: -2px 0 5px rgba(0,0,0,0.3); /* Shadow on the left */
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Smooth transition */
        }
         /* Position toggle button when panel is open */
         .live-panel-container.active + .live-panel-toggle-btn {
             transform: translateX(-300px); /* Move button with the panel */
         }


         .live-panel-toggle-btn .unread-dot {
             position: absolute;
             top: 5px;
             right: 5px;
             width: 8px;
             height: 8px;
             background-color: var(--danger); /* Red dot */
             border-radius: 50%;
             display: none; /* Hidden by default */
         }


        /* Bet Controls */
        .bet-controls {
            /* position: absolute; */ /* Removed absolute positioning */
            background: var(--panel-background);
            padding: 15px;
            border-radius: var(--panel-border-radius);
            margin: 10px;
            display: flex;
            flex-direction: column;
            gap: 15px; /* Increased gap */
            width: calc(100% - 20px);
            max-width: 600px;
            backdrop-filter: blur(6px);
            z-index: 10;
             position: relative; /* Needed for onboarding tooltip */
             /* Added margin-top for desktop layout */
             margin-top: 20px;
        }
         .bet-label {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--accent);
         }
        .multiplier-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); /* Responsive grid */
            gap: 8px;
             /* Onboarding glow */
             transition: box-shadow 0.3s ease-in-out;
        }
         .multiplier-options.onboarding-glow {
             animation: onboarding-glow 1.5s infinite alternate;
         }

        .multiplier-btn {
            background: #333;
            color: var(--text);
            padding: 10px;
            border: none;
            border-radius: var(--button-border-radius);
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
             display: flex; /* Enable flex for label alignment */
             flex-direction: column;
             align-items: center;
             justify-content: center;
             gap: 4px;
        }
        .multiplier-btn:hover:not(:disabled) {
            background: var(--primary);
            transform: scale(1.05);
             box-shadow: 0 4px 10px rgba(153, 69, 255, 0.5);
             animation: subtle-vibrate 0.3s infinite alternate; /* Subtle vibrate on hover */
        }
        .multiplier-btn.active:not(:disabled) {
            background: var(--success);
            transform: scale(1.1);
            box-shadow: 0 44px 10px rgba(20, 241, 149, 0.5);
        }
        .multiplier-btn:disabled {
            background: #555;
            cursor: not-allowed;
             transform: scale(1);
             box-shadow: none;
             opacity: 0.6; /* Indicate disabled state */
             animation: none; /* No vibrate when disabled */
        }
         .multiplier-btn:disabled[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            white-space: nowrap;
            font-size: 0.8em;
            margin-bottom: 5px;
            z-index: 11; /* Above controls */
         }
         .multiplier-btn small {
             font-size: 0.6em;
             font-weight: normal;
             color: #aaa; /* Subtle gray */
         }


        .bet-amount {
            display: flex;
            flex-direction: column; /* Stack label and input/value */
            gap: 5px;
        }
         .bet-amount-top {
             display: flex;
             align-items: center;
             gap: 10px;
         }
         .bet-amount-label {
            font-weight: bold;
         }
        .bet-slider {
            flex: 1;
            -webkit-appearance: none; /* Override default appearance */
            appearance: none;
            height: 10px; /* Thicker slider */
            background: #333;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
            cursor: pointer;
        }
        .bet-slider:hover:not(:disabled) {
            opacity: 1;
        }
        .bet-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px; /* Thumb size */
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
         .bet-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
             box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
         .bet-slider:disabled {
             opacity: 0.6;
             cursor: not-allowed;
         }
         .bet-slider:disabled[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            white-space: nowrap;
            font-size: 0.8em;
            margin-bottom: 5px;
            z-index: 11; /* Above controls */
         }

        .bet-value {
            font-size: 1.2em; /* Larger value */
            font-weight: bold;
            color: var(--accent);
             min-width: 80px; /* Prevent jumping */
             text-align: right;
        }
         .max-win-text {
             font-size: 0.8em;
             color: #aaa;
             text-align: right;
             margin-top: -10px; /* Pull it closer to the slider */
         }
         .bet-summary {
             font-size: 0.9em;
             color: #ccc;
             margin-top: 10px;
             text-align: center;
         }


        .place-bet, .connect-wallet-btn {
            background: var(--primary);
            color: var(--text);
            padding: 12px;
            border: none;
            border-radius: var(--button-border-radius);
            font-size: 1.1em; /* Larger font */
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s, box-shadow 0.2s;
            width: 100%;
             box-shadow: 0 4px 10px rgba(153, 69, 255, 0.5);
        }
        .place-bet:hover:not(:disabled), .connect-wallet-btn:hover:not(:disabled) {
            background: #7A37CC;
            transform: scale(1.02);
             box-shadow: 0 6px 12px rgba(153, 69, 255, 0.7);
        }
        .place-bet:disabled, .connect-wallet-btn:disabled {
            background: #555;
            cursor: not-allowed;
             transform: scale(1);
             box-shadow: none;
             opacity: 0.6; /* Indicate disabled state */
        }
         .place-bet:disabled[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            white-space: nowrap;
            font-size: 0.8em;
            margin-bottom: 5px;
            z-index: 11; /* Above controls */
         }

         /* Onboarding Tooltip */
         .onboarding-tooltip {
             position: absolute;
             bottom: 100%; /* Position above the target */
             left: 50%;
             transform: translateX(-50%);
             background: var(--accent);
             color: #000;
             padding: 8px 12px;
             border-radius: var(--button-border-radius);
             font-size: 0.9em;
             font-weight: bold;
             white-space: nowrap;
             pointer-events: none; /* Don't block clicks */
             opacity: 0;
             transition: opacity 0.3s ease-in-out;
             margin-bottom: 10px; /* Space between tooltip and target */
             z-index: 11; /* Above controls */
         }
         .onboarding-tooltip.visible {
             opacity: 1;
         }
         .onboarding-tooltip::after {
             content: '';
             position: absolute;
             top: 100%;
             left: 50%;
             transform: translateX(-50%);
             width: 0;
             height: 0;
             border-left: 8px solid transparent;
             border-right: 8px solid transparent;
             border-top: 8px solid var(--accent);
         }


        /* Unified Live Panel Styling */
        .live-panel {
            background: var(--panel-background);
            padding: 12px;
            border-radius: var(--panel-border-radius);
            max-height: 100%; /* Allow panel to take full height of container */
            overflow: hidden; /* Hide content overflow */
            backdrop-filter: blur(6px);
            width: 100%; /* Take full width of container */
            height: 100%; /* Take full height of container */
            font-size: 0.85em;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }

        .live-panel-tabs {
            display: flex;
            margin-bottom: 10px;
            border-bottom: 1px solid #555;
        }

        .live-panel-tab {
            flex-grow: 1;
            text-align: center;
            padding: 8px 0; /* Increased padding */
            cursor: pointer;
            font-weight: bold;
            color: #aaa;
            border-bottom: 2px solid transparent;
            transition: color 0.2s, border-bottom-color 0.2s;
            position: relative; /* Needed for unread dot */
        }

        .live-panel-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
         .live-panel-tab .unread-dot {
             position: absolute;
             top: 5px;
             right: 5px;
             width: 8px;
             height: 8px;
             background-color: var(--danger); /* Red dot */
             border-radius: 50%;
             display: none; /* Hidden by default */
         }


        .live-panel-content {
            flex-grow: 1;
            overflow-y: auto; /* Allow content to scroll */
            padding-right: 5px; /* Space for scrollbar */
        }
         .live-panel-content::-webkit-scrollbar {
            width: 6px;
         }
         .live-panel-content::-webkit-scrollbar-track {
            background: #333;
            border-radius: 3px;
         }
         .live-panel-content::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
         }


        /* Live Bets Feed (inside live-panel-content) */
        #liveBetsContent {
            display: none; /* Hidden by default */
        }
         #liveBetsContent.active {
            display: block; /* Show when active */
         }

        .bet-entry {
            padding: 8px 0;
            border-bottom: 1px solid #333;
            display: flex;
            gap: 6px;
            animation: enter 0.3s ease-out;
        }
         .bet-entry:last-child {
            border-bottom: none;
         }
         .bet-entry i {
            color: var(--success); /* Coin icon color */
         }
         .bet-entry .user {
            font-weight: bold;
            color: var(--primary);
         }
         .bet-entry .amount {
            color: var(--accent);
         }
         .bet-entry .multiplier {
            font-weight: bold;
         }

        /* Chat Box (inside live-panel-content) */
        #liveChatContent {
             display: none; /* Hidden by default */
             flex-direction: column; /* Use flex column for chat layout */
             height: 100%; /* Fill parent height */
        }
         #liveChatContent.active {
            display: flex; /* Show and use flex layout when active */
         }

         .chat-feed {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
         }
         .chat-feed::-webkit-scrollbar {
            width: 6px;
         }
         .chat-feed::-webkit-scrollbar-track {
            background: #333;
            border-radius: 3px;
         }
         .chat-feed::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
         }
        .chat-message {
            padding: 8px 0;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 6px;
            animation: enter 0.3s ease-out;
        }
         .chat-message:last-child {
            border-bottom: none;
         }
         .chat-message .user {
            font-weight: bold;
            color: var(--success); /* User name color */
         }
         .chat-message .system {
            font-style: italic;
            color: #aaa;
         }
        .chat-input {
            display: flex;
            gap: 6px;
            margin-top: auto; /* Push to bottom */
             flex-shrink: 0; /* Prevent shrinking */
        }
        .chat-input input {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: var(--input-border-radius);
            background: #333;
            color: var(--text);
            font-size: 0.85em;
             outline: none;
        }
        .chat-input button {
            background: var(--primary);
            color: var(--text);
            padding: 8px 12px;
            border: none;
            border-radius: var(--button-border-radius);
            cursor: pointer;
            font-size: 0.85em;
             transition: background 0.2s;
        }
         .chat-input button:hover {
            background: #7A37CC;
         }
        .reaction {
            font-size: 0.8em;
            margin-left: 4px;
            cursor: pointer;
             opacity: 0.8;
             transition: opacity 0.2s;
        }
         .reaction:hover {
            opacity: 1;
         }

        /* Token Rewards */
        .token-notification {
            position: absolute;
            bottom: 20px; /* Adjusted position */
            right: 10px;
            background: var(--panel-background);
            padding: 12px 20px;
            border-radius: var(--panel-border-radius);
            border-left: 6px solid var(--success);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: enter 0.3s ease-out;
            z-index: 10;
             box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
         .token-notification button {
            background: var(--success);
            color: #000;
            padding: 4px 8px;
            border: none;
            border-radius: var(--button-border-radius);
            font-size: 0.8em;
            cursor: pointer;
             transition: background 0.2s;
         }
         .token-notification button:hover {
            background: #10C07D;
         }
        .token-float {
            position: absolute;
            color: var(--success);
            font-weight: bold;
            animation: floatUp 1.5s ease-out forwards;
             pointer-events: none; /* Don't block clicks */
        }

        /* Achievements */
        .achievement-popup {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: var(--panel-background);
            padding: 12px;
            border-radius: var(--panel-border-radius);
            border-left: 6px solid var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: enter 0.3s ease-out;
            z-index: 10;
             box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .badge-icon {
            width: 36px;
            height: 36px;
            background: var(--accent);
            border-radius: 8px;
            display: grid;
            place-items: center;
            font-size: 1.2em;
             box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* Share Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9); /* Darker overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20;
             opacity: 0;
             pointer-events: none;
             transition: opacity 0.3s ease-in-out;
        }
         .modal-overlay.visible {
             opacity: 1;
             pointer-events: auto;
         }
        .modal-content {
            background: var(--secondary);
            padding: 20px;
            border-radius: var(--panel-border-radius);
            text-align: center;
            max-width: 90%; /* Added max-width for mobile */
             width: 400px; /* Fixed width on larger screens */
             box-shadow: 0 8px 20px rgba(0,0,0,0.6);
             transform: translateY(-20px);
             opacity: 0;
             animation: enter 0.3s ease-out forwards;
             position: relative; /* For close button positioning */
             margin: 20px; /* Added margin for mobile padding */
        }
         .modal-content h2 {
            color: var(--success);
            margin-bottom: 10px;
         }
         .modal-content p {
            margin-bottom: 15px;
            color: #ccc;
         }
        .modal-content input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: none;
            border-radius: var(--input-border-radius);
            background: #333;
            color: var(--text);
             font-size: 0.9em;
             cursor: text;
        }
        .modal-content button {
            background: var(--primary);
            color: var(--text);
            padding: 10px 20px;
            border: none;
            border-radius: var(--button-border-radius);
            cursor: pointer;
            margin: 5px;
             transition: background 0.2s;
        }
         .modal-content button:hover {
            background: #7A37CC;
         }
         .modal-content .close-btn {
             position: absolute;
             top: 10px;
             right: 10px;
             background: none;
             border: none;
             font-size: 1.5em;
             color: #aaa;
             cursor: pointer;
         }

        /* Flash Screen */
        .flash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 15;
            opacity: 0;
            transition: opacity 0.1s ease-out; /* Faster flash */
        }
        .flash-screen.win {
            background: var(--success);
            opacity: 0.4; /* More intense flash */
        }
         .flash-screen.win-10x {
            background: var(--accent); /* Yellow flash for 10x */
            opacity: 0.6; /* Very intense flash */
         }
        .flash-screen.lose {
            background: var(--danger);
            opacity: 0.4; /* More intense flash */
        }

         /* Confetti Effect (for wins) */
         .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--accent); /* Default color */
            animation: confetti-fall 2s ease-out forwards;
            pointer-events: none;
            z-index: 16; /* Above flash screen */
         }

        /* Leaderboard */
        .leaderboard-panel {
            position: absolute;
            top: 120px;
            right: 10px;
            background: var(--panel-background);
            padding: 12px;
            border-radius: var(--panel-border-radius);
            max-height: 250px;
            overflow-y: auto;
            backdrop-filter: blur(6px);
            width: 250px;
            font-size: 0.85em;
            z-index: 10;
             box-shadow: 0 4px 15px rgba(0,0,0,0.5);
             display: flex; /* Use flexbox for tabs */
             flex-direction: column;
             /* Added margin-top for desktop layout */
             margin-top: 180px;
         }
         /* Leaderboard Auto-Scroll Animation (if needed) */
         /* @keyframes autoscroll {
             0% { transform: translateY(0); }
             100% { transform: translateY(calc(-100% + 250px)); } // Adjust 250px to max-height
         } */


         .leaderboard-tabs {
             display: flex;
             margin-bottom: 10px;
             border-bottom: 1px solid #555;
         }
         .leaderboard-tab {
             flex-grow: 1;
             text-align: center;
             padding: 5px 0;
             cursor: pointer;
             font-weight: bold;
             color: #aaa;
             border-bottom: 2px solid transparent;
             transition: color 0.2s, border-bottom-color 0.2s;
         }
         .leaderboard-tab.active {
             color: var(--accent);
             border-bottom-color: var(--accent);
         }
         .leaderboard-content-tab {
             display: none; /* Hide content tabs by default */
         }
         .leaderboard-content-tab.active {
             display: block; /* Show active content tab */
         }


         .leaderboard-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--accent);
         }
         .leaderboard-entry {
             padding: 6px 0;
             border-bottom: 1px solid #333;
             display: flex;
             justify-content: space-between;
             align-items: center; /* Align items vertically */
         }
         .leaderboard-entry:last-child {
             border-bottom: none;
         }
         .leaderboard-entry .user {
             font-weight: bold;
             color: var(--primary);
             display: flex; /* Enable flex for user + emoji */
             align-items: center;
             gap: 5px;
         }
         .leaderboard-entry .value {
             color: var(--text);
         }

        /* Limited Time Bonus Banner */
        .bonus-banner {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(90deg, var(--accent), #FF8C00); /* Orange-gold gradient */
            color: #000;
            padding: 8px 15px;
            border-radius: var(--button-border-radius);
            font-weight: bold;
            font-size: 0.9em;
            z-index: 12; /* Above header */
            box-shadow: 0 4px 10px rgba(255, 215, 0, 0.5);
            animation: bounce 0.5s infinite alternate; /* Bouncing animation */
            display: none; /* Hidden by default */
        }

        /* Low Balance Alert */
        .low-balance-alert {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--danger);
            color: var(--text);
            padding: 15px 20px;
            border-radius: var(--panel-border-radius);
            font-weight: bold;
            z-index: 15;
            box-shadow: 0 4px 15px rgba(255, 55, 95, 0.5);
            display: none; /* Hidden by default */
            animation: enter 0.3s ease-out;
            text-align: center;
        }
        .low-balance-alert button {
            background: var(--text);
            color: var(--danger);
            padding: 8px 15px;
            border: none;
            border-radius: var(--button-border-radius);
            font-weight: bold;
            margin-top: 10px;
            cursor: pointer;
        }

         /* Refill Demo SOL Modal */
         #refillFakeSolModal .modal-content h2 {
             color: var(--primary);
         }
         #refillFakeSolModal .modal-content button {
             background: var(--success);
             color: #000;
         }

        /* Double or Nothing Modal */
        #doubleOrNothingModal .modal-content h2 {
            color: var(--danger); /* Red title for loss prompt */
        }
         #doubleOrNothingModal .modal-content button {
             margin-top: 15px;
         }
         #doubleOrNothingModal .modal-content button:first-of-type {
             background: var(--success); /* Green for Try Again */
             color: #000;
         }
         #doubleOrNothingModal .modal-content button:first-of-type:hover {
             background: #10C07D;
         }
         #doubleOrNothingModal .modal-content button:last-of-type {
             background: #555; /* Darker for Cancel */
         }
         #doubleOrNothingModal .modal-content button:last-of-type:hover {
             background: #777;
         }

         /* Result Modal */
         #resultModal .modal-content h2.win {
             color: var(--success);
         }
          #resultModal .modal-content h2.lose {
             color: var(--danger);
         }
          #resultModal .modal-content button {
             background: var(--primary);
             color: var(--text);
             margin-top: 20px;
             font-size: 1.2em;
             padding: 12px 25px;
             /* Disable style for Spin Again button */
             transition: opacity 0.2s, background 0.2s;
          }
          #resultModal .modal-content button:disabled {
              opacity: 0.6;
              cursor: not-allowed;
              background: #555;
          }

          /* Idle Modal */
          #idleModal .modal-content h2 {
              color: var(--accent);
          }
           #idleModal .modal-content button {
               background: var(--success);
               color: #000;
           }

           /* Auto Demo Banner */
           .auto-demo-banner {
               position: absolute;
               top: 10px;
               left: 50%;
               transform: translateX(-50%);
               background: rgba(0,0,0,0.7);
               color: var(--accent);
               padding: 8px 15px;
               border-radius: var(--button-border-radius);
               font-weight: bold;
               font-size: 0.9em;
               z-index: 12;
               box-shadow: 0 2px 10px rgba(0,0,0,0.3);
               display: none; /* Hidden by default */
           }

        /* Mobile UI Enhancements */
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        /* Fix iOS height issues */
        .full-height {
            height: -webkit-fill-available;
            height: 100vh;
        }

        /* Enhance touch targets */
        button,
        input[type="button"],
        .clickable {
            min-height: 44px;
            min-width: 44px;
        }

        /* Add haptic feedback styles */
        .haptic-feedback:active {
            transform: scale(0.96);
            transition: transform 0.1s ease-out;
        }


        /* Responsive Design */
        @media (max-width: 767px) {
             /* Mobile-only styles */
             .header {
                 padding: 8px 10px; /* Reduced padding */
                 margin: 5px; /* Reduced margin */
                 width: calc(100% - 10px); /* Adjust for margin */
                 flex-wrap: wrap; /* Allow header items to wrap */
                 justify-content: center; /* Center items when wrapped */
                 gap: 8px; /* Reduced gap */
             }
             .site-title {
                 font-size: 1.2em; /* Reduced font size */
                  flex-basis: 100%; /* Take full width when wrapped */
                 text-align: center;
             }
             .players-online, .user-profile {
                 padding: 6px 10px; /* Reduced padding */
                 font-size: 0.8em; /* Reduced font size */
                 gap: 6px; /* Reduced gap */
             }
             .user-profile {
                 flex-wrap: nowrap; /* Prevent wrapping inside user profile */
                 min-width: 0; /* Allow shrinking */
             }
             .avatar {
                 width: 24px; /* Reduced size */
                 height: 24px;
                 font-size: 0.8em;
             }
             .xp-bar {
                 width: 50px; /* Reduced width */
                 height: 6px; /* Reduced height */
             }
             .sol-balance-display {
                 font-size: 0.9em; /* Reduced font size */
             }
              .fake-winnings-display {
                 font-size: 0.7em;
                 margin-left: 5px; /* Reduced margin */
             }

             /* Demo Mode Banner Mobile Position */
             .guest-banner {
                 top: 50px; /* Position slightly lower on mobile */
                 font-size: 0.7em; /* Smaller font on mobile */
                 padding: 4px 8px; /* Reduced padding */
             }


             .global-timer {
                 top: 80px; /* Adjusted position below header/guest banner */
                 padding: 8px 15px; /* Reduced padding */
                 font-size: 0.9em; /* Reduced font size */
             }
              .pre-spin-cta {
                 top: 115px; /* Adjusted position below timer */
                 padding: 6px 10px; /* Reduced padding */
                 font-size: 0.9em; /* Reduced font size */
             }

             /* Adjust padding for content above sticky bet controls on mobile */
             .container {
                 padding-bottom: 150px; /* Add padding to avoid content being hidden by sticky controls */
             }

             .bet-controls {
                 position: fixed; /* Keep fixed at bottom on mobile */
                 bottom: 0;
                 left: 0;
                 width: 100%;
                 border-radius: 0;
                 margin: 0;
                 padding: 10px; /* Reduced padding */
                 padding-bottom: calc(10px + env(safe-area-inset-bottom)); /* Add safe area inset */
                 box-shadow: 0 -4px 15px rgba(0,0,0,0.5);
                 gap: 10px; /* Reduced gap */
                 /* Remove desktop margin-top */
                 margin-top: 0;
             }
             .bet-slider::-webkit-slider-thumb {
                 width: 25px; /* Larger thumb */
                 height: 25px;
             }
             .bet-slider::-moz-range-thumb {
                 width: 25px; /* Larger thumb */
                 height: 25px;
             }

             /* Live Panel Mobile Positioning */
             .live-panel-container {
                 top: 0; /* Full height from top */
                 right: 0; /* Position from right */
                 width: 250px; /* Mobile width */
                 height: 100%; /* Full height */
                 transform: translateX(100%); /* Start hidden offscreen right */
             }
             .live-panel-container.active {
                 transform: translateX(0); /* Slide in fully */
             }
              /* Removed .live-panel-container.closed as active/non-active handles state */

             .live-panel {
                 padding: 8px; /* Reduced padding inside the panel */
             }
             .live-panel-toggle-btn {
                 top: 120px; /* Position mid-right */
                 right: 10px; /* Keep on the right edge */
                 width: 44px; /* Touch target size */
                 height: 44px; /* Touch target size */
                 border-radius: 8px 0 0 8px; /* Rounded left side */
             }
              /* Position toggle button when panel is open on mobile */
             .live-panel-container.active + .live-panel-toggle-btn {
                 transform: translateX(-250px); /* Move button with the panel by panel width */
             }

             .live-panel-tab {
                 padding: 6px 0; /* Reduced padding */
                 font-size: 0.8em; /* Reduced font size */
             }
             .live-panel-content {
                 font-size: 0.8em; /* Reduced font size */
             }
             .bet-entry, .chat-message {
                 padding: 6px 0; /* Reduced padding */
                 gap: 4px; /* Reduced gap */
             }
             .chat-input {
                 gap: 4px; /* Reduced gap */
             }
             .chat-input input, .chat-input button {
                 padding: 6px; /* Reduced padding */
                 font-size: 0.8em; /* Reduced font size */
             }

             .leaderboard-panel {
                 display: none; /* Hide leaderboard on small screens */
             }
             .token-notification {
                 bottom: auto; /* Remove fixed bottom position */
                 top: 80px; /* Position near live panel */
                 right: 5px;
                 padding: 8px 12px;
                 font-size: 0.8em; /* Reduced font size */
             }
             .achievement-popup {
                 bottom: auto; /* Remove fixed bottom position */
                 top: 80px; /* Position near live panel */
                 left: 5px;
                 padding: 8px 12px;
                 font-size: 0.8em; /* Reduced font size */
             }
             .low-balance-alert {
                 bottom: calc(150px + 20px); /* Position above bet controls */
                 padding: 10px 15px; /* Reduced padding */
                 font-size: 0.9em; /* Reduced font size */
             }
             .recent-spins {
                 bottom: 160px; /* Position above bet controls */
                 padding: 6px 10px; /* Reduced padding */
                 font-size: 0.7em; /* Reduced font size */
                 gap: 3px; /* Reduced gap */
             }
             .bonus-banner {
                 top: 60px; /* Adjust position */
                 font-size: 0.8em; /* Reduced font size */
                 padding: 6px 12px; /* Reduced padding */
             }
             .fake-activity-banner {
                 top: 50px; /* Adjust position */
                 font-size: 0.7em; /* Reduced font size */
                 padding: 4px 8px; /* Reduced padding */
             }
             .ten-x-hit-banner {
                 top: 150px; /* Adjust position */
                 font-size: 0.9em; /* Reduced font size */
                 padding: 6px 12px; /* Reduced padding */
             }

             /* Sticky Bet Controls when Keyboard is NOT open */
             body:not(.keyboard-open) .bet-controls {
                 position: fixed;
                 bottom: 0;
                 left: 0;
                 width: 100%;
                 border-radius: 0;
                 margin: 0;
                 padding: 10px; /* Reduced padding */
                 padding-bottom: calc(10px + env(safe-area-inset-bottom));
                 box-shadow: 0 -4px 15px rgba(0,0,0,0.5);
                 gap: 10px; /* Reduced gap */
             }
              /* Adjust padding when keyboard is open */
             body.keyboard-open .container {
                 padding-bottom: 15px; /* Reduce bottom padding when keyboard is open */
             }
             body.keyboard-open .bet-controls {
                 position: static; /* Make bet controls static when keyboard is open */
                 margin-bottom: 0;
                 padding-bottom: 10px; /* Ensure bottom padding */
             }

             /* Modal Scaling on Mobile */
             .modal-content {
                padding: 15px; /* Reduced padding */
                margin: 10px; /* Reduced margin */
             }
             .modal-content h2 {
                font-size: 1.2em; /* Reduced font size */
             }
             .modal-content p {
                font-size: 0.9em; /* Reduced font size */
             }
             .modal-content button {
                padding: 8px 15px; /* Reduced padding */
                font-size: 1em; /* Reduced font size */
             }
             .modal-content .close-btn {
                font-size: 1.2em; /* Reduced size */
                top: 5px;
                right: 5px;
             }
        }

        @media (min-width: 768px) {
             .container {
                 flex-direction: row; /* Layout side-by-side */
                 justify-content: center;
                 align-items: center;
                 gap: 40px;
                 padding: 20px;
             }
             .header {
                 position: absolute;
                 top: 20px;
                 left: 50%;
                 transform: translateX(-50%);
                 width: auto; /* Auto width */
                 max-width: 960px;
                 /* Reset mobile specific styles */
                 padding: 10px 15px;
                 margin: 10px;
                 flex-wrap: nowrap;
                 justify-content: space-between;
                 gap: 10px;
             }
             .site-title {
                 font-size: 1.5em;
                 flex-basis: auto;
                 text-align: left;
             }
             .players-online, .user-profile {
                 padding: 8px 12px;
                 font-size: 0.9em;
                 gap: 8px;
             }
             .user-profile {
                 flex-wrap: nowrap;
             }
             .avatar {
                 width: 28px;
                 height: 28px;
                 font-size: 0.9em;
             }
              .xp-bar {
                 width: 70px;
                 height: 8px;
             }
             .sol-balance-display {
                 font-size: 1em;
             }
              .fake-winnings-display {
                 font-size: 0.8em;
                 margin-left: 10px;
             }

             /* Demo Mode Banner Desktop Position */
             .guest-banner {
                 top: 10px; /* Position near header */
                 font-size: 0.8em; /* Standard font size */
                 padding: 5px 10px; /* Standard padding */
             }


             .global-timer {
                 top: 100px; /* Adjusted position */
                 padding: 10px 20px;
                 font-size: 1em;
             }
              .pre-spin-cta {
                 top: 140px; /* Adjusted position */
                 padding: 8px 15px;
                 font-size: 1em;
             }


            .wheel-container {
                 width: 400px;
                 height: 400px;
                 margin: 0; /* Remove auto margin */
                 margin-top: 180px; /* Space for header/timer/cta */
             }
             #rouletteCanvas {
                 /* Adjust canvas size if needed, but CSS width/height should handle scaling */
             }

             /* Unified Live Panel on Desktop */
             .live-panel-container {
                 position: static; /* Remove fixed positioning */
                 max-height: none; /* Allow full height */
                 overflow: hidden; /* Keep overflow hidden for tab content */
                 width: 300px;
                 margin: 0;
                 align-self: stretch; /* Stretch to fill height */
                 margin-top: 180px; /* Space for header/timer/cta */
                 transform: translateX(0); /* Ensure visible on desktop */
             }
              /* Removed .live-panel-container.closed and .live-panel-container.active desktop styles */

             .live-panel {
                 padding: 12px; /* Reset padding */
             }
             .live-panel-toggle-btn {
                 display: none; /* Hide toggle button on desktop */
             }
              .live-panel-tab {
                 padding: 8px 0; /* Reset padding */
                 font-size: 0.85em; /* Reset font size */
             }
             .live-panel-content {
                 font-size: 0.85em; /* Reset font size */
             }
              .bet-entry, .chat-message {
                 padding: 8px 0; /* Reset padding */
                 gap: 6px; /* Reset gap */
             }
             .chat-input {
                 gap: 6px; /* Reset gap */
             }
             .chat-input input, .chat-input button {
                 padding: 8px; /* Reset padding */
                 font-size: 0.85em; /* Reset font size */
             }


             .bet-controls {
                 position: static; /* Remove absolute positioning */
                 width: 400px; /* Match wheel width */
                 margin: 20px 0 0 0; /* Space below wheel */
                 padding: 15px; /* Reset padding */
                 gap: 15px; /* Reset gap */
                 margin-top: 20px; /* Reset desktop margin-top */
             }
             body:not(.keyboard-open) .bet-controls {
                 position: static; /* Ensure static positioning on desktop */
                 padding-bottom: 15px; /* Ensure bottom padding */
             }
              body.keyboard-open .bet-controls {
                 position: static; /* Ensure static positioning on desktop */
                 margin-bottom: 0;
                 padding-bottom: 15px; /* Ensure bottom padding */
             }


             .token-notification {
                 bottom: auto;
                 top: 180px; /* Position below timer */
                 right: 10px;
                 padding: 12px 20px;
                 font-size: 1em;
             }
             .achievement-popup {
                 bottom: auto;
                 top: 180px; /* Position below timer */
                 left: 10px;
                 padding: 12px;
                 font-size: 0.85em;
             }
             .leaderboard-panel {
                 position: static; /* Remove absolute positioning */
                 max-height: none;
                 overflow-y: visible;
                 width: 300px;
                 margin: 0;
                 align-self: stretch;
                 margin-top: 180px;
             }
             .low-balance-alert {
                 bottom: 20px;
                 left: auto;
                 right: 20px; /* Position on the right */
                 transform: none;
                 padding: 15px 20px;
                 font-size: 1em;
             }
              .bonus-banner {
                 top: 10px;
                 left: 50%;
                 transform: translateX(-50%);
                 font-size: 0.9em;
                 padding: 8px 15px;
             }
             /* Auto Demo Banner Desktop Position */
             .auto-demo-banner {
                  top: 10px; /* Position next to guest banner */
                  font-size: 0.9em;
                  padding: 8px 15px;
             }

             /* Modal Scaling on Desktop */
             .modal-content {
                padding: 20px;
                margin: 20px;
             }
             .modal-content h2 {
                font-size: 1.5em;
             }
             .modal-content p {
                font-size: 1em;
             }
             .modal-content button {
                padding: 10px 20px;
                font-size: 1.1em;
             }
             .modal-content .close-btn {
                font-size: 1.5em;
                top: 10px;
                right: 10px;
             }
        }

/* Final fix for global timer and CTA alignment */
/* Removed conflicting rules */


/* Raise wheel higher for full visibility */
/* Removed conflicting rules */

/* Resize and reposition the modal close button */
.modal-content .close-btn {
    font-size: 1.2em !important;
    transform: scale(0.7) !important;
    top: 8px !important;
    right: 8px !important;
    padding: 2px !important;
    line-height: 1 !important;
    background: none !important;
    z-index: 999 !important;
}


/* Position timer and CTA just below the shop button */
/* Removed conflicting rules */


/* Lock final positioning of Next Spin & Place Your Bets just below Shop button */
/* Removed conflicting rules */


/* Move Recent Spins into top-right area below header */
.recent-spins {
    position: absolute !important;
    top: 135px !important;
    right: 16px !important;
    left: auto !important;
    bottom: auto !important;
    transform: none !important;
    background-color: rgba(0, 0, 0, 0.6) !important;
    padding: 4px 10px !important;
    font-size: 0.7em !important;
    border-radius: 10px !important;
    z-index: 999 !important;
    pointer-events: none !important;
}

/* Override any wheel container rules forcing it inside */
.wheel-container .recent-spins {
    position: absolute !important;
}


.tooltip-warning, #tooltip, .onboarding-tooltip.visible { display: none !important; opacity: 0 !important; pointer-events: none !important; }</style>
</head>
<body>
<div class="background-overlay" id="backgroundOverlay"></div>
<div class="strobe-overlay" id="strobeOverlay"></div>
<div class="container">
<div class="flash-screen" id="flashScreen"></div>
<div class="guest-banner" id="guestModeBanner" style="display: none;" title="You're playing with Demo SOL. Connect wallet to win real rewards.">
              Demo Mode  Demo SOL Only
        </div>
<div class="auto-demo-banner" id="autoDemoBanner" style="display: none;">
             Auto demo in progress  Tap anything to join
         </div>
<div class="header">
<div class="site-title">SolRoulette LIVE</div>
<div class="players-online"><i class="fas fa-users"></i> <span id="playersOnline">1,247</span> Online</div>
<div class="user-profile" id="userProfile">
</div>
</div>
<div class="global-timer" id="globalTimer"> Next Spin: 25s</div>
<div class="pre-spin-cta" id="preSpinCta">Place your bets...</div>
<div class="bonus-banner" id="bonusBanner">Double $SPIN next 10 spins! </div>
<div class="live-panel-container" id="livePanelContainer">
<div class="live-panel" id="livePanel">
<div class="live-panel-tabs">
<div class="live-panel-tab active" data-tab="bets">Live Bets <span class="unread-dot" id="betsUnreadDot"></span></div>
<div class="live-panel-tab" data-tab="leaderboard">Leaderboard <span class="unread-dot" id="leaderboardUnreadDot"></span></div>
<div class="live-panel-tab" data-tab="chat">Live Chat <span class="unread-dot" id="chatUnreadDot"></span></div>
</div>
<div class="live-panel-content">
<div class="live-panel-content-tab active" id="liveBetsContent">
<div class="bet-entry"><i class="fas fa-dice"></i> <span class="system">System:</span> Welcome to SolRoulette LIVE!</div>
</div>
<div class="live-panel-content-tab" id="liveLeaderboardContent" style="display:none;">
  <div class="leaderboard-title">Top Players</div>
  <div class="leaderboard-entry"><span class="user">Alice</span> <span class="value">123.45</span></div>
  <div class="leaderboard-entry"><span class="user">Bob</span> <span class="value">98.76</span></div>
  <div class="leaderboard-entry"><span class="user">Charlie</span> <span class="value">77.00</span></div>
</div>

<div class="live-panel-content-tab" id="liveChatContent">
<div class="chat-feed" id="chatFeed">
<div class="chat-message"><i class="fas fa-robot"></i> <span class="system">System:</span> Spin to win big! <span class="reaction"></span></div>
</div>
<div class="chat-input">
<input aria-label="Chat input" id="chatInput" placeholder="Say something..." type="text"/>
<button aria-label="Send chat message" id="sendChatBtn">Send</button>
</div>
</div>
</div>
</div>
</div>
<button aria-label="Toggle Live Panel" class="live-panel-toggle-btn" id="toggleLivePanel">
<i class="fas fa-chevron-left"></i> <span class="unread-dot" id="livePanelUnreadDot"></span>
</button>
<div class="leaderboard-panel" id="leaderboardPanel">
<div class="leaderboard-tabs">
<div class="leaderboard-tab active" data-tab="wager">Top Wager</div>
<div class="leaderboard-tab" data-tab="streak">Streak</div>
<div class="leaderboard-tab" data-tab="10x">10x Wins</div>
</div>
<div id="leaderboardContent">
<div class="leaderboard-content-tab active" data-tab="wager">
</div>
<div class="leaderboard-content-tab" data-tab="streak">
</div>
<div class="leaderboard-content-tab" data-tab="10x">
</div>
</div>
</div>
<div class="wheel-container" id="wheelContainer">
<div class="pointer" id="pointer"></div>
<canvas id="rouletteCanvas"></canvas>
<div class="recent-spins" id="recentSpins">
<span class="label">Recent:</span>
</div>
</div>
<div class="bet-controls">
<div class="onboarding-tooltip" id="onboardingTooltip">Start here  Pick your multiplier.</div>
<div class="bet-label">Select Multiplier</div>
<div class="multiplier-options" id="multiplierOptions">
<button class="multiplier-btn" data-multiplier="1.5" data-probability="30" title="">1.5x<small>Chance: 30%</small></button>
<button class="multiplier-btn" data-multiplier="2" data-probability="20" title="">2x<small>Chance: 20%</small></button>
<button class="multiplier-btn" data-multiplier="3" data-probability="20" title="">3x<small>Chance: 20%</small></button>
<button class="multiplier-btn" data-multiplier="5" data-probability="15" title="">5x<small>Chance: 15%</small></button>
<button class="multiplier-btn" data-multiplier="10" data-probability="15" title="">10x<small>Chance: 15%</small></button>
</div>
<div class="bet-amount">
<div class="bet-amount-top">
<span class="bet-amount-label">Bet Amount:</span>
<input class="bet-slider" id="betSlider" max="10" min="0.01" step="0.01" title="" type="range" value="0.5"/>
<span class="bet-value" id="betValue">0.50 SOL</span>
</div>
<div class="max-win-text">Max Win Per Round: 50</div>
</div>
<div class="bet-summary" id="betSummary" style="display: none;">
</div>
<button class="connect-wallet-btn" id="connectWalletBtn">Connect Wallet</button>
<button class="place-bet" id="placeBetBtn" style="display: none;" title="Connect your wallet to place real bets"> Place Bet</button>
</div>
<div class="token-notification" id="tokenNotification" style="display: none;">
<i class="fas fa-coins"></i> Earned: <span id="tokenCount">0.000</span> $SPIN
            <button aria-label="Claim SPIN tokens" id="claimModalBtn">Claim</button>
</div>
<div id="achievementContainer"></div>
<div class="modal-overlay" id="walletModal">
<div class="modal-content">
<button aria-label="Close wallet modal" class="close-btn" id="closeWalletModalBtn"></button>
<h2>Connect Your Wallet</h2>
<p>Choose a wallet to connect and start betting.</p>
<button aria-label="Connect Phantom Wallet" class="connect-wallet-button haptic-feedback" data-wallet="phantom" id="connectPhantomBtn">
                    Connect Phantom
                </button>
<button class="secondary-btn" id="justWatchingBtn">Just Watching? Close</button>
</div>
</div>
<div class="modal-overlay" id="profileModal">
<div class="modal-content">
<button aria-label="Close profile modal" class="close-btn" id="closeProfileModalBtn"></button>
<h2>Your Profile</h2>
<div id="profileContent">
<div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
<div class="avatar large" id="profileAvatar"></div>
<div>
<div id="profileName" style="font-size: 1.2em; font-weight: bold;">Guest</div>
<div style="color: #aaa;">Level <span id="profileLevel">1</span></div>
<div class="xp-bar large" style="width: 150px;"><div class="xp-fill" id="profileXpFill" style="width: 0%;"></div></div>
</div>
</div>
<p>Wallet: <span id="profileWallet">Not Connected</span></p>
<p>Balance: <span id="profileBalance">0.00 SOL</span></p>
<p>Total Wagered: <span id="profileTotalWagered">0.00 SOL</span></p>
<p>Win Streak: <span id="profileWinStreak">0</span></p>
<p>10x Wins: <span id="profileTenXWins">0</span></p>
<p id="profileFakeWinnings" style="display: none;">Demo Winnings: <span id="fakeWinningsTotal">0.00</span> SOL</p>
<h3>Achievements</h3>
<div id="profileAchievementsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); gap: 10px; margin-top: 10px;">
</div>
<h3>Referral Code</h3>
<input id="referralLinkInput" readonly="" type="text"/>
<button id="copyReferralLinkBtn">Copy Referral Link</button>
<button id="resetGuestProgressBtn" style="display: none; background: var(--danger); color: var(--text); margin-top: 20px;">Reset Guest Progress</button>
</div>
</div>
</div>
<div class="modal-overlay" id="shopModal">
<div class="modal-content">
<button aria-label="Close shop modal" class="close-btn" id="closeShopModalBtn"></button>
<h2>$SPIN Shop</h2>
<p>Your $SPIN Balance: <span id="shopSpinBalance">0.000</span></p>
<div id="shopItems" style="margin-top: 20px;">
<div style="border: 1px solid #333; padding: 10px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
<span> Rocket Avatar</span>
<span>10 $SPIN <button class="buy-item-btn" data-cost="10" data-item-id="rocket_avatar">Buy</button></span>
</div>
<div style="border: 1px solid #333; padding: 10px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
<span> Fire Chat Emote</span>
<span>5 $SPIN <button class="buy-item-btn" data-cost="5" data-item-id="fire_emote">Buy</button></span>
</div>
</div>
</div>
</div>
<div class="modal-overlay" id="dailyBonusModal">
<div class="modal-content">
<button aria-label="Close daily bonus modal" class="close-btn" id="closeDailyBonusModalBtn"></button>
<h2>Daily Login Bonus!</h2>
<p>Claim your bonus for Day <span id="dailyBonusDay">1</span>!</p>
<p id="dailyBonusAmount">Reward: 0.01 $SPIN</p>
<button id="claimDailyBonusBtn">Claim Bonus</button>
</div>
</div>
<div class="modal-overlay" id="doubleOrNothingModal">
<div class="modal-content">
<button aria-label="Close double or nothing modal" class="close-btn" id="closeDoubleOrNothingBtn"></button>
<h2>Want to win back your loss?</h2>
<p>Bet the same amount again on the same multiplier.</p>
<button id="tryAgainBetBtn">Try Again</button>
<button id="cancelDoubleOrNothingBtn">Cancel</button>
</div>
</div>
<div class="modal-overlay" id="resultModal">
<div class="modal-content">
<button aria-label="Close result modal" class="close-btn" id="closeResultModalBtn"></button>
<h2 id="resultModalTitle"></h2>
<p id="resultModalMessage"></p>
<button id="resultModalSpinAgainBtn">Spin Again</button>
</div>
</div>
<div class="modal-overlay" id="onboardingModal">
<div class="modal-content">
<h2> Welcome to SolRoulette LIVE!</h2>
<p>Heres 500 in Demo SOL to try your luck. Connect your wallet any time to win real rewards.</p>
<button id="onboardingStartBtn">Start Playing</button>
<button id="onboardingConnectBtn">Connect Wallet</button>
</div>
</div>
<div class="modal-overlay" id="refillFakeSolModal">
<div class="modal-content">
<button aria-label="Close refill modal" class="close-btn" id="closeRefillFakeSolModalBtn"></button>
<h2>Out of SOL?</h2>
<p>Looks like your demo SOL balance is low.</p>
<button id="refillFakeSolBtn">Refill 500 Demo SOL!</button>
</div>
</div>
<div class="modal-overlay" id="idleModal">
<div class="modal-content">
<button aria-label="Close idle modal" class="close-btn" id="closeIdleModalBtn"></button>
<h2>Still here?</h2>
<p>Try a spin and feel the rush </p>
<button id="closeIdleModalBtn">OK</button>
</div>
</div>
<div class="modal-overlay" id="dailyRewardModal">
<div class="modal-content">
<button aria-label="Close daily reward modal" class="close-btn" id="closeDailyRewardModalBtn"></button>
<h2>Daily Reward!</h2>
<p>Thanks for playing! Claim your bonus $SPIN.</p>
<p id="dailyRewardAmount">+0.05 $SPIN</p>
<button id="claimDailyRewardBtn">Claim</button>
</div>
</div>
<div class="modal-overlay" id="shareModal">
<div class="modal-content">
<button aria-label="Close share modal" class="close-btn" id="closeShareModalBtn"></button>
<h2 id="shareTitle">Big Win!</h2>
<p id="shareMessage">Share your victory on X!</p>
<input aria-label="Share link" id="shareText" readonly="" type="text"/>
<button id="copyShareTextBtn"><i class="fas fa-copy"></i> Copy Link</button>
<button id="tweetWinBtn"><i class="fab fa-twitter"></i> Tweet Now</button>
</div>
</div>
<div class="modal-overlay" id="messageBox">
<div class="modal-content">
<button aria-label="Close message box" class="close-btn" id="closeMessageBoxBtn"></button>
<h2 id="messageBoxTitle"></h2>
<p id="messageBoxContent"></p>
<button id="closeMessageBoxBtn">OK</button>
</div>
</div>
<div class="low-balance-alert" id="lowBalanceAlert">
             Low Balance! Your SOL is running low.
             <button id="topUpWalletBtn">Top Up Now (Mock)</button>
</div>
<div class="low-balance-alert" id="guestModeToast" style="background: rgba(153, 69, 255, 0.9); display: none;">
             Demo Mode  Playing with Demo SOL. Connect wallet to win real rewards.
         </div>
<div class="bonus-banner" id="fakeActivityBanner" style="background: rgba(0,0,0,0.6); color: #fff; animation: none; top: 50px; font-size: 0.8em; padding: 5px 10px;">
<span id="activityWatchers"> 32 watching</span> | <span id="activityBetting">7 betting 10x</span> | <span id="activityWins">3 wins just hit!</span>
</div>
<div class="bonus-banner" id="tenXHitBanner" style="background: linear-gradient(90deg, var(--danger), var(--accent)); color: #fff; animation: bounce 0.5s infinite alternate; top: 150px; font-size: 1em; padding: 8px 15px; display: none;">
              3 others just hit 10x! 
         </div>
</div>
<script src="https://unpkg.com/@solana/web3.js@1.66.0/lib/index.iife.js"></script>
<script type="module">
    // This import from esm.sh *should* handle the internal dependencies
    import { PhantomWalletAdapter } from 'https://esm.sh/@solana/wallet-adapter-phantom@latest';
    // The Phantom extension still injects `window.solana`. This script
    // ensures a working adapter is available if the extension isn't.
    // Your connectWallet() function should still implicitly rely on `window.solana`.
</script>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>

<script>
        // Global flag for wallet verification status
        window.walletVerified = false;
        window.socket = null; // Global Socket.IO instance

        // State Management
        let spinTimer = 25;
        let isSpinning = false;
        let walletBalance = parseFloat(localStorage.getItem('solroulette_wallet_balance') || '0'); // Load balance from localStorage
        let tokensEarned = parseFloat(localStorage.getItem('solroulette_spin_tokens') || '0'); // Load tokens from localStorage
        let xp = parseInt(localStorage.getItem('solroulette_xp') || '0'); // Load XP from localStorage
        let level = parseInt(localStorage.getItem('solroulette_level') || '1'); // Load level from localStorage
        let totalWagered = parseFloat(localStorage.getItem('solroulette_total_wagered') || '0'); // Load total wagered
        let winStreak = parseInt(localStorage.getItem('solroulette_win_streak') || '0'); // Load win streak
        let tenXWins = parseInt(localStorage.getItem('solroulette_ten_x_wins') || '0'); // Load 10x wins
        // Store multiplier as numeric string
        // Load current bet state from localStorage, default to null multiplier and 0 amount
        let currentBet = { multiplier: localStorage.getItem('solroulette_current_multiplier') || null, amount: parseFloat(localStorage.getItem('solroulette_current_amount') || '0') };
        let achievementsUnlocked = new Set(JSON.parse(localStorage.getItem('solroulette_achievements') || '[]')); // Load achievements
        let playersOnline = 1247;
        let playerBets = []; // Array to store bets for the current round
        let lastLossBet = null; // Store details of the last losing bet for "Double or Nothing"
        // Use isGuestMode to track if the user is in demo mode
        let isGuestMode = localStorage.getItem('solroulette_is_guest') === 'true'; // Track guest mode
        let guestSpinCount = parseInt(localStorage.getItem('solroulette_guest_spin_count') || '0'); // Track guest spins for modal
        let recentSpins = JSON.parse(localStorage.getItem('solroulette_recent_spins') || '[]'); // Load recent spins
        // Use fakeWinningsTotal to track demo winnings
        let fakeWinningsTotal = parseFloat(localStorage.getItem('solroulette_fake_winnings_total') || '0'); // Track fake winnings
        let onboardingShown = localStorage.getItem('solroulette_onboarding_shown') === 'true'; // Track if onboarding tooltip has been shown
        let firstRealBetPlaced = localStorage.getItem('solroulette_first_real_bet_placed') === 'true'; // Track if a real bet has been placed
        // Store actual spin result as string with 'x'
        let lastSpinResult = localStorage.getItem('solroulette_last_spin_result') || null; // Store the actual result of the last spin


        // User Profile
        let user = {
            wallet: localStorage.getItem('solroulette_wallet') || null, // Load wallet from localStorage
            name: localStorage.getItem('solroulette_user_name') || 'Guest', // Load name
            avatar: localStorage.getItem('solroulette_user_avatar') || '', // Load avatar
            referral: localStorage.getItem('solroulette_referral_code') || generateReferralCode(), // Load or generate referral code
        };

        // Daily Bonus State
        let lastLoginDate = localStorage.getItem(isGuestMode ? 'solroulette_guest_last_login' : 'solroulette_last_login') || null;
        let dailyBonusDay = parseInt(localStorage.getItem(isGuestMode ? 'solroulette_guest_daily_bonus_day' : 'solroulette_daily_bonus_day') || '0');
        let dailyRewardClaimedToday = localStorage.getItem('solroulette_daily_reward_claimed') === new Date().toDateString(); // Track daily reward claim

        // Idle Timer State
        let idleTimer = null;
        const IDLE_TIMEOUT = 120000; // 2 minutes in milliseconds

        // Auto Demo State
        let isAutoDemo = false;
        let autoDemoTimer = null;
        const AUTO_DEMO_INTERVAL = 25000; // Spin every 25 seconds in auto demo


        // Dev Flags
        window.autoRefill = false; // Set to true in browser console for auto-refill testing


        // Audio Effects (Lazy Loading)
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const sounds = {};

        // Implement try...catch for sound loading
        async function loadSound(name, url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                     console.warn(`Failed to fetch sound ${name} from ${url}: ${response.status}`);
                     return; // Exit if fetch fails
                }
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                sounds[name] = audioBuffer;
            } catch (e) {
                console.error(`Error loading sound ${name} from ${url}:`, e);
                // Fallback or silent failure for now due to CORS or other issues
            }
        }

        function playSound(name, volume = 1.0, loop = false) {
            // Ensure audio context is resumed after user interaction
            if (audioContext.state === 'suspended') {
                audioContext.resume().catch(e => console.error("AudioContext resume failed:", e));
            }

            const audioBuffer = sounds[name];
            // Check if the audio buffer exists before trying to play
            if (!audioBuffer || !audioContext || audioContext.state === 'suspended') {
                // console.warn(`Sound "${name}" not loaded, audio context not available, or suspended.`);
                return; // Exit the function if sound is not available or context is suspended
            }

            try {
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;

                const gainNode = audioContext.createGain();
                gainNode.gain.value = volume;

                source.connect(gainNode).connect(audioContext.destination);
                source.loop = loop;
                source.start(0);
                return source; // Return source to stop looping sounds later
            } catch (e) {
                console.error(`Error playing sound ${name}:`, e);
                return null; // Return null if playing fails
            }
        }

        let currentTickSound = null; // To control the looping tick sound

        // Debounce function
        function debounce(func, delay) {
            let inDebounce;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(inDebounce);
                inDebounce = setTimeout(() => func.apply(context, args), delay);
            }
        }

        const updateUIDebounced = debounce(updateUI, 50); // Debounce updateUI calls

        // Canvas Wheel Drawing
        const canvas = document.getElementById('rouletteCanvas');
        const ctx = canvas.getContext('2d');
        const segments = [
            { multiplier: '1.5x', color: '--success', probability: 0.3 },
            { multiplier: '2x', color: '--primary', probability: 0.2 },
            { multiplier: '3x', color: '--accent', probability: 0.2 },
            { multiplier: '5x', color: '--success', probability: 0.15 }, // Keeping same as success for visual variety
            { multiplier: '10x', color: '--danger', probability: 0.15 } // Lower chance for 10x
        ];
        const totalProbability = segments.reduce((sum, seg) => sum + seg.probability, 0);
        // Calculate angles based on probability
        let startAngle = 0;
        segments.forEach(segment => {
            segment.startAngle = startAngle;
            segment.endAngle = startAngle + (segment.probability / totalProbability) * 2 * Math.PI;
            segment.middleAngle = segment.startAngle + (segment.endAngle - segment.startAngle) / 2;
            startAngle = segment.endAngle;
        });

        let currentWheelRotation = 0;
        let spinAnimationId = null;
        let spinStartTime = null;
        let spinDuration = 5000; // 5 seconds
        let targetRotation = 0;
        let isNearMiss = false;

        function drawWheel() {
            const size = Math.min(canvas.width, canvas.height);
            const centerX = size / 2;
            const centerY = size / 2;
            // Ensure radius is not negative
            const radius = Math.max(0, size / 2 - 12); // Account for border, ensure non-negative

            ctx.clearRect(0, 0, size, size);

            // Only attempt to draw if the radius is positive
            if (radius > 0) {
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(currentWheelRotation);

                segments.forEach(segment => {
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.arc(0, 0, radius, segment.startAngle, segment.endAngle);
                    ctx.closePath();
                    // Correctly get CSS variable value
                    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue(segment.color).trim();
                    ctx.fill();

                    // Draw text
                    ctx.save();
                    // Rotate to the middle of the segment
                    ctx.rotate(segment.middleAngle);
                    ctx.fillStyle = '#FFF';
                    ctx.font = 'bold 24px "Inter", sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    // Position text away from the center
                    const textRadius = radius * 0.7;
                    ctx.fillText(segment.multiplier, textRadius, 0);
                    ctx.restore();
                });

                ctx.restore();

                // Draw metallic texture effect (simple overlay)
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.beginPath();
                ctx.arc(0, 0, radius, 0, 2 * Math.PI);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.1)'; // Subtle white overlay
                ctx.globalCompositeOperation = 'overlay'; // Blend mode
                ctx.fill();
                ctx.restore();

                // Draw center circle
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius * 0.3, 0, 2 * Math.PI);
                ctx.fillStyle = '#222';
                ctx.fill();
                ctx.lineWidth = 5;
                ctx.strokeStyle = '#444';
                ctx.stroke();

                // Draw center text
                 // Correctly get CSS variable value
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
                ctx.font = 'bold 20px "Press Start 2P", cursive'; // Arcade font for center
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('SPIN', centerX, centerY);
            } else {
                 // Optionally draw a placeholder or message if canvas is too small
                 ctx.fillStyle = '#555';
                 ctx.font = '12px "Inter", sans-serif';
                 ctx.textAlign = 'center';
                 ctx.textBaseline = 'middle';
                 ctx.fillText('Canvas too small', centerX, centerY);
            }
        }

        function animateWheel(timestamp) {
            if (!spinStartTime) spinStartTime = timestamp;
            const elapsed = timestamp - spinStartTime;
            const progress = Math.min(elapsed / spinDuration, 1);

            // Easing function (cubic-bezier for spin)
            // This needs to match the CSS transition for the visual pointer effect
            // A simple cubic-bezier(0.25, 0.1, 0.25, 1) can be approximated
            const easedProgress = 1 - Math.pow(1 - progress, 3); // Simple ease-out

            // Calculate rotation based on progress
            // Start fast, slow down towards the end
            // We need to rotate from current position to targetRotation
            // For near-miss, the targetRotation will be adjusted during the spin

            let currentTargetRotation = targetRotation;
             // Apply near-miss fakeout during the last part of the spin
            if (isNearMiss && progress > 0.7 && progress < 0.95) {
                 // Calculate target rotation for 10x (with 'x' for the function)
                 const nearMissTarget = calculateCanvasTargetRotation('10x') + (Math.random() * 20 - 10); // Aim slightly past 10x
                 const nearMissProgress = (progress - 0.7) / (0.95 - 0.7); // Progress within the fakeout phase
                 currentTargetRotation = targetRotation + (nearMissTarget - targetRotation) * Math.sin(nearMissProgress * Math.PI / 2); // Ease into near miss
            }


            currentWheelRotation = currentTargetRotation * easedProgress;


            drawWheel();

            if (progress < 1) {
                spinAnimationId = requestAnimationFrame(animateWheel);
            } else {
                // Animation finished
                isSpinning = false;
                spinStartTime = null;
                // Snap to the final target position to avoid floating point issues
                currentWheelRotation = targetRotation;
                drawWheel();
                // handleSpinResult is now called by the backend's spinResult event
            }
        }

         // Function to calculate target rotation for canvas
         // This function maps the winning multiplier (string with 'x') to a rotation angle
         function calculateCanvasTargetRotation(winningMultiplierString) {
             const segment = segments.find(seg => seg.multiplier === winningMultiplierString);
             if (!segment) return 0;

             // We want the pointer to land on the middle of the segment
             // The canvas is rotated, so we need to find the rotation value
             // that brings the segment's middle angle to the pointer position (which is at the top, 0 degrees relative to the container)

             // The pointer is at the top (0 degrees relative to the container).
             // The canvas is rotated. We want the segment's middleAngle to align with the top.
             // If the segment's middle angle is M, we need to rotate the canvas by -M
             // However, the canvas drawing starts at 0 degrees to the right (standard canvas arc).
             // Our segments are defined starting from 0 degrees to the right.
             // The pointer is at the top, which is -PI/2 radians or -90 degrees.

             // So, we need to rotate the wheel such that the middle of the winning segment
             // aligns with the pointer's position (-90 degrees).

             const pointerAngle = -Math.PI / 2; // Pointer is at the top (in radians)
             const segmentMiddleAngle = segment.middleAngle; // Middle of the winning segment (in radians)

             // The rotation needed is the difference between the pointer angle and the segment's middle angle.
             // We need to add full rotations to make it spin multiple times.
             const fullRotations = 5; // Spin at least 5 full times
             const rotationInRadians = (pointerAngle - segmentMiddleAngle) + (fullRotations * 2 * Math.PI);

             return rotationInRadians;
         }

        /**
         * Connects to the Socket.IO backend with a JWT token for authentication.
         * Sets up listeners for connection, authentication errors, and successful authentication.
         * @param {string} token - The JWT token obtained from the backend.
         */
        function connectSocketWithToken(token) {
            // Disconnect any existing socket connection before establishing a new one
            if (window.socket && window.socket.connected) {
                window.socket.disconnect();
            }

            window.socket = io('https://solroulette-backend.onrender.com', {
                auth: { token }
            });

            window.socket.on('connect', () => {
                console.log(" Socket connected!");
                addChatMessage('System', 'Connected to game server!', '', 'system');
                // Request initial state from server if needed (server emits it on connection, but good to have a fallback)
                // socket.emit('requestInitialState');
            });

            window.socket.on('disconnect', (reason) => {
                console.log(" Socket disconnected:", reason);
                addChatMessage('System', `Disconnected from game server: ${reason}`, '', 'system');
            });

            window.socket.on('connect_error', (err) => {
                console.error(" Socket Connection Error:", err.message);
                showMessageBox('Connection Error', `Failed to connect to game server: ${err.message}`);
            });

            window.socket.on('authError', (msg) => {
                console.error(" Socket Auth Failed:", msg);
                showMessageBox('Authentication Failed', `Socket authentication failed: ${msg}. Please reconnect your wallet.`);
                // Optionally clear JWT and reset wallet state if auth fails
                localStorage.removeItem("jwtToken");
                window.walletVerified = false;
                isGuestMode = true; // Fallback to guest mode
                updateUIDebounced();
            });

            window.socket.on('authenticated', (user_data) => {
                console.log(" Authenticated user:", user_data);
                // Update UI with authenticated user data
                user.name = user_data.username || user_data.publicKey.slice(0, 4) + '...' + user_data.publicKey.slice(-4);
                user.wallet = user_data.publicKey;
                walletBalance = user_data.solBalance; // Assuming backend sends solBalance
                tokensEarned = user_data.spinTokens; // Assuming backend sends spinTokens
                xp = user_data.xp;
                level = user_data.level;
                totalWagered = user_data.totalWagered;
                winStreak = user_data.winStreak;
                tenXWins = user_data.tenXWins;
                achievementsUnlocked = new Set(user_data.achievements || []);
                dailyBonusDay = user_data.dailyBonusDay; // Ensure daily bonus day is synced
                lastLoginDate = user_data.lastLoginDate; // Ensure last login date is synced

                // Hide demo UI and show real SOL balance
                document.getElementById("guestModeBanner").style.display = "none";
                const verifiedBadge = document.getElementById("verifiedBadge");
                if (verifiedBadge) {
                    verifiedBadge.style.display = "inline-block";
                }

                document.querySelectorAll(".fake-winnings-display").forEach(el => el.style.display = "none");
                document.querySelectorAll(".sol-balance-display").forEach(el => el.style.display = "block");

                updateUIDebounced();
                addChatMessage('System', `${user.name} is now authenticated!`, '', 'system');
            });

            // Listen for global spin countdown from backend
            window.socket.on('spinCountdown', (data) => {
                spinTimer = data.timeLeft;
                // If the backend signals "Spinning...", start the frontend animation
                if (spinTimer === 'Spinning...' && !isSpinning) {
                    spinWheel(); // Trigger frontend spin animation
                }
                updateUIDebounced(); // Update UI based on new timer value
            });


            // Add remaining listeners for game events
            window.socket.on('spinResult', (data) => {
                console.log("Spin Result received:", data);
                // The frontend animation should have just finished or be finishing.
                // Now, process the authoritative result from the backend.
                lastSpinResult = data.winningMultiplier; // e.g., '2x'
                handleSpinResult(data.betsOutcome, data.newLeaderboard, data.newUsersOnline); // Pass all relevant data
            });

            window.socket.on('chatMessage', (message_data) => {
                console.log("Chat message received:", message_data);
                addChatMessage(message_data.username, message_data.text, message_data.reaction || '', message_data.type || 'user');
            });

            window.socket.on('leaderboardUpdate', (leaderboard_data) => {
                console.log("Leaderboard update received:", leaderboard_data);
                updateLeaderboard(leaderboard_data); // Pass the received leaderboard data
            });

            window.socket.on('userUpdate', (user_data) => {
                console.log("User data update received:", user_data);
                // Update local user state with fresh data from backend
                user.name = user_data.username || user_data.publicKey.slice(0, 4) + '...' + user_data.publicKey.slice(-4);
                user.wallet = user_data.publicKey;
                walletBalance = user_data.solBalance;
                tokensEarned = user_data.spinTokens;
                xp = user_data.xp;
                level = user_data.level;
                totalWagered = user_data.totalWagered;
                winStreak = user_data.winStreak;
                tenXWins = user_data.tenXWins;
                achievementsUnlocked = new Set(user_data.achievements || []);
                dailyBonusDay = user_data.dailyBonusDay;
                lastLoginDate = user_data.lastLoginDate;
                updateUIDebounced();
            });

            // Listen for balance updates (e.g., after placing a bet)
            window.socket.on('balanceUpdate', (data) => {
                console.log("Balance update received:", data);
                walletBalance = data.solBalance;
                updateUIDebounced();
            });

            // Listen for bet placement confirmation from server
            window.socket.on('betPlacedConfirmation', (bet_data) => {
                console.log("Bet placed confirmation received:", bet_data);
                // Optionally provide visual feedback that the bet was accepted by the server
                // The local addBetEntry is already immediate, so this is more for confirmation/debugging
            });

            window.socket.on('betError', (msg) => {
                console.error("Bet Error:", msg);
                showMessageBox('Bet Error', msg);
                // Re-enable bet controls if there was an error
                document.getElementById('placeBetBtn').disabled = false;
                document.getElementById('placeBetBtn').textContent = ' Place Bet';
                document.querySelectorAll('.multiplier-btn').forEach(btn => {
                    btn.disabled = false;
                    btn.title = isGuestMode ? 'Using Demo SOL  Real rewards require a wallet' : (user.wallet ? '' : 'Connect Wallet to Bet');
                });
                document.getElementById('betSlider').disabled = false;
                document.getElementById('betSlider').title = isGuestMode ? 'Using Demo SOL  Real rewards require a wallet' : (user.wallet ? '' : 'Connect Wallet to Bet');
                updateUIDebounced();
            });

            // Add other event listeners as needed, e.g., for real-time bets,
            // player count updates, etc.
            window.socket.on('newBet', (bet_data) => {
                console.log("New bet received:", bet_data);
                // Add the bet to the live bets feed
                addBetEntry(bet_data.username, bet_data.amount, bet_data.multiplier); // Multiplier is already formatted with 'x' from backend
            });

            window.socket.on('playersOnlineUpdate', (count) => {
                console.log("Player count update:", count);
                playersOnline = count;
                document.getElementById('playersOnline').textContent = playersOnline;
            });
        }


        // Wallet Connection
        async function connectWallet() {
            playSound('click');
            if (navigator.vibrate) navigator.vibrate(50);

            const connectWalletBtn = document.getElementById('connectWalletBtn');
            connectWalletBtn.textContent = 'Connecting...';
            connectWalletBtn.disabled = true;

            const provider = window.solana;
            if (!provider || !provider.isPhantom) {
                showMessageBox("Phantom Wallet Not Found", "Phantom Wallet not found. Please install it to connect.");
                connectWalletBtn.textContent = 'Connect Wallet';
                connectWalletBtn.disabled = false;
                return;
            }

            try {
                const resp = await provider.connect();
                const publicKey = provider.publicKey.toString();
                const message = `Sign in to SolRoulette LIVE. Nonce: ${Date.now()}`;
                const encodedMessage = new TextEncoder().encode(message);
                const signed = await provider.signMessage(encodedMessage, "utf8");

                const payload = {
                    publicKey,
                    message: btoa(message),
                    signature: btoa(String.fromCharCode(...signed.signature))
                };

                const res = await fetch('https://solroulette-backend.onrender.com/api/auth/verify-signature', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.message || "Verification failed");

                const token = data.token;
                localStorage.setItem("jwtToken", token);
                window.walletVerified = true;
                document.body.classList.add('wallet-verified');
                document.getElementById("guestModeBanner").style.display = "none";
                const verifiedBadge = document.getElementById("verifiedBadge");
                if (verifiedBadge) {
                    verifiedBadge.style.display = "inline-block";
                }


                document.querySelectorAll(".fake-winnings-display").forEach(el => el.style.display = "none");
                document.querySelectorAll(".sol-balance-display").forEach(el => el.style.display = "block");

                connectSocketWithToken(token);

                // Update local user state and UI based on successful connection
                user.wallet = publicKey;
                user.name = publicKey.slice(0, 4) + '...' + publicKey.slice(-4);

                // If coming from demo mode, save demo stats before switching
                if (isGuestMode) {
                    localStorage.setItem('solroulette_guest_balance', walletBalance);
                    localStorage.setItem('solroulette_guest_xp', xp);
                    localStorage.setItem('solroulette_guest_tokens', tokensEarned);
                    localStorage.setItem('solroulette_guest_total_wagered', totalWagered);
                    localStorage.setItem('solroulette_guest_win_streak', winStreak);
                    localStorage.setItem('solroulette_guest_ten_x_wins', tenXWins);
                    localStorage.setItem('solroulette_guest_achievements', JSON.stringify([...achievementsUnlocked]));
                    localStorage.setItem('solroulette_guest_spin_count', guestSpinCount); // Save guest spin count
                    localStorage.setItem('solroulette_fake_winnings_total', fakeWinningsTotal); // Save demo winnings
                }

                isGuestMode = false; // Exit demo mode on real wallet connection

                // Save state to localStorage (real wallet keys)
                localStorage.setItem('solroulette_wallet', user.wallet);
                localStorage.setItem('solroulette_user_name', user.name);
                localStorage.setItem('solroulette_is_guest', 'false'); // Update guest mode status

                // Mark that a real bet is now possible/wallet is connected
                firstRealBetPlaced = true;
                localStorage.setItem('solroulette_first_real_bet_placed', 'true');


                updateUIDebounced();
                addChatMessage('System', `${user.name} joined the game!`, '', 'system');

                // Hide connect button, show place bet button
                document.getElementById('connectWalletBtn').style.display = 'none';
                document.getElementById('placeBetBtn').style.display = 'block';

                closeWalletModal(); // Close the wallet modal on successful connection

                checkDailyBonus(); // Check for daily bonus after connecting wallet

                showMessageBox('Wallet Connected', 'Your wallet has been successfully connected and verified!');

                // Stop auto demo if it was running
                stopAutoDemo();

                connectWalletBtn.textContent = ' Wallet Connected';
                connectWalletBtn.disabled = true;


            } catch (e) {
                console.error("Wallet connection failed:", e);
                showMessageBox("Connection Failed", "Failed to connect wallet: " + e.message);
                if (navigator.vibrate) navigator.vibrate(200); // Vibrate on error
                connectWalletBtn.textContent = 'Connect Wallet';
                connectWalletBtn.disabled = false;
            }
        }

         // Wallet Connection Mobile Fixes
         function handleWalletConnection() {
             const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

             // Deep linking configuration
             const walletConfig = {
                 phantom: {
                     deepLink: 'https://phantom.app/ul/browse/',
                     name: 'Phantom'
                 },
                 solflare: {
                     deepLink: 'https://solflare.com/ul/v1/browse/',
                     name: 'Solflare'
                 }
             };

             document.getElementById('connectPhantomBtn').addEventListener('click', (e) => {
                 if (isMobile) {
                     const currentURL = encodeURIComponent(window.location.href);
                     const deepLink = walletConfig['phantom'].deepLink + currentURL;

                     // Store wallet choice in sessionStorage for return visit
                     sessionStorage.setItem('preferredWallet', 'phantom');

                     // Open wallet app
                     window.location.href = deepLink;
                 } else {
                     connectWallet(); // For desktop, proceed with direct connection
                 }

                 // Add haptic feedback
                 if (navigator.vibrate) {
                     navigator.vibrate(50);
                 }
             });
         }


         function openWalletModal() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             document.getElementById('walletModal').classList.add('visible');
             resetIdleTimer(); // Reset idle timer on modal open
             stopAutoDemo(); // Stop auto demo on modal open
         }

         function closeWalletModal() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             document.getElementById('walletModal').classList.remove('visible');
             resetIdleTimer(); // Reset idle timer on modal close
             // Restart auto demo if it was active before opening the modal (optional, depends on desired flow)
             // if (wasAutoDemoActive) startAutoDemo();
         }

        // Update Timer (now driven by backend's spinCountdown event)
        function updateTimer() {
            const timerElement = document.getElementById('globalTimer');
            const pointerElement = document.getElementById('pointer');
            const preSpinCtaElement = document.getElementById('preSpinCta');
            const rouletteCanvas = document.getElementById('rouletteCanvas');

            // Add console log to check currentBet.multiplier in updateTimer
            console.log('updateTimer running. currentBet.multiplier:', currentBet.multiplier);


            if (isSpinning) {
                 timerElement.textContent = ` Spinning...`;
                 timerElement.style.background = 'linear-gradient(45deg, var(--accent), var(--primary))';
                 timerElement.classList.remove('urgent');
                 pointerElement.classList.remove('pulse'); // Stop pointer pulse
                 document.getElementById('backgroundOverlay').classList.add('intensify-particles'); // Intensify particles
                 if (currentTickSound) {
                     currentTickSound.stop(); // Stop tick sound when spinning starts
                     currentTickSound = null;
                 }
                 document.getElementById('strobeOverlay').classList.add('active'); // Activate strobe
                 preSpinCtaElement.textContent = 'Bets closed. Spinning now...'; // Update CTA

                 // Disable Spin Again button during spin
                 document.getElementById('resultModalSpinAgainBtn').disabled = true;
                 rouletteCanvas.classList.remove('countdown-glow'); // Remove glow while spinning

                 return;
            }

            document.getElementById('strobeOverlay').classList.remove('active'); // Deactivate strobe
            document.getElementById('backgroundOverlay').classList.remove('intensify-particles'); // De-intensify particles

            // Enable Spin Again button if betting is allowed
            if (!isSpinning && spinTimer > 3) {
                 document.getElementById('resultModalSpinAgainBtn').disabled = false;
            }


            timerElement.textContent = ` Next Spin: ${spinTimer}s`;
            timerElement.style.background = 'linear-gradient(45deg, var(--danger), var(--primary))';
             timerElement.classList.remove('urgent'); // Remove urgent class initially
             pointerElement.classList.remove('pulse'); // Stop pointer pulse
             rouletteCanvas.classList.remove('countdown-glow'); // Remove glow unless countdown is low


            if (spinTimer <= 10 && spinTimer > 0) {
                 timerElement.classList.add('urgent'); // Add urgent class for faster pulse and red gradient
                 // Play tick sound only if not already playing
                 if (!currentTickSound) {
                    currentTickSound = playSound('tick', 0.5, true); // Play tick sound on loop
                 }
                 // Increase pitch as timer nears 0 (mock pitch increase)
                 if (currentTickSound && audioContext && currentTickSound.playbackRate) { // Check playbackRate exists
                     const pitch = 1 + (10 - spinTimer) * 0.05; // Increase pitch by 0.05 for each second closer to 0
                     currentTickSound.playbackRate.setValueAtTime(pitch, audioContext.currentTime);
                 }
                if (spinTimer <= 5) {
                    preSpinCtaElement.textContent = `${spinTimer}s left...`; // Update CTA
                } else {
                     preSpinCtaElement.textContent = 'Place your bets...'; // Default CTA
                }
                 // Add glow to wheel during countdown
                 rouletteCanvas.classList.add('countdown-glow');


            } else {
                 if (currentTickSound) {
                     currentTickSound.stop(); // Stop tick sound when timer is above 10 or is 0
                     currentTickSound = null;
                 }
                 preSpinCtaElement.textContent = 'Place your bets...'; // Default CTA
                 rouletteCanvas.classList.remove('countdown-glow'); // Remove glow if timer is high or zero
            }

             // Pulse pointer when timer is <= 3s
             if (spinTimer <= 3 && spinTimer > 0) {
                 pointerElement.classList.add('pulse');
             } else {
                 pointerElement.classList.remove('pulse');
             }

            // The spinWheel() call and timer reset are now handled by the backend's spinCountdown event
            // when it sends 'Spinning...' or 0s.
            // updateUIDebounced(); // Update UI elements that depend on the timer state - already called by socket listener
        }

        // Simulate Multiplayer (placing bets for the next round)
        function simulateMultiplayer() {
            // Only simulate if not spinning or in auto demo (auto demo handles its own bets)
            if (isSpinning || spinTimer <= 3 || isAutoDemo) return;

            playersOnline += Math.floor(Math.random() * 10 - 5);
            document.getElementById('playersOnline').textContent = playersOnline;

            const fakeUsers = ['SolDegen', 'CryptoChad', 'MoonApe', 'WheelMaster', 'LuckyLuke', 'GambaGuy', 'AnonBets', 'SolSpinner', 'DeFiKing', 'NFTCollector'];
            const multipliers = ['1.5', '2', '3', '5', '10']; // Use numeric strings

            // Simulate fake bets
            if (Math.random() < 0.7) { // 70% chance to add a fake bet
                 const newBet = {
                    user: fakeUsers[Math.floor(Math.random() * fakeUsers.length)],
                    amount: parseFloat((Math.random() * 5).toFixed(2)),
                    multiplier: multipliers[Math.floor(Math.random() * multipliers.length)] // Store as numeric string
                 };
                 // Add to the UI feed immediately to show active bets
                 addBetEntry(`@${newBet.user}`, newBet.amount, newBet.multiplier); // Pass amount as number
            }

            // Simulate fake chat messages
            if (Math.random() < 0.5) { // 50% chance to add a fake message
                const fakeMessages = ['Gonna hit 10x this round! ', 'Feeling lucky today!', 'Any big bettors out there?', 'Let\'s gooo!', 'Hope I don\'t bust ', 'What multiplier are you guys on?', 'Spin it!', 'To the moon! ', 'Wen 10x?', 'This wheel is rigged! '];
                addChatMessage(fakeUsers[Math.floor(Math.random() * fakeUsers.length)], fakeMessages[Math.floor(Math.random() * fakeMessages.length)], '', 'user');
            }

            // Simulate leaderboard updates periodically
            // updateLeaderboard(); // Now called by its own interval

            // Update fake activity banner
            updateFakeActivityBanner();
        }

         // Update Fake Activity Banner
         function updateFakeActivityBanner() {
             const watchers = Math.floor(Math.random() * 50) + 20; // 20-70 watchers
             const betting10x = Math.floor(Math.random() * 10); // 0-10 betting 10x
             const winsHit = Math.floor(Math.random() * 5); // 0-5 wins

             document.getElementById('activityWatchers').textContent = ` ${watchers} watching`;
             document.getElementById('activityBetting').textContent = `${betting10x} betting 10x`;
             document.getElementById('activityWins').textContent = `${winsHit} wins just hit!`;
         }

         // Show 10x Hit Banner (Fake)
         function showTenXHitBanner() {
             const banner = document.getElementById('tenXHitBanner');
             banner.style.display = 'block';
             playSound('win_10x'); // Play a sound effect
             setTimeout(() => {
                 banner.style.display = 'none';
             }, 3000); // Hide after 3 seconds
         }


        // Add Bet Entry to Feed
        function addBetEntry(user, amount, multiplier) {
            const feed = document.getElementById('liveBetsContent'); // Append to liveBetsContent
            const entry = document.createElement('div');
            entry.className = 'bet-entry';
            // Display multiplier with 'x' in the feed
            entry.innerHTML = `<i class="fas fa-dice"></i> <span class="user">${user}</span> bet <span class="amount">${amount.toFixed(2)}</span> on <span class="multiplier">${multiplier}x</span>`;
            feed.appendChild(entry);
            feed.scrollTop = feed.scrollHeight; // Auto-scroll to bottom

             // Show unread dot if live panel is closed
             const livePanelContainer = document.getElementById('livePanelContainer');
             // Check if the panel is NOT active (i.e., closed)
             if (!livePanelContainer.classList.contains('active')) {
                 document.getElementById('livePanelUnreadDot').style.display = 'block';
                 document.getElementById('betsUnreadDot').style.display = 'block';
             }
        }

        // Add Chat Message to Feed
        function addChatMessage(user, text, reaction, type) { // Added type parameter
            const chatFeed = document.getElementById('chatFeed'); // Use chatFeed div
            const msg = document.createElement('div');
            msg.className = 'chat-message';
            const userClass = type === 'system' ? 'system' : 'user';
            msg.innerHTML = `<i class="fas ${type === 'system' ? 'fa-robot' : 'fa-user'}"></i> <span class="${userClass}">${user}:</span> ${text} <span class="reaction">${reaction}</span>`;
            chatFeed.appendChild(msg); // Append to chatFeed
            chatFeed.scrollTop = chatFeed.scrollHeight; // Auto-scroll to bottom

            // Show unread dot if live panel is closed or on bets tab
            const livePanelContainer = document.getElementById('livePanelContainer');
            const chatTab = document.querySelector('.live-panel-tab[data-tab="chat"]');
            // Check if the panel is NOT active OR if the chat tab is NOT active
            if (!livePanelContainer.classList.contains('active') || !chatTab.classList.contains('active')) {
                document.getElementById('livePanelUnreadDot').style.display = 'block';
                document.getElementById('chatUnreadDot').style.display = 'block';
            }
        }

        // Send Chat
        function sendChat() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;

            // Handle /tip command (mock)
            if (text.startsWith('/tip ')) {
                 const parts = text.split(' ');
                 if (parts.length === 3) {
                     const targetUser = parts[1];
                     const tipAmount = parseFloat(parts[2]);
                     if (!isNaN(tipAmount) && tipAmount > 0 && tokensEarned >= tipAmount && !isGuestMode) { // Cannot tip in guest mode
                         tokensEarned -= tipAmount;
                         localStorage.setItem('solroulette_spin_tokens', tokensEarned);
                         addChatMessage('System', `${user.name} tipped ${targetUser} ${tipAmount.toFixed(3)} $SPIN!`, '', 'system');
                         updateUIDebounced();
                     } else if (isGuestMode) {
                         showMessageBox('Demo Mode Limitation', 'Connect your wallet to tip $SPIN.');
                     }
                     else {
                         showMessageBox('Tip Failed', 'Invalid tip amount or insufficient $SPIN.');
                     }
                 } else {
                     showMessageBox('Invalid Command', 'Usage: /tip [username] [amount]');
                 }
            } else {
                addChatMessage(user.name, text, '', 'user'); // Use 'user' type
                xp += 5; // Earn XP for chatting
                checkAchievements();
                updateUIDebounced();
                // Emit chat message to backend if connected
                if (window.socket && window.socket.connected && window.walletVerified) {
                    window.socket.emit('chatMessage', { text: text, reaction: '' });
                }
            }

            input.value = '';
            resetIdleTimer(); // Reset idle timer on chat
            stopAutoDemo(); // Stop auto demo on chat interaction
        }

        // Place Bet
        function placeBet() {
             // Add console log at the beginning of placeBet
             console.log("Placing bet with:", currentBet);

            // Play bet confirmation sound
            playSound('click');
            if (navigator.vibrate) navigator.vibrate(80); // Haptic feedback on spin start

            // Null Bet Bug - Check for multiplier and amount > 0
            if (currentBet.multiplier === null || currentBet.amount <= 0) {
                showMessageBox('Invalid Bet', 'Please select a multiplier and enter a bet amount greater than 0.');
                 if (navigator.vibrate) navigator.vibrate(200);
                return; // Prevent placing bet if conditions not met
            }


            const amount = currentBet.amount; // Use currentBet.amount which is already set by slider input

            // Demo SOL Deduction & Refill Modal
            // Auto Refill Demo SOL if balance is too low in guest mode
            if (isGuestMode && walletBalance < amount) {
                 if (window.autoRefill) { // Check autoRefill flag
                     refillFakeSol(); // Auto refill
                     // Now check if the bet is possible after refill
                     if (walletBalance < amount) {
                         showMessageBox('Insufficient Balance', 'Insufficient SOL balance even after refill!');
                         if (navigator.vibrate) navigator.vibrate(200);
                         return;
                     }
                 } else { // Manual refill needed
                     openRefillFakeSolModal();
                     return; // Prevent placing bet if balance is too low
                 }
            }


            if (walletBalance < amount) {
                // This case should be caught by the previous guest mode check,
                // but keep as a fallback for real wallet mode.
                showMessageBox('Insufficient Balance', 'Insufficient SOL balance!');
                 if (navigator.vibrate) navigator.vibrate(200);
                return;
            }
            if (spinTimer <= 3 || isSpinning) { // Betting is closed if timer is 3s or less, or if spinning
                showMessageBox('Betting Closed', 'Betting is closed for this round!');
                 if (navigator.vibrate) navigator.vibrate(200);
                return;
            }

            // Add console log before pushing bet
            console.log('Pushing bet with multiplier:', currentBet.multiplier, 'and amount:', currentBet.amount);

            // Deduct bet amount immediately (optimistic UI update)
            walletBalance -= amount;
            totalWagered += amount;

            // Add user's bet to the list of bets for the current round
            // Store multiplier as numeric string
            playerBets.push({ user: user.name, amount, multiplier: currentBet.multiplier, isUser: true }); // Store numeric string

            // Add user's bet to the live feed (optimistic UI update)
            addBetEntry('You', amount, currentBet.multiplier); // Pass amount as number

            xp += 10; // Earn XP for placing a bet
            checkAchievements();
            updateUIDebounced(); // Update UI to show deducted balance and XP


            // Disable bet controls until next round starts (or until server confirms error)
            document.getElementById('placeBetBtn').disabled = true;
            document.getElementById('placeBetBtn').textContent = 'Bet Placed!';
            document.querySelectorAll('.multiplier-btn').forEach(btn => {
                 btn.disabled = true;
                 btn.title = 'Betting is closed'; // Update tooltip
            });
            document.getElementById('betSlider').disabled = true;
             document.getElementById('betSlider').title = 'Betting is closed'; // Update tooltip

             // Dismiss onboarding tooltip/glow if active
             dismissOnboarding();


            // Show mock transaction feedback (only for real wallet, or maybe simulate for guest?)
            if (!isGuestMode) {
                 addChatMessage('System', `Transaction sent: ${amount.toFixed(2)} on ${currentBet.multiplier}x!`, '', 'system'); // Display with 'x'
                 // Mark that a real bet is now possible/wallet is connected
                 firstRealBetPlaced = true;
                 localStorage.setItem('solroulette_first_real_bet_placed', 'true');
                 stopAutoDemo(); // Stop auto demo on first real bet
                 // Emit bet to backend if connected
                 if (window.socket && window.socket.connected && window.walletVerified) {
                    window.socket.emit('placeBet', { amount: amount, multiplier: parseFloat(currentBet.multiplier) });
                 }
             } else {
                 addChatMessage('System', `Demo transaction sent: ${amount.toFixed(2)} on ${currentBet.multiplier}x!`, '', 'system'); // Display with 'x'
             }


            // Save state to localStorage (real wallet keys)
            if (isGuestMode) {
                 localStorage.setItem('solroulette_guest_balance', walletBalance);
                 localStorage.setItem('solroulette_guest_xp', xp);
                 localStorage.setItem('solroulette_guest_tokens', tokensEarned);
                 localStorage.setItem('solroulette_guest_total_wagered', totalWagered);
                 localStorage.setItem('solroulette_guest_win_streak', winStreak);
                 localStorage.setItem('solroulette_guest_ten_x_wins', tenXWins);
                 localStorage.setItem('solroulette_guest_achievements', JSON.stringify([...achievementsUnlocked]));
                 guestSpinCount++; // Increment guest spin count
                 localStorage.setItem('solroulette_guest_spin_count', guestSpinCount);
                 localStorage.setItem('solroulette_fake_winnings_total', fakeWinningsTotal); // Save demo winnings
             } else {
                 localStorage.setItem('solroulette_wallet_balance', walletBalance); // Save balance
                 localStorage.setItem('solroulette_total_wagered', totalWagered);
                 localStorage.setItem('solroulette_xp', xp);
                 localStorage.setItem('solroulette_level', level);
                 localStorage.setItem('solroulette_spin_tokens', tokensEarned);
                 localStorage.setItem('solroulette_win_streak', winStreak);
                 localStorage.setItem('solroulette_ten_x_wins', tenXWins);
                 localStorage.setItem('solroulette_achievements', JSON.stringify([...achievementsUnlocked]));
                 localStorage.setItem('solroulette_wallet', user.wallet);
                 localStorage.setItem('solroulette_user_name', user.name);
                 localStorage.setItem('solroulette_user_avatar', user.avatar);
             }
             localStorage.setItem('solroulette_is_guest', isGuestMode); // Save guest mode status
             localStorage.setItem('solroulette_first_real_bet_placed', firstRealBetPlaced); // Save real bet flag
             // Clear current bet state in localStorage
             localStorage.removeItem('solroulette_current_multiplier');
             localStorage.removeItem('solroulette_current_amount');
             localStorage.setItem('solroulette_last_spin_result', lastSpinResult); // Save the actual result string


            // Start the spin animation immediately after placing the bet
            // spinWheel(); // This is now triggered by backend's spinCountdown event
            resetIdleTimer(); // Reset idle timer on bet
            // Auto demo is stopped when placeBet is called
        }

         // Function to handle the result of the spin
         // Now accepts betsOutcome, newLeaderboard, newUsersOnline from backend
         function handleSpinResult(betsOutcome, newLeaderboard, newUsersOnline) {
             let userWinAmount = 0;
             let userLostAmount = 0; // Track lost amount for result modal
             let userWon = false;
             // The winningMultiplier is already determined in spinWheel() and stored in lastSpinResult
             // Use lastSpinResult (string with 'x')
             let winningMultiplierString = lastSpinResult; // e.g., '2x'

             // Update recent spins display with the actual winning multiplier
             recentSpins.unshift({ multiplier: winningMultiplierString, won: true }); // Assume 'won: true' for the multiplier that landed
             if (recentSpins.length > 10) {
                 recentSpins.pop(); // Keep only the last 10
             }
             localStorage.setItem('solroulette_recent_spins', JSON.stringify(recentSpins)); // Save recent spins
             updateRecentSpinsDisplay();

             let userBetOutcome = null;
             // Iterate through the authoritative betsOutcome from the backend
             betsOutcome.forEach(outcome => {
                 // Check if this outcome belongs to the current user
                 if (outcome.publicKey === user.wallet) { // Compare with user's wallet (public key)
                     userBetOutcome = outcome;
                     userWon = outcome.won;
                     if (userWon) {
                         userWinAmount = outcome.winnings;
                         // Update user's local state based on server's outcome
                         walletBalance = outcome.solBalance;
                         totalWagered = outcome.totalWagered;
                         winStreak = outcome.winStreak;
                         tenXWins = outcome.tenXWins;
                         xp = outcome.xp;
                         level = outcome.level;
                         achievementsUnlocked = new Set(outcome.achievements || []);
                         addChatMessage('System', `${user.name} won ${userWinAmount.toFixed(2)} on ${winningMultiplierString}! `, '', 'system');
                         if (isGuestMode) {
                             // For guest mode, calculate net winnings based on initial bet amount
                             const initialBetAmount = playerBets.find(b => b.isUser)?.amount || 0;
                             fakeWinningsTotal += userWinAmount - initialBetAmount;
                             localStorage.setItem('solroulette_fake_winnings_total', fakeWinningsTotal);
                         }
                     } else {
                         userLostAmount = outcome.amount; // The amount they lost
                         // Update user's local state based on server's outcome
                         walletBalance = outcome.solBalance;
                         totalWagered = outcome.totalWagered;
                         winStreak = outcome.winStreak;
                         tenXWins = outcome.tenXWins;
                         xp = outcome.xp;
                         level = outcome.level;
                         achievementsUnlocked = new Set(outcome.achievements || []);
                         addChatMessage('System', `${user.name} busted on ${outcome.multiplier}x! `, '', 'system');
                         lastLossBet = { amount: outcome.amount, multiplier: outcome.multiplier };
                         if (isGuestMode) {
                             fakeWinningsTotal -= outcome.amount;
                             localStorage.setItem('solroulette_fake_winnings_total', fakeWinningsTotal);
                         }
                     }
                 } else {
                     // Other players' outcomes
                     if (outcome.won) {
                         addChatMessage('System', `@${outcome.username} won on ${winningMultiplierString}! `, '', 'system');
                     } else {
                         addChatMessage('System', `@${outcome.username} busted! `, '', 'system');
                     }
                 }
             });

             // Handle user's win/loss feedback
             if (userWon) {
                 playSound('win');
                 triggerMoneyRain();
                 if (parseFloat(winningMultiplierString.replace('x', '')) >= 5) {
                     playSound('win_10x');
                     showFlash('win-10x');
                 } else {
                      showFlash('win');
                 }
                 if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
                 showConfetti();
                 lastLossBet = null;
                 if (parseFloat(winningMultiplierString.replace('x', '')) >= 5) showShareModal(userWinAmount, winningMultiplierString);
                 document.getElementById('chatInput').value = ` Just hit ${winningMultiplierString} on SolRoulette! `;
             } else if (userBetOutcome) { // Only play sad trombone if the user actually placed a bet and lost
                 playSound('sad_trombone');
                 showFlash('lose');
                 if (navigator.vibrate) navigator.vibrate(300);
                 if (!isGuestMode && user.wallet && lastLossBet) {
                     openDoubleOrNothingModal();
                 }
             }

             // Update tokens based on participation or win (only in real wallet mode)
             if (!isGuestMode && userBetOutcome) { // Only update tokens if a real bet was placed
                 updateTokens(userWon ? 0.05 : 0.01);
             } else if (isGuestMode) {
                 showGuestModeToast();
                 if (walletBalance < 0.01 && !document.getElementById('refillFakeSolModal').classList.contains('visible')) {
                     openRefillFakeSolModal();
                 }
             }

             // Reset user's current bet state and enable controls
             currentBet = { multiplier: null, amount: 0 };
             document.getElementById('placeBetBtn').disabled = false;
             document.getElementById('placeBetBtn').textContent = ' Place Bet';
             document.querySelectorAll('.multiplier-btn').forEach(btn => {
                 btn.classList.remove('active');
                 btn.disabled = false;
                 btn.title = isGuestMode ? 'Using Demo SOL  Real rewards require a wallet' : (user.wallet ? '' : 'Connect Wallet to Bet');
             });
             document.getElementById('betSlider').disabled = false;
             document.getElementById('betSlider').title = isGuestMode ? 'Using Demo SOL  Real rewards require a wallet' : (user.wallet ? '' : 'Connect Wallet to Bet');

             xp += 10; // Earn XP for completing a round
             checkAchievements();
             updateUIDebounced();

             // Save state to localStorage based on mode
             if (isGuestMode) {
                 localStorage.setItem('solroulette_guest_balance', walletBalance);
                 localStorage.setItem('solroulette_guest_xp', xp);
                 localStorage.setItem('solroulette_guest_tokens', tokensEarned);
                 localStorage.setItem('solroulette_guest_total_wagered', totalWagered);
                 localStorage.setItem('solroulette_guest_win_streak', winStreak);
                 localStorage.setItem('solroulette_guest_ten_x_wins', tenXWins);
                 localStorage.setItem('solroulette_guest_achievements', JSON.stringify([...achievementsUnlocked]));
                 guestSpinCount++;
                 localStorage.setItem('solroulette_guest_spin_count', guestSpinCount);
                 localStorage.setItem('solroulette_fake_winnings_total', fakeWinningsTotal);
             } else {
                 localStorage.setItem('solroulette_wallet_balance', walletBalance);
                 localStorage.setItem('solroulette_total_wagered', totalWagered);
                 localStorage.setItem('solroulette_xp', xp);
                 localStorage.setItem('solroulette_level', level);
                 localStorage.setItem('solroulette_spin_tokens', tokensEarned);
                 localStorage.setItem('solroulette_win_streak', winStreak);
                 localStorage.setItem('solroulette_ten_x_wins', tenXWins);
                 localStorage.setItem('solroulette_achievements', JSON.stringify([...achievementsUnlocked]));
                 localStorage.setItem('solroulette_wallet', user.wallet);
                 localStorage.setItem('solroulette_user_name', user.name);
                 localStorage.setItem('solroulette_user_avatar', user.avatar);
             }
             localStorage.setItem('solroulette_is_guest', isGuestMode);
             localStorage.setItem('solroulette_first_real_bet_placed', firstRealBetPlaced);
             localStorage.removeItem('solroulette_current_multiplier');
             localStorage.removeItem('solroulette_current_amount');
             localStorage.setItem('solroulette_last_spin_result', winningMultiplierString);

             // Update leaderboard and player count from the server's data
             updateLeaderboard(newLeaderboard);
             playersOnline = newUsersOnline; // Update players online count
             document.getElementById('playersOnline').textContent = playersOnline;


             if (!isGuestMode) {
                 checkLowBalance();
             } else {
                 document.getElementById('lowBalanceAlert').style.display = 'none';
             }

             // Only show result modal if the user actually placed a bet
             if (userBetOutcome) {
                showResultModal(userBetOutcome.multiplier + 'x', winningMultiplierString, userWon, userWinAmount, userLostAmount);
             } else {
                 console.log("No user bet placed this round. Spin result:", winningMultiplierString);
             }

             if (isGuestMode && guestSpinCount >= 3 && localStorage.getItem('solroulette_guest_modal_shown') === null) {
                 showMessageBox('Enjoying the game?', 'Connect your wallet to win real rewards!');
                 localStorage.setItem('solroulette_guest_modal_shown', 'true');
             }

             if (isAutoDemo) {
                 setTimeout(startAutoDemo, 3000);
             }
         }

         // Show Result Modal
         function showResultModal(pickedDisplay, landedDisplay, won, winAmount, lostAmount) {
             const modal = document.getElementById('resultModal');
             const title = document.getElementById('resultModalTitle');
             const message = document.getElementById('resultModalMessage');
             const spinAgainBtn = document.getElementById('resultModalSpinAgainBtn');

             title.classList.remove('win', 'lose');

             if (won) {
                 title.textContent = 'You Won!';
                 title.classList.add('win');
                 message.textContent = `You picked ${pickedDisplay}. Landed on ${landedDisplay}. You won ${winAmount.toFixed(2)}.`;
             } else {
                 title.textContent = 'You Lost!';
                 title.classList.add('lose');
                 message.textContent = `You picked ${pickedDisplay}. Landed on ${landedDisplay}. You lost ${lostAmount.toFixed(2)}.`;
             }

             modal.classList.add('visible');
             resetIdleTimer();
             stopAutoDemo();
         }

         function closeResultModal() {
              playSound('click');
              if (navigator.vibrate) navigator.vibrate(50);
              document.getElementById('resultModal').classList.remove('visible');
              resetIdleTimer();
         }

         // Refill Demo SOL Modal
         function openRefillFakeSolModal() {
             document.getElementById('refillFakeSolModal').classList.add('visible');
             resetIdleTimer();
             stopAutoDemo();
         }

         function closeRefillFakeSolModal() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             document.getElementById('refillFakeSolModal').classList.remove('visible');
             resetIdleTimer();
         }

         function refillFakeSol() {
             playSound('win');
             if (navigator.vibrate) navigator.vibrate([50, 50]);
             walletBalance = 500;
             localStorage.setItem('solroulette_guest_balance', walletBalance);
             showMessageBox('Refilled!', 'Your demo SOL balance has been refilled.');
             updateUIDebounced();
             closeRefillFakeSolModal();
         }


        // Wheel Spin (Initiation)
        function spinWheel() {
            isSpinning = true;
            playSound('whoosh', 0.7);
            if (navigator.vibrate) navigator.vibrate([80]);


            const wheel = document.getElementById('rouletteCanvas');
            const pointer = document.getElementById('pointer');
            const container = document.getElementById('wheelContainer');

            // Determine the actual winning multiplier (mock logic with psychological bait)
            // This is now determined by the backend. Frontend just needs to animate to it.
            // The `lastSpinResult` will be set by the `socket.on('spinResult')` event.

            // Calculate the target rotation based on the actual winning multiplier string
            // Use the lastSpinResult (which will be the server's result) for animation target
            targetRotation = calculateCanvasTargetRotation(lastSpinResult);

            spinStartTime = null;
            spinAnimationId = requestAnimationFrame(animateWheel);

            container.classList.add('bounce');
            pointer.classList.add('vibrate');

            // Remove bounce/vibrate after the animation duration
            setTimeout(() => {
                 container.classList.remove('bounce');
                 pointer.classList.remove('vibrate');
                 playSound('clank');
            }, spinDuration);

            // Emit spinstart event
            const event = new Event('spinstart');
            document.getElementById('rouletteCanvas').dispatchEvent(event);
        }


        // Update Tokens
        function updateTokens(amount) {
            tokensEarned += amount;
            localStorage.setItem('solroulette_spin_tokens', tokensEarned);
            document.getElementById('tokenCount').textContent = tokensEarned.toFixed(3);
            document.getElementById('shopSpinBalance').textContent = tokensEarned.toFixed(3);
            document.getElementById('tokenNotification').style.display = 'flex';

            const float = document.createElement('div');
            float.className = 'token-float';
            float.textContent = `+${amount.toFixed(3)} $SPIN`;
            const notificationRect = document.getElementById('tokenNotification').getBoundingClientRect();
            float.style.left = `${notificationRect.left + notificationRect.width / 2}px`;
            float.style.top = `${notificationRect.top - 10}px`;
            document.body.appendChild(float);
            setTimeout(() => float.remove(), 1500);
        }

        // Claim Tokens
        function openClaimModal() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);

            if (isGuestMode) {
                 showMessageBox('Demo Mode Limitation', 'Connect your wallet to claim $SPIN tokens.');
                 return;
            }
            if (tokensEarned <= 0) {
                 showMessageBox('No Tokens', 'No $SPIN tokens to claim.');
                 return;
            }
            showMessageBox('Tokens Claimed', `Claimed ${tokensEarned.toFixed(3)} $SPIN! (Mock Claim)`);
            tokensEarned = 0;
            localStorage.setItem('solroulette_spin_tokens', tokensEarned);
            document.getElementById('tokenCount').textContent = tokensEarned.toFixed(3);
            document.getElementById('shopSpinBalance').textContent = tokensEarned.toFixed(3);
            document.getElementById('tokenNotification').style.display = 'none';
            updateUIDebounced();
        }

        // Achievements
        function checkAchievements() {
            const achievements = [
                { name: 'First Bust', condition: winStreak === 0 && totalWagered > 0, icon: '' },
                { name: 'Hit 10x', condition: tenXWins >= 1, icon: '' },
                { name: '10 Spins', condition: guestSpinCount >= 10, icon: '' },
                { name: 'High Roller', condition: totalWagered >= 50, icon: '' },
                 { name: 'Lucky Streak x3', condition: winStreak >= 3, icon: '' },
                 { name: 'Chatty', condition: xp >= 50, icon: '' },
                 { name: 'Daily Grinder', condition: dailyBonusDay >= 5, icon: '' }
            ];

            achievements.forEach(ach => {
                if (ach.condition && !achievementsUnlocked.has(ach.name)) {
                    unlockAchievement(ach.name, ach.icon);
                }
            });
             localStorage.setItem('solroulette_achievements', JSON.stringify([...achievementsUnlocked]));
        }

        function unlockAchievement(name, icon) {
            achievementsUnlocked.add(name);
            const container = document.getElementById('achievementContainer');
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `
                <div class="badge-icon">${icon}</div>
                <div>
                    <div style="font-weight: bold;">Achievement Unlocked!</div>
                    <div>${name}</div>
                </div>
            `;
            container.appendChild(popup);
            setTimeout(() => popup.remove(), 4000);
             localStorage.setItem('solroulette_achievements', JSON.stringify([...achievementsUnlocked]));
        }

        // Flash Screen
        function showFlash(type) {
            const flash = document.getElementById('flashScreen');
            flash.className = `flash-screen ${type}`;
            setTimeout(() => flash.className = 'flash-screen', 100);
        }

         // Confetti Effect
         function showConfetti() {
            const confettiColors = ['var(--primary)', 'var(--accent)', 'var(--success)', 'var(--danger)'];
            const confettiCount = window.innerWidth < 768 ? 50 : 100;
            const confettiShapes = ['square', 'circle', 'triangle', 'star'];

            for (let i = 0; i < confettiCount; i++) {
                 const confetti = document.createElement('div');
                 const shape = confettiShapes[Math.floor(Math.random() * confettiShapes.length)];
                 confetti.className = `confetti ${shape}`;
                 confetti.style.left = `${Math.random() * 100}vw`;
                 confetti.style.top = `${Math.random() * -20}vh`;
                 const size = window.innerWidth < 768 ? Math.random() * 8 + 3 : Math.random() * 10 + 5;
                 confetti.style.width = `${size}px`;
                 confetti.style.height = confetti.style.width;
                 confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                 confetti.style.animationDelay = `${Math.random() * 1}s`;
                 confetti.style.animationDuration = `${Math.random() * 2 + 1.5}s`;
                 document.body.appendChild(confetti);
                 confetti.addEventListener('animationend', () => confetti.remove());
             }
         }

        // Share Modal
        function showShareModal(winnings, multiplier) {
             playSound('win_10x');
             if (navigator.vibrate) navigator.vibrate([50, 50]);

            document.getElementById('shareTitle').textContent = 'Big Win!';
            document.getElementById('shareMessage').textContent = `Just won ${winnings.toFixed(2)} on the ${multiplier} multiplier! Share your victory!`;
            const shareText = `Just won ${winnings.toFixed(2)} on ${multiplier} at SolRoulette LIVE! Spin now: ${user.referral} #SolRoulette #Solana #Crypto`;
            document.getElementById('shareText').value = shareText;
            document.getElementById('shareModal').classList.add('visible');
        }

        function copyShareText() {
            playSound('click');
            if (navigator.vibrate) navigator.vibrate(50);
            const shareText = document.getElementById('shareText');
            shareText.select();
            shareText.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                showMessageBox('Copied!', 'Share link copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showMessageBox('Copy Failed', 'Failed to copy link. Please copy manually.');
            }
        }

         function tweetWin() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             const shareText = document.getElementById('shareText').value;
             const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`;
             window.open(twitterUrl, '_blank');
             closeShareModal();
         }

        function closeShareModal() {
            playSound('click');
            if (navigator.vibrate) navigator.vibrate(50);
            document.getElementById('shareModal').classList.remove('visible');
        }

         // Message Box (Custom Alert)
         function showMessageBox(title, message, callback = null) {
             document.getElementById('messageBoxTitle').textContent = title;
             document.getElementById('messageBoxContent').textContent = message;
             const msgBox = document.getElementById('messageBox');
             msgBox.classList.add('visible');

             const okBtn = msgBox.querySelector('#closeMessageBoxBtn');
             const clonedOkBtn = okBtn.cloneNode(true);
             okBtn.parentNode.replaceChild(clonedOkBtn, okBtn);

             clonedOkBtn.addEventListener('click', () => {
                 closeMessageBox();
                 if (callback && typeof callback === 'function') {
                     callback();
                 }
             });

             resetIdleTimer();
             stopAutoDemo();
         }

         function closeMessageBox() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             document.getElementById('messageBox').classList.remove('visible');
             resetIdleTimer();
         }

         // Profile Modal
         function openProfileModal() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             updateProfileModal();
             document.getElementById('profileModal').classList.add('visible');
             resetIdleTimer();
             stopAutoDemo();
         }

         function closeProfileModal() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             document.getElementById('profileModal').classList.remove('visible');
             resetIdleTimer();
         }

         function updateProfileModal() {
             document.getElementById('profileAvatar').textContent = user.avatar;
             document.getElementById('profileName').textContent = user.name + (isGuestMode ? ' (Guest)' : '');
             document.getElementById('profileLevel').textContent = level;
             document.getElementById('profileXpFill').style.width = `${(xp % 100)}%`;
             document.getElementById('profileWallet').textContent = user.wallet ? user.wallet.slice(0, 6) + '...' + user.wallet.slice(-6) : 'Not Connected';
             document.getElementById('profileBalance').textContent = walletBalance.toFixed(2) + ' SOL' + (isGuestMode ? ' (Demo)' : '');
             document.getElementById('profileTotalWagered').textContent = totalWagered.toFixed(2) + ' SOL' + (isGuestMode ? ' (Demo)' : '');
             document.getElementById('profileWinStreak').textContent = winStreak + (isGuestMode ? ' (Demo)' : '');
             document.getElementById('profileTenXWins').textContent = tenXWins + (isGuestMode ? ' (Demo)' : '');

             const fakeWinningsElement = document.getElementById('profileFakeWinnings');
             const fakeWinningsTotalElement = document.getElementById('fakeWinningsTotal');
             if (isGuestMode) {
                 fakeWinningsElement.style.display = 'block';
                 fakeWinningsTotalElement.textContent = fakeWinningsTotal.toFixed(2);
             } else {
                 fakeWinningsElement.style.display = 'none';
             }

             const resetGuestBtn = document.getElementById('resetGuestProgressBtn');
             if (isGuestMode) {
                 resetGuestBtn.style.display = 'block';
             } else {
                 resetGuestBtn.style.display = 'none';
             }

             const achievementsGrid = document.getElementById('profileAchievementsGrid');
             achievementsGrid.innerHTML = '';
             const allAchievements = [
                 { name: 'First Bust', condition: winStreak === 0 && totalWagered > 0, icon: '' },
                 { name: 'Hit 10x', condition: tenXWins >= 1, icon: '' },
                 { name: '10 Spins', condition: guestSpinCount >= 10, icon: '' },
                 { name: 'High Roller', condition: totalWagered >= 50, icon: '' },
                 { name: 'Lucky Streak x3', condition: winStreak >= 3, icon: '' },
                 { name: 'Chatty', condition: xp >= 50, icon: '' },
                 { name: 'Daily Grinder', condition: dailyBonusDay >= 5, icon: '' }
             ];

             allAchievements.forEach(ach => {
                 const badge = document.createElement('div');
                 badge.className = 'badge-icon';
                 if (achievementsUnlocked.has(ach.name)) {
                     badge.textContent = ach.icon;
                     badge.title = ach.name;
                 } else {
                     badge.textContent = '?';
                     badge.style.opacity = 0.5;
                     badge.title = 'Locked';
                 }
                 achievementsGrid.appendChild(badge);
             });
         }

         function copyReferralLink() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             const referralInput = document.getElementById('referralLinkInput');
             referralInput.select();
             referralInput.setSelectionRange(0, 99999);
             try {
                document.execCommand('copy');
                showMessageBox('Copied!', 'Referral link copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy referral link: ', err);
                showMessageBox('Copy Failed', 'Failed to copy referral link. Please copy manually.');
            }
         }

         function generateReferralCode() {
             const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
             let code = '';
             for (let i = 0; i < 8; i++) {
                 code += chars.charAt(Math.floor(Math.random() * chars.length));
             }
             const referralLink = `https://solroulette.live?ref=${code}`;
             localStorage.setItem('solroulette_referral_code', referralLink);
             return referralLink;
         }

         // Check for referral code in URL on load
         function checkReferralCode() {
             const urlParams = new URLSearchParams(window.location.search);
             const ref = urlParams.get('ref');
             if (ref) {
                 localStorage.setItem('solroulette_referred_by', ref);
                 console.log(`Referred by: ${ref}`);
             }
         }

         // Reset Guest Progress
         function resetGuestProgress() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             showMessageBox('Confirm Reset', 'Are you sure you want to reset your demo progress? This cannot be undone.', () => {
                 localStorage.removeItem('solroulette_is_guest');
                 localStorage.removeItem('solroulette_guest_balance');
                 localStorage.removeItem('solroulette_guest_xp');
                 localStorage.removeItem('solroulette_guest_tokens');
                 localStorage.removeItem('solroulette_guest_total_wagered');
                 localStorage.removeItem('solroulette_guest_win_streak');
                 localStorage.removeItem('solroulette_guest_ten_x_wins');
                 localStorage.removeItem('solroulette_guest_achievements');
                 localStorage.removeItem('solroulette_guest_spin_count');
                 localStorage.removeItem('solroulette_guest_last_login');
                 localStorage.removeItem('solroulette_guest_daily_bonus_day');
                 localStorage.removeItem('solroulette_fake_winnings_total');
                 localStorage.removeItem('solroulette_fake_intro_shown');
                 localStorage.removeItem('solroulette_guest_modal_shown');
                 localStorage.removeItem('solroulette_onboarding_shown');
                 localStorage.removeItem('solroulette_first_real_bet_placed');
                 localStorage.removeItem('solroulette_current_multiplier');
                 localStorage.removeItem('solroulette_current_amount');
                 localStorage.removeItem('solroulette_last_spin_result');

                 location.reload();
             });
         }


         // Shop Modal
         function openShopModal() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             document.getElementById('shopSpinBalance').textContent = tokensEarned.toFixed(3);
             document.getElementById('shopModal').classList.add('visible');
             resetIdleTimer();
             stopAutoDemo();
         }

         function closeShopModal() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             document.getElementById('shopModal').classList.remove('visible');
             resetIdleTimer();
         }

         function buyShopItem(itemId, cost) {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             if (isGuestMode) {
                 showMessageBox('Demo Mode Limitation', 'Connect your wallet to buy shop items.');
                 return;
             }
             if (tokensEarned >= cost) {
                 tokensEarned -= cost;
                 localStorage.setItem('solroulette_spin_tokens', tokensEarned);
                 document.getElementById('shopSpinBalance').textContent = tokensEarned.toFixed(3);
                 showMessageBox('Purchase Successful', `You bought ${itemId}! (Mock Purchase)`);
                 updateUIDebounced();

                 if (itemId === 'rocket_avatar') {
                     user.avatar = '';
                     localStorage.setItem('solroulette_user_avatar', user.avatar);
                     updateUIDebounced();
                 } else if (itemId === 'fire_emote') {
                     addChatMessage('System', `${user.name} unlocked the  emote!`, '', 'system');
                 }

             } else {
                 showMessageBox('Purchase Failed', 'Not enough $SPIN tokens.');
             }
         }

         // Daily Login Bonus
         function checkDailyBonus() {
             const today = new Date().toDateString();
             const lastBonusDate = localStorage.getItem(isGuestMode ? 'solroulette_guest_last_login' : 'solroulette_last_login');

             if (lastBonusDate !== today) {
                 dailyBonusDay++;
                 localStorage.setItem(isGuestMode ? 'solroulette_guest_last_login' : 'solroulette_last_login', today);
                 localStorage.setItem(isGuestMode ? 'solroulette_guest_daily_bonus_day' : 'solroulette_daily_bonus_day', dailyBonusDay);

                 const bonusAmount = isGuestMode ? 25 : (dailyBonusDay === 7 ? 0.1 : 0.01);
                 const bonusCurrency = isGuestMode ? 'SOL' : (dailyBonusDay === 7 ? 'SOL' : '$SPIN');

                 document.getElementById('dailyBonusDay').textContent = dailyBonusDay;
                 document.getElementById('dailyBonusAmount').textContent = `Reward: ${bonusAmount.toFixed(bonusCurrency === 'SOL' ? 2 : 3)} ${bonusCurrency}`;

                 openDailyBonusModal();
             }
         }

         function openDailyBonusModal() {
             document.getElementById('dailyBonusModal').classList.add('visible');
             resetIdleTimer();
             stopAutoDemo();
         }

         function closeDailyBonusModal() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             document.getElementById('dailyBonusModal').classList.remove('visible');
             resetIdleTimer();
         }

         function claimDailyBonus() {
             playSound('win');
             if (navigator.vibrate) navigator.vibrate([50, 50]);
             const bonusAmount = isGuestMode ? 25 : (dailyBonusDay === 7 ? 0.1 : 0.01);
             const bonusCurrency = isGuestMode ? 'SOL' : (dailyBonusDay === 7 ? 'SOL' : '$SPIN');

             if (isGuestMode) {
                 walletBalance += bonusAmount;
                 localStorage.setItem('solroulette_guest_balance', walletBalance);
                 showMessageBox('Bonus Claimed!', `Claimed ${bonusAmount.toFixed(2)} Demo SOL!`);
             } else if (bonusCurrency === 'SOL') {
                 walletBalance += bonusAmount;
                 localStorage.setItem('solroulette_wallet_balance', walletBalance);
                 showMessageBox('Bonus Claimed!', `Claimed ${bonusAmount} SOL!`);
             } else {
                 tokensEarned += bonusAmount;
                 localStorage.setItem('solroulette_spin_tokens', tokensEarned);
                 showMessageBox('Bonus Claimed!', `Claimed ${bonusAmount} $SPIN!`);
             }

             if (dailyBonusDay === 7) {
                 dailyBonusDay = 0;
                 localStorage.setItem(isGuestMode ? 'solroulette_guest_daily_bonus_day' : 'solroulette_daily_bonus_day', dailyBonusDay);
             }

             checkAchievements();
             updateUIDebounced();
             closeDailyBonusModal();
         }

         // Leaderboard (Now receives data from backend)
         let leaderboardScrollTimer = null;
         const LEADERBOARD_SCROLL_INTERVAL = 5000;

         function updateLeaderboard(leaderboard_data) {
             const leaderboardContent = document.getElementById('leaderboardContent');

             // Use the leaderboard_data received from the backend
             const currentLeaderboard = leaderboard_data || { wager: [], streak: [], '10x': [] };

             Object.keys(currentLeaderboard).forEach(tabId => {
                 const tabContentDiv = leaderboardContent.querySelector(`.leaderboard-content-tab[data-tab="${tabId}"]`);
                 if (tabContentDiv) {
                     tabContentDiv.innerHTML = '';
                     currentLeaderboard[tabId].forEach(entry => {
                         const entryDiv = document.createElement('div');
                         entryDiv.className = 'leaderboard-entry';
                         let valueDisplay = entry.value;
                         if (tabId === 'wager') {
                            valueDisplay = `${entry.totalWagered.toFixed(2)} SOL`;
                         } else if (tabId === 'streak') {
                            valueDisplay = `${entry.winStreak}`;
                         } else if (tabId === '10x') {
                            valueDisplay = `${entry.tenXWins}`;
                         }

                         entryDiv.innerHTML = `
                             <span class="user">
                                 ${entry.avatar || ''} ${entry.username}:
                             </span>
                             <span class="value">${valueDisplay}</span>
                         `;
                         tabContentDiv.appendChild(entryDiv);
                     });
                 }
             });

             const activeTabContent = leaderboardContent.querySelector('.leaderboard-content-tab.active');
             if (activeTabContent && activeTabContent.children.length > 5) {
                 startLeaderboardScroll();
             } else {
                 stopLeaderboardScroll();
             }
         }

         function startLeaderboardScroll() {
             if (leaderboardScrollTimer === null) {
                 const leaderboardPanel = document.getElementById('leaderboardPanel');
                 leaderboardScrollTimer = setInterval(() => {
                     leaderboardPanel.scrollBy({ top: 20, behavior: 'smooth' });
                     if (leaderboardPanel.scrollTop + leaderboardPanel.clientHeight >= leaderboardPanel.scrollHeight) {
                         leaderboardPanel.scrollTo({ top: 0, behavior: 'smooth' });
                     }
                 }, LEADERBOARD_SCROLL_INTERVAL / 5);
             }
         }

         function stopLeaderboardScroll() {
             clearInterval(leaderboardScrollTimer);
             leaderboardScrollTimer = null;
         }


         // Leaderboard Tab Switching
         document.querySelectorAll('.leaderboard-tab').forEach(tab => {
             tab.addEventListener('click', () => {
                 document.querySelectorAll('.leaderboard-tab').forEach(t => t.classList.remove('active'));
                 tab.classList.add('active');
                 const targetTab = tab.dataset.tab;
                 document.querySelectorAll('.leaderboard-content-tab').forEach(content => {
                     content.classList.remove('active');
                     if (content.dataset.tab === targetTab) {
                         content.classList.add('active');
                     }
                 });
                 // No need to pass data here, updateLeaderboard will be called by socket event
                 // updateLeaderboard();
             });
         });

         // Low Balance Alert
         function checkLowBalance() {
             if (!isGuestMode && user.wallet && walletBalance < 0.5) {
                 document.getElementById('lowBalanceAlert').style.display = 'block';
             } else {
                 document.getElementById('lowBalanceAlert').style.display = 'none';
             }
         }

         function topUpWallet() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             // In a real app, this would interact with a smart contract or payment gateway
             // For now, emit to backend for mock top-up
             if (window.socket && window.socket.connected && window.walletVerified) {
                 window.socket.emit('mockTopUp', { amount: 5 }); // Emit mock top-up request
                 showMessageBox('Top Up Request Sent', 'Requesting 5 SOL top-up... (Mock)');
             } else {
                 walletBalance += 5;
                 localStorage.setItem('solroulette_wallet_balance', walletBalance);
                 showMessageBox('Mock Top Up', '5 SOL added to your balance!');
                 updateUIDebounced();
                 checkLowBalance();
             }
         }

         // Double or Nothing
         function openDoubleOrNothingModal() {
             document.getElementById('doubleOrNothingModal').classList.add('visible');
             resetIdleTimer();
             stopAutoDemo();
         }

         function closeDoubleOrNothingModal() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             document.getElementById('doubleOrNothingModal').classList.remove('visible');
             resetIdleTimer();
         }

         function tryAgainBet() {
             playSound('click');
             if (navigator.vibrate) navigator.vibrate(50);
             if (lastLossBet) {
                 if (spinTimer > 3 && !isSpinning && walletBalance >= lastLossBet.amount) {
                     currentBet.multiplier = lastLossBet.multiplier;
                     document.getElementById('betSlider').value = lastLossBet.amount;
                     currentBet.amount = lastLossBet.amount;
                     document.querySelectorAll('.multiplier-btn').forEach(btn => {
                         btn.classList.remove('active');
                         if (btn.dataset.multiplier === currentBet.multiplier) {
                             btn.classList.add('active');
                         }
                     });
                     updateUIDebounced();

                     placeBet();

                     lastLossBet = null;
                     closeDoubleOrNothingModal();
                 } else if (spinTimer <= 3 || isSpinning) {
                     showMessageBox('Betting Closed', 'Betting is closed for this round!');
                 } else if (walletBalance < lastLossBet.amount) {
                     showMessageBox('Insufficient Balance', 'Not enough SOL to try again.');
                 } else {
                     showMessageBox('Try Again Failed', 'Could not place the bet. Please try manually.');
                 }
             } else {
                 closeDoubleOrNothingModal();
             }
         }

         // Show Demo Mode Toast
         function showGuestModeToast() {
             const toast = document.getElementById('guestModeToast');
             toast.style.display = 'block';
             setTimeout(() => {
                 toast.style.display = 'none';
             }, 5000);
         }

         // Onboarding Modal for Guest Mode
         function showOnboardingModal() {
             const modal = document.getElementById('onboardingModal');
             modal.classList.add('visible');
             stopAutoDemo();


             document.getElementById('onboardingStartBtn').onclick = () => {
                 localStorage.setItem('solroulette_fake_intro_shown', 'true');
                 isGuestMode = true;
                 localStorage.setItem('solroulette_is_guest', 'true');
                 walletBalance = 500;
                 localStorage.setItem('solroulette_guest_balance', walletBalance);

                 if (localStorage.getItem('solroulette_guest_xp') === null) localStorage.setItem('solroulette_guest_xp', '0');
                 if (localStorage.getItem('solroulette_guest_tokens') === null) localStorage.setItem('solroulette_guest_tokens', '0');
                 if (localStorage.getItem('solroulette_guest_total_wagered') === null) localStorage.setItem('solroulette_guest_total_wagered', '0');
                 if (localStorage.getItem('solroulette_guest_win_streak') === null) localStorage.setItem('solroulette_guest_win_streak', '0');
                 if (localStorage.getItem('solroulette_guest_ten_x_wins') === null) localStorage.setItem('solroulette_guest_ten_x_wins', '0');
                 if (localStorage.getItem('solroulette_guest_achievements') === null) localStorage.setItem('solroulette_guest_achievements', '[]');
                 if (localStorage.getItem('solroulette_guest_spin_count') === null) localStorage.setItem('solroulette_guest_spin_count', '0');
                 if (localStorage.getItem('solroulette_guest_last_login') === null) localStorage.setItem('solroulette_guest_last_login', new Date().toDateString());
                 if (localStorage.getItem('solroulette_guest_daily_bonus_day') === null) localStorage.setItem('solroulette_guest_daily_bonus_day', '0');
                 if (localStorage.getItem('solroulette_fake_winnings_total') === null) localStorage.setItem('solroulette_fake_winnings_total', '0');

                 xp = parseInt(localStorage.getItem('solroulette_guest_xp'));
                 tokensEarned = parseFloat(localStorage.getItem('solroulette_guest_tokens'));
                 totalWagered = parseFloat(localStorage.getItem('solroulette_total_wagered'));
                 winStreak = parseInt(localStorage.getItem('solroulette_win_streak'));
                 tenXWins = parseInt(localStorage.getItem('solroulette_ten_x_wins'));
                 achievementsUnlocked = new Set(JSON.parse(localStorage.getItem('solroulette_achievements')));
                 guestSpinCount = parseInt(localStorage.getItem('solroulette_guest_spin_count'));
                 dailyBonusDay = parseInt(localStorage.getItem('solroulette_guest_daily_bonus_day'));
                 fakeWinningsTotal = parseFloat(localStorage.getItem('solroulette_fake_winnings_total'));


                 user.name = 'Guest';
                 user.avatar = '';
                 localStorage.setItem('solroulette_user_name', user.name);
                 localStorage.setItem('solroulette_user_avatar', user.avatar);


                 closeOnboardingModal();
                 updateUIDebounced();
                 showMessageBox('Demo SOL Added', '500 Demo SOL added. Start spinning!');
                 showOnboardingTooltip();
                 resetIdleTimer();
             };

             document.getElementById('onboardingConnectBtn').onclick = () => {
                 localStorage.setItem('solroulette_fake_intro_shown', 'true');
                 isGuestMode = false;
                 localStorage.setItem('solroulette_is_guest', 'false');
                 closeOnboardingModal();
                 openWalletModal();
                 dismissOnboarding();
                 resetIdleTimer();
             };
         }

         function closeOnboardingModal() {
             document.getElementById('onboardingModal').classList.remove('visible');
         }

         // Onboarding Tooltip
         function showOnboardingTooltip() {
             if (!onboardingShown && isGuestMode) {
                 const tooltip = document.getElementById('onboardingTooltip');
                 const multiplierOptions = document.getElementById('multiplierOptions');

                 multiplierOptions.classList.add('onboarding-glow');
                 tooltip.classList.add('visible');

                 setTimeout(() => {
                     dismissOnboarding();
                 }, 10000);
             }
         }

         function dismissOnboarding() {
             const tooltip = document.getElementById('onboardingTooltip');
             const multiplierOptions = document.getElementById('multiplierOptions');

             multiplierOptions.classList.remove('onboarding-glow');
             tooltip.classList.remove('visible');

             onboardingShown = true;
             localStorage.setItem('solroulette_onboarding_shown', 'true');
         }


         // Update Recent Spins Display
         function updateRecentSpinsDisplay() {
             const recentSpinsDiv = document.getElementById('recentSpins');
             recentSpinsDiv.innerHTML = '<span class="label">Recent:</span>';

             recentSpins.forEach(spin => {
                 const outcomeSpan = document.createElement('span');
                 const multiplierValue = parseFloat(spin.multiplier.replace('x', ''));
                 let colorClass = 'lose';
                 if (multiplierValue === 1.5 || multiplierValue === 5) {
                     colorClass = 'success';
                 } else if (multiplierValue === 2) {
                     colorClass = 'primary';
                 } else if (multiplierValue === 3) {
                     colorClass = 'accent';
                 } else if (multiplierValue === 10) {
                      colorClass = 'danger';
                 }
                 outcomeSpan.className = `outcome ${colorClass}`;
                 outcomeSpan.textContent = spin.multiplier;
                 recentSpinsDiv.appendChild(outcomeSpan);
             });
         }

         // Update Bet Summary Display
         function updateBetSummary() {
             const betSummaryDiv = document.getElementById('betSummary');
             if (currentBet.multiplier !== null && currentBet.amount > 0) {
                 const potentialWin = currentBet.amount * parseFloat(currentBet.multiplier);
                 betSummaryDiv.innerHTML = `
                      You bet ${currentBet.amount.toFixed(2)} on ${currentBet.multiplier}x
                     <br>
                      Potential Win: ${potentialWin.toFixed(2)}
                 `;
                 betSummaryDiv.style.display = 'block';
             } else {
                 betSummaryDiv.style.display = 'none';
             }
         }

         // Auto Demo Mode Functions
         function startAutoDemo() {
             if (!isGuestMode || firstRealBetPlaced || isSpinning || document.querySelector('.modal-overlay.visible')) {
                 isAutoDemo = false;
                 document.getElementById('autoDemoBanner').style.display = 'none';
                 return;
             }

             isAutoDemo = true;
             document.getElementById('autoDemoBanner').style.display = 'block';

             const multipliers = ['1.5', '2', '3', '5', '10'];
             const randomMultiplier = multipliers[Math.floor(Math.random() * multipliers.length)];

             document.querySelectorAll('.multiplier-btn').forEach(btn => {
                 btn.classList.remove('active');
                 if (btn.dataset.multiplier === randomMultiplier) {
                     btn.classList.add('active');
                 }
             });
             currentBet.multiplier = randomMultiplier;

             const randomAmount = parseFloat((Math.random() * 1.9 + 0.1).toFixed(2));
             document.getElementById('betSlider').value = randomAmount;
             currentBet.amount = randomAmount;
             updateUIDebounced();

             setTimeout(() => {
                 if (isAutoDemo && spinTimer > 3 && !isSpinning) { // Check spinTimer and isSpinning
                     placeBet();
                 } else {
                     autoDemoTimer = setTimeout(startAutoDemo, AUTO_DEMO_INTERVAL);
                 }
             }, 1000);
         }

         function stopAutoDemo() {
             clearTimeout(autoDemoTimer);
             isAutoDemo = false;
             document.getElementById('autoDemoBanner').style.display = 'none';
             document.querySelectorAll('.multiplier-btn').forEach(btn => btn.classList.remove('active'));
             updateUIDebounced();
         }

         // Keyboard Detection for Mobile Sticky Bet Button
         let initialViewportHeight = window.innerHeight;
         let keyboardOpen = false;

         function checkKeyboard() {
             const currentViewportHeight = window.innerHeight;
             const heightDifference = initialViewportHeight - currentViewportHeight;
             const keyboardThreshold = 150;

             if (heightDifference > keyboardThreshold && !keyboardOpen) {
                 keyboardOpen = true;
                 document.body.classList.add('keyboard-open');
             } else if (heightDifference <= keyboardThreshold && keyboardOpen) {
                 keyboardOpen = false;
                 document.body.classList.remove('keyboard-open');
             }
         }

         window.addEventListener('resize', checkKeyboard);
         document.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(input => {
             input.addEventListener('focus', checkKeyboard);
             input.addEventListener('blur', checkKeyboard);
         });


         // Daily Reward Prompt
         let activeUseTimer = null;
         let activeUseDuration = 0;
         const DAILY_REWARD_THRESHOLD = 180;

         function startActiveUseTimer() {
             if (activeUseTimer === null) {
                 activeUseTimer = setInterval(() => {
                     activeUseDuration++;
                     if (activeUseDuration >= DAILY_REWARD_THRESHOLD && isGuestMode && !dailyRewardClaimedToday) {
                         showDailyRewardModal();
                         stopActiveUseTimer();
                     }
                 }, 1000);
             }
         }

         function stopActiveUseTimer() {
             clearInterval(activeUseTimer);
             activeUseTimer = null;
         }

         function resetActiveUseTimer() {
             activeUseDuration = 0;
             stopActiveUseTimer();
             startActiveUseTimer();
         }

         function showDailyRewardModal() {
             const modal = document.getElementById('dailyRewardModal');
             const anyModalVisible = document.querySelector('.modal-overlay.visible');
             if (!anyModalVisible && isGuestMode && !dailyRewardClaimedToday) {
                modal.classList.add('visible');
                resetIdleTimer();
                stopAutoDemo();
             }
         }

         function closeDailyRewardModal() {
             const modal = document.getElementById('dailyRewardModal');
             modal.classList.remove('visible');
             resetIdleTimer();
         }

         function claimDailyReward() {
             playSound('win');
             if (navigator.vibrate) navigator.vibrate([50, 50]);
             const rewardAmount = 0.05;
             tokensEarned += rewardAmount;
             localStorage.setItem('solroulette_spin_tokens', tokensEarned);
             dailyRewardClaimedToday = true;
             localStorage.setItem('solroulette_daily_reward_claimed', new Date().toDateString());
             showMessageBox('Reward Claimed!', `You claimed ${rewardAmount.toFixed(2)} $SPIN!`);
             updateUIDebounced();
             closeDailyRewardModal();
         }


        // Update UI elements
        function updateUI() {
            console.log('updateUI running. currentBet.multiplier:', currentBet.multiplier, 'currentBet.amount:', currentBet.amount, 'spinTimer:', spinTimer, 'isGuestMode:', isGuestMode, 'user.wallet:', user.wallet ? 'Connected' : 'Not Connected');

            const xpPercentage = (xp % 100);
            if (xp >= 100) {
                level++;
                xp -= 100;
                addChatMessage('System', `${user.name} leveled up to ${level}!`, '', 'system');
                localStorage.setItem('solroulette_level', level);
                localStorage.setItem('solroulette_xp', xp);
                if (xp >= 100) updateUIDebounced();
            }
             localStorage.setItem('solroulette_xp', xp);


            document.getElementById('userProfile').innerHTML = `
                <div class="avatar" id="userAvatar">${user.avatar}</div>
                <div class="user-info">
                    <div id="userName">${user.name} ${isGuestMode ? '(Guest)' : ''} (Lv. ${level})</div>
                    <div class="xp-bar"><div class="xp-fill" id="xpFill" style="width: ${(xp % 100)}%"></div></div>
                </div>
                <div class="sol-balance-display" style="display: ${window.walletVerified ? 'flex' : 'none'};"><i class="fas fa-wallet"></i> <span id="solBalance">${walletBalance.toFixed(2)}</span> SOL</div>
                 <div id="fakeWinningsDisplay" class="fake-winnings-display" style="display: ${window.walletVerified ? 'none' : 'block'};" title="Your total demo winnings so far.">
                     <span id="fakeWinningsTotalDisplay">${fakeWinningsTotal.toFixed(2)}</span> (Demo)
                 </div>
            `;
             document.getElementById('userProfile').addEventListener('click', openProfileModal);


            const placeBetBtn = document.getElementById('placeBetBtn');
            const connectWalletBtn = document.getElementById('connectWalletBtn');
            const multiplierBtns = document.querySelectorAll('.multiplier-btn');
            const betSlider = document.getElementById('betSlider');
            const spinAgainBtn = document.getElementById('resultModalSpinAgainBtn');
            const guestModeBanner = document.getElementById('guestModeBanner');


            const bettingAllowedByTimer = spinTimer > 3 && !isSpinning; // Betting allowed if timer > 3 and not spinning
            const betIsValid = currentBet.multiplier !== null && currentBet.amount > 0;


            if (window.walletVerified) {
                 connectWalletBtn.style.display = 'none';
                 placeBetBtn.style.display = 'block';
                 guestModeBanner.style.display = 'none';

                 placeBetBtn.disabled = !bettingAllowedByTimer || !betIsValid;
                 placeBetBtn.title = bettingAllowedByTimer ? '' : 'Betting is closed';

                 multiplierBtns.forEach(btn => {
                     btn.disabled = !bettingAllowedByTimer;
                     btn.title = bettingAllowedByTimer ? '' : 'Betting is closed';
                 });
                 betSlider.disabled = !bettingAllowedByTimer;
                 betSlider.title = bettingAllowedByTimer ? '' : 'Betting is closed';

            } else {
                 if (!user.wallet) {
                     connectWalletBtn.style.display = 'block';
                 } else {
                     connectWalletBtn.style.display = 'none';
                 }

                 placeBetBtn.style.display = 'block';
                 guestModeBanner.style.display = 'block';

                 placeBetBtn.disabled = !bettingAllowedByTimer || !betIsValid;
                 placeBetBtn.title = 'Demo SOL bets. Connect wallet to win real rewards.';

                 multiplierBtns.forEach(btn => {
                     btn.disabled = !bettingAllowedByTimer;
                     btn.title = bettingAllowedByTimer ? 'Using Demo SOL  Real rewards require a wallet' : 'Betting is closed';
                 });
                 betSlider.disabled = !bettingAllowedByTimer;
                 betSlider.title = bettingAllowedByTimer ? 'Using Demo SOL  Real rewards require a wallet' : 'Betting is closed';
            }

             spinAgainBtn.disabled = !bettingAllowedByTimer;

            multiplierBtns.forEach(btn => {
                btn.classList.remove('active');
                if (currentBet.multiplier !== null && btn.dataset.multiplier === currentBet.multiplier) {
                    btn.classList.add('active');
                }
            });

            console.log('Place Bet button disabled state:', placeBetBtn.disabled);


             if (tokensEarned > 0 && window.walletVerified) {
                 document.getElementById('tokenNotification').style.display = 'flex';
             } else {
                  document.getElementById('tokenNotification').style.display = 'none';
             }

             if (window.walletVerified) {
                 checkLowBalance();
             } else {
                 document.getElementById('lowBalanceAlert').style.display = 'none';
             }

             document.getElementById('shopSpinBalance').textContent = tokensEarned.toFixed(3);

             updateBetSummary();

             document.getElementById('fakeWinningsTotalDisplay').textContent = fakeWinningsTotal.toFixed(2);

        }

        // Initial Canvas Setup
        function setupCanvas() {
            const container = document.getElementById('wheelContainer');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            drawWheel();
        }

        // Idle Timer Functions
        function resetIdleTimer() {
            clearTimeout(idleTimer);
            idleTimer = setTimeout(showIdleModalOrAutoDemo, IDLE_TIMEOUT);

             if (isAutoDemo) {
                 stopAutoDemo();
             }
             resetActiveUseTimer();
        }

        function showIdleModalOrAutoDemo() {
             const anyModalVisible = document.querySelector('.modal-overlay.visible');
             if (!anyModalVisible && isGuestMode && !firstRealBetPlaced) {
                 startAutoDemo();
             } else if (!anyModalVisible) {
                 showIdleModal();
             }
             resetIdleTimer();
        }

        function showIdleModal() {
            const idleModal = document.getElementById('idleModal');
            const anyModalVisible = document.querySelector('.modal-overlay.visible');
            if (!anyModalVisible) {
                idleModal.classList.add('visible');
            }
            resetIdleTimer();
        }

        function closeIdleModal() {
            document.getElementById('idleModal').classList.remove('visible');
            resetIdleTimer();
        }


        // Event Listeners
        document.getElementById('betSlider').addEventListener('input', (e) => {
             currentBet.amount = parseFloat(e.target.value);
             localStorage.setItem('solroulette_current_amount', currentBet.amount);
             updateUIDebounced();
             dismissOnboarding();
             resetIdleTimer();
             stopAutoDemo();
        });

        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChat();
                e.preventDefault();
            }
        });

        document.querySelectorAll('.multiplier-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                 console.log('Multiplier button clicked:', btn.dataset.multiplier);

                 if (spinTimer <= 3 || isSpinning) {
                     console.log('Betting closed, ignoring multiplier click.');
                     return;
                 }

                playSound('click');
                if (navigator.vibrate) navigator.vibrate(50);

                document.querySelectorAll('.multiplier-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentBet.multiplier = btn.dataset.multiplier;
                localStorage.setItem('solroulette_current_multiplier', currentBet.multiplier);
                console.log('currentBet.multiplier set to:', currentBet.multiplier);

                 updateUIDebounced();

                 dismissOnboarding();
                 resetIdleTimer();
                 stopAutoDemo();
            });
        });

         document.getElementById('walletModal').addEventListener('click', (e) => {
             // Close modal if clicking outside the content
             // if (e.target === document.getElementById('walletModal')) { }
         });
          document.getElementById('profileModal').addEventListener('click', (e) => {
             if (e.target === document.getElementById('profileModal')) {
                 closeProfileModal();
             }
         });
          document.getElementById('shopModal').addEventListener('click', (e) => {
             if (e.target === document.getElementById('shopModal')) {
                 closeShopModal();
             }
         });
          document.getElementById('dailyBonusModal').addEventListener('click', (e) => {
             if (e.target === document.getElementById('dailyBonusModal')) {
                 closeDailyBonusModal();
             }
         });
          document.getElementById('doubleOrNothingModal').addEventListener('click', (e) => {
             // if (e.target === document.getElementById('doubleOrNothingModal')) { }
         });
         document.getElementById('resultModal').addEventListener('click', (e) => {
             // if (e.target === document.getElementById('resultModal')) { }
         });
         document.getElementById('messageBox').addEventListener('click', (e) => {
             if (e.target === document.getElementById('messageBox')) {
                 closeMessageBox();
             }
         });
          document.getElementById('shareModal').addEventListener('click', (e) => {
             if (e.target === document.getElementById('shareModal')) {
                 closeShareModal();
             }
         });
         document.getElementById('onboardingModal').addEventListener('click', (e) => {
             // if (e.target === document.getElementById('onboardingModal')) { }
         });
          document.getElementById('refillFakeSolModal').addEventListener('click', (e) => {
             // if (e.target === document.getElementById('refillFakeSolModal')) { }
         });
         document.getElementById('idleModal').addEventListener('click', (e) => {
             // if (e.target === document.getElementById('idleModal')) { }
         });
         document.getElementById('dailyRewardModal').addEventListener('click', (e) => {
             // if (e.target === document.getElementById('dailyRewardModal')) { }
         });


        document.getElementById('connectWalletBtn').addEventListener('click', openWalletModal);
        document.getElementById('placeBetBtn').addEventListener('click', placeBet);
        document.getElementById('claimModalBtn').addEventListener('click', openClaimModal);
        document.getElementById('closeWalletModalBtn').addEventListener('click', closeWalletModal);
        document.getElementById('justWatchingBtn').addEventListener('click', closeWalletModal);
        document.getElementById('closeProfileModalBtn').addEventListener('click', closeProfileModal);
        document.getElementById('copyReferralLinkBtn').addEventListener('click', copyReferralLink);
        document.getElementById('resetGuestProgressBtn').addEventListener('click', resetGuestProgress);
        document.getElementById('closeShopModalBtn').addEventListener('click', closeShopModal);
        document.querySelectorAll('.buy-item-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                buyShopItem(btn.dataset.itemId, parseFloat(btn.dataset.cost));
            });
        });
        document.getElementById('closeDailyBonusModalBtn').addEventListener('click', closeDailyBonusModal);
        document.getElementById('claimDailyBonusBtn').addEventListener('click', claimDailyBonus);
        document.getElementById('tryAgainBetBtn').addEventListener('click', tryAgainBet);
        document.getElementById('cancelDoubleOrNothingBtn').addEventListener('click', closeDoubleOrNothingModal);
        document.getElementById('closeResultModalBtn').addEventListener('click', closeResultModal);
        document.getElementById('closeShareModalBtn').addEventListener('click', closeShareModal);
        document.getElementById('copyShareTextBtn').addEventListener('click', copyShareText);
        document.getElementById('tweetWinBtn').addEventListener('click', tweetWin);
        document.getElementById('closeMessageBoxBtn').addEventListener('click', closeMessageBox);
        document.getElementById('topUpWalletBtn').addEventListener('click', topUpWallet);
        document.getElementById('resultModalSpinAgainBtn').addEventListener('click', closeResultModal);
        document.getElementById('closeRefillFakeSolModalBtn').addEventListener('click', closeRefillFakeSolModal);
        document.getElementById('refillFakeSolBtn').addEventListener('click', refillFakeSol);
        document.getElementById('closeIdleModalBtn').addEventListener('click', closeIdleModal);
        document.getElementById('closeDailyRewardModalBtn').addEventListener('click', closeDailyRewardModal);
        document.getElementById('claimDailyRewardBtn').addEventListener('click', claimDailyReward);


        // Live Panel Tab Switching Functionality
        const livePanelTabs = document.querySelectorAll('.live-panel-tab');
        const livePanelContents = document.querySelectorAll('.live-panel-content-tab');

        livePanelTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                livePanelTabs.forEach(t => t.classList.remove('active'));
                livePanelContents.forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                const targetTabId = tab.dataset.tab;
                const targetContent = document.getElementById(`live${targetTabId.charAt(0).toUpperCase() + targetTabId.slice(1)}Content`);

                if (targetContent) {
                    targetContent.classList.add('active');
                    if (targetTabId === 'chat') {
                         const chatFeed = document.getElementById('chatFeed');
                         chatFeed.scrollTop = chatFeed.scrollHeight;
                         document.getElementById('chatUnreadDot').style.display = 'none';
                    } else if (targetTabId === 'bets') {
                         document.getElementById('betsUnreadDot').style.display = 'none';
                    }
                    if (document.querySelector('.live-panel-tab.active')) {
                         document.getElementById('livePanelUnreadDot').style.display = 'none';
                    }
                }
                 resetIdleTimer();
                 stopAutoDemo();
            });
        });

        document.querySelector('.live-panel-tab[data-tab="bets"]').classList.add('active');
        document.getElementById('liveBetsContent').classList.add('active');


        // Add particle effects to the background overlay
        function createParticle() {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = `${Math.random() * 100}vw`;
            particle.style.top = `${Math.random() * 100}vh`;
            particle.style.animationDelay = `${Math.random() * 5}s`;
            document.getElementById('backgroundOverlay').appendChild(particle);
            particle.addEventListener('animationend', () => particle.remove());
        }

        function spawnParticles(count) {
            for (let i = 0; i < count; i++) {
                createParticle();
            }
        }

        // Add money rain effect on win
        function triggerMoneyRain() {
             const moneyCount = 50;
             for (let i = 0; i < moneyCount; i++) {
                 const money = document.createElement('div');
                 money.className = 'money-rain';
                 money.style.left = `${Math.random() * 100}vw`;
                 money.style.animationDelay = `${Math.random() * 0.5}s`;
                 document.body.appendChild(money);
                 money.addEventListener('animationend', () => money.remove());
             }
        }


        // Start Simulation
        // Removed setInterval(updateTimer, 1000) as it's now driven by backend socket events
        setInterval(simulateMultiplayer, 5000);
        // updateLeaderboard is now called by socket.on('leaderboardUpdate')
        setInterval(checkLowBalance, 30000);
        setInterval(updateFakeActivityBanner, 7000);
        setInterval(() => {
             if (Math.random() < 0.3) {
                 showTenXHitBanner();
             }
         }, Math.random() * 30000 + 30000);


        // Initial setup on page load
        window.onload = function() {
            setupCanvas();

             const jwtToken = localStorage.getItem("jwtToken");
             if (jwtToken) {
                 window.walletVerified = true;
                 isGuestMode = false;
                 document.body.classList.add('wallet-verified');
                 document.getElementById("guestModeBanner").style.display = "none";
                 const verifiedBadge = document.getElementById("verifiedBadge");
                 if (verifiedBadge) {
                     verifiedBadge.style.display = "inline-block";
                 }
                 document.getElementById('connectWalletBtn').style.display = 'none';
                 document.getElementById('placeBetBtn').style.display = 'block';

                 document.querySelectorAll(".fake-winnings-display").forEach(el => el.style.display = "none");
                 document.querySelectorAll(".sol-balance-display").forEach(el => el.style.display = "block");

                 connectSocketWithToken(jwtToken);
                 showMessageBox('Welcome Back!', 'Your wallet is already connected and verified.');

                 walletBalance = parseFloat(localStorage.getItem('solroulette_wallet_balance') || '0');
                 xp = parseInt(localStorage.getItem('solroulette_xp') || '0');
                 tokensEarned = parseFloat(localStorage.getItem('solroulette_spin_tokens') || '0');
                 totalWagered = parseFloat(localStorage.getItem('solroulette_total_wagered') || '0');
                 winStreak = parseInt(localStorage.getItem('solroulette_win_streak') || '0');
                 tenXWins = parseInt(localStorage.getItem('solroulette_ten_x_wins') || '0');
                 achievementsUnlocked = new Set(JSON.parse(localStorage.getItem('solroulette_achievements') || '[]'));
                 dailyBonusDay = parseInt(localStorage.getItem('solroulette_daily_bonus_day') || '0');
                 user.wallet = localStorage.getItem('solroulette_wallet');
                 user.name = localStorage.getItem('solroulette_user_name');
                 user.avatar = localStorage.getItem('solroulette_user_avatar');

             } else {
                 const fakeIntroShown = localStorage.getItem('solroulette_fake_intro_shown');

                 if (!fakeIntroShown) {
                     isGuestMode = true;
                     localStorage.setItem('solroulette_is_guest', 'true');
                     walletBalance = 500;
                     localStorage.setItem('solroulette_guest_balance', walletBalance);

                     if (localStorage.getItem('solroulette_guest_xp') === null) localStorage.setItem('solroulette_guest_xp', '0');
                     if (localStorage.getItem('solroulette_guest_tokens') === null) localStorage.setItem('solroulette_guest_tokens', '0');
                     if (localStorage.getItem('solroulette_guest_total_wagered') === null) localStorage.setItem('solroulette_guest_total_wagered', '0');
                     if (localStorage.getItem('solroulette_guest_win_streak') === null) localStorage.setItem('solroulette_guest_win_streak', '0');
                     if (localStorage.getItem('solroulette_guest_ten_x_wins') === null) localStorage.setItem('solroulette_guest_ten_x_wins', '0');
                     if (localStorage.getItem('solroulette_guest_achievements') === null) localStorage.setItem('solroulette_guest_achievements', '[]');
                     if (localStorage.getItem('solroulette_guest_spin_count') === null) localStorage.setItem('solroulette_guest_spin_count', '0');
                     if (localStorage.getItem('solroulette_guest_last_login') === null) localStorage.setItem('solroulette_guest_last_login', new Date().toDateString());
                     if (localStorage.getItem('solroulette_guest_daily_bonus_day') === null) localStorage.setItem('solroulette_guest_daily_bonus_day', '0');
                     if (localStorage.getItem('solroulette_fake_winnings_total') === null) localStorage.setItem('solroulette_fake_winnings_total', '0');

                     xp = parseInt(localStorage.getItem('solroulette_guest_xp'));
                     tokensEarned = parseFloat(localStorage.getItem('solroulette_guest_tokens'));
                     totalWagered = parseFloat(localStorage.getItem('solroulette_total_wagered'));
                     winStreak = parseInt(localStorage.getItem('solroulette_win_streak'));
                     tenXWins = parseInt(localStorage.getItem('solroulette_ten_x_wins'));
                     achievementsUnlocked = new Set(JSON.parse(localStorage.getItem('solroulette_achievements')));
                     guestSpinCount = parseInt(localStorage.getItem('solroulette_guest_spin_count'));
                     dailyBonusDay = parseInt(localStorage.getItem('solroulette_guest_daily_bonus_day'));
                     fakeWinningsTotal = parseFloat(localStorage.getItem('solroulette_fake_winnings_total'));


                     user.name = 'Guest';
                     user.avatar = '';
                     localStorage.setItem('solroulette_user_name', user.name);
                     localStorage.setItem('solroulette_user_avatar', user.avatar);


                     updateUIDebounced();
                     showOnboardingModal();

                 } else {
                     isGuestMode = true;
                     localStorage.setItem('solroulette_is_guest', 'true');
                     walletBalance = parseFloat(localStorage.getItem('solroulette_guest_balance') || '500');
                     if (walletBalance <= 0) {
                        walletBalance = 500;
                        localStorage.setItem('solroulette_guest_balance', walletBalance);
                     }

                     xp = parseInt(localStorage.getItem('solroulette_guest_xp') || '0');
                     tokensEarned = parseFloat(localStorage.getItem('solroulette_guest_tokens') || '0');
                     totalWagered = parseFloat(localStorage.getItem('solroulette_total_wagered') || '0');
                     winStreak = parseInt(localStorage.getItem('solroulette_win_streak') || '0');
                     tenXWins = parseInt(localStorage.getItem('solroulette_ten_x_wins') || '0');
                     achievementsUnlocked = new Set(JSON.parse(localStorage.getItem('solroulette_achievements') || '[]'));
                     guestSpinCount = parseInt(localStorage.getItem('solroulette_guest_spin_count') || '0');
                     dailyBonusDay = parseInt(localStorage.getItem('solroulette_guest_daily_bonus_day') || '0');
                     fakeWinningsTotal = parseFloat(localStorage.getItem('solroulette_fake_winnings_total') || '0');


                     user.name = 'Guest';
                     user.avatar = '';
                     localStorage.setItem('solroulette_user_name', user.name);
                     localStorage.setItem('solroulette_user_avatar', user.avatar);

                     updateUIDebounced();
                     showGuestModeToast();
                     showOnboardingTooltip();
                     resetIdleTimer();
                 }
             }


             if (currentBet.multiplier !== null) {
                  const defaultMultiplierBtn = document.querySelector(`.multiplier-btn[data-multiplier="${currentBet.multiplier}"]`);
                  if (defaultMultiplierBtn) {
                      defaultMultiplierBtn.classList.add('active');
                  }
             }
             if (currentBet.amount > 0) {
                  document.getElementById('betSlider').value = currentBet.amount;
             }


             updateUIDebounced();


            spawnParticles(50);
            checkReferralCode();
            updateRecentSpinsDisplay();
            updateFakeActivityBanner();
            // updateLeaderboard is now called by socket.on('leaderboardUpdate')


             checkDailyBonus();

             if (isGuestMode && !firstRealBetPlaced) {
                 autoDemoTimer = setTimeout(showIdleModalOrAutoDemo, IDLE_TIMEOUT);
             }

             startActiveUseTimer();
        };

        window.addEventListener('resize', setupCanvas);
        window.addEventListener('resize', checkKeyboard);


        document.addEventListener('mousemove', resetIdleTimer);
        document.addEventListener('keypress', resetIdleTimer);
        document.addEventListener('touchstart', resetIdleTimer);
        document.addEventListener('click', resetIdleTimer);
        document.addEventListener('scroll', resetIdleTimer);


         document.getElementById('claimDailyRewardBtn').addEventListener('click', claimDailyReward);
         document.getElementById('dailyRewardModal').addEventListener('click', (e) => {
             if (e.target === document.getElementById('dailyRewardModal')) {
                 closeDailyRewardModal();
             }
         });

         document.addEventListener('DOMContentLoaded', handleWalletConnection);

         document.getElementById('toggleLivePanel').addEventListener('click', function() {
             const livePanelContainer = document.getElementById('livePanelContainer');
             const toggleBtn = document.getElementById('toggleLivePanel');
             const icon = toggleBtn.querySelector('i');

             livePanelContainer.classList.toggle('active');

             if (livePanelContainer.classList.contains('active')) {
                 icon.classList.remove('fa-chevron-left');
                 icon.classList.add('fa-chevron-right');
                 document.getElementById('livePanelUnreadDot').style.display = 'none';
                 document.getElementById('betsUnreadDot').style.display = 'none';
                 document.getElementById('chatUnreadDot').style.display = 'none';
             } else {
                 icon.classList.remove('fa-chevron-right');
                 icon.classList.add('fa-chevron-left');
             }
             resetIdleTimer();
             stopAutoDemo();
         });

         document.getElementById('sendChatBtn').addEventListener('click', sendChat);

        document.getElementById('rouletteCanvas').addEventListener('spinstart', () => {
            const multiplierOptions = document.getElementById('multiplierOptions');
            multiplierOptions.style.display = 'none';
            setTimeout(() => {
                multiplierOptions.style.display = 'grid';
            }, 4000);
        });


    </script>
</body>

</html>
